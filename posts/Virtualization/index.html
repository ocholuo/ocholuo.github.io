<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Virtualization" /><meta property="og:locale" content="en" /><meta name="description" content="Virtualization traditional way Virtualization Virtualization component Comparing Hypervisors Type of Virtualization full virtualization scenario paravirtualization. QEMU KVM Kernel-based Virtual Machine QEMU and KVM QEMU example Libvirt example virsh example virsh example change vm configure snapshot and clone autostart vm migration container" /><meta property="og:description" content="Virtualization traditional way Virtualization Virtualization component Comparing Hypervisors Type of Virtualization full virtualization scenario paravirtualization. QEMU KVM Kernel-based Virtual Machine QEMU and KVM QEMU example Libvirt example virsh example virsh example change vm configure snapshot and clone autostart vm migration container" /><link rel="canonical" href="https://ocholuo.github.io//posts/Virtualization/" /><meta property="og:url" content="https://ocholuo.github.io//posts/Virtualization/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-26T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Virtualization" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2020-11-26T10:11:11-05:00","description":"Virtualization traditional way Virtualization Virtualization component Comparing Hypervisors Type of Virtualization full virtualization scenario paravirtualization. QEMU KVM Kernel-based Virtual Machine QEMU and KVM QEMU example Libvirt example virsh example virsh example change vm configure snapshot and clone autostart vm migration container","headline":"Virtualization","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/Virtualization/"},"url":"https://ocholuo.github.io//posts/Virtualization/"}</script><title>Virtualization | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Virtualization</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Virtualization</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 26, 2020, 10:11 AM -0500" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3058 words">16 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#virtualization">Virtualization</a><ul><li><a href="#traditional-way">traditional way</a><li><a href="#virtualization-1">Virtualization</a><li><a href="#virtualization-component">Virtualization component</a><li><a href="#comparing-hypervisors">Comparing Hypervisors</a><li><a href="#type-of-virtualization">Type of Virtualization</a><ul><li><a href="#full-virtualization-scenario">full virtualization scenario</a><li><a href="#paravirtualization">paravirtualization.</a></ul><li><a href="#qemu">QEMU</a><li><a href="#kvm-kernel-based-virtual-machine">KVM <code class="language-plaintext highlighter-rouge">Kernel-based Virtual Machine</code></a><li><a href="#qemu-and-kvm">QEMU and KVM</a><li><a href="#qemu-example">QEMU example</a><li><a href="#libvirt-example">Libvirt example</a><li><a href="#virsh-example">virsh example</a><li><a href="#virsh-example-1">virsh example</a><li><a href="#change-vm-configure">change vm configure</a><li><a href="#snapshot-and-clone">snapshot and clone</a><li><a href="#autostart">autostart</a><li><a href="#vm-migration">vm migration</a><li><a href="#container">container</a></ul></ul><hr /><h1 id="virtualization">Virtualization</h1><hr /><h2 id="traditional-way">traditional way</h2><p><img data-proofer-ignore data-src="https://i.imgur.com/iUnkAWY.png" alt="Screen Shot 2021-02-11 at 17.21.07" /></p><ul><li>the default way to deploy an application was on its own physical computer.<ul><li>find some physical space, power, cooling, network connectivity for it<li>and then install an operating system, any software dependencies, and then finally the application itself</ul><li>If need more processing power, redundancy, security, or scalability<ul><li>simply add more computers.<li>It was very common for each computer to have a single-purpose.<ul><li>Example: a database, web server, or content delivery.</ul></ul><li>Applications were built for a specific operating system even for specific hardware</ul><hr /><h2 id="virtualization-1">Virtualization</h2><blockquote><p>Virtualization helped by making it possible to run multiple virtual servers and operating systems on the same physical computer.</p></blockquote><p><img data-proofer-ignore data-src="https://i.imgur.com/26faY8t.png" alt="Screen Shot 2021-02-11 at 17.47.31" /></p><p>virtualization</p><ul><li>takes less time to deploy new solutions<li>waste less of the resources on those physical computers<li>get some improved portability because virtual machines can be imaged and then moved around.</ul><p>However</p><ol><li>the application, all of its dependencies and operating system are still bundled together and it’s not very easy to move from a VM from one hypervisor product to another.<li>Every time you start up a VM, it’s operating system still takes time to boot up.<li>Running multiple applications within a single VM creates tricky problem,<ol><li>applications that share dependencies are not isolated from each other<li>the resource requirements from one application, can starve out other applications of the resources that they need.<li>a dependency upgrade for one application might cause another to simply stop working.</ol></ol><p>solve this problem with:</p><ol><li>rigorous software engineering policies.<ul><li>lock down the dependencies that no application is allowed to make changes,<li>but this leads to new problems because dependencies do need to be upgraded occasionally.</ul><li>add integration tests to ensure that applications work.<ul><li>Integration tests are great, but dependency problems can cause new failure modes that are harder to troubleshoot, and it really slows down development if you have to rely on integration tests to simply just perform basic integrity checks of your application environment.</ul></ol><p><img data-proofer-ignore data-src="https://i.imgur.com/KVMQ1Yk.png" alt="Screen Shot 2021-02-11 at 17.49.44" /></p><ol><li>Now, the VM-centric way to solve this problem is to run a dedicated virtual machine for each application.<ul><li>Each application maintains its own dependencies, and the kernel is isolated.<li>So one application won’t affect the performance of another.<li>One you can get as you can see here, is two complete copies of the kernel that are running.<li>issues<ul><li>Scale this approach to hundreds of thousands of applications, and you can quickly see the limitation.<li>trying to do a simple kernel update. So for large systems, dedicated VMs are redundant and wasteful.<li>VMs are also relatively slow to start up because the entire operating system has to boot.</ul></ul></ol><blockquote><p>containers</p><p>A more efficient way to resolve the dependency problem</p><p>Implement abstraction at the level of the application and its dependencies.</p><p>Don’t have to virtualize the entire machine or even the entire operating system, but just the user space.</p><p>the user space is all the code that resides above the kernel, and includes the applications and their dependencies.</p></blockquote><p><img data-proofer-ignore data-src="https://i.imgur.com/Edp2Re5.png" alt="Screen Shot 2021-02-11 at 17.49.28" /></p><hr /><h2 id="virtualization-component">Virtualization component</h2><ul><li><strong>Hypervisor</strong>:<ul><li>The software that creates, runs, and manages the VMs.<li>the software layer that breaks the dependencies of an operating system with its underlying hardware, and allow several virtual machines to share that same hardware<li>Several virtualization technologies:<ul><li>VMware,<li>Microsoft Hyper-V products,<li>and Oracle VM VirtualBox.<li>KVM</ul><li>These applications have their own hypervisor software.</ul><li><strong>Host</strong>:<ul><li>The physical system hosting the VMs.<li>It requires more resources than a typical system, such as multiple processors, massive amounts of RAM, fast and abundant hard drive space, and one or more fast network cards.<li>additional resources increase the cost of the host<li>still less expensive than paying for multiple physical systems, less electricity, less cooling, less physical space.</ul><li><strong>Guest</strong>:<ul><li>Operating systems running on the host system are guests or guest machines.<li>Most hypervisors support several different operating systems, including various Microsoft operating systems and various Linux distributions.<li>Additionally, most hypervisors support both 32- bit and 64-bit operating systems.</ul></ul><p>Host <strong>Elasticity and Scalability</strong>.</p><ul><li><code class="language-plaintext highlighter-rouge">the ability to resize computing capacity based on the load</code>.<ul><li>Example<li>VM has increased traffic. You can increase the amount of processing power and memory used by this server relatively easily.<li>it’s relatively easy to decrease the resources when the load decreases.</ul><li>Virtualization typically provides the best return on investment (ROI) when an organization has many underutilized servers.<ul><li>Example<li>organization has nine servers with each using only about 20 percent processing power, memory, and disk space.<li>You could convert three physical servers to virtual hosts and run three guest servers on each physical server.<li>Assuming all the servers are similar, this wouldn’t cost any more money for the physical servers.<li>Additionally, three physical servers consume less electricity and require less heating and ventilation to maintain.</ul></ul><p>In contrast, imagine the organization has nine servers with each using about 80 percent of their processing power, memory, and disk space.</p><ul><li>Although it is possible to convert them all to virtual servers, it requires the purchase of additional hardware.<li>The savings from less electricity and less heating and ventilation is offset by the cost of the new servers.</ul><hr /><h2 id="comparing-hypervisors">Comparing Hypervisors</h2><p>Hypervisor virtualization is divided into primarily two different types:</p><ul><li><strong>Type I hypervisors</strong><ul><li>run directly on the system hardware.<li>often called <code class="language-plaintext highlighter-rouge">bare-metal hypervisors</code>, because they don’t need to run within an operating system.<li>Example<li>VMware has <code class="language-plaintext highlighter-rouge">ESX/ESXi</code> products that are Type I hypervisors.</ul><li><strong>Type II hypervisors</strong><ul><li>run as software within a host operating system.<li>Example<li>Microsoft <code class="language-plaintext highlighter-rouge">Hyper-V hypervisor</code> runs within a Microsoft operating system.<li>each guest has a full operating system, including its own kernel.<li>kernel is just the central part or most important part of something.<li>When referring to a computer, the kernel is the central part of the operating system.</ul></ul><p><img data-proofer-ignore data-src="https://i.imgur.com/aRoAODK.png" alt="Image21" /></p><blockquote><ul><li>When implementing virtualization on a PC, use Type II hypervisor-based virtualization.<li>But virtualization in large-scale data centers, uses Type I virtualization.</ul></blockquote><hr /><h2 id="type-of-virtualization">Type of Virtualization</h2><ul><li>Full virtualization<li>Paravirtualization</ul><h3 id="full-virtualization-scenario">full virtualization scenario</h3><ul><li><code class="language-plaintext highlighter-rouge">HVM, hardware virtual machine</code><li>the hypervisor <code class="language-plaintext highlighter-rouge">creates emulated virtual devices</code>. <ul><li>Including a virtual motherboard, virtual processor, virtual RAM, and virtual versions of all of the hardware, a system needs to operate. <li>For example<li>a virtual network adaptor. <li>So, the virtual system, gets a device, that looks like a real network adaptor. <li>But in reality, is simulated, or more precisely, emulated by the hypervisor. <li>The guest operating sends and receives data through this virtual adaptor. <li>And then, the emulator translates those requests, to the real hardware. </ul><li>Emulation software can provide almost any kind of device to a virtual machine. <ul><li>Even memory and a processor. <li>Though, emulating the activity of processors, can be pretty slow. <li>To speed up virtual machine,<li>the processor manufacturers, add a set of instructors to their chips, that allow a hypervisor to pass processor instructions directly from a VM to a real processor. <li>Rather than emulating the processor, while keeping those instructors and their results, separate from other instructors from the host machine and from other guest operating systems. </ul><li>can install any operating system, <code class="language-plaintext highlighter-rouge">OS doesn't need to be modified</code> to run correctly. </ul><p>On Linux systems:</p><ul><li>to emulate hardware, use QEMU, Quick emulator. <li>the software that lets instructors pass through, to supported processor, is KVM, Kernel-based virtual machine. <li>Together, these packages handle the details of presenting a virtual environment for an operating system to use.</ul><p><strong>QEMU, Quick emulator</strong></p><ul><li><code class="language-plaintext highlighter-rouge">QEMU</code> can be used by itself to emulate a whole system. <li>if <code class="language-plaintext highlighter-rouge">KVM</code> is available, and the processor of the host machine supports these commands for hardware virtualization, <ul><li>QMEU will use KVM for direct access, instead of emulating a processor and memory. <li>KVM used to be a separate package, but now it’s part of QEMU. </ul></ul><h3 id="paravirtualization">paravirtualization. </h3><ul><li>in a paravirtualization machine, <li>the guest os must be modified to know, that it’s running as a virtual machine. <ul><li>These modifications were added to the Linux kernel a while ago. <ul><li>So, Linux can run either, under a hardware virtualized system, or a paravirtualized system. </ul><li>But many other os, like Windows, can not. <li>These modifications <code class="language-plaintext highlighter-rouge">allow a guest to communicate directly to some hardware resources on the host machine</code>. <ul><li>Like, storage and network hardware. </ul><li>This gives a performance boost, <li>as the hypervisor doesn’t have to take input from an emulated adapter and then translate it physical hardware. </ul><li>But, in a paravirtualized machine, the <strong>memory</strong> and <strong>processor</strong>, are still emulated. <ul><li><code class="language-plaintext highlighter-rouge">QEMU and KVM</code>, provide a hardware machine environment, for guest operating systems, <li>with <code class="language-plaintext highlighter-rouge">some paravirtualized hardware</code>, to improve speed. </ul><li>to use full paravirtualization for a guest, need to use the <code class="language-plaintext highlighter-rouge">xen hypervisor</code>. <ul><li>The Linux kernel has support both hypervisors, and both are widely used in industry. <li>hypervisors such as <code class="language-plaintext highlighter-rouge">Xen</code>, <code class="language-plaintext highlighter-rouge">Proxmox</code> and <code class="language-plaintext highlighter-rouge">ESX</code>, <ul><li>run as the bare metal, or the native operating system on a host. </ul><li><code class="language-plaintext highlighter-rouge">KVM</code><ul><li>runs inside of a Linux installation, as a module within the kernel, <li>leaving an operating system that can be used for other things.</ul><li>In addition to acting as a hypervisor for guest operating systems. </ul><li>to manage virtual machines<ul><li>can use <code class="language-plaintext highlighter-rouge">QEMU</code> directly, <li>or use software that interfaces with a hypervisor, to make creation and manage a more visual experience.<ul><li>Such as <code class="language-plaintext highlighter-rouge">libvirt</code> package<li>software like <code class="language-plaintext highlighter-rouge">Virtual Machine Manager</code>. <ul><li>graphical tool, also part of the libvert ecosystem. </ul></ul></ul><li><p>Virtual machines give the ability, to scale the processing power, memory, storage, and other aspects of a guest, in order to respond to changes in business needs, or to provision identical nodes, in order to scale up, or out, as your app demands. </p><li>Many of the features of cloud services are based on this flexibility, though many of the cloud providers have their own tools and systems, to manage, monitor and track resource usage efficiently. </ul><p>when we create virtual machines, few options:</p><ul><li>Do we use a dedicated hypervisor, like Xen or Proxmox, or ESX? <li>Do we use containers, either natively, or with software like Docker? <li>Do we take advantage of KVM on a Linux installation? <li><p>It depends on what you need to do</p><li>when we create virtual machines on a Linux system, we have a few ways to do so. We can create a VM directly with command line, or we can use some management tools that help make the process easier. We’ll take a look at those, throughout the rest of the course.</ul><hr /><h2 id="qemu">QEMU</h2><ul><li>type 2 (i.e runs upon a host OS) hypervisor<li>performing <code class="language-plaintext highlighter-rouge">hardware virtualization</code> such as disk, network, VGA, PCI, USB, serial/parallel ports, etc.<li>It is flexible in that it can emulate CPUs via dynamic binary translation (DBT) allowing code written for a given processor to be executed on another (i.e ARM on x86, or PPC on ARM).<li>Though QEMU can run on its own and emulate all of the virtual machine’s resources, as all the emulation is performed in software it is extremely slow.<li>QEMU（quick emulator)本身并不包含或依赖KVM模块，而是一套由Fabrice Bellard编写的模拟计算机的自由软件。<li>QEMU虚拟机是一个纯软件的实现，可以在没有KVM模块的情况下独立运行，但是性能比较低。<li>QEMU有整套的虚拟机实现，包括处理器虚拟化、内存虚拟化以及I/O设备的虚拟化。<li>QEMU是一个用户空间的进程，需要通过特定的接口才能调用到KVM模块提供的功能。<li>从QEMU角度来看，虚拟机运行期间，QEMU通过KVM模块提供的系统调用接口进行内核设置，由KVM模块负责将虚拟机置于处理器的特殊模式运行。<li>QEMU使用了KVM模块的虚拟化功能，为自己的虚拟机提供硬件虚拟化加速以提高虚拟机的性能。</ul><h2 id="kvm-kernel-based-virtual-machine">KVM <code class="language-plaintext highlighter-rouge">Kernel-based Virtual Machine</code></h2><ul><li>a Linux kernel module.<li>内核驱动模块, 能够让Linux主机成为一个Hypervisor（虚拟机监控器）。<li>type 1 hypervisor, a <code class="language-plaintext highlighter-rouge">full virtualization solution for Linux on x86 hardware</code> containing virtualization extensions (Intel VT or AMD-V)<li>full virtualization<ul><li>When a CPU is emulated (vCPU) by the hypervisor,<li>the hypervisor has to translate the instructions meant for the vCPU to the physical CPU.<li>massive performance impact.<li>To overcome this,<li><code class="language-plaintext highlighter-rouge">modern processors</code> support <strong>virtualization extensions</strong>, such as <code class="language-plaintext highlighter-rouge">Intel VT-x and AMD-V</code>.<li>provide the ability for a slice of the physical CPU to be directly mapped to the vCPU.<li>so the instructions for the vCPU can be directly executed on the physical CPU slice.</ul><li><p>在支持VMX（Virtual Machine Extension）功能的x86处理器中，Linux在原有的用户模式和内核模式中新增加了客户模式，并且客户模式也拥有自己的内核模式和用户模式，虚拟机就是运行在客户模式中。KVM模块的职责就是打开并初始化VMX功能，提供相应的接口以支持虚拟机的运行。</p><li>KVM只模拟CPU和内存，因此一个客户机操作系统可以在宿主机上跑起来，但是你看不到它，无法和它沟通。<ul><li>KVM只是内核模块，用户并没法直接跟内核模块交互，需要借助用户空间的管理工具QEMU。<li>于是，有人修改了QEMU代码，把他模拟CPU、内存的代码换成KVM，而网卡、显示器等留着，因此QEMU+KVM就成了一个完整的虚拟化平台。</ul></ul><p><img data-proofer-ignore data-src="https://i.imgur.com/DQxrAq8.png" alt="image1" /></p><hr /><h2 id="qemu-and-kvm">QEMU and KVM</h2><ul><li>QEMU can run independently, but due to the emulation being performed entirely in software it is extremely slow.<li>To overcome this, QEMU allows to use KVM as an accelerator so that the <code class="language-plaintext highlighter-rouge">physical CPU virtualization extensions</code> can be used.<li>KVM和QEMU相辅相成，<ul><li>QEMU是个计算机模拟器，而KVM为计算机的模拟提供加速功能。<li>QEMU通过KVM达到了硬件虚拟化的速度，<li>而KVM则通过QEMU来模拟设备。<li>对于KVM来说，其匹配的用户空间工具并不仅仅只有QEMU，还有其他的，比如RedHat开发的l<code class="language-plaintext highlighter-rouge">ibvirt、virsh、virt-manager</code>等，QEMU并不是KVM的唯一选择。</ul></ul><p><strong>conclude</strong>:</p><ul><li>QEMU is a type 2 hypervisor that runs within <code class="language-plaintext highlighter-rouge">user space</code> and performs <code class="language-plaintext highlighter-rouge">virtual hardware emulation</code><li>KVM is a type 1 hypervisor that runs in <code class="language-plaintext highlighter-rouge">kernel space</code>, that allows a user space program access to the <code class="language-plaintext highlighter-rouge">hardware virtualization</code> features of various processors.</ul><hr /><h2 id="qemu-example">QEMU example</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c"># install</span>
<span class="nv">$ </span>apt installl qemu qemu-kvm
<span class="c"># /usr/bin/qeme...</span>

<span class="nv">$ </span>man qemu-system


<span class="c"># create a disc for vm</span>
<span class="c"># generate a disc image file</span>
<span class="c"># Raw: 60G even not use, thick provisiones</span>
<span class="c"># QEMU copy on write (QCOW2): write and use</span>
<span class="nv">$ </span>qemu-img create <span class="nt">-f</span> qcow2 my-image.qcow2 60G
<span class="nv">$ </span>qemu-img create <span class="nt">-f</span> raw my-image.qcow2 60G


<span class="c"># install os, nedd iso</span>
<span class="nv">$ </span>qemu-system-x86_64 <span class="nt">-cdom</span> path/toISO my-image.qcow2 <span class="nt">-m</span> 2G <span class="nt">-enable-kvm</span>

<span class="c"># start</span>
<span class="nv">$ </span>qemu-system-x86_64 my-image.qcow2 <span class="nt">-m</span> 2G <span class="nt">-enable-kvm</span>
<span class="nv">$ </span>qemu-system-x86_64 my-image.qcow2 <span class="nt">-m</span> 4G <span class="nt">-net</span> none <span class="nt">-vga</span> qxl <span class="nt">-enable-kvm</span>


<span class="c"># tools</span>
apt <span class="nb">install </span>hardinfo
<span class="c"># processor: QEMU processor</span>

<span class="c"># check memory</span>
free <span class="nt">-h</span>

<span class="c"># check disc</span>
<span class="nb">df</span> <span class="nt">-h</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/elhp5Kt.png" alt="Screen Shot 2020-11-28 at 22.10.50" /></p><hr /><h2 id="libvirt-example">Libvirt example</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c"># install</span>
<span class="nv">$ </span>apt <span class="nb">install </span>virt-manager

<span class="c"># create and install vm</span>
<span class="nv">$ </span>virt-install
<span class="nv">$ </span>virt-install <span class="nt">--name</span> my-ubunry
               <span class="nt">--memory</span> 2014
               <span class="nt">--disk</span> <span class="nv">size</span><span class="o">=</span>60, <span class="nv">format</span><span class="o">=</span>QCOW2,
                               <span class="nv">path</span><span class="o">=</span>/var/lib/libvirt/images/my-ubuntu.qcow2 <span class="c"># default</span>
               <span class="nt">--cdrom</span> ~/Downloads/ubuntu.iso
<span class="nv">$ </span>virt-install <span class="nt">--name</span> my-ubunry
               <span class="nt">--memory</span> 2014
               <span class="nt">--disk</span> <span class="nv">size</span><span class="o">=</span>60, <span class="nv">format</span><span class="o">=</span>QCOW2,
                               <span class="nv">path</span><span class="o">=</span>/var/lib/libvirt/images/my-ubuntu.qcow2 <span class="c"># default</span>
               <span class="nt">--cdrom</span> ~/Downloads/ubuntu.iso
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/VloX38m.png" alt="Screen Shot 2020-11-28 at 22.27.13" /></p><p><img data-proofer-ignore data-src="https://i.imgur.com/DZAbrU7.png" alt="Screen Shot 2020-11-25 at 10.53.38" /></p><hr /><h2 id="virsh-example">virsh example</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>
<span class="nv">$ </span>virsh <span class="nt">--help</span>


<span class="nv">$ </span>virsh
virsh <span class="nv">$ </span><span class="nb">suspend </span>my-ubuntu
virsh <span class="nv">$ </span>resume my-ubuntu
virsh <span class="nv">$ </span>shutdown my-ubuntu
virsh <span class="nv">$ </span>list <span class="nt">-all</span>
virsh <span class="nv">$ </span>start my-ubuntu
virsh <span class="nv">$ </span>quit

<span class="nv">$ </span>virt-viewer my-ubuntu

<span class="nv">$ </span>virsh domdisplay my-ubuntu
spice 4.4.4.4:8080

</pre></table></code></div></div><p><img data-proofer-ignore data-src="" alt="Uploading Screen Shot 2020-11-28 at 22.39.31.png… (ycc6m1otf)" /></p><hr /><h2 id="virsh-example-1">virsh example</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>virt-manager

<span class="c"># graphy install of vm</span>
</pre></table></code></div></div><hr /><h2 id="change-vm-configure">change vm configure</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>
<span class="c"># change vm memory</span>
<span class="nv">$ </span>virsh dominfo my-ubuntu
<span class="c"># temperaly</span>
<span class="nv">$ </span>virsh setmem my-ubuntu 2048M
<span class="c"># change configure</span>
<span class="nv">$ </span>virsh setmem my-ubuntu 1G <span class="nt">-config</span>
<span class="nv">$ </span>virsh setmaxmem my-ubuntu 4G
<span class="nv">$ </span>virsh start my-ubuntu


<span class="c"># change vm storage</span>
<span class="nv">$ </span><span class="nb">cd</span> /dev
<span class="nv">$ </span><span class="nb">sudo </span>fdish /dev/sda
p <span class="c"># check info</span>
n <span class="c"># create new partition</span>
    p
    1
    w

<span class="nv">$ </span><span class="nb">sudo </span>mkfs.ext4 /dev/sda1

<span class="nv">$ </span><span class="nb">sudo  </span>mount /dev/sda1 /path/to/mount


<span class="c">#  attach disk</span>
<span class="nv">$ </span><span class="nb">sudo </span>qemu-img create <span class="nt">-f</span> qcow2 /var/lib/libvirt/images/disk2.qcow2 40G
<span class="nv">$ </span>virsh attach-disk my-ubuntu <span class="nt">--source</span> /var/lib/libvirt/images/disk2.qcow2 <span class="nt">--drive</span> qemu <span class="nt">--subdriver</span> qcow2 <span class="nt">--target</span> vdb <span class="nt">--persistent</span>


<span class="c"># check all disk</span>
<span class="nv">$ </span><span class="nb">sudo </span>fdisk <span class="nt">-l</span>


<span class="c">#  deattach</span>
<span class="nv">$ </span>virsh detach-disk my-ubuntu <span class="nt">--source</span> /var/lib/libvirt/images/disk2.qcow2

</pre></table></code></div></div><hr /><h2 id="snapshot-and-clone">snapshot and clone</h2><h2 id="autostart">autostart</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>virsh autostart my-ubuntu
<span class="nv">$ </span>virsh autostart my-ubuntu <span class="nt">--disable</span>

</pre></table></code></div></div><hr /><h2 id="vm-migration">vm migration</h2><p><img data-proofer-ignore data-src="https://i.imgur.com/ZfKoiM7.png" alt="Screen Shot 2020-11-28 at 22.39.31" /></p><hr /><h2 id="container">container</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">$ </span>apt <span class="nb">install </span>lxc1
<span class="nv">$ </span><span class="nb">ls</span> /usr/share/lxc/templates/

<span class="c"># install container</span>
<span class="nv">$ </span><span class="nb">sudo </span>lxc-create <span class="nt">-n</span> container1 <span class="nt">-t</span> unbuntu

<span class="c"># start container</span>
<span class="nv">$ </span><span class="nb">sudo </span>lxc-start <span class="nt">-n</span> container1
<span class="nv">$ </span><span class="nb">sudo </span>lxc-concole <span class="nt">-n</span> container1
<span class="nv">$ </span><span class="nb">df</span> <span class="nt">-h</span>
<span class="nv">$ </span>top
<span class="nv">$ </span><span class="nb">sudo </span>lxc-stop <span class="nt">-n</span> container1
<span class="nv">$ </span><span class="nb">sudo </span>lxc-destroy <span class="nt">-n</span> container1
controla+q


<span class="nv">$ </span><span class="nb">sudo </span>lxc-attach <span class="nt">-n</span> container1
<span class="nv">$ </span><span class="nb">sudo </span>lxc-info <span class="nt">-n</span> container1

<span class="nv">$ </span><span class="nb">sudo </span>lxc-ls
</pre></table></code></div></div><p>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/00basic/'>00Basic</a>, <a href='/categories/vmandcontainer/'>VMandContainer</a>, <a href='/categories/vms/'>VMs</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/vms/" class="post-tag no-text-decoration" >VMs</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Virtualization - Grace&url=https://ocholuo.github.io//posts/Virtualization/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Virtualization - Grace&u=https://ocholuo.github.io//posts/Virtualization/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Virtualization - Grace&url=https://ocholuo.github.io//posts/Virtualization/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Container/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtualization - Container</h3><div class="text-muted small"><p> Virtualization - Container basic traditional virtualization containers virtualmachine (VM)-based vs container-based deployment. ...</p></div></div></a></div><div class="card"> <a href="/posts/Docker-dev/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtulization - DockerFile Develop</h3><div class="text-muted small"><p> DockerFile Develop Best practices for writing Dockerfiles General guidelines and recommendations Create ephemeral containers Understand build contex...</p></div></div></a></div><div class="card"> <a href="/posts/Docker-security/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtulization - Docker security</h3><div class="text-muted small"><p> [toc] Docker security basic 评估 Docker 的安全性时，主要考虑三个方面: 由内核的命名空间和控制组机制提供的 容器内在安全 Docker 程序（特别是服务端）本身的抗攻击性 内核安全性的加强机制 对 容器安全性的影响 namespace Docker 容器和 LXC 容器很相似，所提供的安全特性也差不多。 当用 do...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Kubernetes/" class="btn btn-outline-primary" prompt="Older"><p>Virtulization - Google Kubernetes</p></a> <a href="/posts/kali-in-docker/" class="btn btn-outline-primary" prompt="Newer"><p>Virtulization - Running Kali on Docker</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
