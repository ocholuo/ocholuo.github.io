<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="AWS - Management - SSM - Session Manager" /><meta property="og:locale" content="en" /><meta name="description" content="Session Manager session Session document schema 赋予System Manager 对实例可执行操作的权限： 0. setup 1. 修改 instance profile 和加裝 ssm agent Embed permissions for Session Manager actions in a custom instance profile Create a custom IAM instance profile for Session Manager 2. 確認 instance 上面都有安裝好 SSM agent 3: Control user session access to instances Enforce a session document permission check for the AWS CLI 4. 設定 user 的 iam policy end user policies for Session Manager administrator policy for Session Manager Allow full (administrative) access to all sessions 5. user IAM group 6. 設定完以上的基本設定後，登入機器 more session preferencse: 修改 ssm-user sudo 权限 配置ec2 的安全组： 记录会话数据 使用 scp 設定 進階設定 Port forwarding Monitoring Logging AWS Systems Manager API calls with AWS CloudTrail. Reference" /><meta property="og:description" content="Session Manager session Session document schema 赋予System Manager 对实例可执行操作的权限： 0. setup 1. 修改 instance profile 和加裝 ssm agent Embed permissions for Session Manager actions in a custom instance profile Create a custom IAM instance profile for Session Manager 2. 確認 instance 上面都有安裝好 SSM agent 3: Control user session access to instances Enforce a session document permission check for the AWS CLI 4. 設定 user 的 iam policy end user policies for Session Manager administrator policy for Session Manager Allow full (administrative) access to all sessions 5. user IAM group 6. 設定完以上的基本設定後，登入機器 more session preferencse: 修改 ssm-user sudo 权限 配置ec2 的安全组： 记录会话数据 使用 scp 設定 進階設定 Port forwarding Monitoring Logging AWS Systems Manager API calls with AWS CloudTrail. Reference" /><link rel="canonical" href="https://ocholuo.github.io//posts/SSM-SessionManager/" /><meta property="og:url" content="https://ocholuo.github.io//posts/SSM-SessionManager/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-18T11:11:11-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS - Management - SSM - Session Manager" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2020-07-18T11:11:11-04:00","description":"Session Manager session Session document schema 赋予System Manager 对实例可执行操作的权限： 0. setup 1. 修改 instance profile 和加裝 ssm agent Embed permissions for Session Manager actions in a custom instance profile Create a custom IAM instance profile for Session Manager 2. 確認 instance 上面都有安裝好 SSM agent 3: Control user session access to instances Enforce a session document permission check for the AWS CLI 4. 設定 user 的 iam policy end user policies for Session Manager administrator policy for Session Manager Allow full (administrative) access to all sessions 5. user IAM group 6. 設定完以上的基本設定後，登入機器 more session preferencse: 修改 ssm-user sudo 权限 配置ec2 的安全组： 记录会话数据 使用 scp 設定 進階設定 Port forwarding Monitoring Logging AWS Systems Manager API calls with AWS CloudTrail. Reference","headline":"AWS - Management - SSM - Session Manager","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/SSM-SessionManager/"},"url":"https://ocholuo.github.io//posts/SSM-SessionManager/"}</script><title>AWS - Management - SSM - Session Manager | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AWS - Management - SSM - Session Manager</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AWS - Management - SSM - Session Manager</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 18, 2020, 11:11 AM -0400" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6082 words">33 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#session-manager">Session Manager</a><ul><li><a href="#session">session</a><li><a href="#session-document-schema">Session document schema</a><li><a href="#赋予system-manager-对实例可执行操作的权限">赋予System Manager 对实例可执行操作的权限：</a><ul><li><a href="#0-setup">0. setup</a><li><a href="#1-修改-instance-profile-和加裝-ssm-agent">1. 修改 instance profile 和加裝 ssm agent</a><ul><li><a href="#embed-permissions-for-session-manager-actions-in-a-custom-instance-profile">Embed permissions for Session Manager actions in a custom instance profile</a><li><a href="#create-a-custom-iam-instance-profile-for-session-manager">Create a custom IAM instance profile for Session Manager</a></ul><li><a href="#2-確認-instance-上面都有安裝好-ssm-agent">2. 確認 instance 上面都有安裝好 SSM agent</a><li><a href="#3-control-user-session-access-to-instances">3: Control user session access to instances</a><ul><li><a href="#enforce-a-session-document-permission-check-for-the-aws-cli">Enforce a session document permission check for the AWS CLI</a></ul><li><a href="#4-設定-user-的-iam-policy">4. 設定 user 的 iam policy</a><ul><li><a href="#end-user-policies-for-session-manager">end user policies for Session Manager</a><li><a href="#administrator-policy-for-session-manager">administrator policy for Session Manager</a><li><a href="#allow-full-administrative-access-to-all-sessions">Allow full (administrative) access to all sessions</a></ul><li><a href="#5-user-iam-group">5. user IAM group</a><li><a href="#6-設定完以上的基本設定後登入機器">6. 設定完以上的基本設定後，登入機器</a><li><a href="#more-session-preferencse">more session preferencse:</a><li><a href="#修改-ssm-user-sudo-权限">修改 ssm-user sudo 权限</a><li><a href="#配置ec2-的安全组">配置ec2 的安全组：</a><li><a href="#记录会话数据">记录会话数据</a></ul><li><a href="#使用-scp">使用 scp</a><ul><li><a href="#設定">設定</a><li><a href="#進階設定">進階設定</a></ul><li><a href="#port-forwarding">Port forwarding</a><li><a href="#monitoring">Monitoring</a><ul><li><a href="#logging-aws-systems-manager-api-calls-with-aws-cloudtrail">Logging AWS Systems Manager API calls with AWS CloudTrail.</a></ul><li><a href="#reference">Reference</a></ul><li>ref<ul><li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/setup-instance-profile.html">aws doc</a><li><a href="https://kkc.github.io/2020/04/11/aws-ssm-session-manager-note/">AWS SSM session manager 筆記 Posted by Kakashi on 2020-04-11</a><li><a href="https://blog.csdn.net/kozazyh/article/details/88957448">AWS-AWS Systems Manager Session (SSM 会话管理器)试用</a></ul></ul><hr /><h1 id="session-manager">Session Manager</h1><ul><li>使用 session manger 可以減少 key 的管理，減少資安漏洞<li>透過 proxycommand 可以讓我們建立 ssh tunnel，進而可以使用 scp 等等工具<li>port forwarding 可以幫助 developer 測試在 private subnet 的服務<li><p>搭配 aws cliv2 可以透過 SSO 增加系統安全</p><li>makes it easy to comply with corporate policies that require controlled access to instances, strict security practices, and fully auditable logs with instance access details, while still providing end users with simple one-click cross-platform access to the managed instances.<ul><li>automating common administrative tasks across groups of instances<li>such as registry edits, user management, and software and patch installations.<li>improve security and audit posture, reduce operational overhead by centralizing access control on instances, and reduce inbound instance access.<li>monitor and track instance access and activity, close down inbound ports on instances, or enable connections to instances that do not have a public IP address.<li>grant and revoke access from a single location, and who want to provide one solution to users for Linux, macOS, and Windows Server instances.<li>connect to an instance with just one click from the browser or AWS CLI without having to provide SSH keys.</ul><li>integration with AWS IAM<ul><li>can apply granular permissions to control the actions users can perform on instances.<li>Centralized access control to instances using IAM policies<li>single place to grant and revoke access to instances.<li>Using only AWS IAM policies, control which individual users or groups in organization can use Session Manager and which instances they can access.<li>You can also provide temporary access to instances.<li>Example<li>give an on-call user/group of user access to production servers only for the duration of their rotation.</ul><li>No open inbound ports and no need to manage bastion hosts or SSH keys<ul><li>provides safe, secure remote management of the instances at scale<li>without logging into the servers,<li>replacing the need for bastion hosts, SSH, or remote PowerShell.<li>Leaving inbound SSH ports and remote PowerShell ports open on the instances greatly increases the risk of entities running unauthorized or malicious commands on the instances.<li>without the need to open inbound ports, manage SSH keys and certificates, bastion hosts, and jump boxes.<li>manage EC2/on-premises instances, and VMs through an <code class="language-plaintext highlighter-rouge">interactive one-click browser-based shell</code> or through the <code class="language-plaintext highlighter-rouge">AWS CLI</code>.</ul><li>Port forwarding<ul><li>Redirect any port inside the remote instance to a local port on a client.<li>connect to the local port and access the server application that is running inside the instance.<li>Tunneling<li>In a session, use a Session-type SSM document to tunnel traffic, such as http or a custom protocol, between a local port on a client machine and a remote port on an instance.</ul><li>AWS PrivateLink support for instances without public IP addresses<ul><li>can set up VPC Endpoints for Systems Manager using AWS PrivateLink to further secure the sessions.<li>AWS PrivateLink limits all network traffic between managed instances, Systems Manager, and Amazon EC2 to the Amazon network.</ul><li>One-click access to instances from the console and CLI<ul><li>start a session with a single click.<li>Using the AWS CLI, can also start a session that runs a single command or a sequence of commands.<li>as permissions to instances are provided by IAM policies not SSH keys or other mechanisms, the connection time is greatly reduced.<li>Interactive commands<li>Create a Session-type SSM document that uses a session to interactively run a single command, giving you a way to manage what users can do on an instance.</ul><li>Cross-platform support for Windows, Linux, and macOS<ul><li>support for Windows, Linux, and macOS from a single tool.<li>establish secure connections to EC2/on-premises instances, and VMs.<li>support for on-premises servers is provided for the advanced-instances tier only.<li>Example<li>SSH client for Linux and macOS instances<li>RDP connection for Windows Server instances.</ul><li>Logging and auditing session activity<ul><li>All actions taken with Systems Manager are recorded by AWS CloudTrail<li>audit changes throughout the environment.<li>receive notifications when a user in the organization starts or ends session activity.<li>provides secure and auditable instance management<li>Note:<li> <font color="blue"> Logging is not available for Session Manager sessions that connect through port forwarding or SSH </font><li>because SSH encrypts all session data, and Session Manager only serves as a tunnel for SSH connections.<li>Logging and auditing capabilities are provided through integration with the following AWS services:<li>AWS CloudTrail<ul><li>captures information about Session Manager API calls made in the AWS account and writes it to log files that are stored in an S3 bucket you specify.<li>One bucket is used for all CloudTrail logs for the account.</ul><li>Amazon S3<ul><li>choose to store session log data in an S3 bucket of the choice for debugging and troubleshooting purposes.<li>Log data can be sent to the S3 bucket with or without encryption using the AWS Key Management Service (AWS KMS) key.</ul><li>Amazon CloudWatch Logs<ul><li>monitor, store, and access log files from various AWS services.<li>You can send session log data to a CloudWatch Logs log group for debugging and troubleshooting purposes.<li>Log data can be sent to the log group with or without AWS KMS encryption using the AWS KMS key. For more information, see Logging session data using Amazon CloudWatch Logs (console).</ul><li>Amazon EventBridge and Amazon Simple Notification Service<ul><li>EventBridge lets you set up rules to detect when changes happen to AWS resources that you specify. You can create a rule to detect when a user in the organization starts or stops a session, and then receive a notification through Amazon SNS (for example, a text or email message) about the event.<li>You can also configure a CloudWatch event to initiate other responses.</ul><li>Console, CLI, and SDK access to Session Manager capabilities<ul><li>The AWS Systems Manager console:<ul><li>includes access to all the Session Manager capabilities for both administrators and end users. You can perform any task that’s related to sessions by using the Systems Manager console.</ul><li>The Amazon EC2 console<ul><li>provides the ability for end users to connect to the EC2 instances for which they have been granted session permissions.</ul><li>The AWS CLI<ul><li>includes access to Session Manager capabilities for end users.<li>can start a session, view a list of sessions, and permanently end a session by using the AWS CLI.<li>To use the AWS CLI to run session commands, you must be using version 1.16.12 of the CLI (or later), and you must have installed the Session Manager plugin on local machine.<li>Configurable shell profiles<li>Session Manager provides you with options to configure preferences within sessions. These customizable profiles enable you to define preferences such as shell preferences, environment variables, working directories, and running multiple commands when a session is started.</ul><li>The Session Manager SDK<ul><li>consists of libraries and sample code that enables application developers to build front-end applications, such as custom shells or self-service portals for internal users that natively use Session Manager to connect to instances.<li>Developers and partners can integrate Session Manager into their client-side tooling or Automation workflows using the Session Manager APIs.<li>You can even build custom solutions.</ul></ul><li>Customer key data encryption support<ul><li>configure Session Manager to <font color="blue"> encrypt the session data logs send to S3 bucket or stream to a CloudWatch Logs log group </font><li>configure Session Manager to further encrypt the data transmitted between client machines and instances during sessions.</ul></ul></ul><hr /><h2 id="session">session</h2><p>A session is a connection made to an instance using Session Manager.</p><ul><li>Sessions are based on a secure bi-directional communication channel between the client (you) and the remote managed instance that streams inputs and outputs for commands.<li>Traffic between a client and a managed instance is encrypted using TLS 1.2, and requests to create the connection are signed using Sigv4.<li>This two-way communication enables interactive bash and PowerShell access to instances.<li>You can also use an AWS Key Management Service (AWS KMS) key to further encrypt data beyond the default TLS encryption.</ul><p>Example</p><ul><li>John is an on-call engineer in IT department.<li>He receives notification of an issue that requires him to remotely connect to an instance<ul><li>such as a failure that requires troubleshooting or a directive to change a simple configuration option on an instance.</ul><li>Using the AWS Systems Manager console, the EC2 console, or the AWS CLI, John starts a session connect to the instance<li>When John sends that first command to start the session<ul><li>the Session Manager service authenticates his ID,<li>verifies the permissions granted to him by an IAM policy,<li>checks configuration settings (such as verifying allowed limits for the sessions),<li>and sends a message to SSM Agent to open the two-way connection.</ul><li>After the connection is established<li>John types the next command, the command output from SSM Agent is uploaded to this communication channel and sent back to his local machine.</ul><hr /><h2 id="session-document-schema">Session document schema</h2><p>The schema elements of a Session document.</p><ul><li>Session Manager uses Session documents to determine which type of session to start<li>such as a standard session, a port forwarding session, or a session to run an interactive command.</ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre><span class="na">schemaVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Document to hold regional settings for Session Manager</span>
<span class="c1"># Valid values: InteractiveCommands | Port | Standard_Stream</span>

<span class="na">sessionType</span><span class="pi">:</span> <span class="s">Standard_Stream</span>
<span class="c1"># The session preferences to use for sessions established using this Session document.</span>
<span class="c1"># This element is required for Session documents that are used to create Standard_Stream sessions.</span>
<span class="na">inputs</span><span class="pi">:</span>
  <span class="c1"># S3 bucket to send session logs at the end of the sessions.</span>
  <span class="na">s3BucketName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="c1"># The prefix to use when sending logs to the S3 bucket you specified in the s3BucketName input.</span>
  <span class="na">s3KeyPrefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">s3EncryptionEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="c1"># The name of the Amazon CloudWatch Logs (CloudWatch Logs) group to send session logs at the end of the sessions.</span>
  <span class="na">cloudWatchLogGroupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="c1"># the log group you specified in the cloudWatchLogGroupName input must be encrypted.</span>
  <span class="na">cloudWatchEncryptionEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="c1"># If set to true, a continuous stream of session data logs are sent to the cloudWatch log group</span>
  <span class="c1"># If set to false, session logs are sent to the log group at the end of the sessions.</span>
  <span class="na">cloudWatchStreamingEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="c1"># The ID of the AWS KMS to use to further encrypt data between the local client machines and the EC2 instances be connected to.</span>
  <span class="na">kmsKeyId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="c1"># The Run As feature is only supported for Linux instances.</span>
  <span class="c1"># If set to true, must specify a user account exists on the instances you connecting to (if not, sessions will fail to start)</span>
  <span class="c1"># By default, sessions are started using the ssm-user account created by the SSM Agent.</span>
  <span class="na">runAsEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">runAsDefaultUser</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="c1"># The amount of time of inactivity allowed before a session ends. (minutes)</span>
  <span class="na">idleSessionTimeout</span><span class="pi">:</span> <span class="s1">'</span><span class="s">20'</span>
  <span class="c1"># The preferences you specify per operating system to apply within sessions</span>
  <span class="c1"># such as shell preferences, environment variables, working directories, and running multiple commands when a session is started.</span>
  <span class="na">shellProfile</span><span class="pi">:</span>
    <span class="c1"># The shell preferences, environment variables, working directories, and commands you specify for sessions on Windows instances.</span>
    <span class="na">windows</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">linux</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>

<span class="na">schemaVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Document to view a log file on a Linux instance</span>
<span class="na">sessionType</span><span class="pi">:</span> <span class="s">InteractiveCommands</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">logpath</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">The log file path to read.</span>
    <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/amazon/ssm/amazon-ssm-agent.log"</span>
    <span class="na">allowedPattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">^[a-zA-Z0-9-_/]+(.log)$"</span>
<span class="na">properties</span><span class="pi">:</span>
  <span class="na">linux</span><span class="pi">:</span>
    <span class="na">commands</span><span class="pi">:</span> <span class="s2">"</span><span class="s">tail</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">"</span>
    <span class="na">runAsElevated</span><span class="pi">:</span> <span class="kc">true</span>


<span class="na">schemaVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Example document with quotation marks</span>
<span class="na">sessionType</span><span class="pi">:</span> <span class="s">InteractiveCommands</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">Test</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">Test Input</span>
    <span class="na">maxChars</span><span class="pi">:</span> <span class="m">32</span>
<span class="na">properties</span><span class="pi">:</span>
  <span class="na">windows</span><span class="pi">:</span>
    <span class="na">commands</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">$Test = ''</span>
        <span class="s">$myVariable = "Computer name is $env:COMPUTERNAME"</span>
        <span class="s">Write-Host "Test variable: $myVariable`.`nInput parameter: $Test"</span>
    <span class="na">runAsElevated</span><span class="pi">:</span> <span class="kc">false</span>


<span class="na">schemaVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Document to open given port connection over Session Manager</span>
<span class="na">sessionType</span><span class="pi">:</span> <span class="s">Port</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">paramExample</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">document parameter</span>
<span class="na">properties</span><span class="pi">:</span>
  <span class="na">portNumber</span><span class="pi">:</span> <span class="s">anyPortNumber</span>
</pre></table></code></div></div><hr /><h2 id="赋予system-manager-对实例可执行操作的权限">赋予System Manager 对实例可执行操作的权限：</h2><hr /><h3 id="0-setup">0. setup</h3><ol><li>创建一个EC2实例：ID:为：i-xxxxxxxxxx<li>创建一个角色：<ul><li>IAM &gt; 角色 &gt; 创建角色（role-test）<ol><li>选择 受信任实体的类型：AWS产品；<li>选择 将要使用此角色的服务：EC2 - &gt; Attach权限策略：选择 AmazonEC2RoleforSSM</ol></ul><li>把角色(role-test)附加到EC2(i-xxxxxxxxxx)中 ;</ol><p><img data-proofer-ignore data-src="https://i.imgur.com/qqx5AxQ.png" alt="20190402101438357" /></p><hr /><h3 id="1-修改-instance-profile-和加裝-ssm-agent">1. 修改 instance profile 和加裝 ssm agent</h3><p>An <font color="red"> instance profile </font></p><ul><li>a container that passes IAM role information to an EC2 instance at launch.<li>This requirement applies to permissions for all AWS Systems Manager capabilities, not only those specific to Session Manager.<li>can attach an IAM instance profile to an EC2 instance as launch it or to a previously launched instance.</ul><p>By default, AWS Systems Manager doesn’t have permission to perform actions on the instances.</p><ul><li>must grant access by using an AWS IAM instance profile.<li> <font color="blue"> AmazonSSMManagedInstanceCore </font><ul><li>enables an instance to use AWS Systems Manager service core functionality.<li>Depending on the operations plan, might need permissions</ul><li> <font color="blue"> custom policy for S3 bucket access </font><ul><li>Case 1:<ul><li>using a VPC endpoint to privately connect VPC to supported AWS services and VPC endpoint services powered by PrivateLink.<li>SSM Agent is Amazon software that is installed on the instances and performs Systems Manager tasks.<li>This agent requires access to specific Amazon-owned S3 buckets.<li>These buckets are publicly accessible.<li>In a private VPC endpoint environment, however, you must explicitly provide access to these buckets:<div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>arn:aws:s3:::patch-baseline-snapshot-region/*
arn:aws:s3:::aws-ssm-region/*
</pre></table></code></div></div></ul><li>Case 2:<ul><li>use an S3 bucket as part of the Systems Manager operations.<li>the EC2 instance profile for Systems Manager must grant access to an S3 bucket that you own for tasks like the following:<ul><li>To access scripts you store in the S3 bucket to use in commands you run.<li>To store the full output of Run Command commands or Session Manager sessions.<li>To access custom patch lists for use when patching the instances.</ul></ul></ul><li> <font color="blue"> AmazonSSMDirectoryServiceAccess </font><ul><li>Required only if you plan to join EC2 instance for Windows Server to a Microsoft AD directory.<li>This AWS managed policy allows SSM Agent to access AWS Directory Service on your behalf for requests to join the domain by the managed instance.</ul><li> <font color="blue"> CloudWatchAgentServerPolicy </font><ul><li>Required only if you plan to install and run the CloudWatch agent on the instances to read metric and log data on an instance and write it to Amazon CloudWatch.<li>These help you monitor, analyze, and quickly respond to issues or changes to your AWS resources.<li>Your instance profile needs this policy only if you will use features such as Amazon EventBridge or CloudWatch Logs.<li>(You can also create a more restrictive policy that, for example, limits writing access to a specific CloudWatch Logs log stream.)</ul></ul><p>use case</p><ul><li>If already use other Systems Manager capabilities, such as Run Command or Parameter Store, an instance profile with the required basic permissions for Session Manager might already be attached to the instances.<li>If an instance profile that contains the AWS managed policy <code class="language-plaintext highlighter-rouge">AmazonSSMManagedInstanceCore</code> is attached to the instances, the required permissions for Session Manager are already provided.<li>in some cases, might need to modify the permissions attached to the instance profile.<ul><li>example,<li>to provide a narrower set of instance permissions, you have created a custom policy for the instance profile,<li>or you want to use Amazon S3 encryption or AWS KMS encryption options for securing session data.</ul></ul><p>For these cases, do one of the following to allow Session Manager actions to be performed on the instances:</p><h4 id="embed-permissions-for-session-manager-actions-in-a-custom-instance-profile">Embed permissions for Session Manager actions in a custom instance profile</h4><ul><li>add permissions for Session Manager actions to an existing IAM instance profile that does not rely on the AWS-provided default policy <code class="language-plaintext highlighter-rouge">AmazonSSMManagedInstanceCore</code> for instance permissions.<li>assumes the existing profile already includes other Systems Manager ssm permissions for actions you want to allow access to. This policy alone is not enough to use Session Manager.<li>Roles (the role to embed a policy in) &gt; Permissions &gt; <font color="blue"> Add inline policy </font><li>Replace the default content with the following<li>Review policy page, for Name, enter a name for the inline policy, such as <code class="language-plaintext highlighter-rouge">SessionManagerPermissions</code>.<li>Choose Create policy.</ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateDataChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenDataChannel</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">s3:GetEncryptionConfiguration</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="c1"># kms:Decrypt permission enables customer key encryption and decryption for session data. If you will use AWS Key Management Service (AWS KMS) encryption for the session data, replace key-name with the Amazon Resource Name (ARN) of the customer master key (CMK) you want to use, in the format arn:aws:kms:us-west-2:111122223333:key/1234abcd-12ab-34cd-56ef-12345EXAMPLE.</span>
<span class="c1"># If you will not use AWS KMS encryption for the session data, you can remove the following content from the policy.</span>
<span class="c1"># - Effect: Allow</span>
<span class="c1">#   Action: kms:Decrypt</span>
<span class="c1">#   Resource: key-name</span>
</pre></table></code></div></div><h4 id="create-a-custom-iam-instance-profile-for-session-manager">Create a custom IAM instance profile for Session Manager</h4><ol><li>create a custom AWS IAM instance profile that provides permissions for only Session Manager actions on the instances.<li>can create a policy to provide the permissions needed for logs of session activity to be sent to Amazon S3 and CloudWatch Logs.<ul><li>IAM console &gt; Policies &gt; Create policy &gt; <code class="language-plaintext highlighter-rouge">SessionManagerPermissions</code></ul><li>Attach an IAM Role to an Instance and <font color="blue"> Attach or Replace an Instance Profile </font><ul><li>Roles &gt; Create role &gt; AWS service &gt; EC2 &gt; Permissions &gt; <code class="language-plaintext highlighter-rouge">SessionManagerPermissions</code><li>Role name (name for the IAM instance profile) &gt; <code class="language-plaintext highlighter-rouge">MySessionManagerInstanceProfile</code>.</ul></ol><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre><td class="rouge-code"><pre><span class="c1"># Create instance profile with minimal Session Manager permissions</span>
<span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:UpdateInstanceInformation</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateDataChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenDataChannel</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">s3:GetEncryptionConfiguration</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">kms:Decrypt</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">key-name</span> <span class="c1"># arn:aws:kms:us-west-2:111122223333:key/1234abcd-12ab-34cd-56ef-12345EXAMPLE.</span>


<span class="c1"># Create instance profile with permissions for Session Manager and S3 and CloudWatch Logs</span>
<span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:UpdateInstanceInformation</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:CreateDataChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenControlChannel</span>
  <span class="pi">-</span> <span class="s">ssmmessages:OpenDataChannel</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">logs:CreateLogStream</span>
  <span class="pi">-</span> <span class="s">logs:PutLogEvents</span>
  <span class="pi">-</span> <span class="s">logs:DescribeLogGroups</span>
  <span class="pi">-</span> <span class="s">logs:DescribeLogStreams</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">s3:PutObject</span>
  <span class="c1">#To output session logs to an S3 bucket owned by a different AWS account, you must add the IAM s3:PutObject Acl permission to this policy.</span>
  <span class="c1"># If this permission isn't added, the account that owns the S3 bucket cannot access the session output logs.</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">arn:aws:s3:::DOC-EXAMPLE-BUCKET/s3-bucket-prefix</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">s3:GetEncryptionConfiguration</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">kms:GenerateDataKey</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>


<span class="c1"># Create a custom policy for S3 bucket access</span>
<span class="c1"># required only if you are using a VPC endpoint or using an S3 bucket of your own in your Systems Manager operations.</span>
<span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="c1"># required only if you are using a VPC endpoint.</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">s3:GetObject</span>
  <span class="na">Resource</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::aws-ssm-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::aws-windows-downloads-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::amazon-ssm-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::amazon-ssm-packages-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::region-birdwatcher-prod/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::aws-ssm-distributor-file-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::aws-ssm-document-attachments-region/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::patch-baseline-snapshot-region/*</span>
<span class="c1"># required only if you are using an S3 bucket that you created to use in your Systems Manager operations.</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">s3:GetObject</span>
  <span class="pi">-</span> <span class="s">s3:PutObject</span>
  <span class="c1"># required only if you plan to support cross-account access to S3 buckets in other accounts.</span>
  <span class="pi">-</span> <span class="s">s3:PutObjectAcl</span>
  <span class="pi">-</span> <span class="s">s3:GetEncryptionConfiguration</span>
  <span class="c1"># required if your S3 bucket is configured to use encryption.</span>
  <span class="na">Resource</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::DOC-EXAMPLE-BUCKET/*</span>
  <span class="pi">-</span> <span class="s">arn:aws:s3:::DOC-EXAMPLE-BUCKET</span>
  <span class="c1"># If your S3 bucket is configured to use encryption, then the S3 bucket root (for example, arn:aws:s3:::DOC-EXAMPLE-BUCKET) must be listed in the Resource section.</span>
  <span class="c1"># Your IAM user, group, or role must be configured with access to the root bucket.</span>
</pre></table></code></div></div><hr /><h3 id="2-確認-instance-上面都有安裝好-ssm-agent">2. 確認 instance 上面都有安裝好 SSM agent</h3><p>AWS 上面新版的 ubuntu &amp; amazon linux2 都有先裝好了，不過舊的 AMI 就需要自己去安裝。</p><hr /><h3 id="3-control-user-session-access-to-instances">3: Control user session access to instances</h3><p>Session Manager allows <font color="red"> centrally grant and revoke user access to instances </font></p><ul><li>Using IAM policies, control which instances specific users or groups can connect to,<li>and you control what Session Manager API actions they can perform on the instances they are given access to.</ul><p><code class="language-plaintext highlighter-rouge">Session ID</code> ARN Formats</p><ul><li>IAM policies for Session Manager access use variables for user names as part of session IDs.<li>Session IDs in turn are used in session Amazon Resource Names (ARNs) to control access.<li>Session ARNs have the following format:</ul><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>arn:aws:ssm:region-id:account-id:session/session-id
arn:aws:ssm:us-east-2:123456789012:session/JohnDoe-1a2b3c4d5eEXAMPLE
</pre></table></code></div></div><ol><li>use a pair of default IAM policies supplied by AWS<ul><li>one for end users and one for administrators, to supply permissions for Session Manager activities.</ul><li>Or create custom IAM policies for different permissions requirements you might have.</ol><h4 id="enforce-a-session-document-permission-check-for-the-aws-cli">Enforce a session document permission check for the AWS CLI</h4><p>When configure Session Manager for your account, the system creates a Session-type SSM document <code class="language-plaintext highlighter-rouge">SSM-SessionManagerRunShell</code>.</p><ul><li>This SSM document stores your session preferences, such as<ul><li>whether session data is saved in an S3 bucket or Amazon CloudWatch Logs log group,<li>whether session data is encrypted using AWS Key Management Service,<li>whether Run As support is enabled for your sessions.</ul></ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="na">schemaVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Document to hold regional settings for Session Manager</span>
<span class="na">sessionType</span><span class="pi">:</span> <span class="s">Standard_Stream</span>
<span class="na">inputs</span><span class="pi">:</span>
  <span class="na">s3BucketName</span><span class="pi">:</span> <span class="s">DOC-EXAMPLE-BUCKET</span>
  <span class="na">s3KeyPrefix</span><span class="pi">:</span> <span class="s">MyBucketPrefix</span>
  <span class="na">s3EncryptionEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">cloudWatchLogGroupName</span><span class="pi">:</span> <span class="s">MyLogGroupName</span>
  <span class="na">cloudWatchEncryptionEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">kmsKeyId</span><span class="pi">:</span> <span class="s">MyKMSKeyID</span>
  <span class="na">runAsEnabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">runAsDefaultUser</span><span class="pi">:</span> <span class="s">MyDefaultRunAsUser</span>
</pre></table></code></div></div><p>By default, if a user in your account was granted permission in their IAM user policy to start sessions, that user has access to the <code class="language-plaintext highlighter-rouge">SSM-SessionManagerRunShell</code> SSM document.</p><ul><li>This means that when they use the AWS CLI to run the start-session command, and they do not specify a document in the –document-name option, the system uses SSM-SessionManagerRunShell and launches the session.<li>The session starts even if the user’s IAM policy doesn’t grant explicit permission to access the <code class="language-plaintext highlighter-rouge">SSM-SessionManagerRunShell</code> document.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c"># doesn’t specify a session document.</span>
aws ssm start-session <span class="se">\</span>
    <span class="nt">--target</span> i-02573cafcfEXAMPLE

<span class="c"># specifies the default Session Manager session document.</span>
aws ssm start-session <span class="se">\</span>
    <span class="nt">--document-name</span> SSM-SessionManagerRunShell <span class="se">\</span>
    <span class="nt">--target</span> i-02573cafcfEXAMPLE
</pre></table></code></div></div><p>To restrict access to the default or any session document</p><ul><li>add a condition element to the user’s IAM policy that validates whether the user has explicit access to a session document.<li>When this condition is applied, the user must specify a value for the <code class="language-plaintext highlighter-rouge">--document-name</code> option of the <code class="language-plaintext highlighter-rouge">start-session</code> AWS CLI command.<li>This value is either the default Session Manager session document or a custom session document you created.</ul><div class="language-json highlighter-rouge"><div class="code-header" text-data="json"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="err">//</span><span class="w"> </span><span class="err">performs</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">session</span><span class="w"> </span><span class="err">document</span><span class="w"> </span><span class="err">access</span><span class="w"> </span><span class="err">check.</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">With</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">condition</span><span class="w"> </span><span class="err">element</span><span class="w"> </span><span class="err">set</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="kc">true</span><span class="err">,</span><span class="w"> </span><span class="err">explicit</span><span class="w"> </span><span class="err">access</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">session</span><span class="w"> </span><span class="err">document</span><span class="w"> </span><span class="err">must</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">granted</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">IAM</span><span class="w"> </span><span class="err">policy</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">start</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">session.</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">following</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">an</span><span class="w"> </span><span class="err">example.</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"ssm:StartSession"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:ec2:region:account-id:instance/instance-id"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"arn:aws:ssm:region:account-id:document/SSM-SessionManagerRunShell"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"BoolIfExists"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"ssm:SessionDocumentAccessCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><ul><li>Using the default <code class="language-plaintext highlighter-rouge">SSM-SessionManagerRunShell</code> session document is the only case when a document name can be omitted from the start-session CLI command.<li>In other cases, the user must specify a value for the <code class="language-plaintext highlighter-rouge">--document-name</code> option of the start-session AWS CLI command.<li>The system checks whether the user has explicit access to the session document they specify.<li>Example<ul><li>if a user specifies the name of a custom session document created, the user’s IAM policy must grant them permission to access that document.<li>If a user runs a command to start a session using SSH, the user’s policy must grant them access to the <code class="language-plaintext highlighter-rouge">AWS-StartSSHSession</code> session document.<ul><li>To start a session using SSH, configuration steps must be completed on both the target instance and the user’s local machine. For information, see (Optional) Enable SSH connections through Session Manager.</ul></ul></ul><hr /><h3 id="4-設定-user-的-iam-policy">4. 設定 user 的 iam policy</h3><h4 id="end-user-policies-for-session-manager">end user policies for Session Manager</h4><ul><li>create IAM end user policies for Session Manager.<li>allows users to start sessions from only the Session Manager console / AWS CLI / EC2 console, or from all three.<li>These policies provide end users the ability to start a session to a particular instance and the ability to end only their own sessions.</ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:StartSession</span>
  <span class="pi">-</span> <span class="s">ssm:SendCommand</span>
  <span class="c1"># needed for cases where a user attempts to start a session from the Amazon EC2 console, but a command must be sent to update SSM Agent first.</span>
  <span class="na">Resource</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">arn:aws:ec2:*:*:instance/*</span>
  <span class="c1"># no restrict</span>
  <span class="pi">-</span> <span class="s">arn:aws:ec2:region:987654321098:instance/i-02573cafcfEXAMPLE</span>
  <span class="c1"># restrict access to specific instances by creating an IAM user policy that includes the IDs of the instances</span>
  <span class="pi">-</span> <span class="s">arn:aws:ssm:region:account-id:document/SSM-SessionManagerRunShell</span>
  <span class="c1"># the default name of the SSM document that Session Manager creates to store your session configuration preferences. You can create a custom session document and specify it in this policy instead. You can also specify the AWS-provided document AWS-StartSSHSession for users who are starting sessions using SSH.</span>
  <span class="na">Condition</span><span class="pi">:</span>
    <span class="na">BoolIfExists</span><span class="pi">:</span>
      <span class="na">ssm:SessionDocumentAccessCheck</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
      <span class="c1"># the system checks that a user has explicit access to the defined session document, SSM-SessionManagerRunShell, before a session is established.</span>
    <span class="s">StringLike"</span><span class="err">:</span>
      <span class="na">ssm:resourceTag/Environment</span><span class="pi">:</span> <span class="s2">"</span><span class="s">staging"</span>
      <span class="c1"># 使用 tag 去區別用戶能夠存取的環境，像是 staging or production</span>

<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeSessions</span>
  <span class="pi">-</span> <span class="s">ssm:GetConnectionStatus</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeInstanceInformation</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeInstanceProperties</span>
  <span class="pi">-</span> <span class="s">ec2:DescribeInstances</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>

<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">kms:GenerateDataKey</span>
  <span class="c1"># enables the creation of a data encryption key that will be used to encrypt session data. If you won't use AWS KMS key encryption for session data, remove the following content from the policy.</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">key-name</span>

<span class="c1"># Allow a user to end only sessions they started</span>
<span class="c1"># Method 1: Grant TerminateSession privileges using the variable {aws:username}</span>
<span class="c1"># allowed to end only their sessions on those instances.</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">ssm:TerminateSession</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">arn:aws:ssm:*:*:session/${aws:username}-*</span>

<span class="c1"># Method 2: Grant TerminateSession privileges using tags supplied by AWS</span>
<span class="c1"># control which sessions a user can end by using a condition with specific tag key variables in an IAM user policy. The condition specifies that the user can only end sessions that are tagged with one or both of these specific tag key variables and a specified value.</span>
<span class="c1"># When a user in your AWS account starts a session, Session Manager applies two resource tags to the session. The first resource tag is aws:ssmmessages:target-id, with which you specify the ID of the target the user is allowed to end. The other resource tag is aws:ssmmessages:session-id, with a value in the format of role-id:caller-specified-role-name.</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">ssm:TerminateSession</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">Condition</span><span class="pi">:</span>
    <span class="na">StringLike</span><span class="pi">:</span>
      <span class="c1"># the condition statement lets a user end only the instance i-02573cafcfEXAMPLE.</span>
      <span class="na">ssm:resourceTag/aws:ssmmessages:target-id</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">i-02573cafcfEXAMPLE</span>
      <span class="c1"># for cases where the caller type is User. The value you supply for aws:ssmmessages:session-id is the ID of the user.</span>
      <span class="s">ssm:resourceTag/aws:ssmmessages:session-id"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">AIDIODR4TAW7CSEXAMPLE"</span>
      <span class="c1"># for cases where the caller type is AssumedRole. You can use the {aws:userid} variable for the value you supply for aws:ssmmessages:session-id. Alternatively, you can hardcode a role ID for the value you supply for aws:ssmmessages:session-id. If you hardcode a role ID, you must provide the value in the format role-id:caller-specified-role-name. For example, AIDIODR4TAW7CSEXAMPLE:MyRole.</span>
      <span class="pi">-</span> <span class="s">${aws:userid}</span>


</pre></table></code></div></div><h4 id="administrator-policy-for-session-manager">administrator policy for Session Manager</h4><ul><li>create IAM administrator policies for Session Manager.<li>provide administrators the ability to<ul><li>start a session to instances that are tagged with <code class="language-plaintext highlighter-rouge">Key=Finance,Value=WebServers</code>,<li>create, update, and delete preferences,<li>end only their own sessions.</ul></ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:StartSession</span>
  <span class="pi">-</span> <span class="s">ssm:SendCommand</span>
  <span class="c1"># needed for cases where a user attempts to start a session from the Amazon EC2 console, but a command must be sent to update SSM Agent first.</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">arn:aws:ec2:us-west-2:987654321098:instance/*</span>
  <span class="na">Condition</span><span class="pi">:</span>
    <span class="na">StringLike</span><span class="pi">:</span>
      <span class="na">ssm:resourceTag/tag-key1</span><span class="pi">:</span> <span class="s">tag-value1</span>
      <span class="s">ssm:resourceTag/Finance": "WebServers"</span>
      <span class="c1"># restrict access to instances based on specific Amazon EC2 tags.</span>
      <span class="c1"># allowed to start sessions with the condition that the instance is a Finance WebServer (ssm:resourceTag/Finance: WebServer). If the user sends a command to an instance that is not tagged or that has any tag other than Finance: WebServer, the command result will include AccessDenied.</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeSessions</span>
  <span class="pi">-</span> <span class="s">ssm:GetConnectionStatus</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeInstanceInformation</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeInstanceProperties</span>
  <span class="pi">-</span> <span class="s">ec2:DescribeInstances</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:CreateDocument</span>
  <span class="pi">-</span> <span class="s">ssm:UpdateDocument</span>
  <span class="pi">-</span> <span class="s">ssm:GetDocument</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">arn:aws:ssm:region:account-id:document/SSM-SessionManagerRunShell</span>
<span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Action</span><span class="pi">:</span> <span class="s">ssm:TerminateSession</span>
  <span class="na">Resource</span><span class="pi">:</span> <span class="s">rn:aws:ssm:*:*:session/${aws:username}-*</span>
</pre></table></code></div></div><h4 id="allow-full-administrative-access-to-all-sessions">Allow full (administrative) access to all sessions</h4><ul><li>allows a user to fully interact with all instances/sessions created by all users for all instances.<li>It should be granted only to an Administrator who needs full control over your organization’s Session Manager activities.</ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
<span class="na">Statement</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">Action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ssm:StartSession</span>
  <span class="pi">-</span> <span class="s">ssm:TerminateSession</span>
  <span class="pi">-</span> <span class="s">ssm:ResumeSession</span>
  <span class="pi">-</span> <span class="s">ssm:DescribeSessions</span>
  <span class="pi">-</span> <span class="s">ssm:GetConnectionStatus</span>
  <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
  <span class="na">Resource</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
</pre></table></code></div></div><h3 id="5-user-iam-group">5. user IAM group</h3><ol><li>在IAM中创建组:group-test<ul><li>IAM &gt; 选择组(group-test) &gt; 添加权限 &gt; 直接附加现有策略 &gt; 选:policy-test</ul><li>在IAM中创建用户：user-test<ul><li>把你的帐号加入group-test组中<li>(注意：你的帐号只分配凭证就行，不需要设置密码,如果需要登录web控制,才需要设置密码)</ul></ol><h3 id="6-設定完以上的基本設定後登入機器">6. 設定完以上的基本設定後，登入機器</h3><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c"># 安装 AWS CLI</span>
<span class="nv">$ </span><span class="nb">sudo </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> awscli
<span class="c"># 为 AWS CLI 安装 Session Manager Plugin</span>
<span class="nv">$ </span>curl <span class="s2">"https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm"</span> <span class="nt">-o</span> <span class="s2">"session-manager-plugin.rpm"</span>
<span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> session-manager-plugin.rpm
<span class="c"># 验证安装</span>
<span class="nv">$ </span>session-manager-plugin
<span class="c"># Session-Manager-Plugin is installed successfully. Use AWSCLI to start a session.</span>


<span class="c"># 启动SSM Session</span>
<span class="nv">$ </span>aws ssm start-session <span class="se">\</span>
  <span class="nt">--target</span> i-0b0d92751733d1234
<span class="c"># Starting session with SessionId: user-test-xxxxab2b33333333</span>
<span class="c"># sh-4.2$</span>
<span class="c"># sh-4.2$ ls</span>
<span class="c"># /tmp</span>
<span class="c"># 通过SSM登录上EC2(i-xxxxxxxxxx)，并不需要ssh。</span>
</pre></table></code></div></div><h3 id="more-session-preferencse">more session preferencse:</h3><p><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-configure-preferences.html">link</a></p><h3 id="修改-ssm-user-sudo-权限">修改 ssm-user sudo 权限</h3><p>当支持 Session Manager 的某个 SSM 代理版本在实例上启动时，它会创建一个名为 ssm-user 的具有根或管理员权限的用户账户。</p><ul><li>在 Linux 计算机上，此账户添加到 /etc/sudoers。</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># 连接到实例并运行以下命令：</span>
<span class="nb">sudo cd</span> /etc/sudoers.d

<span class="c"># 打开名为 ssm-agent-users 的文件进行编辑。</span>

<span class="c"># 删除 sudo 访问权限，请删除以下行：</span>
ssm-user <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL

<span class="c"># 要恢复 sudo 访问权限，请添加以下行：</span>
ssm-user <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL
</pre></table></code></div></div><h3 id="配置ec2-的安全组">配置ec2 的安全组：</h3><p>入站：取消所有规则</p><p>出站：</p><ol><li>开放tcp/udp 53端口<li>开放tcp/443 端口 （因为需要此端口访问aws ssm服务器）<li>开放tcp/6443 连接k8s的端口以及只允许k8s master IP（如果想只允许访问k8s API）;</ol><h3 id="记录会话数据">记录会话数据</h3><p>启动session后，所有对ec2执行的命令以及返回的结果，可以记录在CloudWatch Logs中。</p><ol><li>在CloudWatch中 新建日志组：session-logs<li>在System Manager 的会话管理器中启用日志流<ul><li>日志组选择:session-logs</ul><li>启动ssm session 后，执行的所有操作，在CloudWatch的日志组（session-logs)都可以查到：</ol><p><img data-proofer-ignore data-src="https://i.imgur.com/iIqBMgE.png" alt="20190402100145503" /></p><p><img data-proofer-ignore data-src="https://i.imgur.com/JlqkmpI.png" alt="2019040210063670" /></p><hr /><h2 id="使用-scp">使用 scp</h2><h3 id="設定">設定</h3><p>透過 session manager 去達成 scp ，基本上透過 AWS 文件 <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html">session-manager-getting-started-enable-ssh-connections</a> 上的描述，可以得知是利用 Proxycommand 透過 AWS tunnel 直接連接到我們的 EC2 機器上。</p><p>編輯 <code class="language-plaintext highlighter-rouge">~/.ssh/config</code> 並加入</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># SSH over Session Manager</span>
host i-<span class="k">*</span> mi-<span class="k">*</span>
 ProxyCommand sh <span class="nt">-c</span> <span class="s2">"aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters'portNumber=%p'"</span>

<span class="c"># 就可以使用</span>
scp <span class="nt">-i</span> <span class="nt">-i</span> /path/my-key-pair.pem test123 ubuntu@i-0b0d92751733d1234:~/test123
<span class="c"># 還是要利用一開始設定好的 key pair 去做連線。</span>
</pre></table></code></div></div><h3 id="進階設定">進階設定</h3><p>上面提供的方法雖然可以讓我們使用 scp &amp; ssh，但是還是得設定 EC2 機器的 key</p><p>繞過去</p><ul><li>網路上有人寫好了這個 proxy command 的 <a href="https://gist.github.com/qoomon/fcf2c85194c55aee34b78ddcaa9e83a1">script</a><li>使用的方式很簡單<ol><li>下載並且把這個 script 放到 <code class="language-plaintext highlighter-rouge">~/.ssh/aws-ssm-ec2-proxy-command.sh</code><li>修改 <code class="language-plaintext highlighter-rouge">aws-ssm-ec2-proxy-command.sh</code> 成為可以執行<li>修改 <code class="language-plaintext highlighter-rouge">~/.ssh/config</code> 裡面的指令</ol><li>原理很簡單<ol><li>利用 <code class="language-plaintext highlighter-rouge">aws ec2-instance-connect send-ssh-public-key</code> 去建立一個 short-lived 的 key<ul><li>這個指令詳細的好處可以看這篇 aws 文章 <a href="https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/">new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances</a></ul><li>接著再使用這把 key 透過原本的 start session 那條路連上遠端的 ec2 機器。</ol></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>host i-<span class="k">*</span> mi-<span class="k">*</span>
 ProxyCommand ~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p

<span class="c"># 就不用在帶一把 key 去做認證了</span>
scp test123 ubuntu@i-0b0d92751733d1234:~/test123
</pre></table></code></div></div><hr /><h2 id="port-forwarding">Port forwarding</h2><p>透過 port forwarding 去連接 EC2 上面的服務，</p><ul><li>很多時候我們會把服務都放進 private subnet 內， 而 developer 想要測試這些 services 時，往往要利用 VPN 或是開一台在內網的 EC2 去連結，<li>而使用 port forwarding 可以讓我們更容易地達成這個需求。</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>aws ssm start-session <span class="se">\</span>
  <span class="nt">--target</span> i-0b0d92751733d1234 <span class="se">\</span>
  <span class="nt">--document-name</span> AWS-StartPortForwardingSession <span class="se">\</span>
  <span class="nt">--parameters</span> <span class="s1">'{"portNumber":["80"],"localPortNumber":["9999"]}'</span>
</pre></table></code></div></div><p>這樣就可以透過 <code class="language-plaintext highlighter-rouge">localhost:9999</code> 去連結到 EC2 上面 service 的 80 port 了</p><ul><li>詳細的內容也可以看這篇 AWS 的文章 <a href="https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/">new-port-forwarding-using-aws-system-manager-sessions-manager</a></ul><hr /><h2 id="monitoring">Monitoring</h2><h3 id="logging-aws-systems-manager-api-calls-with-aws-cloudtrail">Logging AWS Systems Manager API calls with AWS CloudTrail.</h3><hr /><h2 id="reference">Reference</h2><hr /><ul><li><a href="https://www.youtube.com/watch?v=nzjTIjFLiow">https://www.youtube.com/watch?v=nzjTIjFLiow</a><li><a href="https://www.youtube.com/watch?v=kj9NgFfUIHQ">https://www.youtube.com/watch?v=kj9NgFfUIHQ</a><li><a href="https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/">https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/</a><li><a href="https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/">https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/</a><li><a href="https://globaldatanet.com/blog/ssh-and-scp-with-aws-ssm">https://globaldatanet.com/blog/ssh-and-scp-with-aws-ssm</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/01aws/'>01AWS</a>, <a href='/categories/management/'>Management</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >AWS</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS - Management - SSM - Session Manager - Grace&url=https://ocholuo.github.io//posts/SSM-SessionManager/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS - Management - SSM - Session Manager - Grace&u=https://ocholuo.github.io//posts/SSM-SessionManager/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AWS - Management - SSM - Session Manager - Grace&url=https://ocholuo.github.io//posts/SSM-SessionManager/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AWS-Plan/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - Management - AWS Plan</h3><div class="text-muted small"><p> AWS Plan AWS Plan 4 plan Basic Support included for all AWS customers All plans, including Basic Support, provide 24/7 access to customer service, AWS document...</p></div></div></a></div><div class="card"> <a href="/posts/cloud-governance/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - Management - cloud governance on AWS</h3><div class="text-muted small"><p> cloud governance on AWS overview value of the NIST CSF NIST CSF NIST CSF use case with identity The organizational context: AWS Cl...</p></div></div></a></div><div class="card"> <a href="/posts/ELK-Setup/"><div class="card-body"> <span class="timeago small" >Feb 11, 2020<i class="unloaded">2020-02-11T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - ELK Setup</h3><div class="text-muted small"><p> ELK Setup basic Install ELK Environment specifications Configuration Filebeat Logstash collect data ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AWS-Plan/" class="btn btn-outline-primary" prompt="Older"><p>AWS - Management - AWS Plan</p></a> <a href="/posts/cloud-governance/" class="btn btn-outline-primary" prompt="Newer"><p>AWS - Management - cloud governance on AWS</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
