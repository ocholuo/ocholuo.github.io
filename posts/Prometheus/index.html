<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Monitor - Prometheus" /><meta property="og:locale" content="en" /><meta name="description" content="Prometheus basic overall Concepts Prometheus: 监控与告警 1:概要介绍 主要特性 整体架构 2:安装方法 安装方式 安装示例 结果确认 3:指标监控示例 事前准备 配置Prometheus 启动 Prometheus服务 pro golang client 启动监控对象进程 结果确认 4:使用Grafana进行可视化显示 事前准备 5:在Kubernetes上部署 Exporter概要介绍 exporter Cadvisor expose custom metrics to Prometheus App with metric Deploy into Kubernetes Scrape Metrics from Prometheus Metric CONFIGURATION metric_relabel_configs relabel_config monitoring with Prometheus client Instrumenting applications Installation How Go exposition works Add own metrics Other Go client features Client for the Prometheus HTTP API go client 模型 metric 指标 数据指标类型 数据指标向量 state metric 定义指标 registry metric 注册指标 默认方式 自定义 exporter / 结构体 Collector 自定义Collector Package prometheus/client_golang prometheus 包 自定义 Collectors 和常量指标 Registry 的高级用法 HTTP 公开数据指标 推送数据指标到 Pushgateway promauto 包 promhttp 包 Handler() 与 HandlerFor() 函数 InstrumentHandlerX 包装器函数 示例 push 包" /><meta property="og:description" content="Prometheus basic overall Concepts Prometheus: 监控与告警 1:概要介绍 主要特性 整体架构 2:安装方法 安装方式 安装示例 结果确认 3:指标监控示例 事前准备 配置Prometheus 启动 Prometheus服务 pro golang client 启动监控对象进程 结果确认 4:使用Grafana进行可视化显示 事前准备 5:在Kubernetes上部署 Exporter概要介绍 exporter Cadvisor expose custom metrics to Prometheus App with metric Deploy into Kubernetes Scrape Metrics from Prometheus Metric CONFIGURATION metric_relabel_configs relabel_config monitoring with Prometheus client Instrumenting applications Installation How Go exposition works Add own metrics Other Go client features Client for the Prometheus HTTP API go client 模型 metric 指标 数据指标类型 数据指标向量 state metric 定义指标 registry metric 注册指标 默认方式 自定义 exporter / 结构体 Collector 自定义Collector Package prometheus/client_golang prometheus 包 自定义 Collectors 和常量指标 Registry 的高级用法 HTTP 公开数据指标 推送数据指标到 Pushgateway promauto 包 promhttp 包 Handler() 与 HandlerFor() 函数 InstrumentHandlerX 包装器函数 示例 push 包" /><link rel="canonical" href="https://ocholuo.github.io//posts/Prometheus/" /><meta property="og:url" content="https://ocholuo.github.io//posts/Prometheus/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-22T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Monitor - Prometheus" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-02T18:41:50-05:00","datePublished":"2020-12-22T10:11:11-05:00","description":"Prometheus basic overall Concepts Prometheus: 监控与告警 1:概要介绍 主要特性 整体架构 2:安装方法 安装方式 安装示例 结果确认 3:指标监控示例 事前准备 配置Prometheus 启动 Prometheus服务 pro golang client 启动监控对象进程 结果确认 4:使用Grafana进行可视化显示 事前准备 5:在Kubernetes上部署 Exporter概要介绍 exporter Cadvisor expose custom metrics to Prometheus App with metric Deploy into Kubernetes Scrape Metrics from Prometheus Metric CONFIGURATION metric_relabel_configs relabel_config monitoring with Prometheus client Instrumenting applications Installation How Go exposition works Add own metrics Other Go client features Client for the Prometheus HTTP API go client 模型 metric 指标 数据指标类型 数据指标向量 state metric 定义指标 registry metric 注册指标 默认方式 自定义 exporter / 结构体 Collector 自定义Collector Package prometheus/client_golang prometheus 包 自定义 Collectors 和常量指标 Registry 的高级用法 HTTP 公开数据指标 推送数据指标到 Pushgateway promauto 包 promhttp 包 Handler() 与 HandlerFor() 函数 InstrumentHandlerX 包装器函数 示例 push 包","headline":"Monitor - Prometheus","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/Prometheus/"},"url":"https://ocholuo.github.io//posts/Prometheus/"}</script><title>Monitor - Prometheus | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Monitor - Prometheus</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Monitor - Prometheus</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 22, 2020, 10:11 AM -0500" >Dec 22, 2020<i class="unloaded">2020-12-22T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 2, 2023, 3:41 PM -0800" >Jan 2<i class="unloaded">2023-01-02T18:41:50-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="23095 words">128 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#prometheus">Prometheus</a><ul><li><a href="#basic">basic</a><li><a href="#overall">overall</a><li><a href="#concepts">Concepts</a><li><a href="#prometheus-监控与告警">Prometheus: 监控与告警</a><ul><li><a href="#1概要介绍">1:概要介绍</a><ul><li><a href="#主要特性">主要特性</a><li><a href="#整体架构">整体架构</a></ul><li><a href="#2安装方法">2:安装方法</a><ul><li><a href="#安装方式">安装方式</a><li><a href="#安装示例">安装示例</a><li><a href="#结果确认">结果确认</a></ul><li><a href="#3指标监控示例">3:指标监控示例</a><ul><li><a href="#事前准备">事前准备</a><li><a href="#配置prometheus">配置Prometheus</a><li><a href="#启动-prometheus服务">启动 Prometheus服务</a><li><a href="#pro-golang-client">pro golang client</a><li><a href="#启动监控对象进程">启动监控对象进程</a><li><a href="#结果确认-1">结果确认</a></ul><li><a href="#4使用grafana进行可视化显示">4:使用Grafana进行可视化显示</a><ul><li><a href="#事前准备-1">事前准备</a></ul><li><a href="#5在kubernetes上部署">5:在Kubernetes上部署</a></ul><li><a href="#exporter概要介绍">Exporter概要介绍</a><ul><li><a href="#exporter">exporter</a><li><a href="#cadvisor">Cadvisor</a><li><a href="#expose-custom-metrics-to-prometheus">expose custom metrics to Prometheus</a><ul><li><a href="#app-with-metric">App with metric</a><li><a href="#deploy-into-kubernetes">Deploy into Kubernetes</a><ul><li><a href="#scrape-metrics-from-prometheus">Scrape Metrics from Prometheus</a></ul></ul></ul><li><a href="#metric">Metric</a><li><a href="#configuration">CONFIGURATION</a><ul><li><a href="#metric_relabel_configs">metric_relabel_configs</a><li><a href="#relabel_config">relabel_config</a></ul><li><a href="#monitoring-with-prometheus">monitoring with Prometheus</a><li><a href="#client">client</a><ul><li><a href="#instrumenting-applications">Instrumenting applications</a><ul><li><a href="#installation">Installation</a><li><a href="#how-go-exposition-works">How Go exposition works</a><li><a href="#add-own-metrics">Add own metrics</a><li><a href="#other-go-client-features">Other Go client features</a></ul><li><a href="#client-for-the-prometheus-http-api">Client for the Prometheus HTTP API</a></ul><li><a href="#go-client">go client</a><ul><li><a href="#模型">模型</a><li><a href="#metric-指标">metric 指标</a><ul><li><a href="#数据指标类型">数据指标类型</a><li><a href="#数据指标向量">数据指标向量</a><li><a href="#state-metric-定义指标">state metric 定义指标</a><li><a href="#registry-metric-注册指标">registry metric 注册指标</a><ul><li><a href="#默认方式">默认方式</a><li><a href="#自定义-exporter--结构体">自定义 exporter / 结构体</a></ul></ul><li><a href="#collector">Collector</a><li><a href="#自定义collector">自定义Collector</a></ul><li><a href="#package">Package</a><ul><li><a href="#prometheusclient_golang">prometheus/client_golang</a><li><a href="#prometheus-包"><code class="language-plaintext highlighter-rouge">prometheus</code> 包</a><ul><li><a href="#自定义-collectors-和常量指标">自定义 Collectors 和常量指标</a><li><a href="#registry-的高级用法">Registry 的高级用法</a><li><a href="#http-公开数据指标">HTTP 公开数据指标</a><li><a href="#推送数据指标到-pushgateway">推送数据指标到 Pushgateway</a></ul><li><a href="#promauto-包"><code class="language-plaintext highlighter-rouge">promauto</code> 包</a><li><a href="#promhttp-包"><code class="language-plaintext highlighter-rouge">promhttp</code> 包</a><ul><li><a href="#handler-与-handlerfor-函数"><code class="language-plaintext highlighter-rouge">Handler()</code> 与 <code class="language-plaintext highlighter-rouge">HandlerFor()</code> 函数</a><li><a href="#instrumenthandlerx-包装器函数"><code class="language-plaintext highlighter-rouge">InstrumentHandlerX</code> 包装器函数</a><li><a href="#示例">示例</a></ul><li><a href="#push-包"><code class="language-plaintext highlighter-rouge">push</code> 包</a></ul></ul></ul><hr /><h1 id="prometheus">Prometheus</h1><p><strong>几点原则</strong></p><ul><li>监控是基础设施，目的是为了解决问题，不要只朝着大而全去做，尤其是不必要的指标采集，浪费人力和存储资源（To B商业产品例外）。<li>需要处理的告警才发出来，发出来的告警必须得到处理。<li>简单的架构就是最好的架构，业务系统都挂了，监控也不能挂。Google Sre 里面也说避免使用 Magic 系统，例如机器学习报警阈值、自动修复之类。这一点见仁见智吧，感觉很多公司都在搞智能 AI 运维。</ul><p><strong>Prometheus 的局限</strong></p><ul><li>Prometheus 是基于 Metric 的监控，不适用于日志（Logs）、事件(Event)、调用链(Tracing)。<li>Prometheus 默认是 Pull 模型，合理规划你的网络，尽量不要转发。<li>对于集群化和水平扩展，官方和社区都没有银弹，需要合理选择 Federate、Cortex、Thanos等方案。<li>监控系统一般情况下<strong>可用性大于一致性</strong>，容忍部分副本数据丢失，保证查询请求成功。这个后面说 Thanos 去重的时候会提到。<li>Prometheus 不一定保证数据准确，<ul><li>一是指 rate、histogram_quantile 等函数会做统计和推断，产生一些反直觉的结果，这个后面会详细展开。<li>二来查询范围过长要做降采样，势必会造成数据精度丢失，不过这是时序数据的特点，也是不同于日志系统的地方。</ul></ul><p><strong>合理选择黄金指标</strong></p><ul><li>采集的指标有很多，Google 在“Sre Handbook”中提出了“四个黄金信号”：<code class="language-plaintext highlighter-rouge">延迟、流量、错误数、饱和度</code>。<ul><li>实际操作中可以使用 Use 或 Red 方法作为指导，<li>Use 用于资源，Red 用于服务。<li>Use 方法：<code class="language-plaintext highlighter-rouge">Utilization、Saturation、Errors</code>。如 Cadvisor 数据<li>Red 方法：<code class="language-plaintext highlighter-rouge">Rate、Errors、Duration</code>。如 Apiserver 性能指标</ul><li><p>Prometheus 采集中常见的服务分三种：</p><ul><li><p>在线服务：如 Web 服务、数据库等，一般关心请求速率，延迟和错误率即 RED 方法。</p><li><p>离线服务：如日志处理、消息队列等，一般关注队列数量、进行中的数量，处理速度以及发生的错误即 Use 方法。</p><li><p>批处理任务：和离线任务很像，但是离线任务是长期运行的，批处理任务是按计划运行的，如持续集成就是批处理任务，对应 K8S 中的 job 或 cronjob， 一般关注所花的时间、错误数等，因为运行周期短，很可能还没采集到就运行结束了，所以一般使用 Pushgateway，改拉为推。</p></ul><li><p>对Use 和 Red 的实际示例可以参考容器监控实践—K8S常用指标分析这篇文章。</p><li>容器监控实践—K8S常用指标分析：http://www.xuyasong.com/?P=1717</ul><h2 id="basic">basic</h2><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191203090913325.jpeg?x-oss-process=image/resize,m_fixed,h_224,w_224" alt="pic" /></p><p>Prometheus是一个开源监控系统.</p><ul><li>Prometheus是由SoundCloud开发的开源监控报警系统和时序列数据库(TSDB).<li>Prometheus使用Go语言开发,是Google BorgMon监控系统的开源版本.<li>Prometheus也是以重时序数据库.</ul><p>Prometheus 生态是一款优秀的开源监控解决方案，其中包括如下组件</p><ul><li>Prometheus server<ul><li>服务端,用来存储时间序列数据.<li>通过配置各个采集任务，采集各个 expoter 或 pushgateway 数据，保存到其内部的时间序列数据库 (TSDB) 中。<li>并根据规则对采集到的数据指标进行计算或重新保存为新的数据指标，判断是否达到阈值并向 Alertmanager 推送告警信息.</ul><li>Alertmanager<ul><li>用来处理告警.<li>接收 Prometheus 推送过来的告警信息，通过告警路由，向集成的组件 / 工具发送告警信息.</ul><li>各种 Exporter<ul><li>收集系统或进程信息，转换为 Prometheus 可以识别的数据指标，以 http 或 https 服务的方式暴露给 Prometheus.<li>用来监控 HAProxy,StatsD,Graphite 等特殊的监控目标,并向 Prometheus 提供标准格式的监控样本数据.</ul><li>Pushgateway<ul><li>收集系统或进程信息，转换为 Prometheus 可以识别的数据指标，向 Prometheus 推送数据指标.</ul></ul><p>Prometheus 的优势</p><ul><li>由指标名称和和键/值对标签标识的时间序列数据组成的多维数据模型.<li>强大的查询语言 PromQL.<li>不依赖分布式存储;单个服务节点具有自治能力.<li>时间序列数据是服务端通过 HTTP 协议主动拉取获得的.<li>也可以通过中间网关来推送时间序列数据.<li>可以通过静态配置文件或服务发现来获取监控目标.<li>支持多种类型的图表和仪表盘.</ul><p>few key points</p><ul><li>Metric Collection:<ul><li>Prometheus uses the pull model to retrieve metrics over HTTP. There is an option to push metrics to Prometheus using Pushgateway for use cases where Prometheus cannot Scrape the metrics. One such example is collecting custom metrics from short-lived kubernetes jobs &amp; Cronjobs</ul><li>Metric Endpoint:<ul><li>The systems that you want to monitor using Prometheus should expose the metrics on an /metrics endpoint. Prometheus uses this endpoint to pull the metrics in regular intervals.</ul><li>PromQL:<ul><li>Prometheus comes with PromQL, a very flexible query language that can be used to query the metrics in the Prometheus dashboard. Also, the PromQL query will be used by Prometheus UI and Grafana to visualize metrics.</ul><li>Prometheus Exporters:<ul><li>Exporters are libraries that convert existing metrics from third-party apps to Prometheus metrics format. There are many official and community Prometheus exporters. One example is, the Prometheus node exporter. It exposes all Linux system-level metrics in Prometheus format.</ul><li>TSDB (time-series database):<ul><li>Prometheus uses TSDB for storing all the data efficiently.<li>By default, all the data gets stored locally.<li>However, to avoid a single point of failure, there are options to integrate remote storage for Prometheus TSDB.</ul></ul><p><img data-proofer-ignore data-src="https://i.imgur.com/MJw2t7N.png" alt="Screenshot 2022-11-06 at 16.10.26" /></p><h2 id="overall">overall</h2><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre><td class="rouge-code"><pre><span class="c">// # state custom metric</span>
<span class="k">import</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">client_golang</span><span class="o">/</span><span class="n">prometheus</span>
<span class="n">cpuTemp</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="s">"cpu_temperature_celsius"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="s">"Current temperature of the CPU."</span><span class="p">,}</span>
<span class="p">)</span>
<span class="n">hdFailures</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="s">"hd_errors_total"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="s">"Number of hard-disk errors."</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"device"</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">totalScrapes</span><span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounter</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
    <span class="n">Namespace</span><span class="o">:</span> <span class="n">namespace</span><span class="p">,</span>
    <span class="n">Name</span><span class="o">:</span>      <span class="s">"exporter_scrapes_total"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span>      <span class="s">"Current total redis scrapes."</span><span class="p">,}</span>
<span class="p">)</span>

<span class="c">// # registry custom metric</span>
<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Metrics have to be registered to be exposed:</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">cpuTemp</span><span class="p">)</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">hdFailures</span><span class="p">)</span>
<span class="p">}</span>


<span class="c">// # add custom metric to new port</span>

<span class="c">// # add new port in prometheus py</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="n">cpuTemp</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="m">65.3</span><span class="p">)</span>
	<span class="n">hdFailures</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"device"</span><span class="o">:</span> <span class="s">"/dev/sda"</span><span class="p">})</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>

	<span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span>
		<span class="n">qzPro</span><span class="o">.</span><span class="n">CommonCounter</span><span class="p">,</span> <span class="n">qzPro</span><span class="o">.</span><span class="n">FuncCounter</span><span class="p">,</span> <span class="n">qzPro</span><span class="o">.</span><span class="n">VecCounter</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/common_counter"</span><span class="p">,</span> <span class="n">qzPro</span><span class="o">.</span><span class="n">DealCommCounter</span><span class="p">)</span>
	<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/vec_counter"</span><span class="p">,</span> <span class="n">qzPro</span><span class="o">.</span><span class="n">DealVecCounter</span><span class="p">)</span>

	<span class="err">#</span> <span class="c">// The Handler function provides a default handler to expose metrics</span>
	<span class="err">#</span> <span class="c">// via an HTTP server. "/metrics" is the usual endpoint for that.</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span> <span class="c">// 暴露 metrics 指标</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/service"</span><span class="p">,</span> <span class="n">phm</span><span class="o">.</span><span class="n">WrapHandler</span><span class="p">(</span><span class="s">"myhandler"</span><span class="p">,</span> <span class="n">myHandler</span><span class="p">))</span>
	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8090"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">}</span>


<span class="c">// # create dockerfile</span>
<span class="n">run</span> <span class="n">app</span>
<span class="n">run</span> <span class="n">prometheus</span> <span class="n">with</span> <span class="n">port</span>


<span class="c">// # build img from dockerfile</span>
<span class="n">export</span> <span class="err">$</span><span class="n">MYAPP</span><span class="o">=</span><span class="s">"my_app"</span>
<span class="n">export</span> <span class="err">$</span><span class="n">MYTAG</span><span class="o">=</span><span class="s">"my_tag"</span>
<span class="n">export</span> <span class="err">$</span><span class="n">CONTAINERNAME</span><span class="o">=</span><span class="s">"my_container"</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">--</span><span class="n">platform</span> <span class="n">linux</span><span class="o">/</span><span class="n">amd64</span> <span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="n">MYAPP</span><span class="o">/</span><span class="n">Dockerfile</span>  <span class="o">.</span> <span class="o">-</span><span class="n">t</span> <span class="err">$</span><span class="n">MYTAG</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="err">$</span><span class="n">MYTAG</span>

<span class="c">// # Local run container from img</span>
<span class="n">docker</span> <span class="n">run</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">env</span> <span class="n">AWS_ACCESS_KEY_ID</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">env</span> <span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">env</span> <span class="n">AWS_SESSION_TOKEN</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">env</span> <span class="n">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="m">2</span> <span class="err">\</span>
    <span class="err">$</span><span class="n">MYAPP</span><span class="o">:</span><span class="err">$</span><span class="n">MYTAG</span>

<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="m">9090</span><span class="o">:</span><span class="m">9090</span> <span class="err">\</span>
	<span class="o">-</span><span class="n">v</span> <span class="s">`pwd`</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">demo</span><span class="o">.</span><span class="n">yml</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> <span class="err">\</span>
	<span class="o">--</span><span class="n">name</span> <span class="n">prometheus</span> <span class="n">prom</span><span class="o">/</span><span class="n">prometheus</span>


<span class="c">// # check current prometheus config</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">configmap</span> <span class="n">prometheus</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">config</span> <span class="err">\</span>
    <span class="o">-</span><span class="n">n</span> <span class="err">$</span><span class="n">CONTAINERNAME</span> <span class="err">\</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">jsonpath</span><span class="o">=</span><span class="err">'</span><span class="p">{</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">prometheus</span><span class="err">\</span><span class="o">.</span><span class="n">yml</span><span class="p">}</span><span class="err">'</span> <span class="err">\</span>
    <span class="o">&gt;</span> <span class="err">$</span><span class="n">MYAPP</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">current</span><span class="o">.</span><span class="n">yml</span>



<span class="c">// # add custom metric collection to new port</span>

    <span class="o">-</span> <span class="n">job_name</span><span class="o">:</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">test</span>
      <span class="n">bearer_token_file</span><span class="o">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span><span class="o">/</span><span class="n">token</span>
      <span class="n">kubernetes_sd_configs</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">role</span><span class="o">:</span> <span class="n">pod</span>
      <span class="n">relabel_configs</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">action</span><span class="o">:</span> <span class="n">labelmap</span>
        <span class="n">regex</span><span class="o">:</span> <span class="n">__meta_kubernetes_node_label_</span><span class="p">(</span><span class="o">.+</span><span class="p">)</span>
      <span class="o">-</span> <span class="n">replacement</span><span class="o">:</span> <span class="n">kubernetes</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="n">svc</span><span class="o">:</span><span class="m">443</span>
        <span class="n">target_label</span><span class="o">:</span> <span class="n">__address__</span>
      <span class="o">-</span> <span class="n">regex</span><span class="o">:</span> <span class="p">(</span><span class="o">.+</span><span class="p">)</span>
        <span class="n">replacement</span><span class="o">:</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">nodes</span><span class="o">/</span><span class="err">$</span><span class="m">1</span><span class="o">/</span><span class="n">proxy</span><span class="o">/</span><span class="n">metrics</span>
        <span class="n">source_labels</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">__meta_kubernetes_node_name</span>
        <span class="n">target_label</span><span class="o">:</span> <span class="n">__metrics_path__</span>
      <span class="n">scheme</span><span class="o">:</span> <span class="n">https</span>
      <span class="n">tls_config</span><span class="o">:</span>
        <span class="n">ca_file</span><span class="o">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
        <span class="n">insecure_skip_verify</span><span class="o">:</span> <span class="no">true</span>




<span class="c">// # update prometheus</span>
<span class="c">// # - update k8s yaml file -&gt; rebuild container IaC</span>
<span class="c">// # - directly update prometheus.yml -&gt; restart the container</span>
<span class="c">// # - directly update prometheus extra-config</span>
<span class="n">kubectl</span> <span class="n">patch</span> <span class="n">configmap</span> <span class="n">prometheus</span><span class="o">-</span><span class="n">extra</span><span class="o">-</span><span class="n">config</span> <span class="err">\</span>
    <span class="o">-</span><span class="n">n</span> <span class="err">$</span><span class="n">CONTAINERNAME</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">patch</span> <span class="s">"$(cat $MYAPP/patch2.yaml)"</span>


<span class="c">// # go to prometheus dashboard</span>
<span class="n">http</span><span class="o">:</span><span class="c">//127.0.0.1:9090</span>
<span class="n">http</span><span class="o">:</span><span class="c">//127.0.0.1:9090/targets?search=</span>
<span class="n">http</span><span class="o">:</span><span class="c">//127.0.0.1:9090/metric</span>
<span class="n">http</span><span class="o">:</span><span class="c">//127.0.0.1:8089/metric</span>
</pre></table></code></div></div><hr /><h2 id="concepts">Concepts</h2><h2 id="prometheus-监控与告警">Prometheus: 监控与告警</h2><h3 id="1概要介绍">1:概要介绍</h3><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191205135124878.png#pic_center" alt="pic" /></p><p>Prometheus是开源的监控告警的解决方案</p><ul><li>最早由SoundCloud公司所开发和开源，<li>从2012年产生至今已经7年，在技术不断变化的时代这已经是一个很长的时间了，在过去的7年里，Prometheus也得到了越来越多用户的使用和推崇，并且在2016年加入CNCF后，成为继Kubernetes之后最早从中毕业的项目。<li>Prometheus的开发语言以Go为主</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191205142859465.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>同样在CNCF的landcape的同一领域的还有Grafana、Sensu、graphite、Zabbix等。</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191205143232549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>适合的场景<ul><li>非常适合纯数字类型的时序列数据，无论是以机器为中心的监控场景，还是高度动态变化的面向服务架构下的监控场景，Prometheus都是非常适合的。在微服务的世界中，Prometheus对多维度数据收集和查询的支持能力，是其长袖善舞之处。<li>Prometheus被设计用来支撑可靠性，当系统出现问题时能够快速判断故障原因，因此，每个Prometheus服务器都是独立的，不会依赖于网络存储或者其他远程的服务。当你其他的基础设施出现问题的时候，它还是独立可用的，而且不需要昂贵的基础设施的支撑才能够使用。</ul><li>不适合的场景<ul><li>Prometheus看重的是可靠性而不是精确性，使用Prometheus，无论什么样的故障境况下，用户总是能够看到可以看到的统计信息，这部分信息往往来源于独立运行的没有发生故障的那些Prometheus服务器所提供。<li>但是如果使用者需要100%的精确，比如实时的交易系统的每次请求的完整性与精确性的场景下，Prometheus可能就无法很好与完整地收集到所有的数据，这种系统或者场景之下，可以选取其他技术用于保证这些数据的完整性与精确性，而Prometheus则可以用来进行监控。</ul></ul><h4 id="主要特性">主要特性</h4><ul><li>多维度数据模型: 可使用指标名称和键/值对结合进行数据的管理。<li>提供灵活的查询语言PromQL，利用PromQL能更好地为数据先可视化显示或者告警功能提供更好的数据。<li>不依赖于分布式存储，单个服务节点的数据是自主的，可独立使用。<li>时序列数据库可基于HTTP协议使用PULL模式拉取数据。<li>提供中间网关的方式，也支持向中间网关以PUSH模式推送数据，而Prometheus再从中间网关拉取数据。<li>可以通过服务发现或者静态配置的方式发现目标对象。<li>支持多种方式的图表和仪表盘展示，比如对Grafana的支持。</ul><h4 id="整体架构">整体架构</h4><p>整体架构如下图所示</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191205150351782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /> 可以看到，Prometheus的构成非常清晰，主要由如下几个部分构成:</p><ul><li><strong>Pushgateway</strong>: 支持时序列数据使用PUSH模式推送的中间网关<li><strong>Prometheus Server</strong>: 提供PromQL查询语言能力、负责数据的采集和存储等主要功能<li><strong>Alertmanager</strong>: 是一个独立的组件，提供灵活的报警方式，比如Email、webhook等。<li><strong>Web UI</strong>: Prometheus本身提供一个非常简单的Web UI界面，这也是其代码中由小比例的JavaScript和TypeScript的原因。当然也可以结合Grafana进行监控数据的可视化展示。</ul><hr /><h3 id="2安装方法">2:安装方法</h3><h4 id="安装方式">安装方式</h4><p>Prometheus支持多种安装方式，比如：</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="c"># 1. Docker镜像方式</span>
<span class="c"># 最简单的方式莫过于直接使用Prometheus提供的官方镜像，</span>
<span class="c"># 使用如下执行命令即可在本地9090端口启动Prometheus服务。</span>
docker run <span class="nt">--name</span> prometheus <span class="nt">-d</span> <span class="nt">-p</span> 127.0.0.1:9090:9090 prom/prometheus

<span class="c"># 2. 二进制文件方式</span>
<span class="c"># 下载预先编译好的二进制文件然后进行安装和设置，下载地址可以是：</span>
<span class="c"># - https://prometheus.io/download/</span>
<span class="c"># - https://github.com/prometheus/prometheus/releases</span>
<span class="c"># 启动方法</span>
<span class="c"># - 解压操作系统相对应的二进制文件包，提供本地设定文件，</span>
<span class="c"># - 使用如下命令即可启动Prometheus服务了</span>
./prometheus <span class="nt">--config</span>.file<span class="o">=</span>prometheus.yml

<span class="c"># 3. 源码编译方式</span>
<span class="c"># 构建</span>
<span class="c"># - Prometheus使用go语言开发，所以本地只需要提供go的开发环境</span>
<span class="c"># - 然后git clone源码之后执行make即可构建出二进制文件</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$GOPATH</span>/src/github.com/prometheus
<span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/prometheus
git clone https://github.com/prometheus/prometheus.git
<span class="nb">cd </span>prometheus
make build
<span class="c"># 启动服务</span>
./prometheus <span class="nt">--config</span>.file<span class="o">=</span>prometheus.yml


<span class="c"># 4. 其他安装方式</span>
Ansible
<span class="k">*</span> https://github.com/cloudalchemy/ansible-prometheus
Chef
<span class="k">*</span> https://github.com/elijah/chef-prometheus
Puppet
<span class="k">*</span> https://forge.puppet.com/puppet/prometheus
SaltStack
<span class="k">*</span> https://github.com/saltstack-formulas/prometheus-formula
Helm
<span class="k">*</span> 直接使用helm install进行安装，需要注意的是相关版本的Chart是对于Helm 2还是Helm 3的支持。
</pre></table></code></div></div><h4 id="安装示例">安装示例</h4><p>整体来说Prometheus的安装就是一个二进制文件，下载、解压并设定权限，然后通过config.file指定配置文件即可完成安装并启动服务</p><p>各种方式基本上都是简化这一原本就很简单的过程而已。</p><p>这里以Docker方式的服务启动为例进行说明：</p><p>配置文件准备</p><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1"># prometheus-demo.yml</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">10s</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">10s</span>

<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">prometheus"</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">127.0.0.1:9090"</span><span class="pi">]</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">prometheus"</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c"># 下载最新版本的Prometheus镜像</span>
docker pull prom/prometheus

<span class="c"># 启动Prometheus服务</span>
<span class="c"># 把配置文件放在本地 ~/docker/prometheus/prometheus.yml，这样可以方便编辑和查看</span>
<span class="c"># 通过 -v 参数将本地的配置文件挂载到 /etc/prometheus/ 位置，这是 prometheus 在容器中默认加载的配置文件位置。</span>
<span class="c"># 如果不确定默认的配置文件在哪，可以先执行上面的不带 -v 参数的命令，然后通过 docker inspect 命名看看容器在运行时默认的参数有哪些（下面的 Args 参数）：</span>
docker run <span class="nt">-d</span> <span class="nt">-p</span> 9090:9090 <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/prometheus-demo.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
	<span class="nt">--name</span> prometheus prom/prometheus


docker run <span class="nt">-p</span> 9090:9090 <span class="se">\</span>
  <span class="nt">--network</span><span class="o">=</span>host <span class="se">\</span>
  <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/prometheus.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
  prom/prometheus


docker container start prometheus
</pre></table></code></div></div><h4 id="结果确认">结果确认</h4><p>通过<code class="language-plaintext highlighter-rouge">http://localhost:9090</code> 访问启动起来的Prometheus的UI界面，缺省进入的是Grap标签的所在页面：</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231055620111.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>Alerts标签界面信息</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231060311508.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>Status标签界面信息</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231060332842.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>Prometheus使用REACT重新改造了界面的显示，可以通过点 击Try experimental React UI进行体验</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231060649331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>确认metrics内容 <code class="language-plaintext highlighter-rouge">http://localhost:9090/metrics</code></p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231061551286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>稍微运行一会，选择一个指标，调节时间范围为15分钟，即可 看到指标的变化情况</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20191231061807669.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><hr /><h3 id="3指标监控示例">3:指标监控示例</h3><h4 id="事前准备">事前准备</h4><ul><li>Prometheus可以对各种指标数据进行监控，</ul><p>首先准备用于提供监控数据的应用程序。</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/prometheus/client_golang.git
</pre></table></code></div></div><p>启动Docker容器进行编译</p><ul><li>启动Docker并将待编译的工程进行卷的映射</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="c"># Automatically remove the container when it exits</span>
<span class="c"># The -it instructs Docker to allocate a pseudo-TTY connected to the container’s stdin; creating an interactive bash shell in the container.</span>
<span class="c"># Bind mount a volume</span>
<span class="c"># CPU shares (relative weight)</span>
docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/client_golang:/go/src liumiaocn/golang:1.13.5-alpine3.11 sh <span class="se">\</span>
	<span class="nt">-c</span> <span class="s1">'cd /go/src/examples/random &amp;&amp; go get -d &amp;&amp; go build &amp;&amp; ls -l random'</span>

docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/client_golang:/go/src golang:1.13.5-alpine3.11 sh <span class="se">\</span>
	<span class="nt">-c</span> <span class="s1">'cd /go/src/examples/random &amp;&amp; go get -d &amp;&amp; go build &amp;&amp; ls -l random'</span>
<span class="c"># go: downloading github.com/prometheus/common v0.7.0</span>
<span class="c"># go: downloading github.com/prometheus/client_model v0.1.0</span>
<span class="c"># go: extracting github.com/prometheus/client_model v0.1.0</span>
<span class="c"># go: downloading github.com/golang/protobuf v1.3.2</span>
<span class="c"># go: extracting github.com/prometheus/common v0.7.0</span>
<span class="c"># go: downloading github.com/matttproud/golang_protobuf_extensions v1.0.1</span>
<span class="c"># go: downloading golang.org/x/sys v0.0.0-20191220142924-d4481acd189f</span>
<span class="c"># go: downloading github.com/cespare/xxhash/v2 v2.1.1</span>
<span class="c"># go: downloading github.com/prometheus/procfs v0.0.8</span>
<span class="c"># go: downloading github.com/beorn7/perks v1.0.1</span>
<span class="c"># go: extracting github.com/golang/protobuf v1.3.2</span>
<span class="c"># go: extracting github.com/cespare/xxhash/v2 v2.1.1</span>
<span class="c"># go: extracting github.com/matttproud/golang_protobuf_extensions v1.0.1</span>
<span class="c"># go: extracting github.com/beorn7/perks v1.0.1</span>
<span class="c"># go: extracting github.com/prometheus/procfs v0.0.8</span>
<span class="c"># go: extracting golang.org/x/sys v0.0.0-20191220142924-d4481acd189f</span>
<span class="c"># go: finding github.com/prometheus/client_model v0.1.0</span>
<span class="c"># go: finding github.com/prometheus/common v0.7.0</span>
<span class="c"># go: finding github.com/beorn7/perks v1.0.1</span>
<span class="c"># go: finding github.com/cespare/xxhash/v2 v2.1.1</span>
<span class="c"># go: finding github.com/golang/protobuf v1.3.2</span>
<span class="c"># go: finding github.com/prometheus/procfs v0.0.8</span>
<span class="c"># go: finding github.com/matttproud/golang_protobuf_extensions v1.0.1</span>
<span class="c"># github.com/prometheus/procfs/internal/util</span>
<span class="c"># /go/pkg/mod/github.com/prometheus/procfs@v0.8.0/internal/util/parse.go:69:15: undefined: os.ReadFile</span>
<span class="c"># /go/pkg/mod/github.com/prometheus/procfs@v0.8.0/internal/util/parse.go:78:15: undefined: os.ReadFile</span>
<span class="c"># /go/pkg/mod/github.com/prometheus/procfs@v0.8.0/internal/util/readfile.go:36:9: undefined: io.ReadAll</span>
<span class="c"># note: module requires Go 1.17</span>

</pre></table></code></div></div><h4 id="配置prometheus">配置Prometheus</h4><p>将Prometheus进行如下配置：</p><ul><li>在8080-8082三个端口都提供了可供Prometheus进行监控指标数据，</ul><p>配置说明：</p><ul><li>设定job名称为example-random<li>数据的抓取时间间隔设定为5秒<li>将8080-8082三个监控对象分成两组，<ul><li>8080和8081一组，组标签名称为production，<li>8082为一组，组标签名称为canary</ul><li>ip（192.168.31.242）请修改为自己的IP，因为本文启动的内容均在容器之中，又没有使用link或者其他方式来使得各个容器之间的相互联通，这里直接使用IP方式使得Prometheus能够访问到这些对象机器。</ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1"># prometheus-random.yml</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">15s</span> <span class="c1"># By default, scrape targets every 15 seconds.</span>
  <span class="c1"># Attach these labels to any time series or alerts when communicating with</span>
  <span class="c1"># external systems (federation, remote storage, Alertmanager).</span>
  <span class="na">external_labels</span><span class="pi">:</span>
    <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># Here it's Prometheus itself.</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="c1"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">go-test"</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">60s</span>
  <span class="na">scrape_timeout</span><span class="pi">:</span> <span class="s">60s</span>
  <span class="na">metrics_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/metrics"</span>
  <span class="na">static_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">localhost:8888"</span><span class="pi">]</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-random"</span>
    <span class="c1"># Override the global default and scrape targets from this job every 5 seconds.</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">192.168.31.242:8080"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">192.168.31.242:8081"</span><span class="pi">]</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">production"</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">192.168.31.242:8082"</span><span class="pi">]</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">canary"</span>
</pre></table></code></div></div><p>可以看到配置文件中指定了一个job_name</p><ul><li>所要监控的任务即视为一个job<li>scrape_interval, scrape_timeout 是pro进行数据采集的时间间隔和频率，<li>metrics_path 指定了访问数据的http路径，<li>target 是目标的ip:port,这里使用的是同一台主机上的8888端口。<ul><li>[“localhost:8888”]<li>or [“xx.xx.xx.xx:8888”]</ul></ul><h4 id="启动-prometheus服务">启动 Prometheus服务</h4><p>配置好之后就可以启动 or 重启 Prometheus服务 了</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># 使用如下命令启动Prometheus服务</span>
docker run <span class="nt">-d</span> <span class="nt">-p</span> 9090:9090 <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/prometheus-demo.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
	<span class="nt">--name</span> prometheus prom/prometheus

docker run <span class="nt">-d</span> <span class="nt">-p</span> 9090:9090 <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/prometheus-random.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
	<span class="nt">--name</span> prometheus prom/prometheus

docker run <span class="nt">--network</span><span class="o">=</span>host <span class="nt">-p</span> 9090:9090 <span class="se">\</span>
  <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/prometheus.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
  prom/prometheus

<span class="c"># 确认Promtheus容器状态</span>
docker ps |grep prometheus
<span class="c"># 1f9d3831c1d2        prom/prometheus     "/bin/prometheus --c…"   About a minute ago   Up 59 seconds       0.0.0.0:9090-&gt;9090/tcp   prometheus</span>
</pre></table></code></div></div><p>此处网络通信采用的是host模式</p><ul><li>所以docker中的pro可以直接通过localhost来指定同一台主机上所监控的程序。<li>prob暴露9090端口进行界面显示或其他操作，需要对docker中9090端口进行映射。<li>启动之后可以访问web页面http://localhost:9090/graph,在status下拉菜单中可以看到配置文件和目标的状态<li>此时目标状态为DOWN，因为所需要监控的服务还没有启动起来</ul><p><img data-proofer-ignore data-src="https://github.com/ocholuo/ocholuo.github.io/blob/master/assets/img/note/Screenshot%202022-11-02%20at%2011.39.11_4alo4l7ok.png" alt="Screenshot 2022-11-02 at 11.39.11" /></p><p>步入正文，用pro golang client来实现程序吧。</p><h4 id="pro-golang-client">pro golang client</h4><div class="language-py highlighter-rouge"><div class="code-header" text-data="py"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">metrics</span> <span class="n">name</span> <span class="p">{(</span><span class="n">label</span><span class="p">)</span><span class="n">key</span><span class="o">-</span><span class="n">value</span><span class="p">}</span> <span class="n">float64</span> <span class="n">value</span>

<span class="c1"># HELP go_gc_duration_seconds A summary of the GC invocation durations.
# TYPE go_gc_duration_seconds summary
</span><span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"0.5"</span><span class="p">}</span> <span class="mf">0.000107458</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"0.75"</span><span class="p">}</span> <span class="mf">0.000200112</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"1"</span><span class="p">}</span> <span class="mf">0.000299278</span>
<span class="n">go_gc_duration_seconds_sum</span> <span class="mf">0.002341738</span>
<span class="n">go_gc_duration_seconds_count</span> <span class="mi">18</span>

<span class="c1"># HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
</span><span class="n">go_goroutines</span> <span class="mi">107</span>
</pre></table></code></div></div><p>A Basic Example 演示了使用这些数据类型的方法（注意将其中8080端口改为本文的8888）</p><ul><li><p>其中创建了一个 gauge 和 CounterVec 对象，并分别指定了 metric name 和 help 信息</p><li>其中 CounterVec 是用来管理相同 metric 下不同 label 的一组 Counter<ul><li>代码中声明了一个lable的key为<code class="language-plaintext highlighter-rouge">device</code><li>使用的时候也需要指定一个 label<ul><li><code class="language-plaintext highlighter-rouge">hdFailures.With(prometheus.Labels{"device":"/dev/sda"}).Inc()</code></ul></ul><li><p>同理存在GaugeVec，</p><li>变量定义后进行注册<li>最后再开启一个http服务的8888端口就完成了整个程序<li>pro采集数据是通过定期请求该服务http端口来实现的。</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"log"</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="p">(</span>
	<span class="n">cpuTemp</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span> <span class="s">"cpu_temperature_celsius"</span><span class="p">,</span>
		<span class="n">Help</span><span class="o">:</span> <span class="s">"Current temperature of the CPU."</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="n">hdFailures</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="s">"hd_errors_total"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"Number of hard-disk errors."</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"device"</span><span class="p">},</span>
	<span class="p">)</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// Metrics have to be registered to be exposed:</span>
	<span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">cpuTemp</span><span class="p">)</span>
	<span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">hdFailures</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">cpuTemp</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="m">65.3</span><span class="p">)</span>
	<span class="n">hdFailures</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"device"</span><span class="o">:</span><span class="s">"/dev/sda"</span><span class="p">})</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>

	<span class="c">// The Handler function provides a default handler to expose metrics</span>
	<span class="c">// via an HTTP server. "/metrics" is the usual endpoint for that.</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8888"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><p>启动程序之后可以在web浏览器里输入http://localhost:8888/metrics 就可以得到client暴露的数据</p><ul><li>其中有片段显示为：</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># HELP cpu_temperature_celsius Current temperature of the CPU.</span>
<span class="c"># TYPE cpu_temperature_celsius gauge</span>
cpu_temperature_celsius 65.3

<span class="c"># HELP hd_errors_total Number of hard-disk errors.</span>
<span class="c"># TYPE hd_errors_total counter</span>
hd_errors_total<span class="o">{</span><span class="nv">device</span><span class="o">=</span><span class="s2">"/dev/sda"</span><span class="o">}</span> 1
</pre></table></code></div></div><ul><li>上图就是示例程序所暴露出来的数据<ul><li>并且可以看到counterVec是有label的<li>而单纯的gauage对象却不用lable标识，<li>这就是基本数据类型和对应Vec版本的差别。</ul><li>此时再查看http://localhost:9090/graph 就会发现服务状态已经变为UP了。</ul><p><img data-proofer-ignore data-src="https://github.com/ocholuo/ocholuo.github.io/blob/master/assets/img/note/Screenshot%202022-11-02%20at%2012.21.31.png" alt="Screenshot 2022-11-02 at 12.21.31" /></p><p>上面的例子只是一个简单的demo0</p><ul><li>因为在prometheus.yml配置文件中指定采集服务器信息的时间间隔为60s<ul><li>每隔60s pro会通过http请求一次自己暴露的数据</ul><li>而在代码中只设置了一次gauge变量cupTemp的值<ul><li>如果在60s的采样间隔里将该值设置多次，前面的值就会被覆盖，只有pro采集数据那一刻的值能被看到<li>并且如果不再改变这个值，pro就始终能看到这个恒定的变量，除非用户显式通过Delete函数删除这个变量。</ul><li>使用Counter,Gauage等这些结构比较简单，但是如果不再使用这些变量需要手动删，可以调用resetfunction来清除之前的metrics。</ul><h4 id="启动监控对象进程">启动监控对象进程</h4><ul><li>分别在8080-8082三个端口启动三个服务用于提供Prometheus监控的对象进程。</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>docker run <span class="nt">-p</span> 8080:8080 <span class="nt">-d</span> <span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/random:/random <span class="se">\</span>
	<span class="nt">--rm</span> alpine /random <span class="se">\</span>
	<span class="nt">-listen-address</span><span class="o">=</span>:8080
<span class="c"># 22da3e4803b8fc7b31b0ebb7b8eac0afc188c62bfc1e1ae58f26ebf56178f3b8</span>

docker run <span class="nt">-p</span> 8081:8081 <span class="nt">-d</span> <span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/random:/random <span class="se">\</span>
	<span class="nt">--rm</span> alpine /random <span class="se">\</span>
	<span class="nt">-listen-address</span><span class="o">=</span>:8081
<span class="c"># ed35547ffb865df313236adab20d0c20164f051a45df9f59c93df6e1ddaec4b6</span>

docker run <span class="nt">-p</span> 8082:8082 <span class="nt">-d</span> <span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/random:/random <span class="se">\</span>
	<span class="nt">--rm</span> alpine /random <span class="se">\</span>
	<span class="nt">-listen-address</span><span class="o">=</span>:8082
<span class="c"># 4e7da2844b26b67b41ad43b52673fccb95d7631c88906d3dff1f244dff62a43e</span>
</pre></table></code></div></div><p>结果确认：容器状态确认</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>docker ps
<span class="c"># CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span>
<span class="c"># 4e7da2844b26        alpine              "/random -listen-add…"   2 seconds ago       Up 1 second         0.0.0.0:8082-&gt;8082/tcp   ecstatic_hypatia</span>
<span class="c"># ed35547ffb86        alpine              "/random -listen-add…"   10 seconds ago      Up 9 seconds        0.0.0.0:8081-&gt;8081/tcp   blissful_jennings</span>
<span class="c"># 22da3e4803b8        alpine              "/random -listen-add…"   21 seconds ago      Up 20 seconds       0.0.0.0:8080-&gt;8080/tcp   nervous_bell</span>
</pre></table></code></div></div><p>结果确认：指标确认</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>curl http://localhost:8080/metrics 2&gt;/dev/null |wc <span class="nt">-l</span>
<span class="c">#  164</span>

curl http://localhost:8081/metrics 2&gt;/dev/null |wc <span class="nt">-l</span>
<span class="c">#  164</span>

curl http://localhost:8082/metrics 2&gt;/dev/null |wc <span class="nt">-l</span>
<span class="c">#  164</span>
</pre></table></code></div></div><h4 id="结果确认-1">结果确认</h4><p>确认连接状态</p><p>Prometheus从<code class="language-plaintext highlighter-rouge">8080-8082</code>的端口获取监控数据，而这些连接是否正常，可以从如下界面进行确认</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102145254446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>获取的指标信息</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/2020010214533735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>查看某一指标的实时状况</p><p>Prometheus也具有一点可视化的能力，比如可以直接确认选中的某项指标的一定时间段（缺省1个小时，这里选择为5分钟）的变化情况</p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102145520356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><hr /><h3 id="4使用grafana进行可视化显示">4:使用Grafana进行可视化显示</h3><h4 id="事前准备-1">事前准备</h4><ul><li>这里仍然使用前文所创建的random进程提供的指标数据信息，详细设定过程可参看：<a href="https://liumiaocn.blog.csdn.net/article/details/103405873">link</a></ul><p>Grafana准备</p><ul><li>Grafana从2015年10发布的2.5.0版本开始支持对对Prometheus数据源，在本文的示例中将使用6.5.1版本进行可视化显示的演示。</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># 拉取镜像</span>
docker pull grafana/grafana:6.5.1

<span class="c"># 启动Grafana服务</span>
docker run <span class="nt">-d</span> <span class="nt">-p</span> 3000:3000 <span class="se">\</span>
	<span class="nt">--name</span> grafana grafana/grafana:6.5.1
</pre></table></code></div></div><p>设定Prometheus数据源</p><ul><li>启动Grafana和Prometheus之后，使用如下步骤即可在Grafana中添加Prometheus的数据源。</ul><p>步骤1: 登录Grafana</p><ul><li>使用缺省的admin/admin账号登录Grafana，<li>登录之后可以修改缺省密码也可直接跳过 passwd</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102154218450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>步骤2: 添加Prometheus数据源</p><ul><li>点击 Add data source进行数据源的添加</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102154412917.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>Grafana支持很多可视化展示的数据源，这里选择Prometheus</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102154525774.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>设定Prometheus的URL，由于本文示例中各个服务均使用单独的容器启动，所以这里直接使用可以访问的IP来进行设定，除了IP的设定之外其余均可使用缺省设定，点击Save &amp; Test按钮确认连接是否正常</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200102154830793.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>这样数据源的添加就完成了，后续如果需要进行修改或者删除等操作，可通过下图左侧Configuration菜单中的data sources选项进行操作即可。</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103050507289.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>设定可视化显示的仪表盘</p><ul><li>在数据源配置和连通性测试成功之后，即可在Grafana中创建定制的仪表盘了。点击下图中的New Dashboard按钮或者左侧Dashboard菜单的Manage选项即可进行仪表盘的创建。</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103050807417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>在接下来的页面中选择Choose Visualization</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103051111792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>点击Panel Title下拉菜单的Edit选项即可进行编辑</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103051412644.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>另外选择左侧的General按钮，则可对Panel Title的标题进行修改，比如此处修改为Random-Metrics-Info</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103051700741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>实际上这时并没有数据，所以这里点击左下侧四个按钮的第一个，是设定可视化来源的数据信息的。可以看到在Metrics页面可以看到监控的各项指标，这里选取其中一项进行显示，同时将时间范围设定为15分钟（这里只是为了方便示例结果的演示）</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103052115278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>点击保存按钮，将此Dashboard设定名称并点击Save按钮，缺省会保存到General目录下（也可以点击Gneral的下拉菜单创建新的保存目录）</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103052441545.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>保存之后结果如下所示</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103052610779.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>这时就可以随意拖拽进行可视化显示的调节了</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103052723578.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>然后使用相同的步骤再添加两个指标进行设定和显示，</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103053339838.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103053349762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>此时自定义的仪表盘已经变成了这样</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/2020010305343729.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><ul><li>可以进行随意拖拽和调整大小与位置，比如可以调整成这样</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200103053609231.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><hr /><h3 id="5在kubernetes上部署">5:在Kubernetes上部署</h3><p>Prometheus安装方法</p><ul><li>在Kubernetes上直接部署Prometheus也非常简单，<li>使用ConfigMap管理配置文件，然后使用卷方式挂载，<li>然后创建Deployment和Service即可使用了。</ul><p>事前准备</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl get node <span class="nt">-o</span> wide
<span class="c"># NAME              STATUS   ROLES    AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME</span>
<span class="c"># 192.168.163.131   Ready    &lt;none&gt;   20h   v1.17.0   192.168.163.131   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.el7.x86_64   docker://18.9.7</span>
</pre></table></code></div></div><p>步骤1: 创建ConfigMap</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c"># 创建Prometheus使用的ConfigMap配置，所使用的yaml文件如下所示</span>
<span class="c"># prometheus.yml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-configmap
  namespace: default
data:
  prometheus.yml: |
    global:
      scrape_interval:     10s
      evaluation_interval: 10s
    scrape_configs:
      - job_name: <span class="s1">'prometheus'</span>
        static_configs:
        - targets: <span class="o">[</span><span class="s1">'localhost:9090'</span><span class="o">]</span>


<span class="c"># 创建并确认ConfigMap配置</span>
kubectl create <span class="nt">-f</span> prometheus.yml
<span class="c"># configmap/prometheus-configmap created</span>

kubectl get cm
<span class="c"># NAME                   DATA   AGE</span>
<span class="c"># prometheus-configmap   1      4s</span>
kubectl describe cm prometheus-configmap
<span class="c"># Name:         prometheus-configmap</span>
<span class="c"># Namespace:    default</span>
<span class="c"># Labels:       &lt;none&gt;</span>
<span class="c"># Annotations:  &lt;none&gt;</span>

<span class="c"># Data</span>
<span class="c"># ====</span>
<span class="c"># prometheus.yml:</span>
<span class="c"># ----</span>
<span class="c"># global:</span>
<span class="c">#   scrape_interval:     10s</span>
<span class="c">#   evaluation_interval: 10s</span>
<span class="c"># scrape_configs:</span>
<span class="c">#   - job_name: 'prometheus'</span>
<span class="c">#     static_configs:</span>
<span class="c">#     - targets: ['localhost:9090']</span>

<span class="c"># Events:  &lt;none&gt;</span>
</pre></table></code></div></div><p>步骤2: 创建Service与Deployment</p><ul><li>首先准备如下的yaml文件，包含了Prometheus所需的Deployment和Service的配置</ul><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="s">prometheus-deployment.yml</span>
    <span class="s">---</span>
    <span class="s">apiVersion</span><span class="err">:</span> <span class="s">v1</span>
    <span class="s">kind</span><span class="err">:</span> <span class="s2">"</span><span class="s">Service"</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
        <span class="na">targetPort</span><span class="pi">:</span> <span class="m">9090</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
    <span class="s">...</span>
    <span class="s">---</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">selector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
      <span class="na">template</span><span class="pi">:</span>
        <span class="na">metadata</span><span class="pi">:</span>
          <span class="na">labels</span><span class="pi">:</span>
            <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">prom/prometheus:v2.15.1</span>
            <span class="na">command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">/bin/prometheus"</span>
            <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">--config.file=/etc/prometheus/prometheus.yml"</span>
            <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9090</span>
              <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
            <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/prometheus"</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-configmap</span>
          <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-configmap</span>
            <span class="na">configMap</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-configmap</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># 创建Service与Deployment</span>
kubectl create <span class="nt">-f</span> prometheus-deployment.yml
<span class="c"># service/prometheus created</span>
<span class="c"># deployment.apps/prometheus created</span>


<span class="c"># 确认Service信息</span>
kubectl get service <span class="nt">-o</span> wide
<span class="c"># NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE   SELECTOR</span>
<span class="c"># kubernetes   ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP          20h   &lt;none&gt;</span>
<span class="c"># prometheus   NodePort    10.254.229.211   &lt;none&gt;        9090:30944/TCP   7s    app=prometheus</span>


<span class="c"># 确认Pod信息</span>
kubectl get pods
<span class="c"># NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c"># prometheus-fcd87fbf4-ljzrb   1/1     Running   0          13s</span>
</pre></table></code></div></div><p>步骤3: 结果确认</p><ul><li>在30944端口即可确认刚刚部署的Prometheus的运行状况</ul><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200104063822495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><hr /><h2 id="exporter概要介绍">Exporter概要介绍</h2><p><img data-proofer-ignore data-src="https://img-blog.csdnimg.cn/20200113145037917.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="pic" /></p><p>Exporter</p><ul><li>为Prometheus提供监控数据源的应用都可以被成为Exporter，<li>比如Node Exporter则用来提供节点相关的资源使用状况，而Prometheus从这些不同的Exporter中获取监控数据，然后可以在诸如Grafana这样的可视化工具中进行结果的显示。</ul><p>Exporter的类型</p><ul><li>Exporter根据来源可以分为：社区提供的Exporter和自定义的Exporter两种<li>Exporter根据支持方式可以分为：很多软件现在已经内嵌支持Prometheus，比如kubernetes或者etcd，简单来说这种类型的软件中不需要单独的Exporter用于提供给Prometheus的监控数据的功能，这是其本身的功能特性之一。当然更多的情况则是通过独立运行的Exporter来进行，比如Node Exporter，操作系统本身由于不像kubernetes那样提供对于Prometheus的支持，所以需要单独运行Node Exporter用于提供节点自身的信息给Prometheus进行监控。</ul><p>社区常见的Exporter</p><p>数据库 常见的主流数据库几乎逗留相应的Exporter，详细如下所示：</p><ul><li>MongoDB exporter<li>MSSQL server exporter<li>MySQL server exporter (official)<li>OpenTSDB Exporter<li>Oracle DB Exporter<li>PostgreSQL exporter<li>Redis exporter<li>ElasticSearch exporter<li>RethinkDB exporter<li>Consul exporter (official)</ul><p>消息队列</p><ul><li>Kafka exporter<li>IBM MQ exporter<li>RabbitMQ exporter<li>RocketMQ exporter<li>NSQ exporter<li>Gearman exporter</ul><p>存储</p><ul><li>Ceph exporter<li>Gluster exporter<li>Hadoop HDFS FSImage exporter</ul><p>硬件相关</p><ul><li>Node/system metrics exporter (official)<li>Dell Hardware OMSA exporter<li>IoT Edison exporter<li>IBM Z HMC exporter<li>NVIDIA GPU exporter</ul><p>问题追踪与持续集成</p><ul><li>Bamboo exporter<li>Bitbucket exporter<li>Confluence exporter<li>Jenkins exporter<li>JIRA exporter</ul><p>HTTP服务</p><ul><li>Apache exporter<li>HAProxy exporter (official)<li>Nginx metric library<li>Nginx VTS exporter<li>Passenger exporter<li>Squid exporter<li>Tinyproxy exporter<li>Varnish exporter<li>WebDriver exporter</ul><p>API服务</p><ul><li>AWS ECS exporter<li>AWS Health exporter<li>AWS SQS exporter<li>Cloudflare exporter<li>DigitalOcean exporter<li>Docker Cloud exporter<li>Docker Hub exporter<li>GitHub exporter<li>InstaClustr exporter<li>Mozilla Observatory exporter<li>OpenWeatherMap exporter<li>Pagespeed exporter<li>Rancher exporter<li>Speedtest exporter<li>Tankerkönig API Exporter</ul><p>日志</p><ul><li>Fluentd exporter<li>Google’s mtail log data extractor<li>Grok exporter</ul><p>监控系统</p><ul><li>Akamai Cloudmonitor exporter<li>Alibaba Cloudmonitor exporter<li>AWS CloudWatch exporter (official)<li>Azure Monitor exporter<li>Cloud Foundry Firehose exporter<li>Collectd exporter (official)<li>Google Stackdriver exporter<li>Graphite exporter (official)<li>Huawei Cloudeye exporter<li>InfluxDB exporter (official)<li>JavaMelody exporter<li>JMX exporter (official)<li>Nagios / Naemon exporter<li>Sensu exporter<li>SNMP exporter (official)<li>TencentCloud monitor exporter<li>ThousandEyes exporter</ul><p>其他</p><ul><li>BIND exporter<li>Bitcoind exporter<li>cAdvisor<li>Dnsmasq exporter<li>Ethereum Client exporter<li>JFrog Artifactory Exporter<li>JMeter plugin<li>Kibana Exporter<li>kube-state-metrics<li>OpenStack exporter<li>PowerDNS exporter<li>Script exporter<li>SMTP/Maildir MDA blackbox prober<li>WireGuard exporter<li>Xen exporter</ul><p>使用方式</p><ul><li>Prometheus Server提供PromQL查询语言能力、负责数据的采集和存储等主要功能，<li>而数据的采集主要通过周期性的从Exporter所暴露出来的HTTP服务地址（一般是/metrics）来获取监控数据。<li>而Exporter在实际运行的时候根据其支持的方式也会分为：<ul><li>独立运行的Exporter应用，通过HTTP服务地址提供相应的监控数据（比如Node Exporter）<li>内置在监控目标中，通过HTTP服务地址提供相应的监控数据（比如kubernetes）</ul></ul><p>Prometheus 属于 CNCF 项目</p><ul><li>拥有完整的开源生态，与 Zabbix 这种传统 agent 监控不同，它提供了丰富的 exporter 来满足你的各种需求。<li>你可以在这里看到官方、非官方的 exporter。如果还是没满足你的需求，你还可以自己编写 exporter，简单方便、自由开放，这是优点。Prometheus：https://prometheus.io/docs/instrumenting/exporters/<li>但是过于开放就会带来选型、试错成本。之前只需要在 zabbix agent里面几行配置就能完成的事，现在你会需要很多 exporter 搭配才能完成。还要对所有 exporter 维护、监控。尤其是升级 exporter 版本时，很痛苦。非官方exporter 还会有不少 bug。这是使用上的不足，当然也是 Prometheus 的设计原则。</ul><p>K8S 生态的组件都会提供/metric接口以提供自监控:</p><ul><li>cadvisor: 集成在 Kubelet 中。<li>kubelet: 10255为非认证端口，10250为认证端口。<li>apiserver: 6443端口，关心请求数、延迟等。<li>scheduler: 10251端口。<li>controller-manager: 10252端口。<li>etcd: 如etcd 写入读取延迟、存储容量等。<li>docker: 需要开启 experimental 实验特性，配置 metrics-addr，如容器创建耗时等指标。<li>kube-proxy: 默认 127 暴露，10249端口。外部采集时可以修改为 0.0.0.0 监听，会暴露：写入 iptables 规则的耗时等指标。<li>kube-state-metrics: K8S 官方项目，采集pod、deployment等资源的元信息。<li>node-exporter: Prometheus 官方项目，采集机器指标如 CPU、内存、磁盘。<li>blackbox_exporter: Prometheus 官方项目，网络探测，dns、ping、http监控<li>process-exporter: 采集进程指标<li>nvidia exporter: 有 gpu 任务，需要 gpu 数据监控<li>node-problem-detector: 即 npd，准确的说不是 exporter，但也会监测机器状态，上报节点异常打 taint<li>应用层 exporter: mysql、nginx、mq等，看业务需求。<li>cadvisor：http://www.xuyasong.com/?p=1483<li>kube-state-metrics：http://www.xuyasong.com/?p=1525<li>node-exporter：http://www.xuyasong.com/?p=1539</ul><p>自定义 exporter：http://www.xuyasong.com/?p=1942</p><h3 id="exporter">exporter</h3><p>以下是一个简单的exporter</p><ul><li>通过http模块指定了一个路径，并将<code class="language-plaintext highlighter-rouge">client_golang</code>库中的<code class="language-plaintext highlighter-rouge">promhttp.Handler()</code>作为处理函数传递进去后，就可以获取指标信息了,<li>两行代码实现了一个exporter。<li>这里内部其实是使用了一个默认的收集器将通过NewGoCollector采集当前Go运行时的相关信息比如go堆栈使用,goroutine的数据等等。 通过访问http://localhost:8080/metrics 即可查看详细的指标参数。<li>上面的代码仅仅展示了一个默认的采集器，并且通过接口调用隐藏了太多实施细节</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c">// 下载对应的prometheus包</span>
<span class="k">go</span> <span class="n">get</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">client_golang</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">promhttp</span>

<span class="c">// 程序主函数:</span>
<span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>
    <span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="cadvisor">Cadvisor</h3><p>Cadvisor 的指标兼容问题</p><p>在 K8S 1.16版本，Cadvisor 的指标去掉了 pod_Name 和 container_name 的 label，替换为了pod 和 container。</p><ul><li>注意要用 metric_relabel_configs，不是 relabel_configs，采集后做的replace。</ul><hr /><h3 id="expose-custom-metrics-to-prometheus">expose custom metrics to Prometheus</h3><blockquote><p>ref:</p><ul><li>https://zhimin-wen.medium.com/custom-prometheus-metrics-for-apps-running-in-kubernetes-498d69ada7aa</ul></blockquote><p>step</p><ul><li>Develop the custom metrics with Prometheus Client API on a toy app<li>Deploy the app into Kubernetes (IBM Cloud Private)<li>Configure Prometheus in Kubernetes to scrape the metrics<li>Present the result in Grafana dashboard. Especially explore the dashboard for multiple replicas of the pod.</ul><hr /><h5 id="app-with-metric">App with metric</h5><ol><li>use the Prometheus Golang Client API to provide some custom metrics for a hello world web application.<li>The HTTP service is being instrumented with three metrics:<ol><li>Total transaction till now, implemented as a Prometheus Counter.<li>Currently active client, as a Prometheus Gauge.<li>Response time distribution, as a Prometheus Histogram.</ol></ol><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"log"</span>
	<span class="s">"net/http"</span>
	<span class="s">"os"</span>
	<span class="s">"strconv"</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promauto"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">PrometheusHttpMetric</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Prefix</span>                <span class="kt">string</span>
	<span class="n">ClientConnected</span>       <span class="n">prometheus</span><span class="o">.</span><span class="n">Gauge</span>
	<span class="n">TransactionTotal</span>      <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">CounterVec</span>
	<span class="n">ResponseTimeHistogram</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramVec</span>
	<span class="n">Buckets</span>               <span class="p">[]</span><span class="kt">float64</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">InitPrometheusHttpMetric</span><span class="p">(</span><span class="n">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="n">buckets</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">)</span> <span class="o">*</span><span class="n">PrometheusHttpMetric</span> <span class="p">{</span>
	<span class="n">phm</span> <span class="o">:=</span> <span class="n">PrometheusHttpMetric</span><span class="p">{</span>
		<span class="n">Prefix</span><span class="o">:</span> <span class="n">prefix</span><span class="p">,</span>
		<span class="n">ClientConnected</span><span class="o">:</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"_client_connected"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"Number of active client connections"</span><span class="p">,</span>
		<span class="p">}),</span>
		<span class="n">TransactionTotal</span><span class="o">:</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"_requests_total"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"total HTTP requests processed"</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"code"</span><span class="p">,</span> <span class="s">"method"</span><span class="p">},</span>
		<span class="p">),</span>
		<span class="n">ResponseTimeHistogram</span><span class="o">:</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewHistogramVec</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span>    <span class="n">prefix</span> <span class="o">+</span> <span class="s">"_response_time"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span>    <span class="s">"Histogram of response time for handler"</span><span class="p">,</span>
			<span class="n">Buckets</span><span class="o">:</span> <span class="n">buckets</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"handler"</span><span class="p">,</span> <span class="s">"method"</span><span class="p">}),</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">phm</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">phm</span> <span class="o">*</span><span class="n">PrometheusHttpMetric</span><span class="p">)</span> <span class="n">WrapHandler</span><span class="p">(</span><span class="n">handlerLabel</span> <span class="kt">string</span><span class="p">,</span> <span class="n">handlerFunc</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="n">handle</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">handlerFunc</span><span class="p">)</span>
	<span class="n">wrappedHandler</span> <span class="o">:=</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerInFlight</span><span class="p">(</span><span class="n">phm</span><span class="o">.</span><span class="n">ClientConnected</span><span class="p">,</span>
		<span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerCounter</span><span class="p">(</span><span class="n">phm</span><span class="o">.</span><span class="n">TransactionTotal</span><span class="p">,</span>
			<span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerDuration</span><span class="p">(</span><span class="n">phm</span><span class="o">.</span><span class="n">ResponseTimeHistogram</span><span class="o">.</span><span class="n">MustCurryWith</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"handler"</span><span class="o">:</span> <span class="n">handlerLabel</span><span class="p">}),</span>
				<span class="n">handle</span><span class="p">),</span>
		<span class="p">),</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">wrappedHandler</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">myHandler</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cost</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s">"cost"</span><span class="p">)</span>
	<span class="n">val</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">ParseFloat</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="m">64</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"Fail to convert cost as float value"</span><span class="p">,</span> <span class="m">500</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="n">sleep</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">val</span><span class="o">*</span><span class="m">1e+9</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Nanosecond</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"Time spend for this request: %.2f"</span><span class="p">,</span> <span class="n">sleep</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">phm</span> <span class="o">:=</span> <span class="n">InitPrometheusHttpMetric</span><span class="p">(</span><span class="s">"myapp"</span><span class="p">,</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">LinearBuckets</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">20</span><span class="p">))</span>

	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/service"</span><span class="p">,</span> <span class="n">phm</span><span class="o">.</span><span class="n">WrapHandler</span><span class="p">(</span><span class="s">"myhandler"</span><span class="p">,</span> <span class="n">myHandler</span><span class="p">))</span>

	<span class="n">port</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"LISTENING_PORT"</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="s">"8080"</span>
	<span class="p">}</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"listening on port:%s"</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

	<span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":"</span><span class="o">+</span><span class="n">port</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Failed to start server:%v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>check it</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># test run it with some random curl command to populate the Prometheus metrics</span>
<span class="nv">$ </span>curl localhost:8080/service?cost<span class="o">=</span>0.2
Time spend <span class="k">for </span>this request: 0.20


<span class="c"># check the metrics by accessing the URL and grepping only the prefix of `myapp`</span>
<span class="nv">$ </span>curl localhost:8080/metrics | <span class="nb">grep </span>myapp
<span class="c"># HELP myapp_client_connected Number of active client connections</span>
<span class="c"># TYPE myapp_client_connected gauge</span>
myapp_client_connected 0.0
<span class="c"># HELP myapp_requests_total total HTTP requests processed</span>
<span class="c"># TYPE myapp_requests_total counter</span>
myapp_requests_total<span class="o">{</span><span class="nv">code</span><span class="o">=</span><span class="s2">"200"</span>,method<span class="o">=</span><span class="s2">"get"</span><span class="o">}</span> 1.0
<span class="c"># HELP myapp_response_time Histogram of response time for handler</span>
<span class="c"># TYPE myapp_response_time histogram</span>
myapp_response_time_bucket<span class="o">{</span><span class="nv">handler</span><span class="o">=</span><span class="s2">"myhandler"</span>,method<span class="o">=</span><span class="s2">"get"</span>,le<span class="o">=</span><span class="s2">"0.0"</span><span class="o">}</span> 0.0
</pre></table></code></div></div><h4 id="deploy-into-kubernetes">Deploy into Kubernetes</h4><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c"># Use the multi-stage build Dockerfile to build the docker image.</span>
FROM golang:alpine AS builder
RUN apk update <span class="o">&amp;&amp;</span> apk add <span class="nt">--no-cache</span> git
COPY src <span class="nv">$GOPATH</span>/src/zhiminwen/hpasimulator
WORKDIR <span class="nv">$GOPATH</span>/src/zhiminwen/hpasimulator
RUN go get <span class="nt">-d</span> <span class="nt">-v</span>
RUN go build <span class="nt">-o</span> /tmp/simulator <span class="k">*</span>.go

FROM alpine
RUN addgroup <span class="nt">-S</span> appgroup <span class="o">&amp;&amp;</span> adduser <span class="nt">-S</span> appuser <span class="nt">-G</span> appgroup <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /app
COPY <span class="nt">--from</span><span class="o">=</span>builder /tmp/simulator /app
RUN <span class="nb">chmod </span>a+rx /app/simulator

USER appuser
WORKDIR /app
ENV LISTENING_PORT 8080

CMD <span class="o">[</span><span class="s2">"./simulator"</span><span class="o">]</span>
</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hpa-sim</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">hpa-sim</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">hpa-sim</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hpa-sim</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">hpa-sim</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">hpa-sim</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">hpa-sim</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">hpa-sim</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">zhiminwen/hpa-sim:v1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">LISTENING_PORT</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">8080"</span>
</pre></table></code></div></div><h5 id="scrape-metrics-from-prometheus">Scrape Metrics from Prometheus</h5><ol><li>Prometheus using the pull method to bring in the metrics.<li>Need to configure Prometheus to scrape the app for the custom metrics.</ol><p>couple of ways to scrape the custom metrics:</p><ul><li>use the default <code class="language-plaintext highlighter-rouge">kubernetes-pods</code> job which will scape the pod that has the annotation of</ul><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">prometheus.io/scrape</span><span class="pi">:</span> <span class="kc">true</span><span class="s"> for enabling the scraping</span>
<span class="na">prometheus.io/path</span><span class="pi">:</span> <span class="s">If the metrics path is not `/metrics` override this.</span>
<span class="na">prometheus.io/port</span><span class="pi">:</span> <span class="s">Specify the non-default port other than </span><span class="m">9090</span>
</pre></table></code></div></div><ul><li>Updating the Prometheus config YAML file.<ul><li>to have more control over the scraping job on the frequency and labeling.<li>create a dedicate job for the custom metrics.</ul></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl get cm monitoring-prometheus <span class="se">\</span>
  <span class="nt">-n</span> kube-system <span class="se">\</span>
  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.prometheus\.yml }'</span> <span class="o">&gt;</span> prom.yaml
</pre></table></code></div></div><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s">hpa-sim</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">10s</span>
    <span class="na">kubernetes_sd_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s">pod</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">hpa-sim.default:80"</span>
    <span class="na">relabel_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_pod_label_app</span><span class="pi">]</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">keep</span>
        <span class="na">regex</span><span class="pi">:</span> <span class="s">hpa-sim</span>

      <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__address__</span><span class="pi">]</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
        <span class="na">target_label</span><span class="pi">:</span> <span class="s">__address__</span>
        <span class="na">regex</span><span class="pi">:</span> <span class="s">([^:]+)(?::\d+)?</span>
        <span class="na">replacement</span><span class="pi">:</span> <span class="s">${1}:8080</span>

      <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_namespace</span><span class="pi">]</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
        <span class="na">target_label</span><span class="pi">:</span> <span class="s">k8s_namespace</span>

      <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_pod_name</span><span class="pi">]</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
        <span class="na">target_label</span><span class="pi">:</span> <span class="s">k8s_pod_name</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">static_configs</code></p><ul><li>In terms of the target, one way is to use a static config</ul><p><code class="language-plaintext highlighter-rouge">kubernetes_sd_configs</code></p><ul><li>Prometheus is running inside the cluster<ul><li>Prometheus can reach the app using its service name.</ul><li>However, the scraping will be managed by the load balancing mechanism of the K8s service.<ul><li>If there are multiple pods running, not all the pods are scrapped.</ul><li>use the <strong>dynamic discovery feature for Kubernetes in Prometheus</strong>.<ul><li>Set the role for kubernetes_sd_configs as <code class="language-plaintext highlighter-rouge">pod</code>.<li>So the <code class="language-plaintext highlighter-rouge">scrape will target all the Kubernetes pods</code> that match the following criteria,</ul></ul><p><code class="language-plaintext highlighter-rouge">relabel_configs</code></p><ul><li><p>This means Prometheus will</p><li>before the actual scraping, we relabel the <code class="language-plaintext highlighter-rouge">__address__</code><ul><li>to let it point to the container port for the handler, port 8080.</ul><li><code class="language-plaintext highlighter-rouge">ignore all the pods that don’t regex match to </code>hpa-sim`` for the label of <code class="language-plaintext highlighter-rouge">app</code>.<ul><li>Effectively, it <code class="language-plaintext highlighter-rouge">only scrapes the pods that labeled with </code>app=hpa-sim``.</ul><li><code class="language-plaintext highlighter-rouge">assign two extra labels</code> for the Prometheus metrics<ul><li>namely the namespace and the pod name instead of setting those labels inside the code.</ul></ul><p>delete the old configMap and create it again to achieve the effect of updating.</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>kubectl delete cm monitoring-prometheus <span class="se">\</span>
  <span class="nt">-n</span> kube-system
kubectl create cm monitoring-prometheus <span class="se">\</span>
  <span class="nt">-n</span> kube-system <span class="se">\</span>
  <span class="nt">--from-file</span><span class="o">=</span>prometheus.yml<span class="o">=</span>prom.yaml
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>curl http://192.168.0.226:8080/service?cost<span class="o">=</span>0.2
curl http://192.168.0.226:8080/metrics | <span class="nb">grep </span>myapp
</pre></table></code></div></div><hr /><h2 id="metric">Metric</h2><p><strong>标签管理</strong></p><ul><li>Prometheus 在处理数据指标的过程中，包括【抓取的生命周期】和【标签的生命周期】。<li>默认情况下，当 Prometheus加载 Target 实例完成后，这些Target时候都会包含一些默认的标签：这些标签将会告诉Prometheus如何从该Target实例中获取监控数据。</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/xydP0mm.png" alt="promethesu-life" /></p><p><strong>标签配置</strong></p><p>Prometheus通过标签可以实现查询过滤，并且还支持重新标签实现动态生成标签、过滤、删除无用标签等灵活配置。</p><ul><li>在采集数据之前可以使用relabel_configs进行重新标记，<li>存储数据之前可以使用metric_relabel_configs重新标记。</ul><p>两种重新打标签的方式都支持以下动作：</p><ul><li>replace：默认动作，将匹配到的标签内容做替换<li>keep：通过正则匹配，仅保留正则匹配到的标签<li>drop：通过正则匹配，删除正则匹配到的标签<li>labeldrop：删除指定标签，比如一些默认标签并不需要，可以用该动作删除<li>labelkeep：仅保留指定标签</ul><hr /><h2 id="configuration">CONFIGURATION</h2><blockquote><p>https://prometheus.io/docs/prometheus/latest/configuration/configuration/</p></blockquote><blockquote><p>https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</p></blockquote><p><code class="language-plaintext highlighter-rouge">scrape_config:</code></p><ul><li>A scrape_config section specifies a set of targets and parameters describing how to scrape them.<li><p>In the general case, one scrape configuration specifies a single job. In advanced configurations, this may change.</p><li><p><code class="language-plaintext highlighter-rouge">Targets</code> may be statically configured via the <code class="language-plaintext highlighter-rouge">static_configs</code> parameter or dynamically discovered using one of the supported <code class="language-plaintext highlighter-rouge">service-discovery</code> mechanisms.</p><li>Additionally, <code class="language-plaintext highlighter-rouge">relabel_configs</code> allow advanced modifications to any target and its labels before scraping.</ul><h3 id="metric_relabel_configs">metric_relabel_configs</h3><p>Prometheus 从数据源拉取数据后，会对原始数据进行编辑</p><p>其中 metric_relabel_configs是 Prometheus 在保存数据前的最后一步标签重新编辑（relabel_configs）。</p><ul><li>所以哪怕将 metric_relabel_configs模块放在 job_name模块的最前端，Prometheus 解析编辑文件后，也会将 metric_relabel_configs放在最后。</ul><p>metric_relabel_configs 模块和 relabel_config 模块很相似。</p><p>metric_relabel_configs一个很常用的用途：将监控不需要的数据，直接丢掉，不在Prometheus 中保存。</p><ul><li>删除不必要的指标。<li>从指标中删除敏感或不需要的标签。<li>添加、编辑或者修改指标的标签值或者标签格式。<li>一个用处是屏蔽太昂贵的时序数据;</ul><p><strong>删除不需要的指标(metric)</strong></p><ul><li>prometheus 默认会将所有拉取到的 metrics 都写入自己的存储中。<li>如果某些 metrics 对并没有太多意义，可以设置直接丢掉，减少磁盘空间的浪费。<li>‘node_netstat_Icmp_OutMsgs’ 指标数据。</ul><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="na">metric_relabel_configs</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">__name__</span> <span class="pi">]</span>
     <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">node_netstat_Icmp_OutMsgs'</span>
     <span class="na">action</span><span class="pi">:</span> <span class="s">drop</span>
</pre></table></code></div></div><p>使用 <code class="language-plaintext highlighter-rouge">source_labels</code> 参数选择要要操作的指标，并且还需要一组标签名称。</p><ul><li>示例中使用 <code class="language-plaintext highlighter-rouge">__name__</code> 标签，此标签是标识指标名称的预留标签。<li>参考上面的配置，可以对指标(metric) 进行添加，删除，重命名等操作。</ul><p><strong>修改指标(metric) 中的标签(label)</strong></p><ul><li>如果使用 prometheus 监控 Kubernetes 运行状态；应该会遇到，在一个 query 中结合一个以上的<code class="language-plaintext highlighter-rouge">job_name(metric_source)</code>的情况。<li>不同的 job_name 中 metric 的 label 命名可能不相同。<ul><li>比如：pod的名称可以使用<code class="language-plaintext highlighter-rouge">pod</code>或者<code class="language-plaintext highlighter-rouge">pod_name</code> 这两个 label 记录。<li>如果相同含义的label，名称却不相同；对query的编写就很困难了。<li>没有在PromQL 中找到类似 SQL 语句中的 as 的功能的关键词和方法。</ul><li>这样的话，正确的解决思路应该是<ul><li>在 Prometheus 拉取数据后，保存数据前；<li>将 label 的名称进行重写；<li>保证相同含义的label 有相同的名称。</ul></ul><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">metric_relabel_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">pod</span><span class="pi">]</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
    <span class="na">regex</span><span class="pi">:</span> <span class="s">(.+)</span>
    <span class="na">separator</span><span class="pi">:</span> <span class="s">;</span>
    <span class="na">replacement</span><span class="pi">:</span> <span class="s">$1</span>
    <span class="na">target_label</span><span class="pi">:</span> <span class="s">pod_name</span>
  <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">container</span><span class="pi">]</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
    <span class="na">separator</span><span class="pi">:</span> <span class="s">;</span>
    <span class="na">regex</span><span class="pi">:</span> <span class="s">(.+)</span>
    <span class="na">replacement</span><span class="pi">:</span> <span class="s">$1</span>
    <span class="na">target_label</span><span class="pi">:</span> <span class="s">container_name</span>
</pre></table></code></div></div><ul><li>如上，将指定 job_name 中，所有的 metrics 中含有名为<code class="language-plaintext highlighter-rouge">pod</code>和<code class="language-plaintext highlighter-rouge">container</code>名称的 label 分别拷贝到名为<code class="language-plaintext highlighter-rouge">pod_name</code>，<code class="language-plaintext highlighter-rouge">container_name</code>的label中。<li>注意：如果metric 的 label的名称包含了<code class="language-plaintext highlighter-rouge">pod</code>和<code class="language-plaintext highlighter-rouge">container</code>关键词，但是不等于；则不会处理此label。</ul><p><strong>删除标签</strong></p><ul><li>删除标签通常用于隐藏敏感信息或者简化时间序列。</ul><div class="language-yml highlighter-rouge"><div class="code-header" text-data="yml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  <span class="na">metric_relabel_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">kernelVersion'</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">labeldrop</span>
</pre></table></code></div></div><ul><li>为了删除标签，指定了一个正则表达式，然后指定删除标签的操作labeldrop。<li>这将删除与正在表达式匹配的所有标签。</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="c"># 查询指标</span>
curl <span class="s1">'http://localhost:9090/api/v1/query?'</span> <span class="nt">--data-urlencod</span> <span class="s1">'query=prometheus_engine_queries_concurrent_max'</span>
<span class="c"># {</span>
<span class="c"># 	"status": "success",</span>
<span class="c"># 	"data": {</span>
<span class="c"># 		"resultType": "vector",</span>
<span class="c"># 		"result": [{</span>
<span class="c"># 			"metric": {</span>
<span class="c"># 				"Label": "value1",</span>
<span class="c"># 				"__name__": "prometheus_engine_queries_concurrent_max",</span>
<span class="c"># 				"instance": "localhost:9090",</span>
<span class="c"># 				"job": "prometheus",</span>
<span class="c"># 				"userLabel1": "value1",</span>
<span class="c"># 				"userLabel2": "value2"</span>
<span class="c"># 			},</span>
<span class="c"># 			"value": [1587829220.743, "20"]</span>
<span class="c"># 		}]</span>
<span class="c"># 	}</span>
<span class="c"># }</span>


<span class="c"># 删除指标的标签</span>
global:
  scrape_interval:     15s
  evaluation_interval: 15s
alerting:
  alertmanagers:
  - static_configs:
    - targets:
rule_files:
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'localhost:9090'</span><span class="o">]</span>
        labels:
          userLabel1: value1
          userLabel2: value2
    metric_relabel_configs:
      - regex: userLabel1
        action: labeldrop


<span class="c"># 重载配置后查询</span>
curl <span class="s1">'http://localhost:9090/api/v1/query?'</span> <span class="nt">--data-urlencod</span> <span class="s1">'query=prometheus_engine_queries_concurrent_max'</span>
<span class="c"># {</span>
<span class="c"># 	"status": "success",</span>
<span class="c"># 	"data": {</span>
<span class="c"># 		"resultType": "vector",</span>
<span class="c"># 		"result": [{</span>
<span class="c"># 			"metric": {</span>
<span class="c"># 				"__name__": "prometheus_engine_queries_concurrent_max",</span>
<span class="c"># 				"instance": "localhost:9090",</span>
<span class="c"># 				"job": "prometheus",</span>
<span class="c"># 				"userLabel2": "value2" //删除了userLabel1标签</span>
<span class="c"># 			},</span>
<span class="c"># 			"value": [1587829524.788, "20"]</span>
<span class="c"># 		}]</span>
<span class="c"># 	}</span>
<span class="c"># }</span>
</pre></table></code></div></div><hr /><h3 id="relabel_config">relabel_config</h3><ul><li><p>relabel_config 发生在采集之前，metric_relabel_configs 发生在采集之后，合理搭配可以满足很多场景的配置。</p><li>relabel_configs drop动作，那么将不会收集这个指标。<li>metric_relabel_configs 使用的时候指标已经采集过了<li>所以metric_relabel_configs相对来说，更加昂贵，毕竟指标已经采集了。<li>metric_relabel_configs还可以不用指定source_labels</ul><hr /><h2 id="monitoring-with-prometheus">monitoring with Prometheus</h2><h2 id="client">client</h2><p>Package prometheus is the core instrumentation package.</p><ul><li>It provides metrics primitives to instrument code for monitoring.<li>It also offers a registry for metrics.<li>Sub-packages allow to expose the registered metrics via HTTP (package promhttp) or push them to a Pushgateway (package push).<li>There is also a sub-package promauto, which provides metrics constructors with automatic registration.<li>All exported functions and methods are safe to be used concurrently unless specified otherwise.</ul><h3 id="instrumenting-applications">Instrumenting applications</h3><ul><li>The <a href="https://github.com/prometheus/client_golang/tree/main/prometheus">prometheus directory</a> contains the instrumentation library.<li>See the <a href="https://prometheus.io/docs/guides/go-application/">guide on the Prometheus website</a> to learn more about instrumenting applications.<li>For comprehensive API documentation, see the <a href="https://godoc.org/github.com/prometheus/client_golang">GoDoc</a> for Prometheus’ various Go libraries.</ul><p>In this guide, you created two sample Go applications that expose metrics to Prometheus</p><ul><li>one that exposes only the default Go metrics<li>and one that also exposes a custom Prometheus counter and configured a Prometheus instance to scrape metrics from those applications.</ul><p>This documentation is <a href="https://github.com/prometheus/docs#contributing-changes">open-source</a>. Please help improve it by filing issues or pull requests.</p><h4 id="installation">Installation</h4><ul><li>install the <code class="language-plaintext highlighter-rouge">prometheus</code>, <code class="language-plaintext highlighter-rouge">promauto</code>, and <code class="language-plaintext highlighter-rouge">promhttp</code> libraries necessary for the guide using <a href="https://golang.org/doc/articles/go_command.html"><code class="language-plaintext highlighter-rouge">go get</code></a>:</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># create go.mod</span>


<span class="c"># run</span>
go get github.com/prometheus/client_golang/prometheus
go get github.com/prometheus/client_golang/prometheus/promauto
go get github.com/prometheus/client_golang/prometheus/promhttp
</pre></table></code></div></div><h4 id="how-go-exposition-works">How Go exposition works</h4><ul><li>To expose Prometheus metrics in a Go application, you need to provide a <code class="language-plaintext highlighter-rouge">/metrics</code> HTTP endpoint.<li>You can use the <a href="https://godoc.org/github.com/prometheus/client_golang/prometheus/promhttp"><code class="language-plaintext highlighter-rouge">prometheus/promhttp</code></a> library’s HTTP <a href="https://godoc.org/github.com/prometheus/client_golang/prometheus/promhttp#Handler"><code class="language-plaintext highlighter-rouge">Handler</code></a> as the handler function.</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c">// This minimal application, for example, would expose the default metrics for Go applications via `http://localhost:2112/metrics:</span>
<span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":2112"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// To start the application:</span>
<span class="k">go</span> <span class="n">run</span> <span class="n">main</span><span class="o">.</span><span class="k">go</span>

<span class="c">// To access the metrics:</span>
<span class="n">curl</span> <span class="n">http</span><span class="o">:</span><span class="c">//localhost:2112/metrics</span>
</pre></table></code></div></div><h4 id="add-own-metrics">Add own metrics</h4><ul><li>The application <a href="#how-go-exposition-works">above</a> exposes only the default Go metrics.<li>You can also register your own custom application-specific metrics.</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="c">// This example application exposes a `myapp_processed_ops_total` [counter](/docs/concepts/metric_types/#counter) that counts the number of operations that have been processed thus far.</span>
<span class="c">// Every 2 seconds, the counter is incremented by one.</span>
<span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promauto"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">recordMetrics</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="n">opsProcessed</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>
			<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">2</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}()</span>
<span class="p">}</span>

<span class="k">var</span> <span class="p">(</span>
	<span class="n">opsProcessed</span> <span class="o">=</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewCounter</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="s">"myapp_processed_ops_total"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"The total number of processed events"</span><span class="p">,</span>
		<span class="p">})</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">recordMetrics</span><span class="p">()</span>

	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":2112"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">}</span>


<span class="c">// To start the application:</span>
<span class="k">go</span> <span class="n">run</span> <span class="n">main</span><span class="o">.</span><span class="k">go</span>

<span class="c">// To access the metrics:</span>
<span class="n">curl</span> <span class="n">http</span><span class="o">:</span><span class="c">//localhost:2112/metrics</span>
</pre></table></code></div></div><p>In the metrics output, you’ll see the help text, type information, and current value of the <code class="language-plaintext highlighter-rouge">myapp_processed_ops_total</code> counter:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">// # HELP myapp_processed_ops_total The total number of processed events</span>
<span class="c">// # TYPE myapp_processed_ops_total counter</span>
<span class="c">// myapp_processed_ops_total 5</span>
</pre></table></code></div></div><p>configure a locally running Prometheus instance to scrape metrics from the application. Here’s an example <code class="language-plaintext highlighter-rouge">prometheus.yml</code> configuration:</p><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">scrape_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s">myapp</span>
      <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">localhost:2112</span>
</pre></table></code></div></div><h4 id="other-go-client-features">Other Go client features</h4><p>In this guide we covered just a small handful of features available in the Prometheus Go client libraries. You can also expose other metrics types, such as</p><ul><li><a href="https://godoc.org/github.com/prometheus/client_golang/prometheus#Gauge">gauges</a><li>and <a href="https://godoc.org/github.com/prometheus/client_golang/prometheus#Histogram">histograms</a>,<li><a href="https://godoc.org/github.com/prometheus/client_golang/prometheus#Registry">non-global registries</a>,<li>functions for <a href="https://godoc.org/github.com/prometheus/client_golang/prometheus/push">pushing metrics</a> to Prometheus PushGateways<li>bridging Prometheus and <a href="https://godoc.org/github.com/prometheus/client_golang/prometheus/graphite">Graphite</a>, and more.</ul><p>The <a href="https://github.com/prometheus/client_golang/tree/main/examples">examples directory</a> contains simple examples of instrumented code.</p><h3 id="client-for-the-prometheus-http-api">Client for the Prometheus HTTP API</h3><p>The api/prometheus directory contains the client for the Prometheus HTTP API. It allows you to write Go applications that query time series data from a Prometheus server. It is still in alpha stage.</p><hr /><h2 id="go-client">go client</h2><h3 id="模型">模型</h3><p>Prometheus 所有采集的监控数据均以指标（metric）的形式保存在内置的时间序列数据库当中（TSDB）：</p><ul><li>属于同一指标名称，同一标签集合的、有时间戳标记的数据流。<li>除了存储的时间序列，Prometheus 还可以根据查询请求产生临时的、衍生的时间序列作为返回结果。<li>在时间序列中的每一个点称为一个样本（sample）</ul><p>样本由以下三部分组成</p><ul><li>指标（metric）：指标名称和描述当前样本特征的 labelsets<li>时间戳（timestamp）：一个精确到毫秒的时间戳<li>样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值</ul><h3 id="metric-指标">metric 指标</h3><p>四种类型有实现的函数赋值，常用</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">set</span><span class="err">（）</span>
<span class="n">WithLabelValues</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-py highlighter-rouge"><div class="code-header" text-data="py"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">metrics</span> <span class="n">name</span> <span class="p">{(</span><span class="n">label</span><span class="p">)</span><span class="n">key</span><span class="o">-</span><span class="n">value</span><span class="p">}</span> <span class="n">float64</span> <span class="n">value</span>

<span class="c1"># HELP go_gc_duration_seconds A summary of the GC invocation durations.
# TYPE go_gc_duration_seconds summary
</span><span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"0.5"</span><span class="p">}</span> <span class="mf">0.000107458</span>
<span class="n">go_gc_duration_seconds_count</span> <span class="mi">18</span>
<span class="c1"># HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
</span><span class="n">go_goroutines</span> <span class="mi">107</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包为了方便client library的使用提供了四种数据类型：</p><ul><li><code class="language-plaintext highlighter-rouge">Counter</code>, <code class="language-plaintext highlighter-rouge">Gauge</code>, <code class="language-plaintext highlighter-rouge">Histogram</code> 和 <code class="language-plaintext highlighter-rouge">Summary</code> .<li>但这些类型只是在客户端库（客户端可以根据不同的数据类型调用不同的 API 接口）和在线协议中，<li>实际在 Prometheus server 中并不对指标类型进行区分，而是简单地把这些指标统一视为无类型的时间序列。</ul><blockquote><p><a href="https://prometheus.io/docs/concepts/metric_types/">Prometheus docs</a>, 对这四种度量标准类型的更全面的描述.</p></blockquote><p>除了四种基本的数据指标类型外, Prometheus 数据模型的一个非常重要的部分是沿着称为 <code class="language-plaintext highlighter-rouge">标签</code> 的维度对数据指标样本进行划分,这就产生了数据指标向量(<code class="language-plaintext highlighter-rouge">metric vectors</code>).</p><h4 id="数据指标类型">数据指标类型</h4><p>数据类型：</p><ul><li><p><strong>Counter</strong></p><ul><li> <font color="red"> 收集事件次数等单调递增的数据 </font><li>好比计数器,用于统计类似于：CPU时间,API访问总次数,异常发生次数等等场景.<li>代表一种样本数据单调递增的指标，即只增不减。除非监控系统发生了重置。<ul><li>例如，使用 counter 类型的指标来表示服务的请求数、已完成的任务数、错误发生的次数等。<li>不要将 counter 类型应用于样本数据非单调递增的指标，例如：当前运行的进程数量（应该用 Gauge 类型）。</ul></ul><li><p><strong>Gauge</strong></p><ul><li> <font color="red"> 收集当前的状态，可增可减，比如数据库连接数 </font><li><code class="language-plaintext highlighter-rouge">计量器</code> <code class="language-plaintext highlighter-rouge">仪表盘</code><li>代表一种样本数据可以任意变化的指标，即可增可减。<li>Gauge 通常用于像温度或者内存使用率这种指标数据，也可以表示能随时增加或减少的<code class="language-plaintext highlighter-rouge">总数</code>，<li>例如：当前并发请求的数量。</ul><li><p><strong>Histogram</strong></p><ul><li> <font color="red"> 收集随机正态分布数据，比如响应延迟 </font><li>柱状图,更多的是用于统计一些数据分布的情况,用于计算在一定范围内的分布情况,同时还提供了度量指标值的总和.<li>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。<ul><li>这种方式的问题很明显<ul><li>以系统 API 调用的平均响应时间为例：<li>如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，<li>那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</ul><li>为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如<ul><li>统计延迟在 0~10ms 之间的请求数有多少而 10~20ms 之间的请求数又有多少。<li>通过这种方式可以快速分析系统慢的原因。</ul></ul><li>Histogram<ul><li>在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），<li>并将其计入可配置的存储桶（bucket）中，<li>后续可通过指定区间筛选样本，也可以统计样本总数，<li>最后一般将数据展示为直方图。</ul><li>Histogram 类型的样本会提供三种指标（假设指标名称为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;</code>）：<ul><li>样本的值分布在 bucket 中的数量<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_bucket{le=`&lt;上边界&gt;`}</code>。<li>解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。<li><strong>请求响应时间 &lt;=0.005 秒 的请求次数</strong>。</ul><li>所有样本值的大小总和<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_sum</code><li><strong>所有请求响应时间总和</strong></ul><li>样本总数<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_count</code>。<li>值和 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_bucket{le=`+Inf`}</code> 相同。<li><strong>所有请求次数</strong></ul></ul></ul><li><p><strong>Summary</strong></p><ul><li> <font color="red"> 收集随机正态分布数据，和 Histogram 是类似的 </font><li>和Histogram柱状图比较类似,主要用于计算在一定时间窗口范围内度量指标对象的总数以及所有对量指标值的总和.<li>与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等）<ul><li>但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。</ul><li>Summary 类型的样本也会提供三种指标（假设指标名称为 ）：<ul><li>样本值的分位数分布情况<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;{quantile=`0.5`}</code><li><strong>请求中有 50% 的请求响应时间值是</strong></ul><li>所有样本值的大小总和<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_sum</code><li><strong>所有请求响应时间总和</strong></ul><li>样本总数<ul><li>命名为 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_count</code><li><strong>请求的总数</strong></ul></ul></ul></ul><p>Histogram 与 Summary 的异同：</p><ul><li>Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，可以快速了解监控样本的分布情况。<li>它们都包含了 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_sum</code> 和 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_count</code> 指标<li>Histogram 需要通过 <code class="language-plaintext highlighter-rouge">&lt;metrices_name&gt;_bucket</code> 来计算分位数，而 Summary 则直接存储了分位数的值。</ul><p>简单理解就是</p><ul><li>Counter对数据只增不减，<li>Gauage可增可减，<li>Histogram,Summary提供跟多的统计信息。</ul><p>pro将所有数据保存为timeseries data，用 metric name 和 label 区分</p><ul><li>label 是在 metric name 上的更细维度的划分<ul><li>其中的每一个实例是由一个float64和timestamp组成<li>只不过timestamp是隐式加上去的，有时候不会显示出来</ul><li>如下面所示<ul><li><code class="language-plaintext highlighter-rouge">go_gc_duration_seconds</code> 是 metrics name<li><code class="language-plaintext highlighter-rouge">quantile="0.5"</code> 是 key-value pair 的 label<li>而后面的值是 float64 value<li>注释部分 <code class="language-plaintext highlighter-rouge"># TYPE go_gc_duration_seconds summary</code> 标识出这是一个summary对象。</ul></ul><div class="language-py highlighter-rouge"><div class="code-header" text-data="py"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">metrics</span> <span class="n">name</span> <span class="p">{(</span><span class="n">label</span><span class="p">)</span><span class="n">key</span><span class="o">-</span><span class="n">value</span><span class="p">}</span> <span class="n">float64</span> <span class="n">value</span>

<span class="c1"># HELP go_gc_duration_seconds A summary of the GC invocation durations.
# TYPE go_gc_duration_seconds summary
</span><span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"0.5"</span><span class="p">}</span> <span class="mf">0.000107458</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"0.75"</span><span class="p">}</span> <span class="mf">0.000200112</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s">"1"</span><span class="p">}</span> <span class="mf">0.000299278</span>
<span class="n">go_gc_duration_seconds_sum</span> <span class="mf">0.002341738</span>
<span class="n">go_gc_duration_seconds_count</span> <span class="mi">18</span>
<span class="c1"># HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
</span><span class="n">go_goroutines</span> <span class="mi">107</span>
</pre></table></code></div></div><h4 id="数据指标向量">数据指标向量</h4><p>每种标准数据结构还对应了 Vec 结构</p><ul><li>分别是 <code class="language-plaintext highlighter-rouge">CounterVec</code>, <code class="language-plaintext highlighter-rouge">GaugeVec</code>, <code class="language-plaintext highlighter-rouge">HistogramVec</code> 和 <code class="language-plaintext highlighter-rouge">SummaryVec</code> .<li>通过 Vec 可以简洁的定义一组相同性质的 Metric，在采集数据的时候传入一组自定义的 Label/Value 获取具体的 Metric（Counter/Gauge/Histogram/Summary），最终都会落实到基本的数据结构上</ul><p>数据指标向量的方法如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">Collect</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="n">Metric</span><span class="p">)</span>  <span class="c">// 实现 Collector 接口的 Collect() 方法</span>
<span class="n">CurryWith</span><span class="p">(</span><span class="n">labels</span> <span class="n">Labels</span><span class="p">)</span>  <span class="c">// 返回带有指定标签的向量指标及可能发生的错误.多用于 promhttp 包中的中间件.</span>
<span class="n">Delete</span><span class="p">(</span><span class="n">labels</span> <span class="n">Labels</span><span class="p">)</span>  <span class="c">// 删除带有指定标签的向量指标.如果删除了指标,返回 true</span>
<span class="n">DeleteLabelValues</span><span class="p">(</span><span class="n">lvs</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span>  <span class="c">// 删除带有指定标签和标签值的向量指标.如果删除了指标,返回 true</span>
<span class="n">Describe</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="n">Desc</span><span class="p">)</span>  <span class="c">// 实现 Collector 接口的 Describe() 方法</span>
<span class="n">GetMetricWith</span><span class="p">(</span><span class="n">labels</span> <span class="n">Labels</span><span class="p">)</span>  <span class="c">// 返回带有指定标签的数据指标及可能发生的错误</span>
<span class="n">GetMetricWithLabelValues</span><span class="p">(</span><span class="n">lvs</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span>  <span class="c">// 返回带有指定标签和标签值的数据指标及可能发生的错误</span>
<span class="n">MustCurryWith</span><span class="p">(</span><span class="n">labels</span> <span class="n">Labels</span><span class="p">)</span>  <span class="c">// 与 CurryWith 相同,但如果出现错误,则引发 panics</span>
<span class="n">Reset</span><span class="p">()</span>  <span class="c">// 删除此指标向量中的所有数据指标</span>
<span class="n">With</span><span class="p">(</span><span class="n">labels</span> <span class="n">Labels</span><span class="p">)</span>  <span class="c">// 与 GetMetricWithLabels 相同,但如果出现错误,则引发 panics</span>
<span class="n">WithLabelValues</span><span class="p">(</span><span class="n">lvs</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span>  <span class="c">// 与 GetMetricWithLabelValues 相同,但如果出现错误,则引发 panics</span>
</pre></table></code></div></div><p>要创建 <code class="language-plaintext highlighter-rouge">Metrics</code> 及其向量版本的实例</p><ul><li>您需要一个合适的 <code class="language-plaintext highlighter-rouge">…Opts</code> 结构,即 <code class="language-plaintext highlighter-rouge">GaugeOpts</code>, <code class="language-plaintext highlighter-rouge">CounterOpts</code>, <code class="language-plaintext highlighter-rouge">SummaryOpts</code> 或 <code class="language-plaintext highlighter-rouge">HistogramOpts</code> .</ul><p>结构体如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">Opts</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// Namespace, Subsystem, and Name  是 Metric 名称的组成部分</span>
	<span class="c">// (通过 "_" 将这些组成部分连接起来),只有 Name 是必需的.</span>
    <span class="n">Namespace</span> <span class="kt">string</span>
    <span class="n">Subsystem</span> <span class="kt">string</span>
    <span class="n">Name</span>      <span class="kt">string</span>
    <span class="c">// Help 提供 Metric 的信息.具有相同名称的 Metric 必须具有相同的 Help 信息</span>
    <span class="n">Help</span> <span class="kt">string</span>
    <span class="c">// ConstLabels 用于将固定标签附加到该指标.很少使用.</span>
    <span class="n">ConstLabels</span> <span class="n">Labels</span>
<span class="p">}</span>

<span class="c">// 其中 GaugeOpts, CounterOpts 实际上均为 Opts 的别名</span>
<span class="k">type</span> <span class="n">CounterOpts</span> <span class="n">Opts</span>
<span class="k">type</span> <span class="n">GaugeOpts</span> <span class="n">Opts</span>

<span class="k">type</span> <span class="n">HistogramOpts</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// Namespace, Subsystem, and Name  是 Metric 名称的组成部分</span>
	<span class="c">// (通过 "_" 将这些组成部分连接起来),只有 Name 是必需的.</span>
    <span class="n">Namespace</span> <span class="kt">string</span>
    <span class="n">Subsystem</span> <span class="kt">string</span>
    <span class="n">Name</span>      <span class="kt">string</span>
    <span class="c">//  Help 提供 Metric 的信息.具有相同名称的 Metric 必须具有相同的 Help 信息</span>
    <span class="n">Help</span> <span class="kt">string</span>
    <span class="c">// ConstLabels 用于将固定标签附加到该指标.很少使用.</span>
    <span class="n">ConstLabels</span> <span class="n">Labels</span>
    <span class="c">// Buckets 定义了观察值的取值区间.切片中的每个元素值都是区间的上限,元素值必须按升序排序.</span>
    <span class="c">// Buckets 会隐式添加 `+Inf` 值作为取值区间的最大值</span>
    <span class="c">// 默认值是 DefBuckets =  []float64{.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10}</span>
    <span class="n">Buckets</span> <span class="p">[]</span><span class="kt">float64</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">SummaryOpts</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// Namespace, Subsystem, and Name  是 Metric 名称的组成部分</span>
	<span class="c">// (通过 "_" 将这些组成部分连接起来),只有 Name 是必需的.</span>
    <span class="n">Namespace</span> <span class="kt">string</span>
    <span class="n">Subsystem</span> <span class="kt">string</span>
    <span class="n">Name</span>      <span class="kt">string</span>
    <span class="c">//  Help 提供 Metric 的信息.具有相同名称的 Metric 必须具有相同的 Help 信息</span>
    <span class="n">Help</span> <span class="kt">string</span>
    <span class="c">// ConstLabels 用于将固定标签附加到该指标.很少使用.</span>
    <span class="n">ConstLabels</span> <span class="n">Labels</span>
    <span class="c">// Objectives 定义了分位数等级估计及其各自的绝对误差.</span>
	<span class="c">// 如果 Objectives[q] = e，则 q 报告的值将是 [q-e, q + e]之间某个 φ 的 φ 分位数</span>
    <span class="c">// 默认值为空 map,表示没有分位数的摘要</span>
    <span class="n">Objectives</span> <span class="k">map</span><span class="p">[</span><span class="kt">float64</span><span class="p">]</span><span class="kt">float64</span>
    <span class="c">// MaxAge 定义观察值与摘要保持相关的持续时间.必须是正数.默认值为 DefMaxAge = 10 * time.Minute</span>
    <span class="n">MaxAge</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="c">// AgeBuckets 用于从摘要中排除早于 MaxAge 的观察值的取值区间.默认值为 DefAgeBuckets = 5</span>
    <span class="n">AgeBuckets</span> <span class="kt">uint32</span>
    <span class="c">// BufCap 定义默认样本流缓冲区大小.默认值为 DefBufCap = 500.</span>
    <span class="n">BufCap</span> <span class="kt">uint32</span>
<span class="p">}</span>
</pre></table></code></div></div><p>注意:</p><ul><li><code class="language-plaintext highlighter-rouge">Counter</code>, <code class="language-plaintext highlighter-rouge">Gauge</code>, <code class="language-plaintext highlighter-rouge">Histogram</code>, <code class="language-plaintext highlighter-rouge">Summary</code> 都继承了 <code class="language-plaintext highlighter-rouge">Metric</code> 和 <code class="language-plaintext highlighter-rouge">Collector</code> 接口,其本身是接口类型.<li><code class="language-plaintext highlighter-rouge">CounterVec</code>, <code class="language-plaintext highlighter-rouge">GaugeVec</code>, <code class="language-plaintext highlighter-rouge">HistogramVec</code>, <code class="language-plaintext highlighter-rouge">SummaryVec</code> 均继承自 <code class="language-plaintext highlighter-rouge">metricVec</code> 结构体,其本身的是结构体,而它们只实现了 <code class="language-plaintext highlighter-rouge">Collector</code> 接口.</ul><p>Counter 和 Gauge</p><ul><li>Gauge 和 Counter 基本实现上看是一个进程内共享的浮点数，基于 value 结构实现，而 Counter 和 Gauge 仅仅封装了对这个共享浮点数的各种操作和合法性检查逻辑。</ul><p>Histogram</p><ul><li>Histogram 实现了 Observer 接口，用来获取客户端状态初始化（重启）到某个时间点的采样点分布，监控数据常需要服从正态分布。</ul><p>Summary</p><ul><li>Summary 是标准数据结构中最复杂的一个，用来收集服从正态分布的采样数据。<li>在 Go 客户端 Summary 结构和 Histogram 一样，都实现了 Observer 接口</ul><hr /><h4 id="state-metric-定义指标">state metric 定义指标</h4><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c">// 引入另一个依赖库</span>
<span class="k">go</span> <span class="n">get</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">client_golang</span><span class="o">/</span><span class="n">prometheus</span>

<span class="c">// 下面先来定义了两个指标数据，一个是Guage类型， 一个是Counter类型。分别代表了CPU温度和磁盘失败次数统计，使用上面的定义进行分类。</span>
<span class="n">cpuTemp</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="s">"cpu_temperature_celsius"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="s">"Current temperature of the CPU."</span><span class="p">,}</span>
<span class="p">)</span>
<span class="n">hdFailures</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="s">"hd_errors_total"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="s">"Number of hard-disk errors."</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"device"</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">totalScrapes</span><span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounter</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
    <span class="n">Namespace</span><span class="o">:</span> <span class="n">namespace</span><span class="p">,</span>
    <span class="n">Name</span><span class="o">:</span>      <span class="s">"exporter_scrapes_total"</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span>      <span class="s">"Current total redis scrapes."</span><span class="p">,}</span>
<span class="p">)</span>
<span class="c">// 这里还可以注册其他的参数，比如上面的磁盘失败次数统计上，可以同时传递一个device设备名称进去，这样采集的时候就可以获得多个不同的指标。每个指标对应了一个设备的磁盘失败次数统计。</span>
</pre></table></code></div></div><hr /><h4 id="registry-metric-注册指标">registry metric 注册指标</h4><h5 id="默认方式">默认方式</h5><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c">//statement</span>
<span class="n">ABC</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGaugeVec</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="n">zz</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="n">zz</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">zz</span><span class="p">{</span><span class="n">zzz</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">ABC</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="n">zz</span><span class="p">,</span>
    <span class="n">Help</span><span class="o">:</span> <span class="n">zz</span><span class="p">,</span>
<span class="p">})</span>


<span class="n">ABC</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"zz"</span><span class="o">:</span><span class="n">zz</span><span class="p">,})</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
<span class="n">ABC</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
<span class="c">// Metrics have to be registered to be exposed:</span>
<span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">ABC</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">prometheus.MustRegister()</code></p><ul><li>使用prometheus.MustRegister是将数据直接注册到Default Registry<li>这个Default Registry不需要额外的任何代码就可以将指标传递出去。<li>注册后既可以在程序层面上去使用该指标了，这里使用之前定义的指标提供的API（Set和With().Inc）去改变指标的数据内容</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="p">{</span>
  <span class="c">//statement</span>
  <span class="n">proxyTodayTrafficIn</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGaugeVec</span><span class="p">(</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
        <span class="n">Name</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
        <span class="n">Help</span><span class="o">:</span> <span class="s">"The today trafficin of proxy."</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"type"</span><span class="p">,</span><span class="s">"laststarttime"</span><span class="p">,</span><span class="s">"lastclosetime"</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">serverBindPort</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
      <span class="n">Name</span><span class="o">:</span> <span class="s">"frps_server_bind_port"</span><span class="p">,</span>
      <span class="n">Help</span><span class="o">:</span> <span class="s">"The port of server frps."</span><span class="p">,</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c">//registry</span>
<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// Metrics have to be registered to be exposed:</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">proxyTodayTrafficIn</span><span class="p">)</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">serverBindPort</span><span class="p">)</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">cpuTemp</span><span class="p">)</span>
  <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">hdFailures</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">//get value</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">proxyTodayTrafficIn</span><span class="o">.</span><span class="n">With</span><span class="p">(</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span>
      <span class="s">"type"</span><span class="o">:</span><span class="n">v</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
      <span class="s">"laststarttime"</span><span class="o">:</span><span class="n">v</span><span class="o">.</span><span class="n">LastStartTime</span><span class="p">,</span>
      <span class="s">"lastclosetime"</span><span class="o">:</span><span class="n">v</span><span class="o">.</span><span class="n">LastCloseTime</span>
    <span class="p">}</span>
  <span class="p">)</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="kt">float64</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">TodayTrafficIn</span><span class="p">))</span>

  <span class="n">serverBindPort</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="kt">float64</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">BindPort</span><span class="p">))</span>

  <span class="n">cpuTemp</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="m">65.3</span><span class="p">)</span>
  <span class="n">hdFailures</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"device"</span><span class="o">:</span><span class="s">"/dev/sda"</span><span class="p">})</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>

  <span class="c">// The Handler function provides a default handler to expose metrics</span>
  <span class="c">// via an HTTP server. "/metrics" is the usual endpoint for that.</span>
  <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Set()</code></p><p><code class="language-plaintext highlighter-rouge">With().Inc()</code></p><ul><li>With函数是传递到之前定义的label=”device”上的值，也就是生成指标类似于</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">cpu_temperature_celsius</span> <span class="m">65.3</span>
<span class="n">hd_errors_total</span><span class="p">{</span><span class="s">"device"</span><span class="o">=</span><span class="s">"/dev/sda"</span><span class="p">}</span> <span class="m">1</span>
</pre></table></code></div></div><blockquote><p>当然main函数中的方式是有问题的， 这样这个指标仅仅改变了一次，不会随着下次采集数据的时候发生任何变化， 希望的是每次执行采集的时候，程序都去自动的抓取指标并将数据通过http的方式传递给。</p></blockquote><hr /><h5 id="自定义-exporter--结构体">自定义 exporter / 结构体</h5><p>下面就涉及到自定义结构体，</p><ul><li>根据上面的原理，需要重自定义的结构体中获取到两个结构体的值</ul><ol><li>counter数据采集实例，重写collecter<ol><li>下面是一个采集Counter类型数据的实例，<li>实现了一个自定义的，满足采集器(Collector)接口的结构体<li>并手动注册该结构体后，使其每次查询的时候自动执行采集任务。</ol></ol><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
</pre><td class="rouge-code"><pre><span class="c">// 采集器Collector接口的实现</span>
<span class="k">type</span> <span class="n">Collector</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="c">// 用于传递所有可能的指标的定义描述符</span>
    <span class="c">// 可以在程序运行期间添加新的描述，收集新的指标信息</span>
    <span class="c">// 重复的描述符将被忽略。两个不同的Collector不要设置相同的描述符</span>
    <span class="n">Describe</span><span class="p">(</span><span class="k">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="n">Desc</span><span class="p">)</span>

    <span class="c">// Prometheus的注册器调用Collect执行实际的抓取参数的工作，</span>
    <span class="c">// 并将收集的数据传递到Channel中返回</span>
    <span class="c">// 收集的指标信息来自于Describe中传递，可以并发的执行抓取工作，但是必须要保证线程的安全。</span>
    <span class="n">Collect</span><span class="p">(</span><span class="k">chan</span><span class="o">&lt;-</span> <span class="n">Metric</span><span class="p">)</span>
<span class="p">}</span>


<span class="c">// 了解了接口的实现后，就可以写自己的实现了</span>
<span class="c">// 先定义 结构体</span>
<span class="c">// 这是一个集群的指标采集器，每个集群都有自己的Zone, 代表集群的名称。</span>
<span class="c">// 另外两个是保存的采集的指标。</span>
<span class="k">type</span> <span class="n">ClusterManager</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Zone</span>         <span class="kt">string</span>
    <span class="n">OOMCountDesc</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span>
    <span class="n">RAMUsageDesc</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span>
<span class="p">}</span>


<span class="c">// 创建结构体及对应的指标信息</span>
<span class="c">// NewDesc参数:</span>
<span class="c">// 第一个为指标的名称，</span>
<span class="c">// 第二个为帮助信息，显示在指标的上面作为注释，</span>
<span class="c">// 第三个是定义的label名称数组，</span>
<span class="c">// 第四个是定义的Labels</span>
<span class="k">func</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="n">zone</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">ClusterManager</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">ClusterManager</span><span class="p">{</span>
        <span class="n">Zone</span><span class="o">:</span> <span class="n">zone</span><span class="p">,</span>
        <span class="n">OOMCountDesc</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span>
            <span class="s">"clustermanager_oom_crashes_total"</span><span class="p">,</span>
            <span class="s">"Number of OOM crashes."</span><span class="p">,</span>
            <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"host"</span><span class="p">},</span>
            <span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"zone"</span><span class="o">:</span> <span class="n">zone</span><span class="p">},</span>
        <span class="p">),</span>
        <span class="n">RAMUsageDesc</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span>
            <span class="s">"clustermanager_ram_usage_bytes"</span><span class="p">,</span>
            <span class="s">"RAM usage as reported to the cluster manager."</span><span class="p">,</span>
            <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"host"</span><span class="p">},</span>
            <span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"zone"</span><span class="o">:</span> <span class="n">zone</span><span class="p">},</span>
        <span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// 实现一个采集工作,放到了 ReallyExpensiveAssessmentOfTheSystemState 函数中实现，</span>
<span class="c">// 每次执行的时候，返回一个按照主机名作为键采集到的数据</span>
<span class="c">// 两个返回值分别代表了 OOM错误计数，和RAM使用指标信息。</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">ReallyExpensiveAssessmentOfTheSystemState</span><span class="p">()</span> <span class="p">(</span>
    <span class="n">oomCountByHost</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span> <span class="n">ramUsageByHost</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">oomCountByHost</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
        <span class="s">"foo.example.org"</span><span class="o">:</span> <span class="kt">int</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Int31n</span><span class="p">(</span><span class="m">1000</span><span class="p">)),</span>
        <span class="s">"bar.example.org"</span><span class="o">:</span> <span class="kt">int</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Int31n</span><span class="p">(</span><span class="m">1000</span><span class="p">)),</span>
    <span class="p">}</span>
    <span class="n">ramUsageByHost</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span><span class="p">{</span>
        <span class="s">"foo.example.org"</span><span class="o">:</span> <span class="n">rand</span><span class="o">.</span><span class="n">Float64</span><span class="p">()</span> <span class="o">*</span> <span class="m">100</span><span class="p">,</span>
        <span class="s">"bar.example.org"</span><span class="o">:</span> <span class="n">rand</span><span class="o">.</span><span class="n">Float64</span><span class="p">()</span> <span class="o">*</span> <span class="m">100</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>


<span class="c">// Collect函数将执行抓取函数并返回数据，</span>
<span class="c">// 返回的数据传递到channel中，并且传递的同时绑定原先的指标描述符。以及指标的类型（一个Counter和一个Guage）</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">Collect</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Metric</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">oomCountByHost</span><span class="p">,</span> <span class="n">ramUsageByHost</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">ReallyExpensiveAssessmentOfTheSystemState</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">oomCount</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">oomCountByHost</span> <span class="p">{</span>
        <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">OOMCountDesc</span><span class="p">,</span> <span class="c">// 指标描述符</span>
            <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterValue</span><span class="p">,</span> <span class="c">// 指标类型</span>
            <span class="kt">float64</span><span class="p">(</span><span class="n">oomCount</span><span class="p">),</span> <span class="n">host</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">ramUsage</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ramUsageByHost</span> <span class="p">{</span>
        <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">RAMUsageDesc</span><span class="p">,</span>
            <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeValue</span><span class="p">,</span>
            <span class="n">ramUsage</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c">// 实现Describe接口，传递指标描述符到channel</span>
<span class="c">// Describe simply sends the two Descs in the struct to the channel.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">Describe</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="o">.</span><span class="n">OOMCountDesc</span>
    <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="o">.</span><span class="n">RAMUsageDesc</span>
<span class="p">}</span>


<span class="c">// 执行主程序</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">workerDB</span> <span class="o">:=</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="s">"db"</span><span class="p">)</span>
    <span class="n">workerCA</span> <span class="o">:=</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="s">"ca"</span><span class="p">)</span>

    <span class="c">// Since we are dealing with custom Collector implementations, it might</span>
    <span class="c">// be a good idea to try it out with a pedantic registry.</span>
    <span class="n">reg</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewPedanticRegistry</span><span class="p">()</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">workerDB</span><span class="p">)</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">workerCA</span><span class="p">)</span>

    <span class="c">// 如果直接执行上面的参数的话，不会获取任何的参数，</span>
    <span class="c">// 因为程序将自动推出，我们并未定义http接口去暴露数据出来，</span>
    <span class="c">// 因此数据在执行的时候还需要定义一个httphandler来处理http请求。</span>


    <span class="c">// prometheus.Gatherers用来定义一个采集数据的收集器集合，</span>
    <span class="c">// 可以merge多个不同的采集数据到一个结果集合，</span>
    <span class="c">// 这里我们传递了缺省的 DefaultGatherer ，所以他在输出中也会包含go运行时指标信息。</span>
    <span class="c">// 同时包含reg是我们之前生成的一个注册对象，用来自定义采集数据。</span>
    <span class="n">gatherers</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Gatherers</span><span class="p">{</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">DefaultGatherer</span><span class="p">,</span>
        <span class="n">reg</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c">// promhttp.HandlerFor()函数</span>
    <span class="c">// 传递之前的Gatherers对象，并返回一个httpHandler对象，</span>
    <span class="c">// 这个httpHandler对象可以调用其自身的ServHTTP函数来接手http请求，并返回响应。</span>
    <span class="c">// 其中 promhttp.HandlerOpts 定义了采集过程中如果发生错误时，继续采集其他的数据。</span>
    <span class="n">h</span> <span class="o">:=</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">HandlerFor</span><span class="p">(</span>
        <span class="n">gatherers</span><span class="p">,</span>
        <span class="n">promhttp</span><span class="o">.</span><span class="n">HandlerOpts</span><span class="p">{</span>
            <span class="n">ErrorLog</span><span class="o">:</span>      <span class="n">log</span><span class="o">.</span><span class="n">NewErrorLogger</span><span class="p">(),</span>
            <span class="n">ErrorHandling</span><span class="o">:</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">ContinueOnError</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">h</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="n">log</span><span class="o">.</span><span class="n">Infoln</span><span class="p">(</span><span class="s">"Start server at :8080"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Error occur when start server %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c">// 尝试刷新几次浏览器获取最新的指标信息</span>
<span class="c">// 每次刷新的时候，我们都会获得不同的数据，类似于实现了一个数值不断改变的采集器。当然，具体的指标和采集函数还需要按照需求进行修改，满足实际的业务需求。</span>
<span class="n">clustermanager_oom_crashes_total</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"bar.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"ca"</span><span class="p">}</span> <span class="m">364</span>
<span class="n">clustermanager_oom_crashes_total</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"bar.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"db"</span><span class="p">}</span> <span class="m">90</span>
<span class="n">clustermanager_oom_crashes_total</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"foo.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"ca"</span><span class="p">}</span> <span class="m">844</span>
<span class="n">clustermanager_oom_crashes_total</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"foo.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"db"</span><span class="p">}</span> <span class="m">801</span>
<span class="err">#</span> <span class="n">HELP</span> <span class="n">clustermanager_ram_usage_bytes</span> <span class="n">RAM</span> <span class="n">usage</span> <span class="n">as</span> <span class="n">reported</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span> <span class="n">manager</span><span class="o">.</span>
<span class="err">#</span> <span class="n">TYPE</span> <span class="n">clustermanager_ram_usage_bytes</span> <span class="n">gauge</span>
<span class="n">clustermanager_ram_usage_bytes</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"bar.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"ca"</span><span class="p">}</span> <span class="m">10.738111282075208</span>
<span class="n">clustermanager_ram_usage_bytes</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"bar.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"db"</span><span class="p">}</span> <span class="m">19.003276633920805</span>
<span class="n">clustermanager_ram_usage_bytes</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"foo.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"ca"</span><span class="p">}</span> <span class="m">79.72085409108028</span>
<span class="n">clustermanager_ram_usage_bytes</span><span class="p">{</span><span class="n">host</span><span class="o">=</span><span class="s">"foo.example.org"</span><span class="p">,</span><span class="n">zone</span><span class="o">=</span><span class="s">"db"</span><span class="p">}</span> <span class="m">13.041384617379178</span>
</pre></table></code></div></div><p>2.</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">结构体</span><span class="p">)</span> <span class="n">Describe</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span><span class="p">)</span> <span class="p">{}</span>
<span class="c">// ----可见这个接口的实现需要将prometheus.Desc放倒channel中去</span>

<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">结构体</span><span class="p">)</span> <span class="n">Collect</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Metric</span><span class="p">)</span> <span class="p">{}</span>
<span class="c">// ----可见这个接口的实现需要将prometheus.Metric放倒channel中去</span>


<span class="k">type</span> <span class="n">Desc</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// fqName has been built from Namespace, Subsystem, and Name.</span>
    <span class="n">fqName</span> <span class="kt">string</span>
    <span class="c">// help provides some helpful information about this metric.</span>
    <span class="n">help</span> <span class="kt">string</span>
    <span class="c">// constLabelPairs contains precalculated DTO label pairs based on</span>
    <span class="c">// the constant labels.</span>
    <span class="n">constLabelPairs</span> <span class="p">[]</span><span class="o">*</span><span class="n">dto</span><span class="o">.</span><span class="n">LabelPair</span>
    <span class="c">// VariableLabels contains names of labels for which the metric</span>
    <span class="c">// maintains variable values.</span>
    <span class="n">variableLabels</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="c">// id is a hash of the values of the ConstLabels and fqName. This</span>
    <span class="c">// must be unique among all registered descriptors and can therefore be</span>
    <span class="c">// used as an identifier of the descriptor.</span>
    <span class="n">id</span> <span class="kt">uint64</span>
    <span class="c">// dimHash is a hash of the label names (preset and variable) and the</span>
    <span class="c">// Help string. Each Desc with the same fqName must have the same</span>
    <span class="c">// dimHash.</span>
    <span class="n">dimHash</span> <span class="kt">uint64</span>
    <span class="c">// err is an error that occurred during construction. It is reported on</span>
    <span class="c">// registration time.</span>
    <span class="n">err</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Metric</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="c">// Desc returns the descriptor for the Metric. This method idempotently</span>
    <span class="c">// returns the same descriptor throughout the lifetime of the</span>
    <span class="c">// Metric. The returned descriptor is immutable by contract. A Metric</span>
    <span class="c">// unable to describe itself must return an invalid descriptor (created</span>
    <span class="c">// with NewInvalidDesc).</span>
    <span class="n">Desc</span><span class="p">()</span> <span class="o">*</span><span class="n">Desc</span>
    <span class="c">// Write encodes the Metric into a "Metric" Protocol Buffer data</span>
    <span class="c">// transmission object.</span>
    <span class="c">//</span>
    <span class="c">// Metric implementations must observe concurrency safety as reads of</span>
    <span class="c">// this metric may occur at any time, and any blocking occurs at the</span>
    <span class="c">// expense of total performance of rendering all registered</span>
    <span class="c">// metrics. Ideally, Metric implementations should support concurrent</span>
    <span class="c">// readers.</span>
    <span class="c">//</span>
    <span class="c">// While populating dto.Metric, it is the responsibility of the</span>
    <span class="c">// implementation to ensure validity of the Metric protobuf (like valid</span>
    <span class="c">// UTF-8 strings or syntactically valid metric and label names). It is</span>
    <span class="c">// recommended to sort labels lexicographically. (Implementers may find</span>
    <span class="c">// LabelPairSorter useful for that.) Callers of Write should still make</span>
    <span class="c">// sure of sorting if they depend on it.</span>
    <span class="n">Write</span><span class="p">(</span><span class="o">*</span><span class="n">dto</span><span class="o">.</span><span class="n">Metric</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c">// TODO(beorn7): The original rationale of passing in a pre-allocated</span>
    <span class="c">// dto.Metric protobuf to save allocations has disappeared. The</span>
    <span class="c">// signature of this method should be changed to "Write() (*dto.Metric,</span>
    <span class="c">// error)".</span>
<span class="p">}</span>



<span class="c">// 如何获取这两种值</span>

<span class="c">// 首先desc，每种数据类型都有一个desc函数可以直接获取，如下：</span>
<span class="n">name</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s_%s"</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">metricMaps</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
<span class="n">gaugeDescription</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
        <span class="n">Name</span><span class="o">:</span>      <span class="n">name</span><span class="p">,</span>
        <span class="n">Help</span><span class="o">:</span>      <span class="n">metricMaps</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">gaugeDescription</span><span class="o">.</span><span class="n">Desc</span><span class="p">()</span>

<span class="c">// 还可以直接新建 new desc</span>
<span class="k">func</span> <span class="n">NewDesc</span><span class="p">(</span><span class="n">fqName</span><span class="p">,</span> <span class="n">help</span> <span class="kt">string</span><span class="p">,</span> <span class="n">variableLabels</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">constLabels</span> <span class="n">Labels</span><span class="p">)</span> <span class="o">*</span><span class="n">Desc</span> <span class="p">{}</span>
<span class="n">desc</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metricMaps</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">constLabels</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>




<span class="c">// 再来看看metrics这个接口，找到其相应的结构体实现</span>

<span class="k">func</span> <span class="n">MustNewConstMetric</span><span class="p">(</span>
  <span class="n">desc</span> <span class="o">*</span><span class="n">Desc</span><span class="p">,</span> <span class="n">valueType</span> <span class="n">ValueType</span><span class="p">,</span> <span class="n">value</span> <span class="kt">float64</span><span class="p">,</span> <span class="n">labelValues</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="n">Metric</span> <span class="p">{}</span>

<span class="c">//channel</span>
<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">labelValue</span><span class="o">...</span><span class="p">)</span>



<span class="n">第三种</span>


<span class="c">// 新建结构体，完成上面方法的使用，就可以了，如下：</span>
<span class="c">//set var</span>
<span class="n">name</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s_%s"</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">metricMaps</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">Debugf</span><span class="p">(</span><span class="s">"counter name: %s"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="c">//deal Value</span>
<span class="n">value</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dealValue</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"parse value error: %s"</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
    <span class="k">break</span>
<span class="p">}</span>
<span class="n">log</span><span class="o">.</span><span class="n">Debugf</span><span class="p">(</span><span class="s">"counter value: %s"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="c">//new desc</span>
<span class="n">desc</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metricMaps</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">constLabels</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
<span class="n">vtype</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterValue</span>
<span class="c">//channel</span>
<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">labelValue</span><span class="o">...</span><span class="p">)</span>
</pre></table></code></div></div><hr /><hr /><h3 id="collector">Collector</h3><p>Collector 中 Describe 和 Collect 方法都是无状态的函数</p><ul><li>其中 Describe 暴露全部可能的 Metric 描述列表，在注册（Register）或注销（Unregister）Collector 时会调用 Describe 来获取完整的 Metric 列表，用以检测 Metric 定义的冲突，另外在 github.com/prometheus/client_golang/prometheus/promhttp 下的 Instrument Handler 中，也会通过 Describe 获取 Metric 列表，并检查 label 列表（InstrumentHandler 中只支持 code 和 method 两种自定义 label）；<li>而通过 Collect 可以获取采样数据，然后通过 HTTP 接口暴露给 Prom Server。另外，一些临时性的进程，如批处理任务，可以把数据 push 到 Push Gateway，由 Push Gateway 暴露 pull 接口，此处不赘述。</ul><h3 id="自定义collector">自定义Collector</h3><ul><li>更高阶的做法是使用Collector，go client Colletor只会在每次响应pro请求的时候才收集数据，并且需要每次显式传递变量的值，否则就不会再维持该变量，在pro也将看不到这个变量，<li>Collector是一个接口，所有收集metrics数据的对象都需要实现这个接口，Counter和Gauage等不例外<li>它内部提供了两个函数<ul><li>Collector函数用于收集用户数据，将收集好的数据传递给传入参数Channel就可，<li>Descirbe函数用于描述这个Collector。</ul><li>当收集系统数据代价较大时，就可以自定义Collector收集的方式，优化流程，<ul><li>如果已经有了一个成熟的metrics，就不需要使用Counter,Gauage等这些数据结构，直接在Collector内部实现一个代理的功能即可<li>一些高阶的用法都可以通过自定义Collector实现。</ul></ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus"</span>
	<span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">ClusterManager</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Zone</span>         <span class="kt">string</span>
	<span class="n">OOMCountDesc</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span>
	<span class="n">RAMUsageDesc</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span>
	<span class="c">// ... many more fields</span>
<span class="p">}</span>

<span class="c">// Simulate prepare the data</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">ReallyExpensiveAssessmentOfTheSystemState</span><span class="p">()</span> <span class="p">(</span>
	<span class="n">oomCountByHost</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span> <span class="n">ramUsageByHost</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="c">// Just example fake data.</span>
	<span class="n">oomCountByHost</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
		<span class="s">"foo.example.org"</span><span class="o">:</span> <span class="m">42</span><span class="p">,</span>
		<span class="s">"bar.example.org"</span><span class="o">:</span> <span class="m">2001</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">ramUsageByHost</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span><span class="p">{</span>
		<span class="s">"foo.example.org"</span><span class="o">:</span> <span class="m">6.023e23</span><span class="p">,</span>
		<span class="s">"bar.example.org"</span><span class="o">:</span> <span class="m">3.14</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c">// Describe simply sends the two Descs in the struct to the channel.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">Describe</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Desc</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="o">.</span><span class="n">OOMCountDesc</span>
	<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="o">.</span><span class="n">RAMUsageDesc</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">ClusterManager</span><span class="p">)</span> <span class="n">Collect</span><span class="p">(</span><span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Metric</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">oomCountByHost</span><span class="p">,</span> <span class="n">ramUsageByHost</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">ReallyExpensiveAssessmentOfTheSystemState</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">oomCount</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">oomCountByHost</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span>
			<span class="n">c</span><span class="o">.</span><span class="n">OOMCountDesc</span><span class="p">,</span>
			<span class="n">prometheus</span><span class="o">.</span><span class="n">CounterValue</span><span class="p">,</span>
			<span class="kt">float64</span><span class="p">(</span><span class="n">oomCount</span><span class="p">),</span>
			<span class="n">host</span><span class="p">,</span>
		<span class="p">)</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">ramUsage</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ramUsageByHost</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">MustNewConstMetric</span><span class="p">(</span>
			<span class="n">c</span><span class="o">.</span><span class="n">RAMUsageDesc</span><span class="p">,</span>
			<span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeValue</span><span class="p">,</span>
			<span class="n">ramUsage</span><span class="p">,</span>
			<span class="n">host</span><span class="p">,</span>
		<span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c">// NewClusterManager creates the two Descs OOMCountDesc and RAMUsageDesc. Note</span>
<span class="c">// that the zone is set as a ConstLabel. (It's different in each instance of the</span>
<span class="c">// ClusterManager, but constant over the lifetime of an instance.) Then there is</span>
<span class="c">// a variable label "host", since we want to partition the collected metrics by</span>
<span class="c">// host. Since all Descs created in this way are consistent across instances,</span>
<span class="c">// with a guaranteed distinction by the "zone" label, we can register different</span>
<span class="c">// ClusterManager instances with the same registry.</span>
<span class="k">func</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="n">zone</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">ClusterManager</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ClusterManager</span><span class="p">{</span>
		<span class="n">Zone</span><span class="o">:</span> <span class="n">zone</span><span class="p">,</span>
		<span class="n">OOMCountDesc</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span>
			<span class="s">"clustermanager_oom_crashes_total"</span><span class="p">,</span>
			<span class="s">"Number of OOM crashes."</span><span class="p">,</span>
			<span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"host"</span><span class="p">},</span>
			<span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"zone"</span><span class="o">:</span> <span class="n">zone</span><span class="p">},</span>
		<span class="p">),</span>
		<span class="n">RAMUsageDesc</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewDesc</span><span class="p">(</span>
			<span class="s">"clustermanager_ram_usage_bytes"</span><span class="p">,</span>
			<span class="s">"RAM usage as reported to the cluster manager."</span><span class="p">,</span>
			<span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"host"</span><span class="p">},</span>
			<span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"zone"</span><span class="o">:</span> <span class="n">zone</span><span class="p">},</span>
		<span class="p">),</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">workerDB</span> <span class="o">:=</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="s">"db"</span><span class="p">)</span>
	<span class="n">workerCA</span> <span class="o">:=</span> <span class="n">NewClusterManager</span><span class="p">(</span><span class="s">"ca"</span><span class="p">)</span>

	<span class="c">// Since we are dealing with custom Collector implementations, it might</span>
	<span class="c">// be a good idea to try it out with a pedantic registry.</span>
	<span class="n">reg</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewPedanticRegistry</span><span class="p">()</span>
	<span class="n">reg</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">workerDB</span><span class="p">)</span>
	<span class="n">reg</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">workerCA</span><span class="p">)</span>

	<span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">HandlerFor</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">HandlerOpts</span><span class="p">{}))</span>
	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8888"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">}</span>

</pre></table></code></div></div><p>此时就可以去http://localhost:8888/metrics 看到传递过去的数据了。</p><ul><li>示例中定义了两个matrics, host和zone分别是其label。<li>pro client内部提供了几个Collector供使用参考<ul><li>在源码包中可以找到go_collector.go, process_collecor.go, expvar_collector这三个文件的Collecor实现。</ul></ul><hr /><h2 id="package">Package</h2><hr /><h3 id="prometheusclient_golang">prometheus/client_golang</h3><p><a href="https://github.com/prometheus/client_golang">prometheus/client_golang</a> 包结构如下:</p><ul><li>api<ul><li>api 包提供了 Prometheus HTTP API</ul><li>api/prometheus/v1<ul><li>v1 包提供了 v1 版本的 Prometheus HTTP API,详见 <a href="http://prometheus.io/docs/querying/api/">http://prometheus.io/docs/querying/api/</a></ul><li>examples/random<ul><li>一个简单的示例,将具有不同类型的随机分布(均匀,正态和指数)的虚构 RPC 延迟公开为 Prometheus 数据指标</ul><li>examples/simple<ul><li>一个使用 Prometheus 工具的最小示例</ul><li>prometheus<ul><li>prometheus 包是 prometheus/client_golang 的核心包</ul><li>prometheus/graphite<ul><li>graphite 包提供了将 Prometheus 数据指标推送到 Graphite 服务的相关代码</ul><li>prometheus/internal<ul><li>内部包</ul><li>prometheus/promauto<ul><li>promauto 包提供了 Prometheus 指标的基本数据类型及其 <code class="language-plaintext highlighter-rouge">…Vec</code> 和 <code class="language-plaintext highlighter-rouge">…Func</code> 变体数据类型的构造函数</ul><li>prometheus/promhttp<ul><li>promhttp 包提供了 HTTP 服务端和客户端相关工具</ul><li>prometheus/push<ul><li>push 包提供了将指标推送到 Pushgateway 的函数</ul><li>prometheus/testutil<ul><li>testutil 包提供了测试使用 prometheus/client_golang 编写的代码的帮助程序</ul><li>prometheus/testutil/promlint<ul><li>promlint 包为 Prometheus 数据指标提供一个参考.</ul></ul><hr /><h3 id="prometheus-包"><code class="language-plaintext highlighter-rouge">prometheus</code> 包</h3><p>导入方式 <code class="language-plaintext highlighter-rouge">import "github.com/prometheus/client_golang/prometheus"</code> .</p><ul><li><code class="language-plaintext highlighter-rouge">prometheus</code> 包是 prometheus/client_golang 的核心包.<ul><li>它为工具代码提供原生数据指标用于监控,并为数据指标对象提供了注册表.</ul><li><code class="language-plaintext highlighter-rouge">promauto</code> 为数据指标提供自动注册的构造函数,<li><code class="language-plaintext highlighter-rouge">promhttp</code> 子包允许通过 HTTP 公开已注册的数据指标,<li><code class="language-plaintext highlighter-rouge">push</code> 子包可以将已注册的数据指标推送到 Pushgateway.</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>

    <span class="s">"github.com/prometheus/client_golang/prometheus"</span>
    <span class="s">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="p">(</span>
    <span class="c">// 通过 NewGauge() 方法创建 Gauge 接口的实现对象</span>
    <span class="n">cpuTemp</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="s">"cpu_temperature_celsius"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"Current temperature of the CPU."</span><span class="p">,</span>
		<span class="p">})</span>
    <span class="c">// 通过 NewCounterVec() 方法创建带"标签"的 CounterVec 对象</span>
    <span class="n">hdFailures</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span> <span class="s">"hd_errors_total"</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">:</span> <span class="s">"Number of hard-disk errors."</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"device"</span><span class="p">},</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Metrics 数据指标必须被注册后才会被公开</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">cpuTemp</span><span class="p">)</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">hdFailures</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">cpuTemp</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="m">65.3</span><span class="p">)</span>
    <span class="n">hdFailures</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"device"</span><span class="o">:</span><span class="s">"/dev/sda"</span><span class="p">})</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>

    <span class="c">// Handler 函数提供了默认的处理程序,以便通过 HTTP 服务公开指标.通常使用 "/metrics" 作为入口点.</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h4 id="自定义-collectors-和常量指标">自定义 Collectors 和常量指标</h4><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包提供了 <code class="language-plaintext highlighter-rouge">NewConstMetric()</code>, <code class="language-plaintext highlighter-rouge">NewConstHistogram()</code>, <code class="language-plaintext highlighter-rouge">NewConstSummary()</code> 及其各自的 <code class="language-plaintext highlighter-rouge">Must…</code> 版本的函数 <code class="language-plaintext highlighter-rouge">动态</code> 创建 <code class="language-plaintext highlighter-rouge">Metric</code> 实例.</p><ul><li>其中 <code class="language-plaintext highlighter-rouge">NewConstMetric()</code> 函数用于创建仅以 float64 数据作为其值的数据指标类型对象,如 <code class="language-plaintext highlighter-rouge">Counter</code>, <code class="language-plaintext highlighter-rouge">Gauge</code> 及 <code class="language-plaintext highlighter-rouge">Untyped</code> 特殊类型对象. <code class="language-plaintext highlighter-rouge">Metric</code> 实例的创建在 <code class="language-plaintext highlighter-rouge">Collect()</code> 方法中进行.</ul><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包提供了 <code class="language-plaintext highlighter-rouge">NewDesc()</code> 函数创建用于描述以上 <code class="language-plaintext highlighter-rouge">Metric</code> 实例的 <code class="language-plaintext highlighter-rouge">Desc</code> 对象,其中主要包含 <code class="language-plaintext highlighter-rouge">Metric</code> 实例的名称与帮助信息.</p><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包还提供了 <code class="language-plaintext highlighter-rouge">NewCounterFunc()</code>, <code class="language-plaintext highlighter-rouge">NewGaugeFunc()</code> 或 <code class="language-plaintext highlighter-rouge">NewUntypedFunc()</code> 函数用于创建实现了 <code class="language-plaintext highlighter-rouge">CounterFunc</code>, <code class="language-plaintext highlighter-rouge">GaugeFunc</code>, <code class="language-plaintext highlighter-rouge">UntypedFunc</code> 接口的 <code class="language-plaintext highlighter-rouge">valueFunc</code> 对象,用于只需要以传入函数的浮点数返回值作为数据指标值创建数据指标的场景.</p><h4 id="registry-的高级用法">Registry 的高级用法</h4><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包提供了 <code class="language-plaintext highlighter-rouge">MustRegister()</code> 函数用于注册 <code class="language-plaintext highlighter-rouge">Collector</code> ,但如果注册过程中发生错误,程序会引发 panics.而使用 <code class="language-plaintext highlighter-rouge">Register()</code> 函数可以实现注册 <code class="language-plaintext highlighter-rouge">Collector</code> 的同时处理可能发生的错误.</p><p><code class="language-plaintext highlighter-rouge">prometheus</code> 包中所有的注册都是在默认的注册表上进行的,可以在全局变量 <code class="language-plaintext highlighter-rouge">DefaultRegisterer</code> 中找到该对象. <code class="language-plaintext highlighter-rouge">prometheus</code> 包提供了 <code class="language-plaintext highlighter-rouge">NewRegistry()</code> 函数用于创建自定义注册表,甚至可以自己实现 <code class="language-plaintext highlighter-rouge">Registerer</code> 或 <code class="language-plaintext highlighter-rouge">Gatherer</code> 接口.</p><p><code class="language-plaintext highlighter-rouge">prometheus</code> 通过 <code class="language-plaintext highlighter-rouge">NewGoCollector()</code> 和 <code class="language-plaintext highlighter-rouge">NewProcessCollector()</code> 函数创建 Go 运行时数据指标的 <code class="language-plaintext highlighter-rouge">Collector</code> 和进程数据指标的 <code class="language-plaintext highlighter-rouge">Collector</code> .而这两个 <code class="language-plaintext highlighter-rouge">Collector</code> 已在默认的注册表 <code class="language-plaintext highlighter-rouge">DefaultRegisterer</code> 中注册.使用自定义注册表,您可以控制并自行决定要注册的 <code class="language-plaintext highlighter-rouge">Collector</code> .</p><h4 id="http-公开数据指标">HTTP 公开数据指标</h4><p>注册表( <code class="language-plaintext highlighter-rouge">Registry</code> 结构体)实现了 <code class="language-plaintext highlighter-rouge">Gatherer</code> 接口,实现了 <code class="language-plaintext highlighter-rouge">Gather()</code> 方法. <code class="language-plaintext highlighter-rouge">Gather()</code> 方法的调用者可以以某种方式公开收集的数据指标.通常通过 <code class="language-plaintext highlighter-rouge">/metrics</code> 入口以 HTTP 方式提供.通过 HTTP 公开数据指标的工具在 <code class="language-plaintext highlighter-rouge">promhttp</code> 包中.</p><h4 id="推送数据指标到-pushgateway">推送数据指标到 Pushgateway</h4><p>在 <code class="language-plaintext highlighter-rouge">push</code> 子包中可以找到用于推送到 Pushgateway 的函数.</p><hr /><h3 id="promauto-包"><code class="language-plaintext highlighter-rouge">promauto</code> 包</h3><p>导入方式: <code class="language-plaintext highlighter-rouge">import "github.com/prometheus/client_golang/prometheus/promauto"</code></p><ul><li><p><code class="language-plaintext highlighter-rouge">promauto</code> 包提供了 Prometheus 指标的基本数据类型及其 <code class="language-plaintext highlighter-rouge">…Vec</code> 和 <code class="language-plaintext highlighter-rouge">…Func</code> 变体数据类型的构造函数.与 <code class="language-plaintext highlighter-rouge">prometheus</code> 包中提供的构造函数不同的是, <code class="language-plaintext highlighter-rouge">promauto</code> 包中的构造函数返回已经注册的 <code class="language-plaintext highlighter-rouge">Collector</code> 对象.</p><li><p><code class="language-plaintext highlighter-rouge">promauto</code> 包中包含三组构造函数, <code class="language-plaintext highlighter-rouge">New&lt;Metric&gt;</code>, <code class="language-plaintext highlighter-rouge">New&lt;Metric&gt;Vec</code> 与 <code class="language-plaintext highlighter-rouge">New&lt;Metric&gt;Func</code> .</p><li><code class="language-plaintext highlighter-rouge">promauto</code> 包中 <code class="language-plaintext highlighter-rouge">NewXXX</code> 函数,其实都是调用了 <code class="language-plaintext highlighter-rouge">prometheus</code> 包中对应的 <code class="language-plaintext highlighter-rouge">NewXXX</code> 函数创建了 <code class="language-plaintext highlighter-rouge">Collector</code> 对象,并将此 <code class="language-plaintext highlighter-rouge">Collector</code> 对象在 <code class="language-plaintext highlighter-rouge">prometheus.DefaultRegisterer</code> 中调用 <code class="language-plaintext highlighter-rouge">MustRegister()</code> 方法注册<li>.因此如果注册失败,所有构造函数都会引发 <code class="language-plaintext highlighter-rouge">panics</code> .</ul><p>以 <code class="language-plaintext highlighter-rouge">promauto.NewCounter()</code> 为例,源代码如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c">// github.com/prometheus/client_golang@v1.7.1/prometheus/promauto/auto.go#L167</span>
<span class="k">func</span> <span class="n">NewCounter</span><span class="p">(</span><span class="n">opts</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">)</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Counter</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">With</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">DefaultRegisterer</span><span class="p">)</span><span class="o">.</span><span class="n">NewCounter</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">f</span> <span class="n">Factory</span><span class="p">)</span> <span class="n">NewCounter</span><span class="p">(</span><span class="n">opts</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">)</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Counter</span> <span class="p">{</span>
	<span class="c">// 调用 prometheus 包中对应方法,创建 Counter 实现对象</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounter</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">r</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="c">// 调用 `prometheus.DefaultRegisterer.MustRegister()` 方法对 Counter 进行注册</span>
        <span class="n">f</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="p">}</span>
	<span class="c">// 返回已注册的 Counter 实现对象</span>
    <span class="k">return</span> <span class="n">c</span>
<span class="p">}</span>
</pre></table></code></div></div><p>示例如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c">// 通过 `promauto` 包中方法创建的 Collector 对象 histogramRegistered 已被注册,</span>
<span class="c">// 可直接被公开为数据指标</span>
<span class="k">var</span> <span class="n">histogramRegistered</span> <span class="o">=</span> <span class="n">promauto</span><span class="o">.</span><span class="n">NewHistogram</span><span class="p">(</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
        <span class="n">Name</span><span class="o">:</span>    <span class="s">"random_number_registered"</span><span class="p">,</span>
        <span class="n">Help</span><span class="o">:</span>    <span class="s">"A histogram of normally distributed random numbers."</span><span class="p">,</span>
        <span class="n">Buckets</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">LinearBuckets</span><span class="p">(</span><span class="o">-</span><span class="m">3</span><span class="p">,</span> <span class="m">.1</span><span class="p">,</span> <span class="m">61</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c">// 通过 `prometheus` 包中方法创建的 Collector 对象 histogramNotRegistered 没有被注册</span>
<span class="c">// 需要手动进行注册才被公开为数据指标</span>
<span class="k">var</span> <span class="n">histogramNotRegistered</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewHistogram</span><span class="p">(</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
        <span class="n">Name</span><span class="o">:</span>    <span class="s">"random_number_not_registered"</span><span class="p">,</span>
        <span class="n">Help</span><span class="o">:</span>    <span class="s">"A histogram of normally distributed random numbers."</span><span class="p">,</span>
        <span class="n">Buckets</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">LinearBuckets</span><span class="p">(</span><span class="o">-</span><span class="m">3</span><span class="p">,</span> <span class="m">.1</span><span class="p">,</span> <span class="m">61</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c">// 在 `init()` 函数中对 histogramNotRegistered 对象进行注册</span>
<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">histogramNotRegistered</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>promauto 包还提供了 With() 函数。<ul><li>该函数返回创建 Collector 的工厂对象。<li>通过该工厂对象创建的 Collector 都在传入的 Registerer 中进行注册.</ul></ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">With</span><span class="p">(</span><span class="n">r</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Registerer</span><span class="p">)</span> <span class="n">Factory</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">Factory</span><span class="p">{</span><span class="n">r</span><span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>示例如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="p">(</span>
    <span class="n">reg</span>           <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewRegistry</span><span class="p">()</span>
    <span class="n">factory</span>       <span class="o">=</span> <span class="n">promauto</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="c">// 使用 reg 定义工厂对象</span>

    <span class="c">// 创建已在 reg 中注册的 histogram 类型的数据对象,该对象实现了 Histogram 接口与 Metric 接口</span>
    <span class="n">randomNumbers</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">NewHistogram</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span>    <span class="s">"random_numbers"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span>    <span class="s">"A histogram of normally distributed random numbers."</span><span class="p">,</span>
			<span class="n">Buckets</span><span class="o">:</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">LinearBuckets</span><span class="p">(</span><span class="o">-</span><span class="m">3</span><span class="p">,</span> <span class="m">.1</span><span class="p">,</span> <span class="m">61</span><span class="p">),</span>
    <span class="p">})</span>

    <span class="c">// 创建已在 reg 中注册的带有标签的 counter 类型的数据对象,该对象实现了 Collector 接口</span>
    <span class="n">requestCount</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span> <span class="s">"http_requests_total"</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">:</span> <span class="s">"Total number of HTTP requests by status code and method."</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"code"</span><span class="p">,</span> <span class="s">"method"</span><span class="p">},</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></table></code></div></div><hr /><h3 id="promhttp-包"><code class="language-plaintext highlighter-rouge">promhttp</code> 包</h3><p><code class="language-plaintext highlighter-rouge">promhttp</code> 包允许创建 <code class="language-plaintext highlighter-rouge">http.Handler</code> 实例通过 HTTP 公开 Prometheus 数据指标.</p><hr /><h4 id="handler-与-handlerfor-函数"><code class="language-plaintext highlighter-rouge">Handler()</code> 与 <code class="language-plaintext highlighter-rouge">HandlerFor()</code> 函数</h4><p><code class="language-plaintext highlighter-rouge">promhttp</code> 包提供了 <code class="language-plaintext highlighter-rouge">Handler()</code> 函数使用默认的 <code class="language-plaintext highlighter-rouge">prometheus.DefaultGatherer</code> 返回一个 <code class="language-plaintext highlighter-rouge">http.Handler</code> .它将第一个错误报告为 HTTP 错误,没有错误记录.返回的 <code class="language-plaintext highlighter-rouge">http.Handler</code> 已使用 <code class="language-plaintext highlighter-rouge">InstrumentMetricHandler()</code> 函数和默认的 <code class="language-plaintext highlighter-rouge">prometheus.DefaultRegisterer</code> 进行检测.如果调用多个 <code class="language-plaintext highlighter-rouge">Handler()</code> 函数创建多个 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,则用于检测的数据指标将在它们之间共享,从而提供全局采集计数.如 <code class="language-plaintext highlighter-rouge">promhttp_metric_handler_requests_total</code> 和 <code class="language-plaintext highlighter-rouge">promhttp_metric_handler_requests_in_flight</code> 数据指标.</p><p><code class="language-plaintext highlighter-rouge">promhttp</code> 包提供了 <code class="language-plaintext highlighter-rouge">HandlerFor()</code> 函数,您可以为自定义注册表或实现 <code class="language-plaintext highlighter-rouge">Gatherer</code> 接口的任何内容创建处理程序,还允许通过传入 <code class="language-plaintext highlighter-rouge">HandlerOpts</code> 对象自定义错误处理行为或记录错误的对象.</p><h4 id="instrumenthandlerx-包装器函数"><code class="language-plaintext highlighter-rouge">InstrumentHandlerX</code> 包装器函数</h4><p><code class="language-plaintext highlighter-rouge">promhttp</code> 包提供了通过中间件来检测 <code class="language-plaintext highlighter-rouge">http.Handler</code> 实例的工具.中间件包装器遵循 <code class="language-plaintext highlighter-rouge">InstrumentHandlerX</code> 命名方案,其中 <code class="language-plaintext highlighter-rouge">X</code> 描述了中间件的预期用途.有关详细信息,请参见每个函数的文档注释.</p><p><code class="language-plaintext highlighter-rouge">promhttp</code> 包提供以下中间件包装器:</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerCounter(counter *prometheus.CounterVec, next http.Handler) http.HandlerFunc</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerCounter</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,并通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.CounterVec</code> 记录不同请求方法或响应状态分组的计数结果.</p><p><code class="language-plaintext highlighter-rouge">CounterVec</code> 可以通过 HTTP 状态码或方法对 <code class="language-plaintext highlighter-rouge">CounterVec</code> 中带有相应标签实例的数据指标进行分组,其允许的标签名称是 <code class="language-plaintext highlighter-rouge">"code"</code> 和 <code class="language-plaintext highlighter-rouge">"method"</code> ,否则该函数会引发 panics.对于未分区的计数,可使用不带标签的 <code class="language-plaintext highlighter-rouge">CounterVec</code> .如果装饰的 <code class="language-plaintext highlighter-rouge">Handler</code> 未设置状态码,默认为 200.</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerDuration(obs prometheus.ObserverVec, next http.Handler) http.HandlerFunc</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerDuration</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,并通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.ObserverVec</code> 记录不同请求方法或响应状态分组的持续时间.持续时间以秒为单位.</p><p>与 <code class="language-plaintext highlighter-rouge">CounterVec</code> 类似, <code class="language-plaintext highlighter-rouge">ObserverVec</code> 可以通过 HTTP 状态码或方法对 <code class="language-plaintext highlighter-rouge">ObserverVec</code> 中带有相应标签实例的数据指标进行分组,其默认允许的标签名称是 <code class="language-plaintext highlighter-rouge">"code"</code> 和 <code class="language-plaintext highlighter-rouge">"method"</code> ,如果除 <code class="language-plaintext highlighter-rouge">method,code</code> 外有其它标签,需要在包装器中调用 <code class="language-plaintext highlighter-rouge">CurryWith()</code> 或 <code class="language-plaintext highlighter-rouge">MustCurryWith()</code> 传入标签的值,否则该函数会引发 panics.对于未分区的计数,可使用不带标签的 <code class="language-plaintext highlighter-rouge">ObserverVec</code> .如果装饰的 <code class="language-plaintext highlighter-rouge">Handler</code> 未设置状态码,默认为 200.</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerInFlight(g prometheus.Gauge, next http.Handler) http.Handler</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerInFlight</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,它通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.Gauge</code> 记录处理的请求数</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerRequestSize(obs prometheus.ObserverVec, next http.Handler) http.HandlerFunc</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerRequestSize</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,它通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.ObserverVec</code> 记录不同请求方法或响应状态分组的请求大小.请求大小以字节为单位.</p><p>与 <code class="language-plaintext highlighter-rouge">CounterVec</code> 类似, <code class="language-plaintext highlighter-rouge">ObserverVec</code> 可以通过 HTTP 状态码或方法对 <code class="language-plaintext highlighter-rouge">ObserverVec</code> 中带有相应标签实例的数据指标进行分组,其默认允许的标签名称是 <code class="language-plaintext highlighter-rouge">"code"</code> 和 <code class="language-plaintext highlighter-rouge">"method"</code> ,如果除 <code class="language-plaintext highlighter-rouge">method,code</code> 外有其它标签,需要在包装器中调用 <code class="language-plaintext highlighter-rouge">CurryWith()</code> 或 <code class="language-plaintext highlighter-rouge">MustCurryWith()</code> 传入标签的值,否则该函数会引发 panics.对于未分区的计数,可使用不带标签的 <code class="language-plaintext highlighter-rouge">ObserverVec</code> .如果装饰的 <code class="language-plaintext highlighter-rouge">Handler</code> 未设置状态码,默认为 200.</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerResponseSize(obs prometheus.ObserverVec, next http.Handler) http.Handler</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerResponseSize</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,它通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.ObserverVec</code> 记录不同请求方法或响应状态分组的响应大小.响应大小以字节为单位.</p><p>与 <code class="language-plaintext highlighter-rouge">CounterVec</code> 类似, <code class="language-plaintext highlighter-rouge">ObserverVec</code> 可以通过 HTTP 状态码或方法对 <code class="language-plaintext highlighter-rouge">ObserverVec</code> 中带有相应标签实例的数据指标进行分组,其默认允许的标签名称是 <code class="language-plaintext highlighter-rouge">"code"</code> 和 <code class="language-plaintext highlighter-rouge">"method"</code> ,如果除 <code class="language-plaintext highlighter-rouge">method,code</code> 外有其它标签,需要在包装器中调用 <code class="language-plaintext highlighter-rouge">CurryWith()</code> 或 <code class="language-plaintext highlighter-rouge">MustCurryWith()</code> 传入标签的值,否则该函数会引发 panics.对于未分区的计数,可使用不带标签的 <code class="language-plaintext highlighter-rouge">ObserverVec</code> .如果装饰的 <code class="language-plaintext highlighter-rouge">Handler</code> 未设置状态码,默认为 200.</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentHandlerTimeToWriteHeader(obs prometheus.ObserverVec, next http.Handler) http.HandlerFunc</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentHandlerResponseSize</code> 包装传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> ,它通过传入的 <code class="language-plaintext highlighter-rouge">prometheus.ObserverVec</code> 记录不同请求方法或响应状态分组的写入响应头部的时间.持续时间以秒为单位.</p><p>与 <code class="language-plaintext highlighter-rouge">CounterVec</code> 类似, <code class="language-plaintext highlighter-rouge">ObserverVec</code> 可以通过 HTTP 状态码或方法对 <code class="language-plaintext highlighter-rouge">ObserverVec</code> 中带有相应标签实例的数据指标进行分组,其默认允许的标签名称是 <code class="language-plaintext highlighter-rouge">"code"</code> 和 <code class="language-plaintext highlighter-rouge">"method"</code> ,如果除 <code class="language-plaintext highlighter-rouge">method,code</code> 外有其它标签,需要在包装器中调用 <code class="language-plaintext highlighter-rouge">CurryWith()</code> 或 <code class="language-plaintext highlighter-rouge">MustCurryWith()</code> 传入标签的值,否则该函数会引发 panics.对于未分区的计数,可使用不带标签的 <code class="language-plaintext highlighter-rouge">ObserverVec</code> .如果装饰的 <code class="language-plaintext highlighter-rouge">Handler</code> 未设置状态码,默认为 200.</p><ul><li><code class="language-plaintext highlighter-rouge">func InstrumentMetricHandler(reg prometheus.Registerer, handler http.Handler) http.Handler</code></ul><p><code class="language-plaintext highlighter-rouge">InstrumentMetricHandler</code> 通常与 <code class="language-plaintext highlighter-rouge">HandlerFor</code> 函数返回的 <code class="language-plaintext highlighter-rouge">http.Handler</code> 一起使用.它使用两个数据指标为传入的 <code class="language-plaintext highlighter-rouge">http.Handler</code> 进行包装: <code class="language-plaintext highlighter-rouge">promhttp_metric_handler_requests_total</code> ( <code class="language-plaintext highlighter-rouge">CounterVec</code> 类型) 对按 HTTP 响应状态码分组的请求进行计数, <code class="language-plaintext highlighter-rouge">promhttp_metric_handler_requests_in_flight</code> ( <code class="language-plaintext highlighter-rouge">Gauge</code> 类型) 跟踪同时进行的请求数量.</p><p>如上两个数据指标对于查看多少数据指标采集请求发送到监控目标上以及它们的重复率(同时有多少个采集请求)非常有用.</p><h4 id="示例">示例</h4><p>中间件包装器示例如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">inFlightGauge</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewGauge</span><span class="p">(</span>
		<span class="n">prometheus</span><span class="o">.</span><span class="n">GaugeOpts</span><span class="p">{</span>
			<span class="n">Name</span><span class="o">:</span> <span class="s">"in_flight_requests"</span><span class="p">,</span>
			<span class="n">Help</span><span class="o">:</span> <span class="s">"A gauge of requests currently being served by the wrapped handler."</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="c">// 带有 "code", "method" 标签的计数器</span>
    <span class="n">counter</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewCounterVec</span><span class="p">(</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">CounterOpts</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span> <span class="s">"api_requests_total"</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">:</span> <span class="s">"A counter for requests to the wrapped handler."</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"code"</span><span class="p">,</span> <span class="s">"method"</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="c">// 带标签的 duration.</span>
	<span class="c">// 如果除 `method,code` 外有其它标签,需要在包装器中调用 `CurryWith()` 或 `MustCurryWith()` 传入标签的值.</span>
    <span class="n">duration</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewHistogramVec</span><span class="p">(</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span>    <span class="s">"request_duration_seconds"</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">:</span>    <span class="s">"A histogram of latencies for requests."</span><span class="p">,</span>
            <span class="n">Buckets</span><span class="o">:</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="m">.25</span><span class="p">,</span> <span class="m">.5</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2.5</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">10</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"handler"</span><span class="p">,</span> <span class="s">"method"</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="c">// 不带标签的 responseSize</span>
    <span class="n">responseSize</span> <span class="o">:=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewHistogramVec</span><span class="p">(</span>
        <span class="n">prometheus</span><span class="o">.</span><span class="n">HistogramOpts</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span>    <span class="s">"response_size_bytes"</span><span class="p">,</span>
            <span class="n">Help</span><span class="o">:</span>    <span class="s">"A histogram of response sizes for requests."</span><span class="p">,</span>
            <span class="n">Buckets</span><span class="o">:</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="m">200</span><span class="p">,</span> <span class="m">500</span><span class="p">,</span> <span class="m">900</span><span class="p">,</span> <span class="m">1500</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
    <span class="p">)</span>

    <span class="c">// 创建将被中间件包装的 Handlers</span>
    <span class="n">pushHandler</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span>
		<span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span><span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Push"</span><span class="p">))</span>
    <span class="p">})</span>
    <span class="n">pullHandler</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span>
		<span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span><span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Pull"</span><span class="p">))</span>
    <span class="p">})</span>

    <span class="c">// 在默认的注册表中注册所有的数据指标</span>
    <span class="n">prometheus</span><span class="o">.</span><span class="n">MustRegister</span><span class="p">(</span><span class="n">inFlightGauge</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">responseSize</span><span class="p">)</span>

    <span class="c">// 按照以上定义的数据指标将 Handler 分组,并通过 `ObserverVec` 接口的 `MustCurryWith()` 方法传入 "handler" 标签</span>
    <span class="n">pushChain</span> <span class="o">:=</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerInFlight</span><span class="p">(</span><span class="n">inFlightGauge</span><span class="p">,</span>
        <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerDuration</span><span class="p">(</span>
			<span class="n">duration</span><span class="o">.</span><span class="n">MustCurryWith</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"handler"</span><span class="o">:</span> <span class="s">"push"</span><span class="p">}),</span>
            <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerCounter</span><span class="p">(</span>
				<span class="n">counter</span><span class="p">,</span>
                <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerResponseSize</span><span class="p">(</span><span class="n">responseSize</span><span class="p">,</span> <span class="n">pushHandler</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pullChain</span> <span class="o">:=</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerInFlight</span><span class="p">(</span><span class="n">inFlightGauge</span><span class="p">,</span>
        <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerDuration</span><span class="p">(</span>
			<span class="n">duration</span><span class="o">.</span><span class="n">MustCurryWith</span><span class="p">(</span><span class="n">prometheus</span><span class="o">.</span><span class="n">Labels</span><span class="p">{</span><span class="s">"handler"</span><span class="o">:</span> <span class="s">"pull"</span><span class="p">}),</span>
            <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerCounter</span><span class="p">(</span>
				<span class="n">counter</span><span class="p">,</span>
                <span class="n">promhttp</span><span class="o">.</span><span class="n">InstrumentHandlerResponseSize</span><span class="p">(</span><span class="n">responseSize</span><span class="p">,</span> <span class="n">pullHandler</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/metrics"</span><span class="p">,</span> <span class="n">promhttp</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
    <span class="c">// 对不同的 HTTP 入口端点请求应用到带有不同标签的 Handler 中间件包装器</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/pull"</span><span class="p">,</span> <span class="n">pullChain</span><span class="p">)</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/push"</span><span class="p">,</span> <span class="n">pushChain</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":3000"</span><span class="p">,</span> <span class="no">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h3 id="push-包"><code class="language-plaintext highlighter-rouge">push</code> 包</h3><ul><li><code class="language-plaintext highlighter-rouge">push</code> 包提供了将数据指标推送到 Pushgateway 的函数,<li>它使用构造其函数 <code class="language-plaintext highlighter-rouge">New()</code> 创建 <code class="language-plaintext highlighter-rouge">Pusher</code> 对象,然后使用其实例方法添加各种选项,最后调用 <code class="language-plaintext highlighter-rouge">Add()</code> 或 <code class="language-plaintext highlighter-rouge">Push()</code> 方法向 Pushgateway 推送数据指标.</ul><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">push</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"http://example.org/metrics"</span><span class="p">,</span> <span class="s">"my_job"</span><span class="p">)</span><span class="o">.</span><span class="n">Gatherer</span><span class="p">(</span><span class="n">myRegistry</span><span class="p">)</span><span class="o">.</span><span class="n">Push</span><span class="p">()</span>

<span class="c">// Complex case:</span>
<span class="n">push</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"http://example.org/metrics"</span><span class="p">,</span> <span class="s">"my_job"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Collector</span><span class="p">(</span><span class="n">myCollector1</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Collector</span><span class="p">(</span><span class="n">myCollector2</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Grouping</span><span class="p">(</span><span class="s">"zone"</span><span class="p">,</span> <span class="s">"xy"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myHTTPClient</span><span class="p">)</span><span class="o">.</span>
    <span class="n">BasicAuth</span><span class="p">(</span><span class="s">"top"</span><span class="p">,</span> <span class="s">"secret"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Add</span><span class="p">()</span>
</pre></table></code></div></div><p>源码解析如下:</p><div class="language-go highlighter-rouge"><div class="code-header" text-data="go"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
</pre><td class="rouge-code"><pre><span class="c">// github.com/prometheus/client_golang/prometheus/push/push.go</span>
<span class="c">// 定义 Pusher 结构体及构造方法</span>
<span class="k">type</span> <span class="n">Pusher</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">error</span> <span class="kt">error</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">job</span> <span class="kt">string</span>
    <span class="n">grouping</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
    <span class="n">gatherers</span>  <span class="n">prometheus</span><span class="o">.</span><span class="n">Gatherers</span>
    <span class="n">registerer</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Registerer</span><span class="o">=</span>
    <span class="n">client</span>             <span class="n">HTTPDoer</span>
    <span class="n">useBasicAuth</span>       <span class="kt">bool</span>
    <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="kt">string</span>
    <span class="n">expfmt</span> <span class="n">expfmt</span><span class="o">.</span><span class="n">Format</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">job</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="k">var</span> <span class="p">(</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">NewRegistry</span><span class="p">()</span>
        <span class="n">err</span> <span class="kt">error</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">job</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">errJobEmpty</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"://"</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">url</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">strings</span><span class="o">.</span><span class="n">HasSuffix</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"/"</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="o">:</span><span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">Pusher</span><span class="p">{</span>
        <span class="kt">error</span><span class="o">:</span>      <span class="n">err</span><span class="p">,</span>
        <span class="n">url</span><span class="o">:</span>        <span class="n">url</span><span class="p">,</span>
        <span class="n">job</span><span class="o">:</span>        <span class="n">job</span><span class="p">,</span>
        <span class="n">grouping</span><span class="o">:</span>   <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{},</span>
        <span class="n">gatherers</span><span class="o">:</span>  <span class="n">prometheus</span><span class="o">.</span><span class="n">Gatherers</span><span class="p">{</span><span class="n">reg</span><span class="p">},</span>
        <span class="n">registerer</span><span class="o">:</span> <span class="n">reg</span><span class="p">,</span>
        <span class="n">client</span><span class="o">:</span>     <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{},</span> <span class="c">// 使用默认的 HTTP 客户端</span>
        <span class="n">expfmt</span><span class="o">:</span>     <span class="n">expfmt</span><span class="o">.</span><span class="n">FmtProtoDelim</span><span class="p">,</span> <span class="c">// 默认使用 expfmt.FmtProtoDelim</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// 添加 Gatherer 对象到 Pusher 中</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Gatherer</span><span class="p">(</span><span class="n">g</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Gatherer</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">gatherers</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">gatherers</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// 添加 Collector 对象到 Pusher 中</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Collector</span><span class="p">(</span><span class="n">c</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">Collector</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">registerer</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// 对 Pusher 添加键值对分组</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Grouping</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">model</span><span class="o">.</span><span class="n">LabelName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">IsValid</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"grouping label has invalid name: %s"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">.</span><span class="n">grouping</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// 自定义 Pusher 向 Pushgateway 发送请求的 HTTP 客户端</span>
<span class="c">// HTTP 客户端是 `HTTPDoer` 接口的实现类,也就是实现了 `Do(*http.Request)` 方法</span>
<span class="c">// 默认的 http.Client 满足这个要求,因此可以直接使用</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Client</span><span class="p">(</span><span class="n">c</span> <span class="n">HTTPDoer</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// BasicAuth 配置 Pusher 使用 HTTP Basic Authentication</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">BasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">useBasicAuth</span> <span class="o">=</span> <span class="no">true</span>
    <span class="n">p</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">p</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// Format 配置 Pusher 使用 `expfmt.Format` 的编码类型.默认为 `expfmt.FmtProtoDelim`</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Format</span><span class="p">(</span><span class="n">format</span> <span class="n">expfmt</span><span class="o">.</span><span class="n">Format</span><span class="p">)</span> <span class="o">*</span><span class="n">Pusher</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">expfmt</span> <span class="o">=</span> <span class="n">format</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// Pusher 向 Pushgateway 发送 DELETE 请求,删除 URL 下所有数据指标.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Delete</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">MethodDelete</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">fullURL</span><span class="p">(),</span> <span class="no">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">useBasicAuth</span> <span class="p">{</span>
        <span class="n">req</span><span class="o">.</span><span class="n">SetBasicAuth</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusAccepted</span> <span class="p">{</span>
        <span class="n">body</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span> <span class="c">// Ignore any further error as this is for an error message only.</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"unexpected status code %d while deleting %s: %s"</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">fullURL</span><span class="p">(),</span> <span class="n">body</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// Push 从添加到此 Pusher 的所有 Collector 和 Gatherer 收集所有指标,然后使用配置的作业名称和分组标签作为分组键,将指标推送到配置的 Pushgateway</span>
<span class="c">// 具有该作业和其他分组标签的所有先前推送的数据指标将被此调用推送的指标替换.一般用于第一次推送(类似于删除原来推送的数据,后重新推送)</span>
<span class="c">// Push 方法向 Pushgateway 发送 PUT 请求</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Push</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">MethodPut</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Add 的工作方式类似于 Push,但只会替换具有相同名称(以及相同的作业和其他分组标签)的先前推送的指标.一般用于后续推送(类似于对此次推送的数据做更新或添加)</span>
<span class="c">// Add 方法向 Pushgateway 发送 POST 请求</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">Add</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">MethodPost</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// github.com/prometheus/client_golang/prometheus/push/push.goL236</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Pusher</span><span class="p">)</span> <span class="n">push</span><span class="p">(</span><span class="n">method</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="kt">error</span>
    <span class="p">}</span>
    <span class="c">// 这里应该是收集各个注册的 Collector 的数据指标</span>
    <span class="n">mfs</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">gatherers</span><span class="o">.</span><span class="n">Gather</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">buf</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span><span class="p">{}</span>
    <span class="n">enc</span> <span class="o">:=</span> <span class="n">expfmt</span><span class="o">.</span><span class="n">NewEncoder</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">expfmt</span><span class="p">)</span>
    <span class="c">// Check for pre-existing grouping labels:</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mf</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">mfs</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">mf</span><span class="o">.</span><span class="n">GetMetric</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">m</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span> <span class="o">==</span> <span class="s">"job"</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"pushed metric %s (%s) already contains a job label"</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span> <span class="n">m</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">grouping</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">GetName</span><span class="p">()];</span> <span class="n">ok</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span>
                        <span class="s">"pushed metric %s (%s) already contains grouping label %s"</span><span class="p">,</span>
                        <span class="n">mf</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c">// 这里应该是将 mf 序列化后写入了请求体 buf</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c">// 使用 http 包创建新请求,请求使用指定的 方法,URL 与 请求体 buf,并配置请求的各种参数</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">fullURL</span><span class="p">(),</span> <span class="n">buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">useBasicAuth</span> <span class="p">{</span>
        <span class="n">req</span><span class="o">.</span><span class="n">SetBasicAuth</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">contentTypeHeader</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">expfmt</span><span class="p">))</span>
    <span class="c">// 发送请求</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="c">// Depending on version and configuration of the PGW, StatusOK or StatusAccepted may be returned.</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusAccepted</span> <span class="p">{</span>
        <span class="n">body</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span> <span class="c">// Ignore any further error as this is for an error message only.</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"unexpected status code %d while pushing to %s: %s"</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">fullURL</span><span class="p">(),</span> <span class="n">body</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/02security/'>02Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/02security/" class="post-tag no-text-decoration" >02Security</a> <a href="/tags/prometheus/" class="post-tag no-text-decoration" >Prometheus</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Monitor - Prometheus - Grace&url=https://ocholuo.github.io//posts/Prometheus/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Monitor - Prometheus - Grace&u=https://ocholuo.github.io//posts/Prometheus/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Monitor - Prometheus - Grace&url=https://ocholuo.github.io//posts/Prometheus/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Interview-Q/"><div class="card-body"> <span class="timeago small" >Feb 28, 2022<i class="unloaded">2022-02-28T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>遇到的 Interview Quetsions</h3><div class="text-muted small"><p> Question during interview AWS Streaming packet processing calculate number of 1s in the binary form. 1 亚麻order Apple ...</p></div></div></a></div><div class="card"> <a href="/posts/whitebox-cipher/"><div class="card-body"> <span class="timeago small" >Jan 18, 2022<i class="unloaded">2022-01-18T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cryptography - White box Cryptography</h3><div class="text-muted small"><p> Cryptography - White box Cryptography Kerckhoffs’s Principle basic attacks link Cryptography - White box Cryptography In penetration testing, white-box te...</p></div></div></a></div><div class="card"> <a href="/posts/CompanyBenefit/"><div class="card-body"> <span class="timeago small" >Nov 8, 2021<i class="unloaded">2021-11-08T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Company Benefit</h3><div class="text-muted small"><p> Company Benefit Future Plan 401k Life and Accident Insurance HSA FSA Limited Purpose FSA Depe...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/web-cache/" class="btn btn-outline-primary" prompt="Older"><p>Meow's CyberAttack - - Web cache posion</p></a> <a href="/posts/GCP/" class="btn btn-outline-primary" prompt="Newer"><p>GCP - Google Cloud Platform Fundamentals - Core Infrastructure</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
