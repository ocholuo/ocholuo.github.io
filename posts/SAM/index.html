<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="AWS - Compute - SAM" /><meta property="og:locale" content="en" /><meta name="description" content="SAM Serverless Application Model 无服务器应用模型 AWS SAM Benefits of using AWS SAM SAM 模板特有资源类型 AWS::Serverless::Function AWS::Serverless::Api AWS::Serverless::SimpleTable SAM code example 使用SAM模板管理Lambda环境变量 用CloudFormation部署SAM模板 Deploying a Hello World application Process Amazon S3 events SAM + Lambda" /><meta property="og:description" content="SAM Serverless Application Model 无服务器应用模型 AWS SAM Benefits of using AWS SAM SAM 模板特有资源类型 AWS::Serverless::Function AWS::Serverless::Api AWS::Serverless::SimpleTable SAM code example 使用SAM模板管理Lambda环境变量 用CloudFormation部署SAM模板 Deploying a Hello World application Process Amazon S3 events SAM + Lambda" /><link rel="canonical" href="https://ocholuo.github.io//posts/SAM/" /><meta property="og:url" content="https://ocholuo.github.io//posts/SAM/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-18T11:11:11-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS - Compute - SAM" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2020-07-18T11:11:11-04:00","description":"SAM Serverless Application Model 无服务器应用模型 AWS SAM Benefits of using AWS SAM SAM 模板特有资源类型 AWS::Serverless::Function AWS::Serverless::Api AWS::Serverless::SimpleTable SAM code example 使用SAM模板管理Lambda环境变量 用CloudFormation部署SAM模板 Deploying a Hello World application Process Amazon S3 events SAM + Lambda","headline":"AWS - Compute - SAM","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/SAM/"},"url":"https://ocholuo.github.io//posts/SAM/"}</script><title>AWS - Compute - SAM | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AWS - Compute - SAM</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AWS - Compute - SAM</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 18, 2020, 11:11 AM -0400" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4641 words">25 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#sam-serverless-application-model-无服务器应用模型">SAM Serverless Application Model 无服务器应用模型</a><ul><li><a href="#aws-sam">AWS SAM</a><li><a href="#benefits-of-using-aws-sam">Benefits of using AWS SAM</a><ul><li><a href="#sam-模板特有资源类型">SAM 模板特有资源类型</a><ul><li><a href="#awsserverlessfunction">AWS::Serverless::Function</a><li><a href="#awsserverlessapi">AWS::Serverless::Api</a><li><a href="#awsserverlesssimpletable">AWS::Serverless::SimpleTable</a></ul></ul><li><a href="#sam-code">SAM code</a><li><a href="#example">example</a><ul><li><a href="#使用sam模板管理lambda环境变量">使用SAM模板管理Lambda环境变量</a><li><a href="#用cloudformation部署sam模板">用CloudFormation部署SAM模板</a><li><a href="#deploying-a-hello-world-application">Deploying a Hello World application</a><li><a href="#process-amazon-s3-events">Process Amazon S3 events</a><li><a href="#sam--lambda">SAM + Lambda</a></ul></ul><li>ref<ul><li>https://aws.amazon.com/cn/blogs/china/getting-started-with-a-serverless-application-model/<li>https://zhuanlan.zhihu.com/p/121438139</ul></ul><hr /><h1 id="sam-serverless-application-model-无服务器应用模型">SAM Serverless Application Model 无服务器应用模型</h1><p><strong>无服务器（Serverless）</strong></p><ul><li>看上去似乎是「没有服务器」的意思，但其实=是「云原生」（Cloud Native）。<li>换句话说，就是「无服务器」的服务，一定是「云原生」的。<li>虽然用户也可以自建机房，也能抽象出一个平台式的服务，看上去好像也不用去管理服务器，但实际上这只是把服务器管理的职责从研发团队转移到了运维团队，所有的成本、风险、经济效应，甚至到遇到问题之后的调试方式和研发的思路，并没有实质的变化。也正因如此，这类服务一般不叫「无服务器」，最多也就被叫「PaaS」（Platform-as-a-Service，平台即服务）。<li>真正要做到无服务器，就意味着管理服务器的工作，服务器运行、运维的成本，必须完全转移到第三方——即云服务商。只有这样，才能做到非常精细的按需付费，并且形成与原来完全不同的研发思路。</ul><p><strong>云研发</strong></p><ul><li>既然服务器运行、运维都由云服务商负责，那么整套体系就必然完全架设在云上，并且对用户来说它是不透明的。<li>也就是说，它是云原生的，系统的整个生命周期都完全在云上。<li>云的巨大弹性和底层优化，使得模拟一个类似环境来做研发、测试变得困难，大家只能都在云上去做研发。<li>最好的情况当然是，我们在浏览器或者远程桌面上开一个 IDE，直接在云上做开发，然后云上做测试，提交代码到云上的仓库，并且通过云上的流水线做部署。<li>可现实是，大部分的研发还是发生在客户端。大家还是希望有个简单的办法，让我在本地机器，用自己喜欢的 IDE 和编辑器，快速地写代码、做测试，而不是必须连到云上来操作。<li>这时候，我们就需要一个工具，它应该要能在本地模拟一套无服务器的研发环境。最好足够简单、便捷，也不辜负我们使用无服务器的初衷。针对这个需求，AWS 推出了 Serverless Application Model（SAM）。</ul><hr /><h2 id="aws-sam">AWS SAM</h2><p><img data-proofer-ignore data-src="https://i.imgur.com/idVQYiw.png" alt="Screen Shot 2021-01-04 at 22.17.51" /></p><ul><li>an open-source framework<ul><li>是一个开源的模型，<li>https://github.com/awslabs/serverless-application-model</ul><li><p>to build serverless applications on AWS.</p><li>A serverless application<ul><li>use AWS SAM to define the serverless applications.<li>用无服务器应用模型 部署 无服务器应用<li>a combination of Lambda functions, event sources, and other resources (such as APIs, databases) that work together to perform tasks.</ul><li><p>AWS 无服务器应用模型 AWS Serverless Application Model</p><li><p>AWS 2016年11月发布</p><li><p>结合AWS自动运维相关的服务如AWS CloudFormation 和AWS CodePipeline，统一管理多种资源，实现无服务器应用的 持续集成和部署。</p><li><p>把这些服务资源方便地管理起来</p><li>an open-source framework to build <strong>serverless applications</strong> on AWS.<ul><li>A serverless application is a combination of <code class="language-plaintext highlighter-rouge">Lambda functions, event sources, and other resources that work together to perform tasks</code>.<li>Note that a serverless application is more than just a Lambda function—it can include additional resources such as APIs, databases, and event source mappings</ul></ul><p>AWS SAM consists of the following components:</p><ol><li>AWS SAM template specification.<ul><li>一套对 CloudFormation 模板格式的扩展，让我们可以更抽象地来定义无服务器资源。<li>use this specification to define the serverless application.<li>simple and clean syntax to describe the functions, APIs, permissions, configurations, and events that make up a serverless application.<li>use an AWS SAM template file to operate on a single, deployable, versioned entity that’s your serverless application.</ul><li>AWS SAM command line interface (AWS SAM CLI).<ul><li>一个命令行工具，帮助我们在本地搭建无服务器计算环境，即 API Gateway 和 Lambda。<li>use this tool to build serverless applications that are defined by AWS SAM templates.<li>The CLI provides commands enable you to<ul><li>verify that AWS SAM template files are written according to the specification,<li>invoke Lambda functions locally,<li>step-through debug Lambda functions,<li>package and deploy serverless applications to the AWS Cloud, and so on.</ul></ul></ol><ul><li><p>基于以yaml格式编写的模板使用各种AWS资源构建应用程序。</p><li><p>实质上是一个AWS CloudFormation 的扩展</p><ul><li>基于AWS CloudFormation 并且为无服务器做了优化，<li>简化了无服务器资源的管理，增加了无服务器相关的新资源类型。<li>AWS CloudFormation标准模板语法比较复杂，SAM模板提供了一套简化的语法<li>SAM 基于 CloudFormation，所以也是支持YAML 和JSON两种格式。</ul></ul><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1"># 模板格式的版本号和Transform声明。</span>
<span class="c1"># Transform声明告诉 CloudFormation这是一个 SAM 模板，需要转换成标准模板再执行。</span>
<span class="c1"># 它的值取固定值，这里是 AWS::Serverless-2016-10-31，告诉CloudFormation这个模板里的声明都是无服务器应用的描述，以及进行相应的转换。</span>
<span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2010-09-09'</span>
<span class="na">Transform</span><span class="pi">:</span> <span class="s">AWS::Serverless-2016-10-31</span>

<span class="c1"># 具体资源的声明：</span>
<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">GetHtmlFunction</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::Function</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CodeUri</span><span class="pi">:</span> <span class="s">s3 file location</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">index.gethtml</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s">nodejs4.3</span>
      <span class="na">Policies</span><span class="pi">:</span> <span class="s">AmazonDynamoDBReadOnlyAccess</span>
      <span class="na">Events</span><span class="pi">:</span>
        <span class="na">GetHtml</span><span class="pi">:</span>
          <span class="na">Type</span><span class="pi">:</span> <span class="s">Api</span>
          <span class="na">Properties</span><span class="pi">:</span>
            <span class="na">Path</span><span class="pi">:</span> <span class="s">/{proxy+}</span>
            <span class="na">Method</span><span class="pi">:</span> <span class="s">ANY</span>
  <span class="na">ListTable</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::SimpleTable</span>
</pre></table></code></div></div><hr /><h2 id="benefits-of-using-aws-sam">Benefits of using AWS SAM</h2><p>Because AWS SAM integrates with other AWS services, creating serverless applications with AWS SAM:</p><p><strong>Single-deployment configuration</strong></p><ul><li>easy to organize related components and resources, and operate on a single stack.<li>use AWS SAM to share configuration (such as memory and timeouts) between resources, and deploy all related resources together as a single, versioned entity.</ul><p><strong>Extension of AWS CloudFormation</strong></p><ul><li>Because AWS SAM is an extension of AWS CloudFormation, you get the reliable deployment capabilities of AWS CloudFormation.<li>You can define resources by using AWS CloudFormation in your AWS SAM template.<li>You can use the full suite of resources, intrinsic functions, and other template features that are available in AWS CloudFormation.</ul><p><strong>Built-in best practices</strong></p><ul><li>You can use AWS SAM to define and deploy your infrastructure as config.<li>This makes it possible for you to use and enforce best practices such as code reviews.<li>Also, with a few lines of configuration, enable safe deployments through CodeDeploy, and enable tracing by using AWS X-Ray.</ul><p><strong>Local debugging and testing</strong></p><ul><li>The AWS SAM CLI lets you locally build, test, and debug serverless applications that are defined by AWS SAM templates.<li>The CLI provides a Lambda-like execution environment locally.<li>It helps you catch issues upfront by providing parity with the actual Lambda execution environment. To step through and debug your code to understand what the code is doing,<li>use AWS SAM with AWS toolkits like the <code class="language-plaintext highlighter-rouge">AWS Toolkit for JetBrains, PyCharm, IntelliJ, Visual Studio Code</code>. This tightens the feedback loop by making it possible for you to find and troubleshoot issues that you might run into in the cloud.</ul><p><strong>Deep integration with development tools</strong></p><ul><li>You can use AWS SAM with a suite of AWS tools for building serverless applications. You can discover new applications in the AWS Serverless Application Repository. For authoring, testing, and debugging AWS SAM–based serverless applications,<li>use the <code class="language-plaintext highlighter-rouge">AWS Cloud9 IDE</code>. To build a deployment pipeline for your serverless applications,<li>use <code class="language-plaintext highlighter-rouge">CodeBuild, CodeDeploy, and CodePipeline</code>.<li>use <code class="language-plaintext highlighter-rouge">AWS CodeStar</code> to get started with a project structure, code repository, and a CI/CD pipeline that’s automatically configured for you. To deploy your serverless application,<li>use the Jenkins plugin.</ul><hr /><h3 id="sam-模板特有资源类型">SAM 模板特有资源类型</h3><p>SAM 模板 7个特有资源类型</p><ul><li><code class="language-plaintext highlighter-rouge">AWS::Serverless::Function</code><li><code class="language-plaintext highlighter-rouge">AWS::Serverless::Api</code><li><code class="language-plaintext highlighter-rouge">AWS::Serverless::SimpleTable</code><li>…<li>这是当前Transform版本为 AWS::Serverless-2016-10-31所支持的特有资源类型。<li>将来还有可能增加更多资源类型，升级换用相应的Transform版本号。</ul><h4 id="awsserverlessfunction">AWS::Serverless::Function</h4><ul><li>Lambda函数，<li>模板中包括Lambda函数所有的属性，如Handler、运行时、代码地址、描述等等。<li>Events用来声明事件源，同一函数可以支持多个事件源。<ul><li>AWS Lambda 是事件驱动的无服务器函数服务，所以事件源也是部署Lambda函数的重要属性。<li>事件源可以有很多种，大体分为3类：<ul><li>数据状态变化，如S3对象的新增、删除。<li>请求端点，这里主要指的是通过 API Gateway 暴露为对外服务的 HTTP API 接口。<li>资源状态变化，如EC2实例的启动、停止等状态。<li>具体产生的事件源来自这些服务：S3、SNS、Kinesis、DynamoDB、Schedule、CloudWatchEvent、AlexaSkill。<li>各事件源的各种事件及属性全部支持。</ul></ul><li>Policies 声明IAM策略。<li>Environment 可以声明环境变量，可用于传递给 Lambda函数。<ul><li>Lambda环境变量<li>Lambda环境变量是可以动态传递给我们的函数的键值对，比如IAM的验证凭据，API的密钥等等。<li>Lambda环境变量是Lambda服务本身的功能，在无服务器应用模型SAM里，我们可以方便地把环境变量管理起来。<li>在SAM模板中以 Parameters 节点来声明环境变量。<li>可以通过标准环境变量API使用，如 Node.js 的process.env 或 Python的os.environ，即Lambda的环境变量会添加到Node.js 的process.env 里，方便咱们开发时使用。</ul><li>另外还有 Tags声明标签，这是 AWS 管理资源的通用功能，比如用于资源分组，账单和成本分解等。</ul><h4 id="awsserverlessapi">AWS::Serverless::Api</h4><ul><li>API Gateway，关于API的详细定义，在 DefinitionUri 指定的swagger.yml里。<li>其余的属性不多，主要是：<li>StageName 阶段名称、<li>CacheClusterEnabled 是否启用API Gateway的缓存，<li>以及 CacheClusterSize缓存的容量。<li>最后的Variables是传递给API 的参数，比如阶段参数，也是用来灵活部署的。</ul><h4 id="awsserverlesssimpletable">AWS::Serverless::SimpleTable</h4><ul><li>用于创建 DynamoDb 表。<li>需要声明主键、类型，以及配置的容量规模。</ul><hr /><h2 id="sam-code">SAM code</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre>
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> awscli
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> aws-sam-cli
<span class="nv">$ </span>sam <span class="nt">--version</span>


<span class="nv">$ </span>tree
SAM-Tutorial
├── afterAllowTraffic.js
├── beforeAllowTraffic.js
├── myFunction.js
└── template.yml


<span class="nv">$ </span>sam package <span class="se">\</span>
    <span class="nt">--template-file</span> template.yml <span class="se">\</span>
    <span class="nt">--output-template-file</span> package.yml <span class="se">\</span>
    <span class="nt">--s3-bucket</span> YOUR_BUCKET
<span class="c"># Uploading to c2fe022d92156eeb459d45f02a766921  4113 / 4113.0  (100.00%)</span>
<span class="c"># Successfully packaged artifacts and wrote output template to file package.yml.</span>



<span class="nv">$ </span>sam deploy <span class="se">\</span>
  <span class="nt">--template-file</span> package.yml <span class="se">\</span>
  <span class="nt">--stack-name</span> my-date-time-app2 <span class="se">\</span>
  <span class="nt">--capabilities</span> CAPABILITY_IAM
    <span class="c"># Deploying with following values</span>
    <span class="c"># ===============================</span>
    <span class="c"># Stack name                 : my-date-time-app2</span>
    <span class="c"># Region                     : None</span>
    <span class="c"># Confirm changeset          : False</span>
    <span class="c"># Deployment s3 bucket       : None</span>
    <span class="c"># Capabilities               : ["CAPABILITY_IAM"]</span>
    <span class="c"># Parameter overrides        : {}</span>

<span class="nv">$ </span>aws lambda invoke <span class="se">\</span>
  <span class="nt">--function</span> arn:aws:lambda:region:xxxx:function:my-date-time-app2-myFunction-1S9F <span class="se">\</span>
  <span class="nt">--payload</span> <span class="s2">"{"</span>option<span class="s2">": "</span><span class="nb">date</span><span class="s2">", "</span>period<span class="s2">": "</span>today<span class="s2">"}"</span> out.txt
<span class="c"># {</span>
<span class="c">#     "StatusCode": 200,</span>
<span class="c">#     "ExecutedVersion": "$LATEST"</span>
<span class="c"># }</span>


<span class="c"># update</span>
<span class="c"># sam build and sam deploy can be leveraged to deploy changes for testing</span>
<span class="nv">$ </span>sam build &amp; sam deploy


SAM init

</pre></table></code></div></div><hr /><h2 id="example">example</h2><h4 id="使用sam模板管理lambda环境变量">使用SAM模板管理Lambda环境变量</h4><p>https://github.com/xfsnow/serverless/tree/master/sam/parameters</p><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="na">Parameters</span><span class="pi">:</span>
<span class="c1"># 声明了一个Lambda环境变量，变量名是MyEnvironment。</span>
<span class="c1"># 属性类型是字符串，默认值是testing，可取值是testing、staging和 prod。</span>
<span class="c1"># 描述, 说明它们具体的使用情况。</span>
  <span class="na">MyEnvironment</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">Default</span><span class="pi">:</span> <span class="s">testing</span>
    <span class="na">AllowedValues</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">testing</span>
      <span class="pi">-</span> <span class="s">staging</span>
      <span class="pi">-</span> <span class="s">prod</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">Environment of this stack of resources</span>

<span class="c1"># 然后在声明Lambda函数时在 Variables 段声明一个环境变量S3_BUCKET</span>
<span class="c1"># 它的值使用CloudFormatioin内置函数 !Ref 读取SAM模板中的环境变量MyEnvironment。</span>
<span class="na">ApiHelloFunction</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::Function</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">index.handler</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s">nodejs6.10</span>
      <span class="na">Environment</span><span class="pi">:</span>
        <span class="na">Variables</span><span class="pi">:</span>
          <span class="na">S3_BUCKET</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">MyEnvironment</span>

<span class="c1"># 相应地，在Lambda函数代码中，index.js 中上述这段就可以通过全局变量process.env 获取到S3_BUCKET这个环境变量值了。</span>
<span class="c1"># var bucketName = process.env.S3_BUCKET;</span>
</pre></table></code></div></div><hr /><h4 id="用cloudformation部署sam模板">用CloudFormation部署SAM模板</h4><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="c"># 把文件上传到S3并打包成可用于 CloudFormation 的模板文件。</span>
aws cloudformation package <span class="se">\</span>
    <span class="nt">--template-file</span> parameters.yaml <span class="se">\</span>
    <span class="nt">--s3-bucket</span> &lt;bucket-name&gt; <span class="se">\</span>
    <span class="nt">--output-template-file</span> packaged_parameters.yaml

<span class="c"># –parameter-overrides MyEnvironment=prod 表示部署时为 CloudFormation 的模板参数指定值为 prod。</span>
aws cloudformation deploy <span class="se">\</span>
   <span class="nt">--template-file</span> output_parameters.yaml <span class="se">\</span>
   <span class="nt">--stack-name</span> parameters <span class="se">\</span>
   <span class="nt">--capabilities</span> CAPABILITY_IAM <span class="se">\</span>
   <span class="nt">--parameter-overrides</span> <span class="nv">MyEnvironment</span><span class="o">=</span>prod

<span class="c"># 顺利地话，会看到逐渐输出的返回结果。</span>
Waiting <span class="k">for </span>changeset to be created..
Waiting <span class="k">for </span>stack create/update to <span class="nb">complete
</span>Successfully created/updated stack - lambdaProxy


<span class="c"># 这时到 CloudFormation 的控制台已经创建出一个 lambdaProxy，整个过程大约持续 1 到 2 分钟。</span>
<span class="c"># 然后到 API Gateway 控制台，可以看到创建出的 lambdaProxy 的 API</span>
<span class="c"># 点击其 Stages 下的 Prod 链接，可以看到形如下面的调用 URL:</span>
<span class="c"># Invoke URL: https://xxxxxxxxx.execute-api.my-region.amazonaws.com/Prod</span>

<span class="c"># 点击它，打开一个新窗口，显示</span>
<span class="o">{</span>“bucketName”:”prod”<span class="o">}</span>
<span class="c"># 表示已经部署成功。</span>


<span class="c"># 再执行一次 aws cloudformation deploy，把 MyEnvironment 参数变成 testing</span>
aws cloudformation deploy <span class="se">\</span>
   <span class="nt">--template-file</span> output_parameters.yaml <span class="se">\</span>
   <span class="nt">--stack-name</span> parameters <span class="se">\</span>
   <span class="nt">--capabilities</span> CAPABILITY_IAM <span class="se">\</span>
   <span class="nt">--parameter-overrides</span> <span class="nv">MyEnvironment</span><span class="o">=</span>testing
<span class="c"># 等待执行完毕后，刷新刚才的调用 URL，可以看到内容已经更新成了</span>
<span class="o">{</span>“bucketName”:”testing”<span class="o">}</span>
<span class="c"># 这个例子演示了我们在SAM模板中定义的环境变量在具体部署时可以灵活赋成不同的值，然后部署出相应的效果。</span>
</pre></table></code></div></div><hr /><h4 id="deploying-a-hello-world-application">Deploying a Hello World application</h4><p>This application implements a basic API backend. It consists of an Amazon API Gateway endpoint and an AWS Lambda function.</p><ul><li>When you send a GET request to the API Gateway endpoint, the Lambda function is invoked.<li>This function returns a hello world message.</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/s2CrYTD.png" alt="sam-getting-started-hello-world" /></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="c"># Prerequisites</span>
<span class="c"># Creating an AWS account.</span>
<span class="c"># Configuring AWS Identity and Access Management (IAM) permissions.</span>

<span class="c"># Installing Docker. prerequisite only for testing your application locally.</span>

<span class="c"># Installing Homebrew.</span>
<span class="c"># Installing the AWS SAM command line interface (CLI).</span>
<span class="c"># Check the version</span>
sam <span class="nt">--version</span> command.

<span class="c"># If you select the Image package type, having an Amazon Elastic Container Registry (Amazon ECR) repository URI to perform a deployment.</span>


<span class="c"># ------------------ Step 1 - Download a sample application</span>
sam init
<span class="c"># This command creates a directory with the name that you provided as the project name. The contents of the project directory are similar to the following:</span>
 sam-app/
   ├── README.md
   ├── events/
   │   └── event.json
   ├── hello_world/
   │   ├── __init__.py
   │   ├── app.py            <span class="c">#Contains your AWS Lambda handler logic.</span>
   │   └── requirements.txt  <span class="c">#Contains any Python dependencies the application requires, used for sam build</span>
   ├── template.yaml         <span class="c">#Contains the AWS SAM template defining your application's AWS resources.</span>
   └── tests/
       └── unit/
           ├── __init__.py
           └── test_handler.p


<span class="c"># ------------------ Step 2 - Build your application</span>
<span class="nb">cd </span>sam-app
sam build
<span class="c"># sam build command builds any dependencies that your application has,</span>
<span class="c"># and copies your application source code to folders under .aws-sam/build to be zipped and uploaded to Lambda.</span>
<span class="c"># You can see the following top-level tree under .aws-sam:</span>
 .aws_sam/
   └── build/
       ├── HelloWorldFunction/ <span class="c"># directory contains app.py file, third-party dependencies that app uses.</span>
       └── template.yaml


<span class="c"># ------------------ Step 3 - Deploy your application</span>
sam deploy <span class="nt">--guided</span>
<span class="c"># This command deploys your application to the AWS Cloud.</span>
<span class="c"># It takes the deployment artifacts that you build with the sam build command, packages and uploads them to an Amazon Simple Storage Service (Amazon S3) bucket that the AWS SAM CLI creates, and deploys the application using AWS CloudFormation.</span>
<span class="c"># In the output of the sam deploy command, you can see the changes being made to your AWS CloudFormation stack.</span>


<span class="c"># ------------------ Step 4 - test your application</span>
<span class="c"># If your application created an HTTP endpoint, the outputs that sam deploy generates also show you the endpoint URL for your test application. You can use curl to send a request to your application using that endpoint URL. For example:</span>
curl https://&lt;restapiid&gt;.execute-api.us-east-1.amazonaws.com/Prod/hello/
<span class="c">#  {"message": "hello world"}</span>


<span class="c"># ------------------ Step 4: (Optional) Test your application locally</span>
<span class="c"># When you're developing your application, you might find it useful to test locally. The AWS SAM CLI provides the sam local command to run your application using Docker containers that simulate the execution environment of Lambda. There are two options to do this:</span>
<span class="c"># Host your API locally</span>
sam <span class="nb">local </span>start-api
curl http://127.0.0.1:3000/hello

<span class="c"># Invoke your Lambda function directly</span>
sam <span class="nb">local </span>invoke <span class="s2">"HelloWorldFunction"</span> <span class="nt">-e</span> events/event.json



</pre></table></code></div></div><h3 id="process-amazon-s3-events">Process Amazon S3 events</h3><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="c"># Step 1: Initialize the application</span>
<span class="c"># download the sample application</span>
<span class="c"># consists of an AWS SAM template and application code.</span>

sam init <span class="se">\</span>
  <span class="nt">--location</span> https://github.com/aws-samples/cookiecutter-aws-sam-s3-rekognition-dynamodb-python <span class="se">\</span>
  <span class="nt">--no-input</span>

<span class="c"># Review the contents of the directory that the command created (aws_sam_ocr/):</span>
<span class="c"># template.yaml – Defines three AWS resources that the Amazon S3 application needs: a Lambda function, an Amazon S3 bucket, and a DynamoDB table. The template also defines the mappings and permissions between these resources.</span>
<span class="c"># src/ directory – Contains the Amazon S3 application code.</span>
<span class="c"># SampleEvent.json – The sample event source, which is used for local testing.</span>



<span class="c"># Step 2: Package the application</span>
<span class="c"># create a Lambda deployment package, which you use to deploy the application to the AWS Cloud.</span>
<span class="c"># This deployment creates the necessary AWS resources and permissions that are required to test the application locally.</span>

<span class="c"># Create an S3 bucket where to save the packaged code.</span>
aws s3 mb s3://bucketname

<span class="c"># Create the deployment package</span>
sam package <span class="se">\</span>
    <span class="nt">--template-file</span> template.yaml <span class="se">\</span>
    <span class="nt">--output-template-file</span> packaged.yaml <span class="se">\ </span> <span class="c"># specify the new template file</span>
    <span class="nt">--s3-bucket</span> bucketname



<span class="c"># Step 3: Deploy the application</span>
<span class="c"># test the application by invoking it in the AWS Cloud.</span>

<span class="c"># To deploy the serverless application to the AWS Cloud</span>
sam deploy <span class="se">\</span>
    <span class="nt">--template-file</span> packaged.yaml <span class="se">\</span>
    <span class="nt">--stack-name</span> aws-sam-ocr <span class="se">\</span>
    <span class="nt">--capabilities</span> CAPABILITY_IAM <span class="se">\ </span>  <span class="c"># allows AWS CloudFormation to create an IAM role.</span>
    <span class="nt">--region</span> us-east-1



<span class="c"># Step 4: test the serverless application in the AWS Cloud</span>
<span class="c"># Upload an image to the Amazon S3 bucket that you created for this sample application.</span>
<span class="c"># Open the DynamoDB console and find the table that was created. See the table for results returned by Amazon Rekognition.</span>
<span class="c"># Verify that the DynamoDB table contains new records that contain text that Amazon Rekognition found in the uploaded image.</span>



<span class="c"># Step 4: Test the application locally</span>
<span class="c"># retrieve the names of the AWS resources that were created by AWS CloudFormation.</span>

<span class="c"># Retrieve the Amazon S3 key name and bucket name from AWS CloudFormation.</span>
<span class="c"># Modify the SampleEvent.json file by replacing the values for the object key, bucket name, and bucket ARN.</span>

<span class="c"># Retrieve the DynamoDB table name. This name is used for the following sam local invoke command.</span>

<span class="c"># generate a sample Amazon S3 event and invoke the Lambda function:</span>
<span class="nv">TABLE_NAME</span><span class="o">=</span><span class="s2">"Table name obtained from AWS CloudFormation console"</span>

sam <span class="nb">local </span>invoke <span class="nt">--event</span> SampleEvent.json

<span class="c"># The TABLE_NAME= portion sets the DynamoDB table name.</span>
<span class="c"># The --event parameter specifies the file that contains the test event message to pass to the Lambda function.</span>
<span class="c">#  now verify that the expected DynamoDB records were created, based on the results returned by Amazon Rekognition.</span>
</pre></table></code></div></div><hr /><h3 id="sam--lambda">SAM + Lambda</h3><p>code:</p><div class="language-py highlighter-rouge"><div class="code-header" text-data="py"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">urllib</span>
<span class="kn">import</span> <span class="n">boto3</span>

<span class="nf">print</span><span class="p">(</span><span class="s">'Loading function'</span><span class="p">)</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="s">'s3'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Get the object from the event and show its content type
</span>    <span class="n">bucket</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'Records'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'s3'</span><span class="p">][</span><span class="s">'bucket'</span><span class="p">][</span><span class="s">'name'</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="nf">unquote_plus</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">'Records'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'s3'</span><span class="p">][</span><span class="s">'object'</span><span class="p">][</span><span class="s">'key'</span><span class="p">].</span><span class="nf">encode</span><span class="p">(</span><span class="s">'utf8'</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="p">.</span><span class="nf">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"CONTENT TYPE: "</span> <span class="o">+</span> <span class="n">response</span><span class="p">[</span><span class="s">'ContentType'</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'ContentType'</span><span class="p">]</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">'Error getting object {} from bucket {}. Make sure they exist and your bucket is in the same region as this function.'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">e</span>
</pre></table></code></div></div><p>resource:</p><ul><li>S3 的 bucket: test4lambda<li>key: lambda-test.txt</ul><p>test</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>sam <span class="nb">local </span>generate-event s3 <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--bucket</span> test4lambda <span class="se">\</span>
  <span class="nt">--key</span> lambda-test.txt <span class="o">&gt;</span> event.json



</pre></table></code></div></div><p>生成如下用例 event.json</p><div class="language-json highlighter-rouge"><div class="code-header" text-data="json"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Records"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"eventVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"eventName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ObjectCreated:Put"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"eventTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1970-01-01T00:00:00.000Z"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"userIdentity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"principalId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"eventSource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aws:s3"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"requestParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"sourceIPAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"s3"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"configurationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"testConfigRule"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"object"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"eTag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0123456789abcdef0123456789abcdef"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lambda-test.txt"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"sequencer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0A1B2C3D4E5F678901"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"ownerIdentity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"principalId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test4lambda"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::test4lambda"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"s3SchemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"responseElements"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"x-amz-id-2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE123/5678abcdefghijklambdaisawesome/mnGH"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"x-amz-request-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE123456789"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"awsRegion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>编写 yaml 配置文件</p><ul><li>到 lambda 后台导出函数<li>下载 AWS SAM 文件</ul><p>得到的配置文件如下</p><div class="language-yaml highlighter-rouge"><div class="code-header" text-data="yaml"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2010-09-09'</span>
<span class="na">Transform</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::Serverless-2016-10-31'</span>
<span class="na">Description</span><span class="pi">:</span> <span class="s">An Amazon S3 trigger that retrieves metadata for the object that has been updated.</span>
<span class="na">Resources</span><span class="pi">:</span>

  <span class="na">myTest1</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::Serverless::Function'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">lambda_function.lambda_handler</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s">python2.7</span>
      <span class="na">CodeUri</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">Description</span><span class="pi">:</span> <span class="s">An Amazon S3 trigger that retrieves metadata for the object that has been updated.</span>
      <span class="na">MemorySize</span><span class="pi">:</span> <span class="m">128</span>
      <span class="na">Timeout</span><span class="pi">:</span> <span class="m">3</span>
      <span class="na">Role</span><span class="pi">:</span> <span class="s1">'</span><span class="s">arn:aws:iam::851829110870:role/service-role/lambdaTest'</span>
      <span class="na">Events</span><span class="pi">:</span>
        <span class="na">BucketEvent1</span><span class="pi">:</span>
          <span class="na">Type</span><span class="pi">:</span> <span class="s">S3</span>
          <span class="na">Properties</span><span class="pi">:</span>
            <span class="na">Bucket</span><span class="pi">:</span>
              <span class="na">Ref</span><span class="pi">:</span> <span class="s">Bucket1</span>
            <span class="na">Events</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s1">'</span><span class="s">s3:ObjectCreated:*'</span>
      <span class="na">Tags</span><span class="pi">:</span>
        <span class="s1">'</span><span class="s">lambda-console:blueprint'</span><span class="err">:</span> <span class="s">s3-get-object-python</span>

  <span class="na">Bucket1</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::S3::Bucket'</span>
</pre></table></code></div></div><p>运行</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>sam <span class="nb">local </span>invoke myTest1 <span class="se">\</span>
  <span class="nt">-e</span> event.json <span class="se">\</span>
  <span class="nt">-t</span> myTest1.yaml

<span class="c"># "time out after 3 seconds"</span>
<span class="c"># 解决方法: 在 myTest1.yaml 找到 Timeout 字段, 改成 30</span>

<span class="c"># 再次运行, 成功输出 "text/plain", 也就是 python 代码那句 print 语句的结果</span>
</pre></table></code></div></div><p>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/01aws/'>01AWS</a>, <a href='/categories/compute/'>Compute</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >AWS</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS - Compute - SAM - Grace&url=https://ocholuo.github.io//posts/SAM/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS - Compute - SAM - Grace&u=https://ocholuo.github.io//posts/SAM/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AWS - Compute - SAM - Grace&url=https://ocholuo.github.io//posts/SAM/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AWSLambda/"><div class="card-body"> <span class="timeago small" >Jul 16, 2020<i class="unloaded">2020-07-16T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - Lambda sample</h3><div class="text-muted small"><p> Lambda sample Lambda sample basic S3 triggered, Loops and inserts data into DynamoDB tables function to calculate and send Simple Notification Service notification basic import json,...</p></div></div></a></div><div class="card"> <a href="/posts/SNS/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - MQ - SAM</h3><div class="text-muted small"><p> SNS - Amazon simple notification service architecture overall massage persistency use case SNS - Amazon simple notification service architectu...</p></div></div></a></div><div class="card"> <a href="/posts/ELK-Setup/"><div class="card-body"> <span class="timeago small" >Feb 11, 2020<i class="unloaded">2020-02-11T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - ELK Setup</h3><div class="text-muted small"><p> ELK Setup basic Install ELK Environment specifications Configuration Filebeat Logstash collect data ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AWS-Inspector/" class="btn btn-outline-primary" prompt="Older"><p>AWS - Security - AWS Inspector (EC2)</p></a> <a href="/posts/ELK/" class="btn btn-outline-primary" prompt="Newer"><p>AWS - ELK</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
