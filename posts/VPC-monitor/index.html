<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="AWS - VPC - Log and monitor" /><meta property="og:locale" content="en" /><meta name="description" content="Log and monitor for Amazon VPC Monitoring NAT gateways using Amazon CloudWatch VPC Flow Logs Flow logs basics create a flow log Flow log records Flow log limitations Flow logs pricing price" /><meta property="og:description" content="Log and monitor for Amazon VPC Monitoring NAT gateways using Amazon CloudWatch VPC Flow Logs Flow logs basics create a flow log Flow log records Flow log limitations Flow logs pricing price" /><link rel="canonical" href="https://ocholuo.github.io//posts/VPC-monitor/" /><meta property="og:url" content="https://ocholuo.github.io//posts/VPC-monitor/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-18T11:11:11-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS - VPC - Log and monitor" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2020-07-18T11:11:11-04:00","description":"Log and monitor for Amazon VPC Monitoring NAT gateways using Amazon CloudWatch VPC Flow Logs Flow logs basics create a flow log Flow log records Flow log limitations Flow logs pricing price","headline":"AWS - VPC - Log and monitor","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/VPC-monitor/"},"url":"https://ocholuo.github.io//posts/VPC-monitor/"}</script><title>AWS - VPC - Log and monitor | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AWS - VPC - Log and monitor</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AWS - VPC - Log and monitor</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 18, 2020, 11:11 AM -0400" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3512 words">19 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#log-and-monitor-for-amazon-vpc">Log and monitor for Amazon VPC</a><ul><li><a href="#monitoring-nat-gateways-using-amazon-cloudwatch">Monitoring NAT gateways using Amazon CloudWatch</a><li><a href="#vpc-flow-logs">VPC Flow Logs</a><ul><li><a href="#flow-logs-basics">Flow logs basics</a><li><a href="#create-a-flow-log">create a flow log</a><li><a href="#flow-log-records">Flow log records</a><li><a href="#flow-log-limitations">Flow log limitations</a><li><a href="#flow-logs-pricing">Flow logs pricing</a><li><a href="#price">price</a></ul></ul></ul><hr /><h1 id="log-and-monitor-for-amazon-vpc">Log and monitor for Amazon VPC</h1><p>use automated monitoring tools to watch components in VPC and report when something is wrong:</p><ol><li><strong>Flow logs</strong>:<ol><li>Flow logs capture information about the IP traffic going to and from network interfaces in VPC.<li>create a flow log for a VPC, subnet, or individual network interface.<li>Flow log data is published to CloudWatch Logs or Amazon S3<li>help diagnose overly restrictive or overly permissive security group and network ACL rules.</ol><li><strong>Monitoring NAT gateways</strong>:<ol><li>monitor NAT gateway using CloudWatch, which collects information from NAT gateway and creates readable, near real-time metrics.</ol><li><strong>Traffic Mirroring</strong><ol><li>provides deeper insight into the network traffic by allow analyze actual traffic content, including payload.<li>Traffic Mirroring is targeted for the following types of cases:<ol><li>Analyzing the actual packets to perform a root-cause analysis on a performance issue<li>Reverse-engineering a sophisticated network attack<li>Detecting and stopping insider abuse or compromised workloads</ol></ol></ol><hr /><h2 id="monitoring-nat-gateways-using-amazon-cloudwatch">Monitoring NAT gateways using Amazon CloudWatch</h2><p>monitor NAT gateway using CloudWatch</p><ul><li>collects information from NAT gateway and creates readable, near real-time metrics.<li>use this information to monitor and troubleshoot NAT gateway.<li>NAT gateway metric data is provided at 1-minute intervals, and statistics are recorded for a period of 15 months.</ul><p>For more information about Amazon CloudWatch, see the Amazon CloudWatch User Guide. For more information about pricing, see Amazon CloudWatch Pricing.</p><hr /><h2 id="vpc-flow-logs">VPC Flow Logs</h2><blockquote><p>to monitor VPC traffic</p></blockquote><blockquote><p>to verify that the configured network access rules are working as expected</p></blockquote><h3 id="flow-logs-basics">Flow logs basics</h3><p>VPC Flow Logs</p><ol><li> <font color="red"> captures accepted and rejected traffic flow information </font><p>that goes to and from all network interfaces in your VPC or in the selected resource.</p><ul><li> <font color="blue"> troubleshoot connectivity and security issues </font><ul><li>why specific traffic is not reaching an instance</ul><li> <font color="blue"> test network access rules </font><ul><li>diagnose overly restrictive security group rules.</ul><li> <font color="blue"> monitor traffic that reaching the instance </font><ul><li>Determining the <code class="language-plaintext highlighter-rouge">direction of the traffic</code> to and from the network interfaces</ul><li> <font color="blue"> detect and investigate security incidents </font></ul><li>can <font color="red"> create alarms </font><ul><li>notify if certain types of traffic are detected<li>create metrics to identify trends and patterns.</ul><li> <font color="red"> enable flow log </font><ul><li>Flow logs can be enabled/created at the following levels:<ul><li>VPC.<li>Subnet.<li>Network interface.</ul><li>If create a flow log for a subnet / VPC, each network interface in the VPC or subnet is monitored.</ul><li>Flow log data is recorded as <font color="red"> flow log records </font><ul><li>log events consisting of fields that describe the traffic flow.<li>Flow log data is collected outside of the path of network traffic<ul><li>therefore does not affect network throughput or latency.<li>create or delete flow logs without any risk of impact to network performance.</ul></ul><li>can be published to <font color="red"> Amazon CloudWatch Logs or Amazon S3 </font><ul><li>CloudWatch Logs<ul><li>Flow log data is published / stored to a <font color="blue"> log group in CloudWatchLogs </font><li>each network interface has a unique <font color="blue"> log stream </font><li>Log streams contain flow log records,<li>which are log events that consist of fields that describe the traffic for that network interface.</ul><li>it can take several minutes to begin collecting and publishing data to the chosen destinations.<ul><li>Flow logs <font color="blue"> do not capture real-time log streams for network interfaces </font></ul><li>If you launch more instances into subnet after you’ve created a flow log for subnet or VPC, a new log stream (for CloudWatch Logs) or log file object (for Amazon S3) is created for each new network interface.<ul><li>This occurs as soon as any network traffic is recorded for that network interface.</ul></ul><li>analyze flow logs with your own applications or with solutions from AWS Marketplace.</ol><hr /><p>You cannot:</p><ul><li>can’t enable flow logs for VPC’s that are peered with your VPC unless the peer VPC is in your account.<li>can’t tag a flow log.<li> <font color="blue"> can’t change the configuration </font><p>of a flow log after it’s been created.</p><ul><li>need to delete and re-create</ul></ul><p>Not all traffic is monitored, e.g. the following traffic is excluded:</p><ul><li>Traffic that goes to Route53.<li>Traffic generated for Windows license activation.<li>Traffic to and from 169.254.169.254 (instance metadata).<li>Traffic to and from 169.254.169.123 for the Amazon Time Sync Service.<li>DHCP traffic.<li>Traffic to the reserved IP address for the default VPC router.</ul><hr /><h3 id="create-a-flow-log">create a flow log</h3><p>To create a flow log, you specify:</p><ul><li><code class="language-plaintext highlighter-rouge">The resource</code> for which to create the flow log<li><code class="language-plaintext highlighter-rouge">The type</code> of traffic to capture (accepted traffic, rejected traffic, or all traffic)<li><code class="language-plaintext highlighter-rouge">The destinations</code> to publish the flow log data</ul><p><img data-proofer-ignore data-src="https://i.imgur.com/sBGBdBd.png" alt="flow-logs-diagram" /></p><p>You can create flow logs for network interfaces that are created by other AWS services, such as:</p><ul><li>Elastic Load Balancing<li>Amazon RDS<li>Amazon ElastiCache<li>Amazon Redshift<li>Amazon WorkSpaces<li>NAT gateways<li>Transit gateways<li>Regardless of the type of network interface, you must use the <code class="language-plaintext highlighter-rouge">Amazon EC2 console</code> or the <code class="language-plaintext highlighter-rouge">Amazon EC2 API</code> to create a flow log for a network interface.</ul><p>You can apply tags to flow logs.</p><ul><li>Each tag consists of a key and an optional value, both of which you define.<li>Tags can help to organize flow logs</ul><p>delete</p><ul><li>Deleting a flow log disables the flow log service for the resource, and no new flow log records are created or published to CloudWatch Logs / Amazon S3.<li>Deleting the flow log does not delete any existing flow log records or log streams (for CloudWatch Logs) or log file objects (for Amazon S3) for a network interface.<li>To delete an existing log stream, use the CloudWatch Logs console.<li>To delete existing log file objects, use the Amazon S3 console.<li>After you’ve deleted a flow log, it can take several minutes to stop collecting data.</ul><hr /><h3 id="flow-log-records">Flow log records</h3><ul><li>A flow log record represents a network flow in VPC.<li>By default, each record captures a network internet protocol (IP) traffic flow (characterized by a 5-tuple on a per network interface basis) that occurs within an aggregation interval, also referred to as a capture window.<li>By default, the record includes values for the different components of the IP flow, including the source, destination, and protocol.<li>When you create a flow log, you can use the default format for the flow log record, or you can specify a custom format.<ul><li>Topics<li>Aggregation interval<li>Default format<li>Custom format<li>Available fields</ul></ul><p><strong>Aggregation interval</strong></p><ul><li>the period of time during which a particular flow is captured and aggregated into a flow log record.<ul><li>By default, the maximum is 10min.<li>when you create a flow log, you can optionally specify a maximum aggregation interval of 1 minute.<li>Flow logs with a maximum aggregation interval of 1 minute produce a higher volume of flow log records than flow logs with a maximum aggregation interval of 10 minutes.</ul><li>When a network interface is attached to a Nitro-based instance, the aggregation interval is always 1 minute or less, regardless of the specified maximum aggregation interval.<li>After data is captured within an aggregation interval, it takes additional time to process and publish the data to CloudWatch Logs or Amazon S3.<ul><li>around 5 min to publish to CloudWatch Logs,<li>around 10 min to publish to Amazon S3.<li>The flow logs service delivers within this additional time in a best effort manner. In some cases, logs might be delayed beyond the 5 to 10 minutes additional time mentioned previously.</ul></ul><p><strong>Default format</strong></p><ul><li>By default, the log line format for a flow log record is a space-separated string that has the following set of fields in the following order.<ul><li><code class="language-plaintext highlighter-rouge">&lt;version&gt; &lt;account-id&gt; &lt;interface-id&gt; &lt;srcaddr&gt; &lt;dstaddr&gt; &lt;srcport&gt; &lt;dstport&gt; &lt;protocol&gt; &lt;packets&gt; &lt;bytes&gt; &lt;start&gt; &lt;end&gt; &lt;action&gt; &lt;log-status&gt;</code><li>The default format captures only a subset of all of the available fields for a flow log record.<li>To capture all available fields or a different subset of fields, specify a <code class="language-plaintext highlighter-rouge">custom format</code>.<li>cannot customize or change the default format.</ul></ul><p><strong>Custom format</strong></p><ul><li>specify a custom format for the flow log record.<li>This enables you to create flow logs that are specific to needs and to omit fields that are not relevant to you.<li>reduce the need for separate processes to extract specific information from published flow logs. You can specify any number of the available flow log fields, but you must specify at least one.</ul><p><strong>Available fields</strong></p><ul><li>The following table describes all of the available fields for a flow log record. The Version column indicates the VPC Flow Logs version in which the field was introduced.</ul><div class="table-wrapper"><table><thead><tr><th>Field<th>Description<th>Version<th> <th> <tbody><tr><td>version<td>The VPC Flow Logs version. If you use the default format, the version is 2. If you use a custom format, the version is the highest version among the specified fields. For example, if you only specify fields from version 2, the version is 2. If you specify a mixture of fields from versions 2, 3, and 4, the version is 4.<td>2<td> <td> <tr><td>account-id<td>The AWS account ID of the owner of the source network interface for which traffic is recorded. If the network interface is created by an AWS service, for example when creating a VPC endpoint or Network Load Balancer, the record may display unknown for this field.<td>2<td> <td> <tr><td>interface-id<td>The ID of the network interface for which the traffic is recorded.<td>2<td> <td> <tr><td>srcaddr<td>The source address for incoming traffic, or the IPv4 or IPv6 address of the network interface for outgoing traffic on the network interface. The IPv4 address of the network interface is always its private IPv4 address. See also pkt-srcaddr.<td>2<td> <td> <tr><td>dstaddr<td>The destination address for outgoing traffic, or the IPv4 or IPv6 address of the network interface for incoming traffic on the network interface. The IPv4 address of the network interface is always its private IPv4 address. See also pkt-dstaddr.<td>2<td> <td> <tr><td>srcport<td>The source port of the traffic.<td>2<td> <td> <tr><td>dstport<td>The destination port of the traffic.<td>2<td> <td> <tr><td>protocol<td>The IANA protocol number of the traffic. For more information, see Assigned Internet Protocol Numbers.<td>2<td> <td> <tr><td>packets<td>The number of packets transferred during the flow<td>2bytes<td>The number of bytes transferred during the flow.<td>2<tr><td>start<td>The time, in Unix seconds, when the first packet of the flow was received within the aggregation interval. This might be up to 60 seconds after the packet was transmitted or received on the network interface.<td>2<td> <td> <tr><td>end<td>The time, in Unix seconds, when the last packet of the flow was received within the aggregation interval. This might be up to 60 seconds after the packet was transmitted or received on the network interface.<td>2<td> <td> <tr><td><code class="language-plaintext highlighter-rouge">action</code><td>The action that is associated with the traffic: <br /> ACCEPT: The recorded traffic was permitted by the security groups and network ACLs. <br /> REJECT: The recorded traffic was not permitted by the security groups or network ACLs.<td>2<td> <td> <tr><td>log-status<td>The logging status of the flow log: <br /> OK: Data is logging normally to the chosen destinations. <br /> NODATA: There was no network traffic to or from the network interface during the aggregation interval. <br /> SKIPDATA: Some flow log records were skipped during the aggregation interval. This may be because of an internal capacity constraint, or an internal error.<td>2<td> <td> <tr><td><code class="language-plaintext highlighter-rouge">vpc-id</code><td>The ID of the VPC that contains the network interface for which the traffic is recorded.<td>3<td> <td> <tr><td>subnet-id<td>The ID of the subnet that contains the network interface for which the traffic is recorded<td>3instance-id<td>The ID of the instance that’s associated with network interface for which the traffic is recorded, if the instance is owned by you. Returns a ‘-‘ symbol for a requester-managed network interface; for example, the network interface for a NAT gateway.<td>3<tr><td><code class="language-plaintext highlighter-rouge">tcp-flags</code><td>The bitmask value for the following TCP flags:<br /> SYN: 2 <br /> SYN-ACK: 18 <br /> FIN: 1 <br /> RST: 4 <br /> ACK is reported only when it’s accompanied with SYN. <br /> TCP flags can be OR-ed during the aggregation interval. For short connections, the flags might be set on the same line in the flow log record, for example, 19 for SYN-ACK and FIN, and 3 for SYN and FIN. For an example, see TCP flag sequence.<td>3<td> <td> <tr><td><code class="language-plaintext highlighter-rouge">type</code><td>The type of traffic: IPv4, IPv6, or EFA. For more information about the Elastic Fabric Adapter (EFA), see Elastic Fabric Adapter.<td>3<td> <td> <tr><td>pkt-srcaddr<td>The packet-level (original) source IP address of the traffic. Use this field with the srcaddr field to distinguish between the IP address of an intermediate layer through which traffic flows, and the original source IP address of the traffic. For example, when traffic flows through a network interface for a NAT gateway, or where the IP address of a pod in Amazon EKS is different from the IP address of the network interface of the instance node on which the pod is running (for communication within a VPC).<td>3<td> <td> <tr><td>pkt-dstaddr<td>The packet-level (original) destination IP address for the traffic. Use this field with the dstaddr field to distinguish between the IP address of an intermediate layer through which traffic flows, and the final destination IP address of the traffic. For example, when traffic flows through a network interface for a NAT gateway, or where the IP address of a pod in Amazon EKS is different from the IP address of the network interface of the instance node on which the pod is running (for communication within a VPC).<td>3<td> <td> <tr><td>region<td>The Region that contains the network interface for which traffic is recorded.<td>4<td> <td> <tr><td>az-id<td>The ID of the Availability Zone that contains the network interface for which traffic is recorded. If the traffic is from a sublocation, the record displays a ‘-‘ symbol for this field.<td>4<td> <td> <tr><td>sublocation-type<td>The type of sublocation that’s returned in the sublocation-id field: <br /> wavelength <br /> outpost <br /> localzone <br /> If the traffic is not from a sublocation, the record displays a ‘-‘ symbol for this field.<td>4<td> <td> <tr><td>sublocation-id<td>The ID of the sublocation that contains the network interface for which traffic is recorded. If the traffic is not from a sublocation, the record displays a ‘-‘ symbol for this field<td>4<td> <td> </table></div><blockquote><p>If a field is not applicable for a specific record, the record displays a ‘-‘ symbol for that entry.</p></blockquote><h3 id="flow-log-limitations">Flow log limitations</h3><ul><li>To use flow logs, you need to be aware of the following limitations:<li>cannot enable flow logs for network interfaces that are in the EC2-Classic platform.<ul><li>This includes EC2-Classic instances that have been linked to a VPC through ClassicLink.</ul><li>can’t enable flow logs for VPCs that are peered with VPC unless the peer VPC is in account.<li>After you’ve created a flow log, you cannot change its configuration or the flow log record format. For example, you can’t associate a different IAM role with the flow log, or add or remove fields in the flow log record. but delete the flow log and create a new one with the required configuration.<li>If network interface has multiple IPv4 addresses and traffic is sent to a secondary private IPv4 address, the flow log displays the primary private IPv4 address in the dstaddr field. To capture the original destination IP address, create a flow log with the pkt-dstaddr field.<li>If traffic is sent to a network interface and the destination is not any of the network interface’s IP addresses, the flow log displays the primary private IPv4 address in the dstaddr field. To capture the original destination IP address, create a flow log with the pkt-dstaddr field.<li>If traffic is sent from a network interface and the source is not any of the network interface’s IP addresses, the flow log displays the primary private IPv4 address in the srcaddr field. To capture the original source IP address, create a flow log with the pkt-srcaddr field.<li>If traffic is sent to or sent by a network interface, the srcaddr and dstaddr fields in the flow log always display the primary private IPv4 address, regardless of the packet source or destination. To capture the packet source or destination, create a flow log with the pkt-srcaddr and pkt-dstaddr fields.<li>When network interface is attached to a Nitro-based instance, the aggregation interval is always 1 minute or less, regardless of the specified maximum aggregation interval.</ul><p>Flow logs do not capture all IP traffic. The following types of traffic are not logged:</p><ul><li>Traffic generated by instances when they contact the Amazon DNS server. If you use own DNS server, then all traffic to that DNS server is logged.<li>Traffic generated by a Windows instance for Amazon Windows license activation.<li>Traffic to and from 169.254.169.254 for instance metadata.<li>Traffic to and from 169.254.169.123 for the Amazon Time Sync Service.<li>DHCP traffic.<li>Traffic to the reserved IP address for the default VPC router. For more information, see VPC and subnet sizing.<li>Traffic between an endpoint network interface and a Network Load Balancer network interface. For more information, see VPC endpoint services (AWS PrivateLink).</ul><h3 id="flow-logs-pricing">Flow logs pricing</h3><ul><li><code class="language-plaintext highlighter-rouge">Data ingestion and archival</code> charges for vended logs apply when you publish flow logs to CloudWatch Logs / S3.<li>To track charges from publishing flow logs to S3 buckets, apply <code class="language-plaintext highlighter-rouge">cost allocation tags</code> to flow log subscriptions.<li>To track charges from publishing flow logs to CloudWatch Logs, apply <code class="language-plaintext highlighter-rouge">cost allocation tags</code> to destination CloudWatch Logs log group.<li>Thereafter, AWS cost allocation report will include usage and costs aggregated by these tags. You can apply tags that represent business categories (such as cost centers, application names, or owners) to organize costs.</ul><p>CloudWatch Container Insights ingests performance events as CloudWatch Logs that automatically create CloudWatch metrics. These performance events are analyzed using CloudWatch Logs Insights queries and are automatically executed as part of some Container Insights automated dashboards (e.g., task/pod, service, node, namespace).</p><div class="table-wrapper"><table><thead><tr><th>into CloudWatch<th>price<tbody><tr><td>Collect (Data Ingestion)<td>$0.50 per GB<tr><td>Store (Archival)<td>$0.03 per GB<tr><td>Analyze (Logs Insights queries)<td>$0.005 per GB of data scanned</table></div><hr /><h3 id="price">price</h3><p><a href="https://calculator.s3.amazonaws.com/index.html">AWS Simple Monthly Calculator</a> <a href="https://calculator.aws/#/createCalculator">AWS Pricing Calculator</a></p><p>example:</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="c"># detailed monitoring</span>
<span class="c"># The number of metrics sent by EC2 instance as detailed monitoring is dependent on the EC2 instance type</span>
<span class="c"># This example assumes 7 metrics, which covers the most commonly used instance types.</span>
If application runs on 10 EC2 instances 24x7 <span class="k">for </span>a 30-day month, and <span class="nb">enable </span>EC2 Detailed Monitoring on all instances:
Total number of metrics: 7 metrics per instance <span class="k">*</span> 10 instances <span class="o">=</span> 70 metrics
Monthly CloudWatch Metrics Charges @<span class="nv">$0</span>.30 per custom metric: 70 <span class="k">*</span> <span class="nv">$0</span>.30 <span class="o">=</span> <span class="nv">$21</span>
Monthly CloudWatch charges <span class="o">=</span> <span class="nv">$21</span> per month
Once you exceed 10,000 total metrics <span class="k">then </span>volume pricing tiers will apply - see metrics pricing table <span class="k">for </span>details.


<span class="c"># monitor with logs</span>
<span class="c"># If you are monitoring HTTP 2xx, 3xx &amp; 4xx response codes using web application access logs 24x7 for one 30-day month, by sending 1GB per day of ingested log data, monitoring for HTTP responses, and archiving the data for one month, charges would be as follows:</span>
<span class="c"># Monthly Ingested Log Charges</span>
Total log data ingested: 1GB <span class="k">*</span> 30 days <span class="o">=</span> 30GB
0 to 5GB: <span class="nv">$0</span>
5 to 30GB: <span class="nv">$0</span>.50 <span class="k">*</span> 25 <span class="o">=</span> <span class="nv">$12</span>.50
<span class="c"># Monthly Monitoring Charges</span>
3 CloudWatch Metrics @<span class="nv">$0</span>: 3 <span class="k">*</span> <span class="nv">$0</span> <span class="o">=</span> <span class="nv">$0</span>
<span class="c"># Monthly Archived Log Charges (assume log data compresses to 6GB)</span>
0 to 5GB: <span class="nv">$0</span>
5GB to 6GB: <span class="nv">$0</span>.03 <span class="k">*</span> 1 <span class="o">=</span> <span class="nv">$0</span>.03
<span class="c"># Monthly CloudWatch Charges</span>
<span class="nv">$12</span>.50 + <span class="nv">$0</span> + <span class="nv">$0</span>.03 <span class="o">=</span> <span class="nv">$12</span>.53


<span class="c"># monitore VPCs that send 72TB of ingested VPC flow logs to CloudWatch logs per month and archiving the data for one month</span>
<span class="c"># Monthly Log Ingestion Charges</span>
0 to 10TB @<span class="nv">$0</span>.50 per GB <span class="o">=</span> 10 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.50 <span class="o">=</span> <span class="nv">$5</span>,120.00
10TB to 30TB @<span class="nv">$0</span>.25 per GB <span class="o">=</span> 20 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.25 <span class="o">=</span> <span class="nv">$5</span>,120.00
30TB to 50TB @<span class="nv">$0</span>.10 per GB <span class="o">=</span> 20 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.10 <span class="o">=</span> <span class="nv">$2</span>,048.00
50TB to 72TB @<span class="nv">$0</span>.05 per GB <span class="o">=</span> 22 <span class="k">*</span> 1024 <span class="k">*</span> <span class="nv">$0</span>.05 <span class="o">=</span> <span class="nv">$1</span>,126.40
Total Ingestion Charges <span class="o">=</span> <span class="nv">$5</span>,120 + <span class="nv">$5</span>,120 + <span class="nv">$2</span>,048 + <span class="nv">$1126</span>.40 <span class="o">=</span> <span class="nv">$13</span>,414.40
<span class="c"># Monthly Log Archival Charges (Assume log data compresses to 30TB)</span>
30TB @ <span class="nv">$0</span>.03 per GB <span class="o">=</span> 30 <span class="k">*</span> 1024 <span class="k">*</span> 0.03 <span class="o">=</span> <span class="nv">$921</span>.6
<span class="c"># Monthly CloudWatch Charges = $13,414.40 + $921.6 = $14,336</span>


<span class="c"># 2.</span>
<span class="c"># monitore VPCs that send 72TB of ingested VPC flow logs directly to S3 per month and archiving the data for one month</span>
<span class="c"># Monthly Log Ingestion Charges</span>
0 to 10TB @<span class="nv">$0</span>.25 per GB <span class="o">=</span> 10 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.25 <span class="o">=</span> <span class="nv">$2</span>,560.00
10TB to 30TB @<span class="nv">$0</span>.15 per GB <span class="o">=</span> 20 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.15 <span class="o">=</span> <span class="nv">$3</span>,072.00
30TB to 50TB @<span class="nv">$0</span>.075 per GB <span class="o">=</span> 20 <span class="k">*</span> 1,024 <span class="k">*</span> <span class="nv">$0</span>.075 <span class="o">=</span> <span class="nv">$1</span>,536.00
50TB to 72TB @<span class="nv">$0</span>.05 per GB <span class="o">=</span> 22 <span class="k">*</span> 1024 <span class="k">*</span> <span class="nv">$0</span>.05 <span class="o">=</span> <span class="nv">$1</span>,126.40
Total Ingestion Charges <span class="o">=</span> <span class="nv">$2</span>,560 + <span class="nv">$3</span>,072 + <span class="nv">$1</span>,536 + <span class="nv">$1126</span>.40 <span class="o">=</span> <span class="nv">$8</span>,294.40
<span class="c"># Monthly Log Archival Charges (Assume log data compresses to 6.5TB)* *</span>
6.5TB @ <span class="nv">$0</span>.023 per GB <span class="o">=</span> 6.5 <span class="k">*</span> 1024 <span class="k">*</span> 0.023 <span class="o">=</span> <span class="nv">$153</span>.01
<span class="c"># Monthly Charges = $8,294.40 + $153.01 = $8,447.41</span>
</pre></table></code></div></div><hr /><p>ref:</p><ul><li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">*VPC Flow Logs</a><li><a href="https://docs.aws.amazon.com/vpc/latest/mirroring/flow-log.html">*Traffic Mirroring and VPC Flow Logs</a><li><a href="https://aws.amazon.com/blogs/aws/new-vpc-traffic-mirroring/">New – VPC Traffic Mirroring – Capture &amp; Inspect Network Traffic</a></ul><p>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/01aws/'>01AWS</a>, <a href='/categories/network/'>Network</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >AWS</a> <a href="/tags/network/" class="post-tag no-text-decoration" >Network</a> <a href="/tags/vpc/" class="post-tag no-text-decoration" >VPC</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS - VPC - Log and monitor - Grace&url=https://ocholuo.github.io//posts/VPC-monitor/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS - VPC - Log and monitor - Grace&u=https://ocholuo.github.io//posts/VPC-monitor/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AWS - VPC - Log and monitor - Grace&url=https://ocholuo.github.io//posts/VPC-monitor/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/BadNetwork/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - Network - BadNetwork</h3><div class="text-muted small"><p> BadNetwork Misconfiguration 1: Unnecessary Service Exposure Misconfiguration 2: Soft Center Misconfiguration 3: Bad Failover Misconfiguration 4: Typo in Security Gro...</p></div></div></a></div><div class="card"> <a href="/posts/Gatway-API-Gateway/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - VPC Gateway - API Gateway</h3><div class="text-muted small"><p> AWS API Gateway benefits Security Application Firewall Resource Policy Authorization AWS API Gateway benefi...</p></div></div></a></div><div class="card"> <a href="/posts/Gatway-IGW/"><div class="card-body"> <span class="timeago small" >Jul 18, 2020<i class="unloaded">2020-07-18T11:11:11-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS - VPC Gateway - IGW</h3><div class="text-muted small"><p> Internet gateway (IGWs) Internet gateway (IGWs) The key: whether it can access internet IGW is resilient by design a scalable, redundant, and highly availabl...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/VPC-Endpoint/" class="btn btn-outline-primary" prompt="Older"><p>AWS - VPC - VPC endpoint</p></a> <a href="/posts/VPC/" class="btn btn-outline-primary" prompt="Newer"><p>AWS - VPC - Amazon Virtual Private Cloud</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
