<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://myochosite-291718.appspot.com/query?id=ahNwfm15b2Nob3NpdGUtMjkxNzE4chULEghBcGlRdWVyeRiAgIDo14eBCgw"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Virtulization - DockerFile Develop" /><meta property="og:locale" content="en" /><meta name="description" content="DockerFile Develop Best practices for writing Dockerfiles General guidelines and recommendations Create ephemeral containers Understand build context Pipe Dockerfile through stdin Build an image using a Dockerfile from stdin, without sending build context Build from a local build context, using a Dockerfile from stdin Build from a remote build context, using a Dockerfile from stdin Exclude with .dockerignore Use multi-stage builds Don’t install unnecessary packages Decouple applications Minimize the number of layers Sort multi-line arguments Leverage build cache Dockerfile instructions CMD EXPOSE ENV ADD or COPY ENTRYPOINT FROM LABEL RUN RUN the command apt-get Using pipes VOLUME USER WORKDIR ONBUILD" /><meta property="og:description" content="DockerFile Develop Best practices for writing Dockerfiles General guidelines and recommendations Create ephemeral containers Understand build context Pipe Dockerfile through stdin Build an image using a Dockerfile from stdin, without sending build context Build from a local build context, using a Dockerfile from stdin Build from a remote build context, using a Dockerfile from stdin Exclude with .dockerignore Use multi-stage builds Don’t install unnecessary packages Decouple applications Minimize the number of layers Sort multi-line arguments Leverage build cache Dockerfile instructions CMD EXPOSE ENV ADD or COPY ENTRYPOINT FROM LABEL RUN RUN the command apt-get Using pipes VOLUME USER WORKDIR ONBUILD" /><link rel="canonical" href="https://ocholuo.github.io//posts/Docker-dev/" /><meta property="og:url" content="https://ocholuo.github.io//posts/Docker-dev/" /><meta property="og:site_name" content="Grace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-26T10:11:11-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Virtulization - DockerFile Develop" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-30T21:02:21-04:00","datePublished":"2020-11-26T10:11:11-05:00","description":"DockerFile Develop Best practices for writing Dockerfiles General guidelines and recommendations Create ephemeral containers Understand build context Pipe Dockerfile through stdin Build an image using a Dockerfile from stdin, without sending build context Build from a local build context, using a Dockerfile from stdin Build from a remote build context, using a Dockerfile from stdin Exclude with .dockerignore Use multi-stage builds Don’t install unnecessary packages Decouple applications Minimize the number of layers Sort multi-line arguments Leverage build cache Dockerfile instructions CMD EXPOSE ENV ADD or COPY ENTRYPOINT FROM LABEL RUN RUN the command apt-get Using pipes VOLUME USER WORKDIR ONBUILD","headline":"Virtulization - DockerFile Develop","mainEntityOfPage":{"@type":"WebPage","@id":"https://ocholuo.github.io//posts/Docker-dev/"},"url":"https://ocholuo.github.io//posts/Docker-dev/"}</script><title>Virtulization - DockerFile Develop | Grace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grace"><meta name="application-name" content="Grace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://myochosite-291718.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://myochosite-291718.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/huoye.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grace</a></div><div class="site-subtitle font-italic">2023 Mar 14 updated</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ocholuo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Virtulization - DockerFile Develop</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Virtulization - DockerFile Develop</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Grace JyL </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 26, 2020, 10:11 AM -0500" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 30, 2022, 6:02 PM -0700" >Oct 30, 2022<i class="unloaded">2022-10-30T21:02:21-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5448 words">30 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><ul><li><a href="#dockerfile-develop">DockerFile Develop</a><ul><li><a href="#best-practices-for-writing-dockerfiles">Best practices for writing Dockerfiles</a><li><a href="#general-guidelines-and-recommendations">General guidelines and recommendations</a><ul><li><a href="#create-ephemeral-containers">Create ephemeral containers</a><li><a href="#understand-build-context">Understand build context</a><li><a href="#pipe-dockerfile-through-stdin">Pipe Dockerfile through <code class="language-plaintext highlighter-rouge">stdin</code></a><ul><li><a href="#build-an-image-using-a-dockerfile-from-stdin-without-sending-build-context">Build an image using a Dockerfile from stdin, without sending build context</a><li><a href="#build-from-a-local-build-context-using-a-dockerfile-from-stdin">Build from a local build context, using a Dockerfile from stdin</a><li><a href="#build-from-a-remote-build-context-using-a-dockerfile-from-stdin">Build from a remote build context, using a Dockerfile from stdin</a></ul><li><a href="#exclude-with-dockerignore">Exclude with .dockerignore</a><li><a href="#use-multi-stage-builds">Use multi-stage builds</a><li><a href="#dont-install-unnecessary-packages">Don’t install unnecessary packages</a><li><a href="#decouple-applications">Decouple applications</a><li><a href="#minimize-the-number-of-layers">Minimize the number of layers</a><li><a href="#sort-multi-line-arguments">Sort multi-line arguments</a><li><a href="#leverage-build-cache">Leverage build cache</a></ul><li><a href="#dockerfile-instructions">Dockerfile instructions</a><ul><li><a href="#cmd">CMD</a><li><a href="#expose">EXPOSE</a><li><a href="#env">ENV</a><li><a href="#add-or-copy">ADD or COPY</a><li><a href="#entrypoint">ENTRYPOINT</a><li><a href="#from">FROM</a><li><a href="#label">LABEL</a><li><a href="#run-run-the-command">RUN <code class="language-plaintext highlighter-rouge">RUN the command</code></a><ul><li><a href="#apt-get">apt-get</a><li><a href="#using-pipes">Using pipes</a></ul><li><a href="#volume">VOLUME</a><li><a href="#user">USER</a><li><a href="#workdir">WORKDIR</a><li><a href="#onbuild">ONBUILD</a></ul></ul></ul><hr /><h1 id="dockerfile-develop">DockerFile Develop</h1><h2 id="best-practices-for-writing-dockerfiles">Best practices for writing Dockerfiles</h2><p>Docker builds images automatically by reading the instructions from a <code class="language-plaintext highlighter-rouge">Dockerfile</code></p><ul><li>a text file that contains all commands, in order, needed to build a given image.<li>A <code class="language-plaintext highlighter-rouge">Dockerfile</code> adheres to a specific format and set of instructions which you can find at <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a>.</ul><p>A Docker image consists of read-only layers each of which represents a Dockerfile instruction.</p><ul><li>The layers are stacked and each one is a delta of the changes from the previous layer.</ul><div class="language-js highlighter-rouge"><div class="code-header" text-data="js"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">FROM</span> <span class="nx">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>
<span class="nx">COPY</span> <span class="p">.</span> <span class="o">/</span><span class="nx">app</span>
<span class="nx">RUN</span> <span class="nx">make</span> <span class="o">/</span><span class="nx">app</span>
    <span class="nx">CMD</span> <span class="nx">python</span> <span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">app</span><span class="p">.</span><span class="nx">py</span>
</pre></table></code></div></div><p>Each instruction creates one layer:</p><ul><li><code class="language-plaintext highlighter-rouge">FROM</code> creates a layer from the <code class="language-plaintext highlighter-rouge">ubuntu:18.04</code> Docker image.<li><code class="language-plaintext highlighter-rouge">COPY</code> adds files from the Docker client’s current directory.<li><code class="language-plaintext highlighter-rouge">RUN</code> builds the application with <code class="language-plaintext highlighter-rouge">make</code>.<li><code class="language-plaintext highlighter-rouge">CMD</code> specifies what command to run within the container.</ul><p>When you run an image and generate a container, you add a new <em>writable layer</em> (the “container layer”) on top of the underlying layers.</p><ul><li>All changes made to the running container, such as writing new files, modifying existing files, and deleting files, are written to this thin writable container layer.</ul><h2 id="general-guidelines-and-recommendations">General guidelines and recommendations</h2><h3 id="create-ephemeral-containers">Create ephemeral containers</h3><p>The image defined by the <code class="language-plaintext highlighter-rouge">Dockerfile</code> should generate containers that are as ephemeral as possible. By “ephemeral”, we mean that the container can be stopped and destroyed, then rebuilt and replaced with an absolute minimum set up and configuration.</p><p>Refer to <a href="https://12factor.net/processes">Processes</a> under <em>The Twelve-factor App</em> methodology to get a feel for the motivations of running containers in such a stateless fashion.</p><h3 id="understand-build-context">Understand build context</h3><p><code class="language-plaintext highlighter-rouge">docker build</code> command, the current working directory is called the <code class="language-plaintext highlighter-rouge">_build context_</code>.</p><ul><li>By default, the Dockerfile is assumed to be located here, but you can specify a different location with the file flag (<code class="language-plaintext highlighter-rouge">-f</code>).<li>Regardless of where the <code class="language-plaintext highlighter-rouge">Dockerfile</code> actually lives, all recursive contents of files and directories in the current directory are sent to the Docker daemon as the build context.</ul><blockquote><p>Build context example</p><p>Create a directory for the build context and <code class="language-plaintext highlighter-rouge">cd</code> into it. Write “hello” into a text file named <code class="language-plaintext highlighter-rouge">hello</code> and create a Dockerfile that runs <code class="language-plaintext highlighter-rouge">cat</code> on it. Build the image from within the build context (<code class="language-plaintext highlighter-rouge">.</code>):</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>mkdir myproject &amp;&amp; cd myproject
echo "hello" &gt; hello
echo -e "FROM busybox\nCOPY /hello /\nRUN cat /hello" &gt; Dockerfile
docker build -t helloapp:v1 .
</pre></table></code></div></div><p>Move <code class="language-plaintext highlighter-rouge">Dockerfile</code> and <code class="language-plaintext highlighter-rouge">hello</code> into separate directories and build a second version of the image (without relying on cache from the last build). Use <code class="language-plaintext highlighter-rouge">-f</code> to point to the Dockerfile and specify the directory of the build context:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>mkdir -p dockerfiles context
mv Dockerfile dockerfiles &amp;&amp; mv hello context
docker build --no-cache -t helloapp:v2 -f dockerfiles/Dockerfile context
</pre></table></code></div></div></blockquote><p>Inadvertently including files that are not necessary for building an image results in a larger build context and larger image size.</p><ul><li>This can increase the time to build the image, time to pull and push it, and the container runtime size.<li>To see how big the build context is, look for a message like this when building the <code class="language-plaintext highlighter-rouge">Dockerfile</code>:</ul><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>    Sending build context to Docker daemon  187.8MB
</pre></table></code></div></div><h3 id="pipe-dockerfile-through-stdin">Pipe Dockerfile through <code class="language-plaintext highlighter-rouge">stdin</code></h3><p>Docker has the ability to build images by piping <code class="language-plaintext highlighter-rouge">Dockerfile</code> through <code class="language-plaintext highlighter-rouge">stdin</code> with a <code class="language-plaintext highlighter-rouge">_local</code> or <code class="language-plaintext highlighter-rouge">remote</code> <code class="language-plaintext highlighter-rouge">build context_</code>.</p><ul><li>Piping a <code class="language-plaintext highlighter-rouge">Dockerfile</code> through <code class="language-plaintext highlighter-rouge">stdin</code> can be useful to perform one-off builds without writing a Dockerfile to disk, or in situations where the <code class="language-plaintext highlighter-rouge">Dockerfile</code> is generated, and should not persist afterwards.</ul><blockquote><p>The examples in this section use <a href="https://tldp.org/LDP/abs/html/here-docs.html">here documents</a> for convenience, but any method to provide the <code class="language-plaintext highlighter-rouge">Dockerfile</code> on <code class="language-plaintext highlighter-rouge">stdin</code> can be used.</p><p>For example, the following commands are equivalent:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>echo -e 'FROM busybox\nRUN echo "hello world"' | docker build -

docker build -&lt;&lt;EOF
FROM busybox
RUN echo "hello world"
EOF
</pre></table></code></div></div><p>You can substitute the examples with the preferred approach, or the approach that best fits the use-case.</p></blockquote><h4 id="build-an-image-using-a-dockerfile-from-stdin-without-sending-build-context">Build an image using a Dockerfile from stdin, without sending build context</h4><p>Use this syntax to build an image using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>, without sending additional files as build context. The hyphen (<code class="language-plaintext highlighter-rouge">-</code>) takes the position of the <code class="language-plaintext highlighter-rouge">PATH</code>, and instructs Docker to read the build context (which only contains a <code class="language-plaintext highlighter-rouge">Dockerfile</code>) from <code class="language-plaintext highlighter-rouge">stdin</code> instead of a directory:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>    docker build [OPTIONS] -
</pre></table></code></div></div><p>The following example builds an image using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> that is passed through <code class="language-plaintext highlighter-rouge">stdin</code>. No files are sent as build context to the daemon.</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    docker build -t myimage:latest -&lt;&lt;EOF
FROM busybox
RUN echo "hello world"
    EOF
</pre></table></code></div></div><p>Omitting the build context can be useful in situations where the <code class="language-plaintext highlighter-rouge">Dockerfile</code> does not require files to be copied into the image, and improves the build-speed, as no files are sent to the daemon.</p><p>If you want to improve the build-speed by excluding <em>some</em> files from the build- context, refer to <a href="#exclude-with-dockerignore">exclude with .dockerignore</a>.</p><blockquote><p><strong>Note</strong>: Attempting to build a Dockerfile that uses <code class="language-plaintext highlighter-rouge">COPY</code> or <code class="language-plaintext highlighter-rouge">ADD</code> will fail if this syntax is used. The following example illustrates this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre># create a directory to work in
mkdir example
cd example

# create an example file
touch somefile.txt

docker build -t myimage:latest -&lt;&lt;EOF
FROM busybox    COPY somefile.txt .
RUN cat /somefile.txt
EOF

# observe that the build fails
...
Step 2/3 : COPY somefile.txt .    COPY failed: stat /var/lib/docker/tmp/docker-builder249218248/somefile.txt: no such file or directory
</pre></table></code></div></div></blockquote><h4 id="build-from-a-local-build-context-using-a-dockerfile-from-stdin">Build from a local build context, using a Dockerfile from stdin</h4><p>build an image using files on local filesystem, but using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>.</p><ul><li>The syntax uses the <code class="language-plaintext highlighter-rouge">-f</code> (or <code class="language-plaintext highlighter-rouge">--file</code>) option to specify the <code class="language-plaintext highlighter-rouge">Dockerfile</code> to use,<li>using a hyphen (<code class="language-plaintext highlighter-rouge">-</code>) as filename to instruct Docker to read the <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>:</ul><p><code class="language-plaintext highlighter-rouge">docker build [OPTIONS] -f- PATH</code></p><p>The example below uses the current directory (<code class="language-plaintext highlighter-rouge">.</code>) as the build context</p><ul><li>builds an image using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> that is passed through <code class="language-plaintext highlighter-rouge">stdin</code> using a <a href="https://tldp.org/LDP/abs/html/here-docs.html">here document</a>.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>    # create a directory to work in
    mkdir example
    cd example

    # create an example file
    touch somefile.txt

    # build an image using the current directory as context, and a Dockerfile passed through stdin
    docker build -t myimage:latest -f- . &lt;&lt;EOF
FROM busybox
COPY somefile.txt .
RUN cat /somefile.txt
    EOF
</pre></table></code></div></div><h4 id="build-from-a-remote-build-context-using-a-dockerfile-from-stdin">Build from a remote build context, using a Dockerfile from stdin</h4><p>Use this syntax to build an image using files from a remote <code class="language-plaintext highlighter-rouge">git</code> repository, using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>. The syntax uses the <code class="language-plaintext highlighter-rouge">-f</code> (or <code class="language-plaintext highlighter-rouge">--file</code>) option to specify the <code class="language-plaintext highlighter-rouge">Dockerfile</code> to use, using a hyphen (<code class="language-plaintext highlighter-rouge">-</code>) as filename to instruct Docker to read the <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>:</p><p><code class="language-plaintext highlighter-rouge">docker build [OPTIONS] -f- PATH</code></p><p>This syntax can be useful in situations where you want to build an image from a repository that does not contain a <code class="language-plaintext highlighter-rouge">Dockerfile</code>, or if you want to build with a custom <code class="language-plaintext highlighter-rouge">Dockerfile</code>, without maintaining the own fork of the repository.</p><p>The example below builds an image using a <code class="language-plaintext highlighter-rouge">Dockerfile</code> from <code class="language-plaintext highlighter-rouge">stdin</code>, and adds the <code class="language-plaintext highlighter-rouge">hello.c</code> file from the <a href="https://github.com/docker-library/hello-world">“hello-world” Git repository on GitHub</a>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    docker build -t myimage:latest -f- https://github.com/docker-library/hello-world.git &lt;&lt;EOF
FROM busybox
COPY hello.c .
    EOF
</pre></table></code></div></div><blockquote><p><strong>Under the hood</strong></p><p>When building an image using a remote Git repository as build context, Docker performs a <code class="language-plaintext highlighter-rouge">git clone</code> of the repository on the local machine, and sends those files as build context to the daemon. This feature requires <code class="language-plaintext highlighter-rouge">git</code> to be installed on the host where you run the <code class="language-plaintext highlighter-rouge">docker build</code> command.</p></blockquote><h3 id="exclude-with-dockerignore">Exclude with .dockerignore</h3><p>To exclude files not relevant to the build (without restructuring the source repository) use a <code class="language-plaintext highlighter-rouge">.dockerignore</code> file. This file supports exclusion patterns similar to <code class="language-plaintext highlighter-rouge">.gitignore</code> files. For information on creating one, see the <a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">.dockerignore file</a>.</p><h3 id="use-multi-stage-builds">Use multi-stage builds</h3><ul><li>drastically reduce the size of the final image,<li>without struggling to reduce the number of intermediate layers and files.</ul><p>Because an image is built during the final stage of the build process, you can minimize image layers by <a href="#leverage-build-cache">leveraging build cache</a>.</p><p>For example, if the build contains several layers, you can order them from the less frequently changed (to ensure the build cache is reusable) to the more frequently changed:</p><ul><li>Install tools you need to build the application<li>Install or update library dependencies<li>Generate the application</ul><p>A Dockerfile for a Go application could look like:</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>FROM golang:1.11-alpine AS build

    <span class="c"># Install tools required for project</span>
    <span class="c"># Run `docker build --no-cache .` to update dependencies</span>
RUN apk add <span class="nt">--no-cache</span> git
RUN go get github.com/golang/dep/cmd/dep

    <span class="c"># List project dependencies with Gopkg.toml and Gopkg.lock</span>
    <span class="c"># These layers are only re-built when Gopkg files are updated</span>
COPY Gopkg.lock Gopkg.toml /go/src/project/
    WORKDIR /go/src/project/
    <span class="c"># Install library dependencies</span>
RUN dep ensure <span class="nt">-vendor-only</span>

    <span class="c"># Copy the entire project and build it</span>
    <span class="c"># This layer is rebuilt when a file changes in the project directory</span>
COPY <span class="nb">.</span> /go/src/project/
RUN go build <span class="nt">-o</span> /bin/project

    <span class="c"># This results in a single layer image</span>
FROM scratch
COPY <span class="nt">--from</span><span class="o">=</span>build /bin/project /bin/project
    ENTRYPOINT <span class="o">[</span><span class="s2">"/bin/project"</span><span class="o">]</span>
    CMD <span class="o">[</span><span class="s2">"--help"</span><span class="o">]</span>
</pre></table></code></div></div><h3 id="dont-install-unnecessary-packages">Don’t install unnecessary packages</h3><p>To reduce complexity, dependencies, file sizes, and build times</p><ul><li>avoid installing extra or unnecessary packages just because they might be “nice to have.”<li>For example, you don’t need to include a text editor in a database image.</ul><h3 id="decouple-applications">Decouple applications</h3><p>Each container should have only one concern. Decoupling applications into multiple containers makes it easier to scale horizontally and reuse containers. For instance, a web application stack might consist of three separate containers, each with its own unique image, to manage the web application, database, and an in-memory cache in a decoupled manner.</p><p>Limiting each container to one process is a good rule of thumb, but it is not a hard and fast rule. For example, not only can containers be <a href="https://docs.docker.com/engine/reference/run/#specify-an-init-process">spawned with an init process</a>, some programs might spawn additional processes of their own accord. For instance, <a href="https://docs.celeryproject.org/">Celery</a> can spawn multiple worker processes, and <a href="https://httpd.apache.org/">Apache</a> can create one process per request.</p><p>Use the best judgment to keep containers as clean and modular as possible. If containers depend on each other, you can use <a href="https://docs.docker.com/network/">Docker container networks</a> to ensure that these containers can communicate.</p><h3 id="minimize-the-number-of-layers">Minimize the number of layers</h3><p>In older versions of Docker, it was important that you minimized the number of layers in the images to ensure they were performant. The following features were added to reduce this limitation:</p><ul><li>Only the instructions <code class="language-plaintext highlighter-rouge">RUN</code>, <code class="language-plaintext highlighter-rouge">COPY</code>, <code class="language-plaintext highlighter-rouge">ADD</code> create layers. Other instructions create temporary intermediate images, and do not increase the size of the build.<li>Where possible, use <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage builds</a>, and only copy the artifacts you need into the final image. This allows you to include tools and debug information in the intermediate build stages without increasing the size of the final image.</ul><h3 id="sort-multi-line-arguments">Sort multi-line arguments</h3><p>Whenever possible, ease later changes by sorting multi-line arguments alphanumerically.</p><ul><li>This helps to avoid duplication of packages and make the list much easier to update.<li>This also makes PRs a lot easier to read and review.<li>Adding a space before a backslash (<code class="language-plaintext highlighter-rouge">\</code>) helps as well.</ul><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>
RUN apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
      bzr <span class="se">\</span>
      cvs <span class="se">\</span>
      git <span class="se">\</span>
      mercurial <span class="se">\</span>
      subversion <span class="se">\</span>
      <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

</pre></table></code></div></div><h3 id="leverage-build-cache">Leverage build cache</h3><p>When building an image, Docker steps through the instructions in the <code class="language-plaintext highlighter-rouge">Dockerfile</code>, executing each in the order specified. As each instruction is examined, Docker looks for an existing image in its cache that it can reuse, rather than creating a new (duplicate) image.</p><p>If you do not want to use the cache at all, you can use the <code class="language-plaintext highlighter-rouge">--no-cache=true</code> option on the <code class="language-plaintext highlighter-rouge">docker build</code> command. However, if you do let Docker use its cache, it is important to understand when it can, and cannot, find a matching image. The basic rules that Docker follows are outlined below:</p><ul><li><p>Starting with a parent image that is already in the cache, the next instruction is compared against all child images derived from that base image to see if one of them was built using the exact same instruction. If not, the cache is invalidated.</p><li><p>In most cases, simply comparing the instruction in the <code class="language-plaintext highlighter-rouge">Dockerfile</code> with one of the child images is sufficient. However, certain instructions require more examination and explanation.</p><li><p>For the <code class="language-plaintext highlighter-rouge">ADD</code> and <code class="language-plaintext highlighter-rouge">COPY</code> instructions, the contents of the file(s) in the image are examined and a checksum is calculated for each file. The last-modified and last-accessed times of the file(s) are not considered in these checksums. During the cache lookup, the checksum is compared against the checksum in the existing images. If anything has changed in the file(s), such as the contents and metadata, then the cache is invalidated.</p><li><p>Aside from the <code class="language-plaintext highlighter-rouge">ADD</code> and <code class="language-plaintext highlighter-rouge">COPY</code> commands, cache checking does not look at the files in the container to determine a cache match. For example, when processing a <code class="language-plaintext highlighter-rouge">RUN apt-get -y update</code> command the files updated in the container are not examined to determine if a cache hit exists. In that case just the command string itself is used to find a match.</p></ul><p>Once the cache is invalidated, all subsequent <code class="language-plaintext highlighter-rouge">Dockerfile</code> commands generate new images and the cache is not used.</p><hr /><h2 id="dockerfile-instructions">Dockerfile instructions</h2><p>create an efficient and maintainable <code class="language-plaintext highlighter-rouge">Dockerfile</code>.</p><hr /><h3 id="cmd">CMD</h3><p>The <code class="language-plaintext highlighter-rouge">CMD</code> instruction should be used to run the software contained in the image, along with any arguments.</p><ul><li><code class="language-plaintext highlighter-rouge">CMD</code> should almost always be used in the form of <code class="language-plaintext highlighter-rouge">CMD ["executable", "param1", "param2"…]</code>.<li>Thus, if the image is for a service, such as Apache and Rails, you would run something like <code class="language-plaintext highlighter-rouge">CMD ["apache2","-DFOREGROUND"]</code>.<li>Indeed, this form of the instruction is recommended for any service-based image.</ul><p>In most other cases, <code class="language-plaintext highlighter-rouge">CMD</code> should be given an interactive shell, such as bash, python and perl.</p><ul><li>For example, <code class="language-plaintext highlighter-rouge">CMD ["perl", "-de0"]</code>, <code class="language-plaintext highlighter-rouge">CMD ["python"]</code>, or <code class="language-plaintext highlighter-rouge">CMD ["php", "-a"]</code>.<li>Using this form means that when you execute something like <code class="language-plaintext highlighter-rouge">docker run -it python</code>, you’ll get dropped into a usable shell, ready to go.<li><code class="language-plaintext highlighter-rouge">CMD</code> should rarely be used in the manner of <code class="language-plaintext highlighter-rouge">CMD ["param", "param"]</code> in conjunction with <a href="https://docs.docker.com/engine/reference/builder/#entrypoint"><code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></a>, unless you and the expected users are already quite familiar with how <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code> works.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c"># The CMD instruction has three forms:</span>

<span class="k">CMD</span><span class="s"> ["executable","app1", "app2"…]</span>
<span class="c"># exec form, this is the preferred form</span>

<span class="k">CMD</span><span class="s"> ["param1","param2"]</span>
<span class="k">CMD</span><span class="s"> ["apache2","-DFOREGROUND"]</span>
<span class="k">CMD</span><span class="s"> ["perl", "-de0"]</span>
<span class="k">CMD</span><span class="s"> ["python"]</span>
<span class="k">CMD</span><span class="s"> ["php", "-a"]</span>
<span class="c"># as default parameters to ENTRYPOINT</span>

<span class="k">CMD</span><span class="s"> command param1 param2</span>
<span class="c"># shell form</span>
</pre></table></code></div></div><hr /><h3 id="expose">EXPOSE</h3><p><a href="https://docs.docker.com/engine/reference/builder/#expose">EXPOSE instruction</a></p><ul><li>The <code class="language-plaintext highlighter-rouge">EXPOSE</code> instruction<ul><li>indicates the ports on which a container listens for connections.<li>informs Docker that the container listens on the specified network ports at runtime.</ul><li><p>can specify whether the port listens on TCP or UDP, and the default is TCP if the protocol is not specified.</p><li>Consequently, you should use the common, traditional port for the application.<ul><li>For example,<ul><li>an image containing the Apache web server would use <code class="language-plaintext highlighter-rouge">EXPOSE 80</code>,<li>an image containing MongoDB would use <code class="language-plaintext highlighter-rouge">EXPOSE 27017</code> and so on.</ul></ul><li>For external access, the users can execute <code class="language-plaintext highlighter-rouge">docker run</code> with a flag indicating how to map the specified port to the port of their choice.<li>For container linking, Docker provides environment variables for the path from the recipient container back to the source (ie, <code class="language-plaintext highlighter-rouge">MYSQL_PORT_3306_TCP</code>).</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">EXPOSE</span><span class="s"> &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]</span>

<span class="k">EXPOSE</span><span class="s"> 80/udp</span>
<span class="c"># To expose on both TCP and UDP, include two lines:</span>
<span class="k">EXPOSE</span><span class="s"> 80/tcp</span>
<span class="k">EXPOSE</span><span class="s"> 80/udp</span>
</pre></table></code></div></div><p>Regardless of the <code class="language-plaintext highlighter-rouge">EXPOSE</code> settings, can override them at runtime by using the <code class="language-plaintext highlighter-rouge">-p</code> flag.</p><div class="language-bash highlighter-rouge"><div class="code-header" text-data="bash"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>docker run <span class="nt">-p</span> 80:80/tcp <span class="nt">-p</span> 80:80/udp
</pre></table></code></div></div><hr /><h3 id="env">ENV</h3><p><a href="https://docs.docker.com/engine/reference/builder/#env">ENV instruction</a></p><ul><li>To make new software easier to run<ul><li>use <code class="language-plaintext highlighter-rouge">ENV</code> to update the <code class="language-plaintext highlighter-rouge">PATH</code> environment variable for the software the container installs.<li>For example<li><code class="language-plaintext highlighter-rouge">ENV PATH=/usr/local/nginx/bin:$PATH</code> ensures that <code class="language-plaintext highlighter-rouge">CMD ["nginx"]</code> just works.</ul><li>provide required environment variables specific to services you wish to containerize,<ul><li>such as Postgres’s <code class="language-plaintext highlighter-rouge">PGDATA</code>.</ul><li>set commonly used version numbers<ul><li>so that version bumps are easier to maintain</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">ENV</span><span class="s"> PG_MAJOR=9.3</span>
<span class="k">ENV</span><span class="s"> PG_VERSION=9.3.4</span>

<span class="k">RUN </span>curl <span class="nt">-SL</span> https://example.com/postgres-<span class="nv">$PG_VERSION</span>.tar.xz | <span class="nb">tar</span> <span class="nt">-xJC</span> /usr/src/postgress <span class="o">&amp;&amp;</span> …
<span class="k">ENV</span><span class="s"> PATH=/usr/local/postgres-$PG_MAJOR/bin:$PATH</span>
</pre></table></code></div></div><ul><li>Similar to having constant variables in a program (as opposed to hard-coding values)<ul><li><p>this approach lets you change a single <code class="language-plaintext highlighter-rouge">ENV</code> instruction to auto-magically bump the version of the software in the container.</p><li>Each <code class="language-plaintext highlighter-rouge">ENV</code> line creates a new intermediate layer, just like <code class="language-plaintext highlighter-rouge">RUN</code> commands.<li>even unset the environment variable in a future layer, it still persists in this layer and its value can’t be dumped.</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> alpine</span>
<span class="k">ENV</span><span class="s"> ADMIN_USER="mark"</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="nv">$ADMIN_USER</span> <span class="o">&gt;</span> ./mark

<span class="k">RUN </span><span class="nb">unset </span>ADMIN_USER

$ docker run --rm test sh -c 'echo $ADMIN_USER'
# mark
</pre></table></code></div></div><p><strong>unset</strong></p><ul><li>To really unset the environment variable, use a <code class="language-plaintext highlighter-rouge">RUN</code> command with shell commands, to set, use, and unset the variable all in a single layer.<li>You can separate the commands with <code class="language-plaintext highlighter-rouge">;</code> or <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>. If you use the second method, and one of the commands fails, the <code class="language-plaintext highlighter-rouge">docker build</code> also fails. This is usually a good idea.<li>Using <code class="language-plaintext highlighter-rouge">\</code> as a line continuation character for Linux Dockerfiles improves readability.<li>You could also put all of the commands into a shell script and have the <code class="language-plaintext highlighter-rouge">RUN</code> command just run that shell script.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> alpine</span>
<span class="k">RUN </span><span class="nb">export </span><span class="nv">ADMIN_USER</span><span class="o">=</span><span class="s2">"mark"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$ADMIN_USER</span> <span class="o">&gt;</span> ./mark <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">unset </span>ADMIN_USER
<span class="k">CMD</span><span class="s"> sh</span>

$ docker run --rm test sh -c 'echo $ADMIN_USER'
</pre></table></code></div></div><hr /><h3 id="add-or-copy">ADD or COPY</h3><p>Although <code class="language-plaintext highlighter-rouge">ADD</code> and <code class="language-plaintext highlighter-rouge">COPY</code> are functionally similar, generally speaking, <code class="language-plaintext highlighter-rouge">COPY</code> is preferred.</p><ul><li><code class="language-plaintext highlighter-rouge">COPY</code> is more transparent than <code class="language-plaintext highlighter-rouge">ADD</code>.<li><code class="language-plaintext highlighter-rouge">COPY</code> only supports the basic copying of local files into the container<li><code class="language-plaintext highlighter-rouge">ADD</code> has some features (like local-only tar extraction and remote URL support) that are not immediately obvious.<li>the best use for <code class="language-plaintext highlighter-rouge">ADD</code> is local tar file auto-extraction into the image, as in <code class="language-plaintext highlighter-rouge">ADD rootfs.tar.xz /</code>.</ul><p><strong>COPY</strong></p><ul><li>copies new files or directories from <code class="language-plaintext highlighter-rouge">&lt;src&gt;</code> and adds them to the filesystem of the container at the path <code class="language-plaintext highlighter-rouge">&lt;dest&gt;</code>.<li>have multiple <code class="language-plaintext highlighter-rouge">Dockerfile</code> steps that use different files from the context, <code class="language-plaintext highlighter-rouge">COPY</code> them individually, rather than all at once.<li>ensures that each step’s build cache is only invalidated (forcing the step to be re-run) if the specifically required files change.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>
<span class="c"># COPY has two forms:</span>

<span class="k">COPY</span><span class="s"> [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</span>
<span class="k">COPY</span><span class="s"> [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</span>

<span class="c"># Results in fewer cache invalidations for the `RUN` step, than if put the `COPY . /tmp/` before it</span>
<span class="k">COPY</span><span class="s"> requirements.txt /tmp/</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--requirement</span> /tmp/requirements.txt
<span class="k">COPY</span><span class="s"> . /tmp/</span>

<span class="c"># To add all files starting with “hom”:</span>
<span class="k">COPY</span><span class="s"> hom* /mydir/</span>

<span class="c"># ? is replaced with any single character, e.g., “home.txt”.</span>
<span class="k">COPY</span><span class="s"> hom?.txt /mydir/</span>

<span class="c"># uses a relative path, and adds “test.txt” to &lt;WORKDIR&gt;/relativeDir/:</span>
<span class="k">COPY</span><span class="s"> test.txt relativeDir/</span>

<span class="c"># uses an absolute path, and adds “test.txt” to /absoluteDir/</span>
<span class="k">COPY</span><span class="s"> test.txt /absoluteDir/</span>

<span class="c"># copying files or directories that contain special characters (such as [ and ])</span>
<span class="c"># escape those paths following the Golang rules to prevent them from being treated as a matching pattern.</span>
<span class="c"># copy a file named arr[0].txt, use the following;</span>
<span class="k">COPY</span><span class="s"> arr[[]0].txt /mydir/</span>
</pre></table></code></div></div><p><strong>ADD</strong></p><ul><li>Because image size matters, using <code class="language-plaintext highlighter-rouge">ADD</code> to fetch packages from remote URLs is strongly discouraged; you should use <code class="language-plaintext highlighter-rouge">curl</code> or <code class="language-plaintext highlighter-rouge">wget</code> instead.<li>That way you can delete the files you no longer need after they’ve been extracted and you don’t have to add another layer in the image.</ul><p>For example, you should avoid doing things like:</p><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">ADD</span><span class="s"> https://example.com/big.tar.xz /usr/src/things/</span>
<span class="k">RUN </span><span class="nb">tar</span> <span class="nt">-xJf</span> /usr/src/things/big.tar.xz <span class="nt">-C</span> /usr/src/things
<span class="k">RUN </span>make <span class="nt">-C</span> /usr/src/things all
</pre></table></code></div></div><p>And instead, do something like:</p><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /usr/src/things <span class="se">\
</span>    <span class="o">&amp;&amp;</span> curl <span class="nt">-SL</span> https://example.com/big.tar.xz | <span class="nb">tar</span> <span class="nt">-xJC</span> /usr/src/things <span class="se">\
</span>    <span class="o">&amp;&amp;</span> make <span class="nt">-C</span> /usr/src/things all
</pre></table></code></div></div><p>For other items (files, directories) that do not require <code class="language-plaintext highlighter-rouge">ADD</code>’s tar auto-extraction capability, you should always use <code class="language-plaintext highlighter-rouge">COPY</code>.</p><hr /><h3 id="entrypoint">ENTRYPOINT</h3><p><a href="https://docs.docker.com/engine/reference/builder/#entrypoint">ENTRYPOINT instruction</a></p><ul><li>set the image’s main command, allowing that image to be run as though it was that command (and then use <code class="language-plaintext highlighter-rouge">CMD</code> as the default flags).<ul><li>This is useful because the image name can double as a reference to the binary as shown in the command above.<li>example<li>an image for the command line tool <code class="language-plaintext highlighter-rouge">s3cmd</code></ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">ENTRYPOINT</span><span class="s"> ["s3cmd"]</span>
<span class="k">CMD</span><span class="s"> ["--help"]</span>

<span class="c"># Now the image can be run like this to show the command’s help:</span>
$ docker run s3cmd

<span class="c"># Or using the right parameters to execute a command:</span>
$ docker run s3cmd ls s3://mybucket
</pre></table></code></div></div><ul><li>can also be used in combination with a helper script, allowing it to function in a similar way to the command above, even when starting the tool may require more than one step.<ul><li>For example<li>the <a href="https://hub.docker.com/_/postgres/">Postgres Official Image</a> uses the following script as its <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code>:</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>    <span class="c">#!/bin/bash</span>
    set -e

    if [ "$1" = 'postgres' ]; then
    chown -R postgres "$PGDATA"

    if [ -z "$(ls -A "$PGDATA")" ]; then
        gosu postgres initdb
    fi

    exec gosu postgres "$@"
    fi

    exec "$@"

# &gt; Configure app as PID 1
<span class="c"># &gt;</span>
<span class="c"># &gt; This script uses [the `exec` Bash command](https://wiki.bash-hackers.org/commands/builtin/exec) so that the final running application becomes the container’s PID 1. This allows the application to receive any Unix signals sent to the container. For more, see the [`ENTRYPOINT` reference](https://docs.docker.com/engine/reference/builder/#entrypoint).</span>

<span class="c"># The helper script is copied into the container and run via `ENTRYPOINT` on container start:</span>
<span class="k">COPY</span><span class="s"> ./docker-entrypoint.sh /</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/docker-entrypoint.sh"]</span>
<span class="k">CMD</span><span class="s"> ["postgres"]</span>

<span class="c"># This script allows the user to interact with Postgres in several ways.</span>

<span class="c"># simply start Postgres:</span>
$ docker run postgres

<span class="c"># run Postgres and pass parameters to the server:</span>
$ docker run postgres postgres --help

<span class="c"># start a totally different tool, such as Bash:</span>
$ docker run --rm -it postgres bash
</pre></table></code></div></div><hr /><h3 id="from">FROM</h3><p><a href="https://docs.docker.com/engine/reference/builder/#from">FROM instruction</a></p><p>Whenever possible, use current official images as the basis for the images.</p><ul><li>recommend the <a href="https://hub.docker.com/_/alpine/">Alpine image</a> as it is tightly controlled and small in size (currently under 5 MB), while still being a full Linux distribution.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> [--platform=&lt;platform&gt;] &lt;image&gt; [AS &lt;name&gt;]</span>
<span class="k">FROM</span><span class="s"> [--platform=&lt;platform&gt;] &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]</span>
<span class="k">FROM</span><span class="s"> [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</span>
</pre></table></code></div></div><h3 id="label">LABEL</h3><p><a href="https://docs.docker.com/config/labels-custom-metadata/">Understanding object labels</a></p><p>You can add labels to the image to help organize images by project, record licensing information, to aid in automation, or for other reasons. For each label, add a line beginning with <code class="language-plaintext highlighter-rouge">LABEL</code> and with one or more key-value pairs. The following examples show the different acceptable formats. Explanatory comments are included inline.</p><blockquote><p>Strings with spaces must be quoted <strong>or</strong> the spaces must be escaped. Inner quote characters (<code class="language-plaintext highlighter-rouge">"</code>), must also be escaped.</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre># Set one or more individual labels
LABEL com.example.version="0.0.1-beta"
LABEL vendor1="ACME Incorporated"
LABEL vendor2=ZENITH\ Incorporated
LABEL com.example.release-date="2015-02-12"
LABEL com.example.version.is-production=""
</pre></table></code></div></div><p>An image can have more than one label. Prior to Docker 1.10, it was recommended to combine all labels into a single <code class="language-plaintext highlighter-rouge">LABEL</code> instruction, to prevent extra layers from being created. This is no longer necessary, but combining labels is still supported.</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre># Set multiple labels on one line
LABEL com.example.version="0.0.1-beta" com.example.release-date="2015-02-12"
</pre></table></code></div></div><p>The above can also be written as:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre># Set multiple labels at once, using line-continuation characters to break long lines
LABEL vendor=ACME\ Incorporated \
  com.example.is-beta= \
  com.example.is-production="" \
  com.example.version="0.0.1-beta" \
  com.example.release-date="2015-02-12"
</pre></table></code></div></div><p>See <a href="https://docs.docker.com/config/labels-custom-metadata/">Understanding object labels</a> for guidelines about acceptable label keys and values. For information about querying labels, refer to the items related to filtering in <a href="https://docs.docker.com/config/labels-custom-metadata/#manage-labels-on-objects">Managing labels on objects</a>. See also <a href="https://docs.docker.com/engine/reference/builder/#label">LABEL</a> in the Dockerfile reference.</p><hr /><h3 id="run-run-the-command">RUN <code class="language-plaintext highlighter-rouge">RUN the command</code></h3><ul><li>Split long or complex <code class="language-plaintext highlighter-rouge">RUN</code> statements on multiple lines separated with backslashes to make <code class="language-plaintext highlighter-rouge">Dockerfile</code> more readable, understandable, and maintainable.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># RUN has 2 forms:</span>

<span class="c"># shell form, the command is run in a shell</span>
<span class="c"># which by default is</span>
<span class="c"># /bin/sh -c on Linux</span>
<span class="c"># cmd /S /C on Win</span>
<span class="k">RUN </span>&lt;<span class="nb">command</span><span class="o">&gt;</span>
<span class="k">RUN </span>/bin/bash <span class="nt">-c</span> <span class="s1">'source $HOME/.bashrc; </span><span class="se">\
</span><span class="s1">echo $HOME'</span>
<span class="c"># equivalent to this single line:</span>
<span class="k">RUN </span>/bin/bash <span class="nt">-c</span> <span class="s1">'source $HOME/.bashrc; echo $HOME'</span>


<span class="c"># exec form</span>
<span class="k">RUN </span><span class="o">[</span><span class="s2">"executable"</span>, <span class="s2">"param1"</span>, <span class="s2">"param2"</span><span class="o">]</span>
<span class="k">RUN </span><span class="o">[</span><span class="s2">"/bin/bash"</span>, <span class="s2">"-c"</span>, <span class="s2">"echo hello"</span><span class="o">]</span>
</pre></table></code></div></div><hr /><h4 id="apt-get">apt-get</h4><p>the <code class="language-plaintext highlighter-rouge">RUN apt-get</code> command has several gotchas to look out for.</p><ul><li><p>Avoid <code class="language-plaintext highlighter-rouge">RUN apt-get upgrade</code> and <code class="language-plaintext highlighter-rouge">dist-upgrade</code>, as many of the “essential” packages from the parent images cannot upgrade inside an <a href="https://docs.docker.com/engine/reference/run/#security-configuration">unprivileged container</a>.</p><li><p>If a package contained in the parent image is out-of-date, contact its maintainers.</p><li><p>If you know there is a particular package, <code class="language-plaintext highlighter-rouge">foo</code> needs to be updated, use <code class="language-plaintext highlighter-rouge">apt-get install -y foo</code> to update automatically.</p><li><p>Always combine <code class="language-plaintext highlighter-rouge">RUN apt-get update</code> with <code class="language-plaintext highlighter-rouge">apt-get install</code> in the same <code class="language-plaintext highlighter-rouge">RUN</code> statement. For example:</p></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    package-bar <span class="se">\
</span>    package-baz <span class="se">\
</span>    package-foo <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
</pre></table></code></div></div><ul><li>Using <code class="language-plaintext highlighter-rouge">apt-get update</code> alone in a <code class="language-plaintext highlighter-rouge">RUN</code> statement causes caching issues and subsequent <code class="language-plaintext highlighter-rouge">apt-get install</code> instructions fail.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
<span class="k">RUN </span>apt-get update
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> curl

<span class="c"># After building the image, all layers are in the Docker cache.</span>
<span class="c"># Suppose you later modify `apt-get install` by adding extra package:</span>

<span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
<span class="k">RUN </span>apt-get update
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> curl nginx


<span class="c"># Docker sees the initial and modified instructions as identical</span>
<span class="c"># it reuses the cache from previous steps.</span>
<span class="c"># As a result the `apt-get update` is _not_ executed because the build uses the cached version.</span>
<span class="c"># Because the `apt-get update` is not run, potentially get an outdated version of the `curl` and `nginx` packages.</span>
</pre></table></code></div></div><p><strong>cache busting</strong></p><ul><li>Using <code class="language-plaintext highlighter-rouge">RUN apt-get update &amp;&amp; apt-get install -y</code> ensures the Dockerfile installs the latest package versions with no further coding or manual intervention.</ul><p><strong>version pinning</strong></p><ul><li>You can also achieve cache-busting by specifying a package version.<li>Version pinning forces the build to retrieve a particular version regardless of what’s in the cache. This technique can also reduce failures due to unanticipated changes in required packages.<li>Below is a well-formed <code class="language-plaintext highlighter-rouge">RUN</code> instruction that demonstrates all the <code class="language-plaintext highlighter-rouge">apt-get</code> recommendations.</ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    package-bar <span class="se">\
</span>    package-baz <span class="se">\
</span>    package-foo<span class="o">=</span>1.3.<span class="k">*</span>


<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    aufs-tools <span class="se">\
</span>    automake <span class="se">\
</span>    build-essential <span class="se">\
</span>    curl <span class="se">\
</span>    dpkg-sig <span class="se">\
</span>    libcap-dev <span class="se">\
</span>    libsqlite3-dev <span class="se">\
</span>    mercurial <span class="se">\
</span>    reprepro <span class="se">\
</span>    ruby1.9.1 <span class="se">\
</span>    ruby1.9.1-dev <span class="se">\
</span>    <span class="nv">s3cmd</span><span class="o">=</span>1.1.<span class="k">*</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

</pre></table></code></div></div><ul><li><p>The <code class="language-plaintext highlighter-rouge">s3cmd</code> argument specifies a version <code class="language-plaintext highlighter-rouge">1.1.*</code>. If the image previously used an older version, specifying the new one causes a cache bust of <code class="language-plaintext highlighter-rouge">apt-get update</code> and ensures the installation of the new version. Listing packages on each line can also prevent mistakes in package duplication.</p><li><p>when clean up the apt cache by removing <code class="language-plaintext highlighter-rouge">/var/lib/apt/lists</code></p><ul><li>it reduces the image size, since the apt cache is not stored in a layer.<li>Since the <code class="language-plaintext highlighter-rouge">RUN</code> statement starts with <code class="language-plaintext highlighter-rouge">apt-get update</code>, the package cache is always refreshed prior to <code class="language-plaintext highlighter-rouge">apt-get install</code>.</ul></ul><blockquote><p>Official Debian and Ubuntu images <a href="https://github.com/moby/moby/blob/03e2923e42446dbb830c654d0eec323a0b4ef02a/contrib/mkimage/debootstrap#L82-L105">automatically run <code class="language-plaintext highlighter-rouge">apt-get clean</code></a>, so explicit invocation is not required.</p></blockquote><hr /><h4 id="using-pipes">Using pipes</h4><p>Some <code class="language-plaintext highlighter-rouge">RUN</code> commands depend on the ability to pipe the output of one command into another, using the pipe character (<code class="language-plaintext highlighter-rouge">|</code>), as in the following example:</p><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">RUN </span>wget <span class="nt">-O</span> - https://some.site | <span class="nb">wc</span> <span class="nt">-l</span> <span class="o">&gt;</span> /number
</pre></table></code></div></div><p>Docker executes these commands using the <code class="language-plaintext highlighter-rouge">/bin/sh -c</code> interpreter, which only evaluates the exit code of the last operation in the pipe to determine success. In the example above this build step succeeds and produces a new image so long as the <code class="language-plaintext highlighter-rouge">wc -l</code> command succeeds, even if the <code class="language-plaintext highlighter-rouge">wget</code> command fails.</p><p>If you want the command to fail due to an error at any stage in the pipe, prepend <code class="language-plaintext highlighter-rouge">set -o pipefail &amp;&amp;</code> to ensure that an unexpected error prevents the build from inadvertently succeeding. For example:</p><div class="table-wrapper"><table><tbody><tr><td>RUN set -o pipefail &amp;&amp; wget -O - https://some.site<td>wc -l &gt; /number</table></div><blockquote><p>Not all shells support the <code class="language-plaintext highlighter-rouge">-o pipefail</code> option.</p><p>In cases such as the <code class="language-plaintext highlighter-rouge">dash</code> shell on Debian-based images, consider using the <em>exec</em> form of <code class="language-plaintext highlighter-rouge">RUN</code> to explicitly choose a shell that does support the <code class="language-plaintext highlighter-rouge">pipefail</code> option. For example:</p><div class="language-plaintext highlighter-rouge"><div class="code-header" text-data="plaintext"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>RUN ["/bin/bash", "-c", "set -o pipefail &amp;&amp; wget -O - https://some.site | wc -l &gt; /number"]
</pre></table></code></div></div></blockquote><h3 id="volume">VOLUME</h3><p>The <code class="language-plaintext highlighter-rouge">VOLUME</code> instruction should be used to expose any database storage area, configuration storage, or files/folders created by the docker container. You are strongly encouraged to use <code class="language-plaintext highlighter-rouge">VOLUME</code> for any mutable and/or user-serviceable parts of the image.</p><h3 id="user">USER</h3><p>If a service can run without privileges, use <code class="language-plaintext highlighter-rouge">USER</code> to change to a non-root user. Start by creating the user and group in the <code class="language-plaintext highlighter-rouge">Dockerfile</code> with something like <code class="language-plaintext highlighter-rouge">RUN groupadd -r postgres &amp;&amp; useradd --no-log-init -r -g postgres postgres</code>.</p><blockquote><p>Consider an explicit UID/GID</p><p>Users and groups in an image are assigned a non-deterministic UID/GID in that the “next” UID/GID is assigned regardless of image rebuilds. So, if it’s critical, you should assign an explicit UID/GID.</p></blockquote><blockquote><p>Due to an <a href="https://github.com/golang/go/issues/13548">unresolved bug</a> in the Go archive/tar package’s handling of sparse files, attempting to create a user with a significantly large UID inside a Docker container can lead to disk exhaustion because <code class="language-plaintext highlighter-rouge">/var/log/faillog</code> in the container layer is filled with NULL (\0) characters. A workaround is to pass the <code class="language-plaintext highlighter-rouge">--no-log-init</code> flag to useradd. The Debian/Ubuntu <code class="language-plaintext highlighter-rouge">adduser</code> wrapper does not support this flag.</p></blockquote><p>Avoid installing or using <code class="language-plaintext highlighter-rouge">sudo</code> as it has unpredictable TTY and signal-forwarding behavior that can cause problems. If you absolutely need functionality similar to <code class="language-plaintext highlighter-rouge">sudo</code>, such as initializing the daemon as <code class="language-plaintext highlighter-rouge">root</code> but running it as non-<code class="language-plaintext highlighter-rouge">root</code>, consider using <a href="https://github.com/tianon/gosu">“gosu”</a>.</p><p>Lastly, to reduce layers and complexity, avoid switching <code class="language-plaintext highlighter-rouge">USER</code> back and forth frequently.</p><hr /><h3 id="workdir">WORKDIR</h3><p>For clarity and reliability, always use absolute paths for the <code class="language-plaintext highlighter-rouge">WORKDIR</code>.</p><ul><li>use <code class="language-plaintext highlighter-rouge">WORKDIR</code> instead of proliferating instructions like <code class="language-plaintext highlighter-rouge">RUN cd … &amp;&amp; do-something</code>, which are hard to read, troubleshoot, and maintain.<ul><li>it sets the working directory for any <code class="language-plaintext highlighter-rouge">RUN, CMD, ENTRYPOINT, COPY and ADD</code> instructions that follow it in the Dockerfile.<li>If the WORKDIR doesn’t exist, it will be created even if it’s not used in any subsequent Dockerfile instruction.</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">WORKDIR</span><span class="s"> /path/to/workdir</span>
</pre></table></code></div></div><ul><li>can be used multiple times in a Dockerfile.<ul><li>If a relative path is provided, it will be relative to the path of the previous WORKDIR instruction.</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">WORKDIR</span><span class="s"> /a</span>
<span class="k">WORKDIR</span><span class="s"> b</span>
<span class="k">WORKDIR</span><span class="s"> c</span>
<span class="k">RUN </span><span class="nb">pwd</span>
<span class="c"># /a/b/c</span>
</pre></table></code></div></div><ul><li>can resolve environment variables previously set using <code class="language-plaintext highlighter-rouge">ENV</code>.<ul><li>You can only use environment variables explicitly set in the Dockerfile.</ul></ul><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">ENV</span><span class="s"> DIRPATH=/path</span>
<span class="k">WORKDIR</span><span class="s"> $DIRPATH/$DIRNAME</span>
<span class="k">RUN </span><span class="nb">pwd</span>
<span class="c"># /path/$DIRNAME</span>
</pre></table></code></div></div><ul><li>If not specified, the default working directory is <code class="language-plaintext highlighter-rouge">/</code>.<ul><li>In practice, if you aren’t building a Dockerfile from scratch (FROM scratch), the <code class="language-plaintext highlighter-rouge">WORKDIR</code> may likely be set by the base image you’re using.<li>to avoid unintended operations in unknown directories, it is best practice to set <code class="language-plaintext highlighter-rouge">WORKDIR</code> explicitly.</ul></ul><hr /><h3 id="onbuild">ONBUILD</h3><p><a href="https://docs.docker.com/engine/reference/builder/#onbuild">ONBUILD instruction</a></p><p>An <code class="language-plaintext highlighter-rouge">ONBUILD</code> command executes after the current <code class="language-plaintext highlighter-rouge">Dockerfile</code> build completes. <code class="language-plaintext highlighter-rouge">ONBUILD</code> executes in any child image derived <code class="language-plaintext highlighter-rouge">FROM</code> the current image. Think of the <code class="language-plaintext highlighter-rouge">ONBUILD</code> command as an instruction the parent <code class="language-plaintext highlighter-rouge">Dockerfile</code> gives to the child <code class="language-plaintext highlighter-rouge">Dockerfile</code>.</p><p>A Docker build executes <code class="language-plaintext highlighter-rouge">ONBUILD</code> commands before any command in a child <code class="language-plaintext highlighter-rouge">Dockerfile</code>.</p><p><code class="language-plaintext highlighter-rouge">ONBUILD</code> is useful for images that are going to be built <code class="language-plaintext highlighter-rouge">FROM</code> a given image. For example, you would use <code class="language-plaintext highlighter-rouge">ONBUILD</code> for a language stack image that builds arbitrary user software written in that language within the <code class="language-plaintext highlighter-rouge">Dockerfile</code>, as you can see in <a href="https://github.com/docker-library/ruby/blob/c43fef8a60cea31eb9e7d960a076d633cb62ba8d/2.4/jessie/onbuild/Dockerfile">Ruby’s <code class="language-plaintext highlighter-rouge">ONBUILD</code> variants</a>.</p><p>Images built with <code class="language-plaintext highlighter-rouge">ONBUILD</code> should get a separate tag, for example: <code class="language-plaintext highlighter-rouge">ruby:1.9-onbuild</code> or <code class="language-plaintext highlighter-rouge">ruby:2.0-onbuild</code>.</p><p>Be careful when putting <code class="language-plaintext highlighter-rouge">ADD</code> or <code class="language-plaintext highlighter-rouge">COPY</code> in <code class="language-plaintext highlighter-rouge">ONBUILD</code>. The “onbuild” image fails catastrophically if the new build’s context is missing the resource being added. Adding a separate tag, as recommended above, helps mitigate this by allowing the <code class="language-plaintext highlighter-rouge">Dockerfile</code> author to make a choice.</p><div class="language-dockerfile highlighter-rouge"><div class="code-header" text-data="dockerfile"><button data-original-title="Copied!"><i class="far fa-clone"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c"># Kali Linux Top10</span>
<span class="c"># Docker image with kali-linux-top10 and a handful of other useful tools</span>
<span class="k">FROM</span><span class="s"> kalilinux/kali-rolling</span>
<span class="k">RUN </span>apt-get <span class="nt">-y</span> update <span class="o">&amp;&amp;</span> apt-get <span class="nt">-y</span> upgrade <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    apt-utils <span class="se">\
</span>    metasploit-framework <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
    apt-utils
</pre></table></code></div></div><p>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/00basic/'>00Basic</a>, <a href='/categories/vmandcontainer/'>VMandContainer</a>, <a href='/categories/containers/'>Containers</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/vms/" class="post-tag no-text-decoration" >VMs</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Virtulization - DockerFile Develop - Grace&url=https://ocholuo.github.io//posts/Docker-dev/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Virtulization - DockerFile Develop - Grace&u=https://ocholuo.github.io//posts/Docker-dev/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Virtulization - DockerFile Develop - Grace&url=https://ocholuo.github.io//posts/Docker-dev/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Amazon-CloudFront/">AWS Lab - AWS CloudFront</a><li><a href="/posts/Alexa-1stSkill/">AWS Alex First Skill - RedVelvet Time</a><li><a href="/posts/NetworkProtocol-SSL-TLS-Handshake/">NetworkProtocol SSL/TLS Handshake</a><li><a href="/posts/pythonCrash/">Python Crash</a><li><a href="/posts/%E4%B8%80%E5%8F%A5%E8%AF%9D%E8%A7%A3%E9%87%8AAWS/">AWS - 一句话解释AWS</a><li><a href="/posts/GKE/">GCP - Google Cloud Computing - Kubernetes and Kubernetes Engine</a><li><a href="/posts/Go-Note/">Go Note</a><li><a href="/posts/SCPs/">AWS - IdenAccessManage - SCPs (Service Control Policies)</a><li><a href="/posts/CompanyBenefit/">Company Benefit</a><li><a href="/posts/Encryption-SSL&TLS/">Cryptography - SSL/TLS Encryption</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Docker-security/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtulization - Docker security</h3><div class="text-muted small"><p> [toc] Docker security basic 评估 Docker 的安全性时，主要考虑三个方面: 由内核的命名空间和控制组机制提供的 容器内在安全 Docker 程序（特别是服务端）本身的抗攻击性 内核安全性的加强机制 对 容器安全性的影响 namespace Docker 容器和 LXC 容器很相似，所提供的安全特性也差不多。 当用 do...</p></div></div></a></div><div class="card"> <a href="/posts/kali-in-docker/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtulization - Running Kali on Docker</h3><div class="text-muted small"><p> [toc] Running Kali on Docker 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Installing Docker on Linux $ sudo apt install docker.io # create folder # make a folder on our ho...</p></div></div></a></div><div class="card"> <a href="/posts/Container/"><div class="card-body"> <span class="timeago small" >Nov 26, 2020<i class="unloaded">2020-11-26T10:11:11-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Virtualization - Container</h3><div class="text-muted small"><p> Virtualization - Container basic traditional virtualization containers virtualmachine (VM)-based vs container-based deployment. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Container/" class="btn btn-outline-primary" prompt="Older"><p>Virtualization - Container</p></a> <a href="/posts/Docker-security/" class="btn btn-outline-primary" prompt="Newer"><p>Virtulization - Docker security</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ocholuo">Grace JyL</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/cyberattack/">CyberAttack</a> <a class="post-tag" href="/tags/lab/">Lab</a> <a class="post-tag" href="/tags/cyberattacktools/">CyberAttackTools</a> <a class="post-tag" href="/tags/gcp/">GCP</a> <a class="post-tag" href="/tags/sysadmin/">Sysadmin</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/soc/">SOC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ocholuo.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-179830187-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-179830187-1'); }); </script>
